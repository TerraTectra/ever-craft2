(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();const tu=e=>{let r;const t=new Set,a=(p,u)=>{const c=typeof p=="function"?p(r):p;if(!Object.is(c,r)){const g=r;r=u??(typeof c!="object"||c===null)?c:Object.assign({},r,c),t.forEach(m=>m(r,g))}},n=()=>r,i={setState:a,getState:n,getInitialState:()=>l,subscribe:p=>(t.add(p),()=>t.delete(p))},l=r=e(a,n,i);return i},ru=(e=>tu),J=e=>e.realms[e.activeRealm];function vo(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function pi(e,r){for(var t=0;t<r.length;t++){var a=r[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function bo(e,r,t){return r&&pi(e.prototype,r),t&&pi(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}var au=(function(){function e(r){vo(this,e),this.map=new Map,this.first=void 0,this.last=void 0,this.maxSize=r}return bo(e,[{key:"size",get:function(){return this.map.size}},{key:"get",value:function(t){var a=this.map.get(t);if(a!==void 0)return a!==this.first&&(a===this.last?(this.last=a.prev,this.last.next=void 0):(a.prev.next=a.next,a.next.prev=a.prev),a.next=this.first,this.first.prev=a,this.first=a),a.value}},{key:"set",value:function(t,a){if(!(this.maxSize<1)){if(this.map.has(t))throw new Error("Cannot update existing keys in the cache");var n=new nu(t,a);for(this.first===void 0?(this.first=n,this.last=n):(n.next=this.first,this.first.prev=n,this.first=n),this.map.set(t,n);this.map.size>this.maxSize;){var s=this.last;this.map.delete(s.key),this.last=s.prev,this.last.next=void 0}}}}]),e})(),nu=bo(function e(r,t){vo(this,e),this.next=void 0,this.prev=void 0,this.key=r,this.value=t}),ds=17,rt=9e15,su=Math.log10(9e15),gr=1/9e15,ou=308,iu=-324,fi=5,lu=1023,cu=(function(){for(var e=[],r=iu+1;r<=ou;r++)e.push(+("1e"+r));var t=323;return function(a){return e[a+t]}})(),hr=[2,Math.E,3,4,5,6,7,8,9,10],uu=[[1,1.0891180521811203,1.1789767925673957,1.2701455431742086,1.3632090180450092,1.4587818160364217,1.5575237916251419,1.6601571006859253,1.767485818836978,1.8804192098842727,2],[1,1.1121114330934079,1.231038924931609,1.3583836963111375,1.4960519303993531,1.6463542337511945,1.8121385357018724,1.996971324618307,2.2053895545527546,2.4432574483385254,Math.E],[1,1.1187738849693603,1.2464963939368214,1.38527004705667,1.5376664685821402,1.7068895236551784,1.897001227148399,2.1132403089001035,2.362480153784171,2.6539010333870774,3],[1,1.1367350847096405,1.2889510672956703,1.4606478703324786,1.6570295196661111,1.8850062585672889,2.1539465047453485,2.476829779693097,2.872061932789197,3.3664204535587183,4],[1,1.1494592900767588,1.319708228183931,1.5166291280087583,1.748171114438024,2.0253263297298045,2.3636668498288547,2.7858359149579424,3.3257226212448145,4.035730287722532,5],[1,1.159225940787673,1.343712473580932,1.5611293155111927,1.8221199554561318,2.14183924486326,2.542468319282638,3.0574682501653316,3.7390572020926873,4.6719550537360774,6],[1,1.1670905356972596,1.3632807444991446,1.5979222279405536,1.8842640123816674,2.2416069644878687,2.69893426559423,3.3012632110403577,4.121250340630164,5.281493033448316,7],[1,1.1736630594087796,1.379783782386201,1.6292821855668218,1.9378971836180754,2.3289975651071977,2.8384347394720835,3.5232708454565906,4.478242031114584,5.868592169644505,8],[1,1.1793017514670474,1.394054150657457,1.65664127441059,1.985170999970283,2.4069682290577457,2.9647310119960752,3.7278665320924946,4.814462547283592,6.436522247411611,9],[1,1.1840100246247336,1.4061375836156955,1.6802272208863964,2.026757028388619,2.4770056063449646,3.080525271755482,3.9191964192627284,5.135152840833187,6.989961179534715,10]],du=[[-1,-.9194161097107025,-.8335625019330468,-.7425599821143978,-.6466611521029437,-.5462617907227869,-.4419033816638769,-.3342645487554494,-.224140440909962,-.11241087890006762,0],[-1,-.90603157029014,-.80786507256596,-.7064666939634,-.60294836853664,-.49849837513117,-.39430303318768,-.29147201034755,-.19097820800866,-.09361896280296,0],[-1,-.9021579584316141,-.8005762598234203,-.6964780623319391,-.5911906810998454,-.486050182576545,-.3823089430815083,-.28106046722897615,-.1831906535795894,-.08935809204418144,0],[-1,-.8917227442365535,-.781258746326964,-.6705130326902455,-.5612813129406509,-.4551067709033134,-.35319256652135966,-.2563741554088552,-.1651412821106526,-.0796919581982668,0],[-1,-.8843387974366064,-.7678744063886243,-.6529563724510552,-.5415870994657841,-.4352842206588936,-.33504449124791424,-.24138853420685147,-.15445285440944467,-.07409659641336663,0],[-1,-.8786709358426346,-.7577735191184886,-.6399546189952064,-.527284921869926,-.4211627631006314,-.3223479611761232,-.23107655627789858,-.1472057700818259,-.07035171210706326,0],[-1,-.8740862815291583,-.7497032990976209,-.6297119746181752,-.5161838335958787,-.41036238255751956,-.31277212146489963,-.2233976621705518,-.1418697367979619,-.06762117662323441,0],[-1,-.8702632331800649,-.7430366914122081,-.6213373075161548,-.5072025698095242,-.40171437727184167,-.30517930701410456,-.21736343968190863,-.137710238299109,-.06550774483471955,0],[-1,-.8670016295947213,-.7373984232432306,-.6143173985094293,-.49973884395492807,-.394584953527678,-.2989649949848695,-.21245647317021688,-.13434688362382652,-.0638072667348083,0],[-1,-.8641642839543857,-.732534623168535,-.6083127477059322,-.4934049257184696,-.3885773075899922,-.29376029055315767,-.2083678561173622,-.13155653399373268,-.062401588652553186,0]],q=function(r){return d.fromValue_noAlloc(r)},fe=function(r,t,a){return d.fromComponents(r,t,a)},ve=function(r,t,a){return d.fromComponents_noNormalize(r,t,a)},rr=function(r,t){var a=t+1,n=Math.ceil(Math.log10(Math.abs(r))),s=Math.round(r*Math.pow(10,a-n))*Math.pow(10,n-a);return parseFloat(s.toFixed(Math.max(a-n,0)))},ms=function(r){return Math.sign(r)*Math.log10(Math.abs(r))},mu=function(r){if(!isFinite(r))return r;if(r<-50)return r===Math.trunc(r)?Number.NEGATIVE_INFINITY:0;for(var t=1;r<10;)t=t*r,++r;r-=1;var a=.9189385332046727;a=a+(r+.5)*Math.log(r),a=a-r;var n=r*r,s=r;return a=a+1/(12*s),s=s*n,a=a-1/(360*s),s=s*n,a=a+1/(1260*s),s=s*n,a=a-1/(1680*s),s=s*n,a=a+1/(1188*s),s=s*n,a=a-691/(360360*s),s=s*n,a=a+7/(1092*s),s=s*n,a=a-3617/(122400*s),Math.exp(a)/t},pu=.36787944117144233,wl=.5671432904097838,ps=function(r){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1e-10,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,n,s;if(!Number.isFinite(r))return r;if(a){if(r===0)return r;if(r===1)return wl;r<10?n=0:n=Math.log(r)-Math.log(Math.log(r))}else{if(r===0)return-1/0;r<=-.1?n=-2:n=Math.log(-r)-Math.log(-Math.log(-r))}for(var o=0;o<100;++o){if(s=(r*Math.exp(-n)+n*n)/(n+1),Math.abs(s-n)<t*Math.abs(s))return s;n=s}throw Error("Iteration failed to converge: ".concat(r.toString()))};function gi(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1e-10,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,a,n,s,o;if(!Number.isFinite(e.mag))return new d(e);if(t){if(e.eq(d.dZero))return ve(0,0,0);if(e.eq(d.dOne))return d.fromNumber(wl);a=d.ln(e)}else{if(e.eq(d.dZero))return new d(d.dNegInf);a=d.ln(e.neg())}for(var i=0;i<100;++i){if(n=a.neg().exp(),s=a.sub(e.mul(n)),o=a.sub(s.div(a.add(1).sub(a.add(2).mul(s).div(d.mul(2,a).add(2))))),d.abs(o.sub(a)).lt(d.abs(o).mul(r)))return o;a=o}throw Error("Iteration failed to converge: ".concat(e.toString()))}var d=(function(){function e(r){vo(this,e),this.sign=0,this.mag=0,this.layer=0,r instanceof e?this.fromDecimal(r):typeof r=="number"?this.fromNumber(r):typeof r=="string"&&this.fromString(r)}return bo(e,[{key:"m",get:function(){if(this.sign===0)return 0;if(this.layer===0){var t=Math.floor(Math.log10(this.mag)),a;return this.mag===5e-324?a=5:a=this.mag/cu(t),this.sign*a}else if(this.layer===1){var n=this.mag-Math.floor(this.mag);return this.sign*Math.pow(10,n)}else return this.sign},set:function(t){this.layer<=2?this.fromMantissaExponent(t,this.e):(this.sign=Math.sign(t),this.sign===0&&(this.layer=0,this.exponent=0))}},{key:"e",get:function(){return this.sign===0?0:this.layer===0?Math.floor(Math.log10(this.mag)):this.layer===1?Math.floor(this.mag):this.layer===2?Math.floor(Math.sign(this.mag)*Math.pow(10,Math.abs(this.mag))):this.mag*Number.POSITIVE_INFINITY},set:function(t){this.fromMantissaExponent(this.m,t)}},{key:"s",get:function(){return this.sign},set:function(t){t===0?(this.sign=0,this.layer=0,this.mag=0):this.sign=t}},{key:"mantissa",get:function(){return this.m},set:function(t){this.m=t}},{key:"exponent",get:function(){return this.e},set:function(t){this.e=t}},{key:"normalize",value:function(){if(this.sign===0||this.mag===0&&this.layer===0||this.mag===Number.NEGATIVE_INFINITY&&this.layer>0&&Number.isFinite(this.layer))return this.sign=0,this.mag=0,this.layer=0,this;if(this.layer===0&&this.mag<0&&(this.mag=-this.mag,this.sign=-this.sign),this.mag===Number.POSITIVE_INFINITY||this.layer===Number.POSITIVE_INFINITY||this.mag===Number.NEGATIVE_INFINITY||this.layer===Number.NEGATIVE_INFINITY)return this.mag=Number.POSITIVE_INFINITY,this.layer=Number.POSITIVE_INFINITY,this;if(this.layer===0&&this.mag<gr)return this.layer+=1,this.mag=Math.log10(this.mag),this;var t=Math.abs(this.mag),a=Math.sign(this.mag);if(t>=rt)return this.layer+=1,this.mag=a*Math.log10(t),this;for(;t<su&&this.layer>0;)this.layer-=1,this.layer===0?this.mag=Math.pow(10,this.mag):(this.mag=a*Math.pow(10,t),t=Math.abs(this.mag),a=Math.sign(this.mag));return this.layer===0&&(this.mag<0?(this.mag=-this.mag,this.sign=-this.sign):this.mag===0&&(this.sign=0)),(Number.isNaN(this.sign)||Number.isNaN(this.layer)||Number.isNaN(this.mag))&&(this.sign=Number.NaN,this.layer=Number.NaN,this.mag=Number.NaN),this}},{key:"fromComponents",value:function(t,a,n){return this.sign=t,this.layer=a,this.mag=n,this.normalize(),this}},{key:"fromComponents_noNormalize",value:function(t,a,n){return this.sign=t,this.layer=a,this.mag=n,this}},{key:"fromMantissaExponent",value:function(t,a){return this.layer=1,this.sign=Math.sign(t),t=Math.abs(t),this.mag=a+Math.log10(t),this.normalize(),this}},{key:"fromMantissaExponent_noNormalize",value:function(t,a){return this.fromMantissaExponent(t,a),this}},{key:"fromDecimal",value:function(t){return this.sign=t.sign,this.layer=t.layer,this.mag=t.mag,this}},{key:"fromNumber",value:function(t){return this.mag=Math.abs(t),this.sign=Math.sign(t),this.layer=0,this.normalize(),this}},{key:"fromString",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=t,s=e.fromStringCache.get(n);if(s!==void 0)return this.fromDecimal(s);if(t=t.replace(",",""),t.toLowerCase()==="nan")return this.fromDecimal(e.dNaN);if(t.toLowerCase()==="infinity")return this.fromDecimal(e.dInf);if(t.toLowerCase()==="-infinity")return this.fromDecimal(e.dNegInf);var o=t.split("^^^");if(o.length===2){var i=parseFloat(o[0]),l=parseFloat(o[1]),p=o[1].split(";"),u=1;if(p.length===2&&(u=parseFloat(p[1]),isFinite(u)||(u=1)),isFinite(i)&&isFinite(l)){var c=e.pentate(i,l,u,a);return this.sign=c.sign,this.layer=c.layer,this.mag=c.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),this}}var g=t.split("^^");if(g.length===2){var m=parseFloat(g[0]),h=parseFloat(g[1]),f=g[1].split(";"),v=1;if(f.length===2&&(v=parseFloat(f[1]),isFinite(v)||(v=1)),isFinite(m)&&isFinite(h)){var S=e.tetrate(m,h,v,a);return this.sign=S.sign,this.layer=S.layer,this.mag=S.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),this}}var b=t.split("^");if(b.length===2){var T=parseFloat(b[0]),w=parseFloat(b[1]);if(isFinite(T)&&isFinite(w)){var $=e.pow(T,w);return this.sign=$.sign,this.layer=$.layer,this.mag=$.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),this}}t=t.trim().toLowerCase();var R,x,y=t.split("pt");if(y.length===2){R=10;var k=!1;y[0][0]=="-"&&(k=!0,y[0]=y[0].slice(1)),x=parseFloat(y[0]),y[1]=y[1].replace("(",""),y[1]=y[1].replace(")","");var C=parseFloat(y[1]);if(isFinite(C)||(C=1),isFinite(R)&&isFinite(x)){var I=e.tetrate(R,x,C,a);return this.sign=I.sign,this.layer=I.layer,this.mag=I.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),k&&(this.sign*=-1),this}}if(y=t.split("p"),y.length===2){R=10;var _=!1;y[0][0]=="-"&&(_=!0,y[0]=y[0].slice(1)),x=parseFloat(y[0]),y[1]=y[1].replace("(",""),y[1]=y[1].replace(")","");var A=parseFloat(y[1]);if(isFinite(A)||(A=1),isFinite(R)&&isFinite(x)){var F=e.tetrate(R,x,A,a);return this.sign=F.sign,this.layer=F.layer,this.mag=F.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),_&&(this.sign*=-1),this}}if(y=t.split("f"),y.length===2){R=10;var E=!1;y[0][0]=="-"&&(E=!0,y[0]=y[0].slice(1)),y[0]=y[0].replace("(",""),y[0]=y[0].replace(")","");var P=parseFloat(y[0]);if(y[1]=y[1].replace("(",""),y[1]=y[1].replace(")",""),x=parseFloat(y[1]),isFinite(P)||(P=1),isFinite(R)&&isFinite(x)){var V=e.tetrate(R,x,P,a);return this.sign=V.sign,this.layer=V.layer,this.mag=V.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),E&&(this.sign*=-1),this}}var j=t.split("e"),B=j.length-1;if(B===0){var Z=parseFloat(t);if(isFinite(Z))return this.fromNumber(Z),e.fromStringCache.size>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),this}else if(B===1){var oe=parseFloat(t);if(isFinite(oe)&&Math.abs(oe)>1e-307)return this.fromNumber(oe),e.fromStringCache.maxSize>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),this}var U=t.split("e^");if(U.length===2){this.sign=1,U[0].charAt(0)=="-"&&(this.sign=-1);for(var O="",K=0;K<U[1].length;++K){var se=U[1].charCodeAt(K);if(se>=43&&se<=57||se===101)O+=U[1].charAt(K);else{if(this.layer=parseFloat(O),this.mag=parseFloat(U[1].substr(K+1)),this.layer<0||this.layer%1!=0){var be=e.tetrate(10,this.layer,this.mag,a);this.sign=be.sign,this.layer=be.layer,this.mag=be.mag}return this.normalize(),e.fromStringCache.maxSize>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),this}}}if(B<1)return this.sign=0,this.layer=0,this.mag=0,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),this;var G=parseFloat(j[0]);if(G===0)return this.sign=0,this.layer=0,this.mag=0,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),this;var L=parseFloat(j[j.length-1]);if(B>=2){var Y=parseFloat(j[j.length-2]);isFinite(Y)&&(L*=Math.sign(Y),L+=ms(Y))}if(!isFinite(G))this.sign=j[0]==="-"?-1:1,this.layer=B,this.mag=L;else if(B===1)this.sign=Math.sign(G),this.layer=1,this.mag=L+Math.log10(Math.abs(G));else if(this.sign=Math.sign(G),this.layer=B,B===2){var X=e.mul(fe(1,2,L),q(G));return this.sign=X.sign,this.layer=X.layer,this.mag=X.mag,e.fromStringCache.maxSize>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),this}else this.mag=L;return this.normalize(),e.fromStringCache.maxSize>=1&&e.fromStringCache.set(n,e.fromDecimal(this)),this}},{key:"fromValue",value:function(t){return t instanceof e?this.fromDecimal(t):typeof t=="number"?this.fromNumber(t):typeof t=="string"?this.fromString(t):(this.sign=0,this.layer=0,this.mag=0,this)}},{key:"toNumber",value:function(){return this.mag===Number.POSITIVE_INFINITY&&this.layer===Number.POSITIVE_INFINITY&&this.sign===1?Number.POSITIVE_INFINITY:this.mag===Number.POSITIVE_INFINITY&&this.layer===Number.POSITIVE_INFINITY&&this.sign===-1?Number.NEGATIVE_INFINITY:Number.isFinite(this.layer)?this.layer===0?this.sign*this.mag:this.layer===1?this.sign*Math.pow(10,this.mag):this.mag>0?this.sign>0?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:0:Number.NaN}},{key:"mantissaWithDecimalPlaces",value:function(t){return isNaN(this.m)?Number.NaN:this.m===0?0:rr(this.m,t)}},{key:"magnitudeWithDecimalPlaces",value:function(t){return isNaN(this.mag)?Number.NaN:this.mag===0?0:rr(this.mag,t)}},{key:"toString",value:function(){return isNaN(this.layer)||isNaN(this.sign)||isNaN(this.mag)?"NaN":this.mag===Number.POSITIVE_INFINITY||this.layer===Number.POSITIVE_INFINITY?this.sign===1?"Infinity":"-Infinity":this.layer===0?this.mag<1e21&&this.mag>1e-7||this.mag===0?(this.sign*this.mag).toString():this.m+"e"+this.e:this.layer===1?this.m+"e"+this.e:this.layer<=fi?(this.sign===-1?"-":"")+"e".repeat(this.layer)+this.mag:(this.sign===-1?"-":"")+"(e^"+this.layer+")"+this.mag}},{key:"toExponential",value:function(t){return this.layer===0?(this.sign*this.mag).toExponential(t):this.toStringWithDecimalPlaces(t)}},{key:"toFixed",value:function(t){return this.layer===0?(this.sign*this.mag).toFixed(t):this.toStringWithDecimalPlaces(t)}},{key:"toPrecision",value:function(t){return this.e<=-7?this.toExponential(t-1):t>this.e?this.toFixed(t-this.exponent-1):this.toExponential(t-1)}},{key:"valueOf",value:function(){return this.toString()}},{key:"toJSON",value:function(){return this.toString()}},{key:"toStringWithDecimalPlaces",value:function(t){return this.layer===0?this.mag<1e21&&this.mag>1e-7||this.mag===0?(this.sign*this.mag).toFixed(t):rr(this.m,t)+"e"+rr(this.e,t):this.layer===1?rr(this.m,t)+"e"+rr(this.e,t):this.layer<=fi?(this.sign===-1?"-":"")+"e".repeat(this.layer)+rr(this.mag,t):(this.sign===-1?"-":"")+"(e^"+this.layer+")"+rr(this.mag,t)}},{key:"abs",value:function(){return ve(this.sign===0?0:1,this.layer,this.mag)}},{key:"neg",value:function(){return ve(-this.sign,this.layer,this.mag)}},{key:"negate",value:function(){return this.neg()}},{key:"negated",value:function(){return this.neg()}},{key:"sgn",value:function(){return this.sign}},{key:"round",value:function(){return this.mag<0?ve(0,0,0):this.layer===0?fe(this.sign,0,Math.round(this.mag)):new e(this)}},{key:"floor",value:function(){return this.mag<0?this.sign===-1?ve(-1,0,1):ve(0,0,0):this.sign===-1?this.neg().ceil().neg():this.layer===0?fe(this.sign,0,Math.floor(this.mag)):new e(this)}},{key:"ceil",value:function(){return this.mag<0?this.sign===1?ve(1,0,1):ve(0,0,0):this.sign===-1?this.neg().floor().neg():this.layer===0?fe(this.sign,0,Math.ceil(this.mag)):new e(this)}},{key:"trunc",value:function(){return this.mag<0?ve(0,0,0):this.layer===0?fe(this.sign,0,Math.trunc(this.mag)):new e(this)}},{key:"add",value:function(t){var a=q(t);if(this.eq(e.dInf)&&a.eq(e.dNegInf)||this.eq(e.dNegInf)&&a.eq(e.dInf))return new e(e.dNaN);if(!Number.isFinite(this.layer))return new e(this);if(!Number.isFinite(a.layer))return new e(a);if(this.sign===0)return new e(a);if(a.sign===0)return new e(this);if(this.sign===-a.sign&&this.layer===a.layer&&this.mag===a.mag)return ve(0,0,0);var n,s;if(this.layer>=2||a.layer>=2)return this.maxabs(a);if(e.cmpabs(this,a)>0?(n=new e(this),s=new e(a)):(n=new e(a),s=new e(this)),n.layer===0&&s.layer===0)return e.fromNumber(n.sign*n.mag+s.sign*s.mag);var o=n.layer*Math.sign(n.mag),i=s.layer*Math.sign(s.mag);if(o-i>=2)return n;if(o===0&&i===-1){if(Math.abs(s.mag-Math.log10(n.mag))>ds)return n;var l=Math.pow(10,Math.log10(n.mag)-s.mag),p=s.sign+n.sign*l;return fe(Math.sign(p),1,s.mag+Math.log10(Math.abs(p)))}if(o===1&&i===0){if(Math.abs(n.mag-Math.log10(s.mag))>ds)return n;var u=Math.pow(10,n.mag-Math.log10(s.mag)),c=s.sign+n.sign*u;return fe(Math.sign(c),1,Math.log10(s.mag)+Math.log10(Math.abs(c)))}if(Math.abs(n.mag-s.mag)>ds)return n;var g=Math.pow(10,n.mag-s.mag),m=s.sign+n.sign*g;return fe(Math.sign(m),1,s.mag+Math.log10(Math.abs(m)))}},{key:"plus",value:function(t){return this.add(t)}},{key:"sub",value:function(t){return this.add(q(t).neg())}},{key:"subtract",value:function(t){return this.sub(t)}},{key:"minus",value:function(t){return this.sub(t)}},{key:"mul",value:function(t){var a=q(t);if(this.eq(e.dInf)&&a.eq(e.dNegInf)||this.eq(e.dNegInf)&&a.eq(e.dInf))return new e(e.dNegInf);if(this.mag==Number.POSITIVE_INFINITY&&a.eq(e.dZero)||this.eq(e.dZero)&&this.mag==Number.POSITIVE_INFINITY)return new e(e.dNaN);if(this.eq(e.dNegInf)&&a.eq(e.dNegInf))return new e(e.dInf);if(!Number.isFinite(this.layer))return new e(this);if(!Number.isFinite(a.layer))return new e(a);if(this.sign===0||a.sign===0)return ve(0,0,0);if(this.layer===a.layer&&this.mag===-a.mag)return ve(this.sign*a.sign,0,1);var n,s;if(this.layer>a.layer||this.layer==a.layer&&Math.abs(this.mag)>Math.abs(a.mag)?(n=new e(this),s=new e(a)):(n=new e(a),s=new e(this)),n.layer===0&&s.layer===0)return e.fromNumber(n.sign*s.sign*n.mag*s.mag);if(n.layer>=3||n.layer-s.layer>=2)return fe(n.sign*s.sign,n.layer,n.mag);if(n.layer===1&&s.layer===0)return fe(n.sign*s.sign,1,n.mag+Math.log10(s.mag));if(n.layer===1&&s.layer===1)return fe(n.sign*s.sign,1,n.mag+s.mag);if(n.layer===2&&s.layer===1){var o=fe(Math.sign(n.mag),n.layer-1,Math.abs(n.mag)).add(fe(Math.sign(s.mag),s.layer-1,Math.abs(s.mag)));return fe(n.sign*s.sign,o.layer+1,o.sign*o.mag)}if(n.layer===2&&s.layer===2){var i=fe(Math.sign(n.mag),n.layer-1,Math.abs(n.mag)).add(fe(Math.sign(s.mag),s.layer-1,Math.abs(s.mag)));return fe(n.sign*s.sign,i.layer+1,i.sign*i.mag)}throw Error("Bad arguments to mul: "+this+", "+t)}},{key:"multiply",value:function(t){return this.mul(t)}},{key:"times",value:function(t){return this.mul(t)}},{key:"div",value:function(t){var a=q(t);return this.mul(a.recip())}},{key:"divide",value:function(t){return this.div(t)}},{key:"divideBy",value:function(t){return this.div(t)}},{key:"dividedBy",value:function(t){return this.div(t)}},{key:"recip",value:function(){return this.mag===0?new e(e.dNaN):this.mag===Number.POSITIVE_INFINITY?ve(0,0,0):this.layer===0?fe(this.sign,0,1/this.mag):fe(this.sign,this.layer,-this.mag)}},{key:"reciprocal",value:function(){return this.recip()}},{key:"reciprocate",value:function(){return this.recip()}},{key:"mod",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=q(t),s=n.abs();if(this.eq(e.dZero)||s.eq(e.dZero))return ve(0,0,0);if(a){var o=this.abs().mod(s);return this.sign==-1!=(n.sign==-1)&&(o=n.abs().sub(o)),o.mul(n.sign)}var i=this.toNumber(),l=s.toNumber();return isFinite(i)&&isFinite(l)&&i!=0&&l!=0?new e(i%l):this.sub(s).eq(this)?ve(0,0,0):s.sub(this).eq(s)?new e(this):this.sign==-1?this.abs().mod(s).neg():this.sub(this.div(s).floor().mul(s))}},{key:"modulo",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return this.mod(t,a)}},{key:"modular",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return this.mod(t,a)}},{key:"cmp",value:function(t){var a=q(t);return this.sign>a.sign?1:this.sign<a.sign?-1:this.sign*this.cmpabs(t)}},{key:"cmpabs",value:function(t){var a=q(t),n=this.mag>0?this.layer:-this.layer,s=a.mag>0?a.layer:-a.layer;return n>s?1:n<s?-1:this.mag>a.mag?1:this.mag<a.mag?-1:0}},{key:"compare",value:function(t){return this.cmp(t)}},{key:"isNan",value:function(){return isNaN(this.sign)||isNaN(this.layer)||isNaN(this.mag)}},{key:"isFinite",value:(function(r){function t(){return r.apply(this,arguments)}return t.toString=function(){return r.toString()},t})(function(){return isFinite(this.sign)&&isFinite(this.layer)&&isFinite(this.mag)})},{key:"eq",value:function(t){var a=q(t);return this.sign===a.sign&&this.layer===a.layer&&this.mag===a.mag}},{key:"equals",value:function(t){return this.eq(t)}},{key:"neq",value:function(t){return!this.eq(t)}},{key:"notEquals",value:function(t){return this.neq(t)}},{key:"lt",value:function(t){return this.cmp(t)===-1}},{key:"lte",value:function(t){return!this.gt(t)}},{key:"gt",value:function(t){return this.cmp(t)===1}},{key:"gte",value:function(t){return!this.lt(t)}},{key:"max",value:function(t){var a=q(t);return this.lt(a)?new e(a):new e(this)}},{key:"min",value:function(t){var a=q(t);return this.gt(a)?new e(a):new e(this)}},{key:"maxabs",value:function(t){var a=q(t);return this.cmpabs(a)<0?new e(a):new e(this)}},{key:"minabs",value:function(t){var a=q(t);return this.cmpabs(a)>0?new e(a):new e(this)}},{key:"clamp",value:function(t,a){return this.max(t).min(a)}},{key:"clampMin",value:function(t){return this.max(t)}},{key:"clampMax",value:function(t){return this.min(t)}},{key:"cmp_tolerance",value:function(t,a){var n=q(t);return this.eq_tolerance(n,a)?0:this.cmp(n)}},{key:"compare_tolerance",value:function(t,a){return this.cmp_tolerance(t,a)}},{key:"eq_tolerance",value:function(t,a){var n=q(t);if(a==null&&(a=1e-7),this.sign!==n.sign||Math.abs(this.layer-n.layer)>1)return!1;var s=this.mag,o=n.mag;return this.layer>n.layer&&(o=ms(o)),this.layer<n.layer&&(s=ms(s)),Math.abs(s-o)<=a*Math.max(Math.abs(s),Math.abs(o))}},{key:"equals_tolerance",value:function(t,a){return this.eq_tolerance(t,a)}},{key:"neq_tolerance",value:function(t,a){return!this.eq_tolerance(t,a)}},{key:"notEquals_tolerance",value:function(t,a){return this.neq_tolerance(t,a)}},{key:"lt_tolerance",value:function(t,a){var n=q(t);return!this.eq_tolerance(n,a)&&this.lt(n)}},{key:"lte_tolerance",value:function(t,a){var n=q(t);return this.eq_tolerance(n,a)||this.lt(n)}},{key:"gt_tolerance",value:function(t,a){var n=q(t);return!this.eq_tolerance(n,a)&&this.gt(n)}},{key:"gte_tolerance",value:function(t,a){var n=q(t);return this.eq_tolerance(n,a)||this.gt(n)}},{key:"pLog10",value:function(){return this.lt(e.dZero)?ve(0,0,0):this.log10()}},{key:"absLog10",value:function(){return this.sign===0?new e(e.dNaN):this.layer>0?fe(Math.sign(this.mag),this.layer-1,Math.abs(this.mag)):fe(1,0,Math.log10(this.mag))}},{key:"log10",value:function(){return this.sign<=0?new e(e.dNaN):this.layer>0?fe(Math.sign(this.mag),this.layer-1,Math.abs(this.mag)):fe(this.sign,0,Math.log10(this.mag))}},{key:"log",value:function(t){return t=q(t),this.sign<=0?new e(e.dNaN):t.sign<=0?new e(e.dNaN):t.sign===1&&t.layer===0&&t.mag===1?new e(e.dNaN):this.layer===0&&t.layer===0?fe(this.sign,0,Math.log(this.mag)/Math.log(t.mag)):e.div(this.log10(),t.log10())}},{key:"log2",value:function(){return this.sign<=0?new e(e.dNaN):this.layer===0?fe(this.sign,0,Math.log2(this.mag)):this.layer===1?fe(Math.sign(this.mag),0,Math.abs(this.mag)*3.321928094887362):this.layer===2?fe(Math.sign(this.mag),1,Math.abs(this.mag)+.5213902276543247):fe(Math.sign(this.mag),this.layer-1,Math.abs(this.mag))}},{key:"ln",value:function(){return this.sign<=0?new e(e.dNaN):this.layer===0?fe(this.sign,0,Math.log(this.mag)):this.layer===1?fe(Math.sign(this.mag),0,Math.abs(this.mag)*2.302585092994046):this.layer===2?fe(Math.sign(this.mag),1,Math.abs(this.mag)+.36221568869946325):fe(Math.sign(this.mag),this.layer-1,Math.abs(this.mag))}},{key:"logarithm",value:function(t){return this.log(t)}},{key:"pow",value:function(t){var a=q(t),n=new e(this),s=new e(a);if(n.sign===0)return s.eq(0)?ve(1,0,1):n;if(n.sign===1&&n.layer===0&&n.mag===1)return n;if(s.sign===0)return ve(1,0,1);if(s.sign===1&&s.layer===0&&s.mag===1)return n;var o=n.absLog10().mul(s).pow10();return this.sign===-1?Math.abs(s.toNumber()%2)%2===1?o.neg():Math.abs(s.toNumber()%2)%2===0?o:new e(e.dNaN):o}},{key:"pow10",value:function(){if(this.eq(e.dInf))return new e(e.dInf);if(this.eq(e.dNegInf))return ve(0,0,0);if(!Number.isFinite(this.layer)||!Number.isFinite(this.mag))return new e(e.dNaN);var t=new e(this);if(t.layer===0){var a=Math.pow(10,t.sign*t.mag);if(Number.isFinite(a)&&Math.abs(a)>=.1)return fe(1,0,a);if(t.sign===0)return ve(1,0,1);t=ve(t.sign,t.layer+1,Math.log10(t.mag))}return t.sign>0&&t.mag>=0?fe(t.sign,t.layer+1,t.mag):t.sign<0&&t.mag>=0?fe(-t.sign,t.layer+1,-t.mag):ve(1,0,1)}},{key:"pow_base",value:function(t){return q(t).pow(this)}},{key:"root",value:function(t){var a=q(t);return this.lt(0)&&a.mod(2,!0).eq(1)?this.neg().root(a).neg():this.pow(a.recip())}},{key:"factorial",value:function(){return this.mag<0?this.add(1).gamma():this.layer===0?this.add(1).gamma():this.layer===1?e.exp(e.mul(this,e.ln(this).sub(1))):e.exp(this)}},{key:"gamma",value:function(){if(this.mag<0)return this.recip();if(this.layer===0){if(this.lt(ve(1,0,24)))return e.fromNumber(mu(this.sign*this.mag));var t=this.mag-1,a=.9189385332046727;a=a+(t+.5)*Math.log(t),a=a-t;var n=t*t,s=t,o=12*s,i=1/o,l=a+i;if(l===a||(a=l,s=s*n,o=360*s,i=1/o,l=a-i,l===a))return e.exp(a);a=l,s=s*n,o=1260*s;var p=1/o;return a=a+p,s=s*n,o=1680*s,p=1/o,a=a-p,e.exp(a)}else return this.layer===1?e.exp(e.mul(this,e.ln(this).sub(1))):e.exp(this)}},{key:"lngamma",value:function(){return this.gamma().ln()}},{key:"exp",value:function(){return this.mag<0?ve(1,0,1):this.layer===0&&this.mag<=709.7?e.fromNumber(Math.exp(this.sign*this.mag)):this.layer===0?fe(1,1,this.sign*Math.log10(Math.E)*this.mag):this.layer===1?fe(1,2,this.sign*(Math.log10(.4342944819032518)+this.mag)):fe(1,this.layer+1,this.sign*this.mag)}},{key:"sqr",value:function(){return this.pow(2)}},{key:"sqrt",value:function(){if(this.layer===0)return e.fromNumber(Math.sqrt(this.sign*this.mag));if(this.layer===1)return fe(1,2,Math.log10(this.mag)-.3010299956639812);var t=e.div(ve(this.sign,this.layer-1,this.mag),ve(1,0,2));return t.layer+=1,t.normalize(),t}},{key:"cube",value:function(){return this.pow(3)}},{key:"cbrt",value:function(){return this.lt(0)?this.neg().pow(1/3).neg():this.pow(1/3)}},{key:"tetrate",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:2,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ve(1,0,1),n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(t===1)return e.pow(this,a);if(t===0)return new e(a);if(this.eq(e.dOne))return ve(1,0,1);if(this.eq(-1))return e.pow(this,a);if(t===Number.POSITIVE_INFINITY){var s=this.toNumber();if(s<=1.444667861009766&&s>=.06598803584531254){var o=e.ln(this).neg(),i=o.lambertw().div(o);if(s<1)return i;var l=o.lambertw(!1).div(o);return s>1.444667861009099&&(i=l=e.fromNumber(Math.E)),a=q(a),a.eq(l)?l:a.lt(l)?i:new e(e.dInf)}else return s>1.444667861009766?new e(e.dInf):new e(e.dNaN)}if(this.eq(e.dZero)){var p=Math.abs((t+1)%2);return p>1&&(p=2-p),e.fromNumber(p)}if(t<0)return e.iteratedlog(a,this,-t,n);a=new e(a);var u=t;t=Math.trunc(t);var c=u-t;if(this.gt(e.dZero)&&(this.lt(1)||this.lte(1.444667861009766)&&a.lte(e.ln(this).neg().lambertw(!1).div(e.ln(this).neg())))&&(u>1e4||!n)){var g=Math.min(1e4,t);a.eq(e.dOne)?a=this.pow(c):this.lt(1)?a=a.pow(1-c).mul(this.pow(a).pow(c)):a=a.layeradd(c,this);for(var m=0;m<g;++m){var h=a;if(a=this.pow(a),h.eq(a))return a}return u>1e4&&Math.ceil(u)%2==1?this.pow(a):a}c!==0&&(a.eq(e.dOne)?this.gt(10)||n?a=this.pow(c):(a=e.fromNumber(e.tetrate_critical(this.toNumber(),c)),this.lt(2)&&(a=a.sub(1).mul(this.minus(1)).plus(1))):this.eq(10)?a=a.layeradd10(c,n):this.lt(1)?a=a.pow(1-c).mul(this.pow(a).pow(c)):a=a.layeradd(c,this,n));for(var f=0;f<t;++f){if(a=this.pow(a),!isFinite(a.layer)||!isFinite(a.mag))return a.normalize();if(a.layer-this.layer>3)return ve(a.sign,a.layer+(t-f-1),a.mag);if(f>1e4)return a}return a}},{key:"iteratedexp",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:2,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ve(1,0,1),n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return this.tetrate(t,a,n)}},{key:"iteratedlog",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(a<0)return e.tetrate(t,-a,this,n);t=q(t);var s=e.fromDecimal(this),o=a;a=Math.trunc(a);var i=o-a;if(s.layer-t.layer>3){var l=Math.min(a,s.layer-t.layer-3);a-=l,s.layer-=l}for(var p=0;p<a;++p){if(s=s.log(t),!isFinite(s.layer)||!isFinite(s.mag))return s.normalize();if(p>1e4)return s}return i>0&&i<1&&(t.eq(10)?s=s.layeradd10(-i,n):s=s.layeradd(-i,t,n)),s}},{key:"slog",value:function(){for(var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:100,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,s=.001,o=!1,i=!1,l=this.slog_internal(t,n).toNumber(),p=1;p<a;++p){var u=new e(t).tetrate(l,e.dOne,n),c=u.gt(this);if(p>1&&i!=c&&(o=!0),i=c,o?s/=2:s*=2,s=Math.abs(s)*(c?-1:1),l+=s,s===0)break}return e.fromNumber(l)}},{key:"slog_internal",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(t=q(t),t.lte(e.dZero))return new e(e.dNaN);if(t.eq(e.dOne))return new e(e.dNaN);if(t.lt(e.dOne))return this.eq(e.dOne)?ve(0,0,0):this.eq(e.dZero)?ve(-1,0,1):new e(e.dNaN);if(this.mag<0||this.eq(e.dZero))return ve(-1,0,1);if(t.lt(1.444667861009766)){var n=e.ln(t).neg(),s=n.lambertw().div(n);if(this.eq(s))return new e(e.dInf);if(this.gt(s))return new e(e.dNaN)}var o=0,i=e.fromDecimal(this);if(i.layer-t.layer>3){var l=i.layer-t.layer-3;o+=l,i.layer-=l}for(var p=0;p<100;++p)if(i.lt(e.dZero))i=e.pow(t,i),o-=1;else{if(i.lte(e.dOne))return a?e.fromNumber(o+i.toNumber()-1):e.fromNumber(o+e.slog_critical(t.toNumber(),i.toNumber()));o+=1,i=e.log(i,t)}return e.fromNumber(o)}},{key:"layeradd10",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t=e.fromValue_noAlloc(t).toNumber();var n=e.fromDecimal(this);if(t>=1){n.mag<0&&n.layer>0?(n.sign=0,n.mag=0,n.layer=0):n.sign===-1&&n.layer==0&&(n.sign=1,n.mag=-n.mag);var s=Math.trunc(t);t-=s,n.layer+=s}if(t<=-1){var o=Math.trunc(t);if(t-=o,n.layer+=o,n.layer<0)for(var i=0;i<100;++i){if(n.layer++,n.mag=Math.log10(n.mag),!isFinite(n.mag))return n.sign===0&&(n.sign=1),n.layer<0&&(n.layer=0),n.normalize();if(n.layer>=0)break}}for(;n.layer<0;)n.layer++,n.mag=Math.log10(n.mag);return n.sign===0&&(n.sign=1,n.mag===0&&n.layer>=1&&(n.layer-=1,n.mag=1)),n.normalize(),t!==0?n.layeradd(t,10,a):n}},{key:"layeradd",value:function(t,a){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,s=q(a);if(s.gt(1)&&s.lte(1.444667861009766)){var o=e.excess_slog(this,a,n),i=o[0].toNumber(),l=o[1],p=i+t,u=e.ln(a).neg(),c=u.lambertw().div(u),g=u.lambertw(!1).div(u),m=e.dOne;l==1?m=c.mul(g).sqrt():l==2&&(m=g.mul(2));var h=s.pow(m),f=Math.floor(p),v=p-f,S=m.pow(1-v).mul(h.pow(v));return e.tetrate(s,f,S,n)}var b=this.slog(a,100,n).toNumber(),T=b+t;return T>=0?e.tetrate(a,T,e.dOne,n):Number.isFinite(T)?T>=-1?e.log(e.tetrate(a,T+1,e.dOne,n),a):e.log(e.log(e.tetrate(a,T+2,e.dOne,n),a),a):new e(e.dNaN)}},{key:"lambertw",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this.lt(-.3678794411710499)?new e(e.dNaN):t?this.abs().lt("1e-300")?new e(this):this.mag<0?e.fromNumber(ps(this.toNumber())):this.layer===0?e.fromNumber(ps(this.sign*this.mag)):this.lt("eee15")?gi(this):this.ln():this.sign===1?new e(e.dNaN):this.layer===0?e.fromNumber(ps(this.sign*this.mag,1e-10,!1)):this.layer==1?gi(this,1e-10,!1):this.neg().recip().lambertw().neg()}},{key:"ssqrt",value:function(){return this.linear_sroot(2)}},{key:"linear_sroot",value:function(t){if(t==1)return this;if(this.eq(e.dInf))return new e(e.dInf);if(!this.isFinite())return new e(e.dNaN);if(t>0&&t<1)return this.root(t);if(t>-2&&t<-1)return e.fromNumber(t).add(2).pow(this.recip());if(t<=0)return new e(e.dNaN);if(t==Number.POSITIVE_INFINITY){var a=this.toNumber();return a<Math.E&&a>pu?this.pow(this.recip()):new e(e.dNaN)}if(this.eq(1))return ve(1,0,1);if(this.lt(0))return new e(e.dNaN);if(this.lte("1ee-16"))return t%2==1?new e(this):new e(e.dNaN);if(this.gt(1)){var n=e.dTen;this.gte(e.tetrate(10,t,1,!0))&&(n=this.iteratedlog(10,t-1,!0)),t<=1&&(n=this.root(t));for(var s=e.dZero,o=n.layer,i=n.iteratedlog(10,o,!0),l=i,p=i.div(2),u=!0;u;)p=s.add(i).div(2),e.iteratedexp(10,o,p,!0).tetrate(t,1,!0).gt(this)?i=p:s=p,p.eq(l)?u=!1:l=p;return e.iteratedexp(10,o,p,!0)}else{for(var c=1,g=fe(1,10,1),m=fe(1,10,1),h=fe(1,10,1),f=fe(1,1,-16),v=e.dZero,S=fe(1,10,1),b=f.pow10().recip(),T=e.dZero,w=b,$=b,R=Math.ceil(t)%2==0,x=0,y=fe(1,10,1),k=!1,C=e.dZero,I=!1;c<4;){if(c==2){if(R)break;h=fe(1,10,1),f=g,c=3,S=fe(1,10,1),y=fe(1,10,1)}for(k=!1;f.neq(h);){if(C=f,f.pow10().recip().tetrate(t,1,!0).eq(1)&&f.pow10().recip().lt(.4))b=f.pow10().recip(),w=f.pow10().recip(),$=f.pow10().recip(),T=e.dZero,x=-1,c==3&&(y=f);else if(f.pow10().recip().tetrate(t,1,!0).eq(f.pow10().recip())&&!R&&f.pow10().recip().lt(.4))b=f.pow10().recip(),w=f.pow10().recip(),$=f.pow10().recip(),T=e.dZero,x=0;else if(f.pow10().recip().tetrate(t,1,!0).eq(f.pow10().recip().mul(2).tetrate(t,1,!0)))b=f.pow10().recip(),w=e.dZero,$=b.mul(2),T=b,R?x=-1:x=0;else{for(v=f.mul(12e-17),b=f.pow10().recip(),w=f.add(v).pow10().recip(),T=b.sub(w),$=b.add(T);w.tetrate(t,1,!0).eq(b.tetrate(t,1,!0))||$.tetrate(t,1,!0).eq(b.tetrate(t,1,!0))||w.gte(b)||$.lte(b);)v=v.mul(2),w=f.add(v).pow10().recip(),T=b.sub(w),$=b.add(T);if((c==1&&$.tetrate(t,1,!0).gt(b.tetrate(t,1,!0))&&w.tetrate(t,1,!0).gt(b.tetrate(t,1,!0))||c==3&&$.tetrate(t,1,!0).lt(b.tetrate(t,1,!0))&&w.tetrate(t,1,!0).lt(b.tetrate(t,1,!0)))&&(y=f),$.tetrate(t,1,!0).lt(b.tetrate(t,1,!0)))x=-1;else if(R)x=1;else if(c==3&&f.gt_tolerance(g,1e-8))x=0;else{for(;w.tetrate(t,1,!0).eq_tolerance(b.tetrate(t,1,!0),1e-8)||$.tetrate(t,1,!0).eq_tolerance(b.tetrate(t,1,!0),1e-8)||w.gte(b)||$.lte(b);)v=v.mul(2),w=f.add(v).pow10().recip(),T=b.sub(w),$=b.add(T);$.tetrate(t,1,!0).sub(b.tetrate(t,1,!0)).lt(b.tetrate(t,1,!0).sub(w.tetrate(t,1,!0)))?x=0:x=1}}if(x==-1&&(I=!0),c==1&&x==1||c==3&&x!=0)if(h.eq(fe(1,10,1)))f=f.mul(2);else{var _=!1;if(k&&(x==1&&c==1||x==-1&&c==3)&&(_=!0),f=f.add(h).div(2),_)break}else if(h.eq(fe(1,10,1)))h=f,f=f.div(2);else{var A=!1;if(k&&(x==1&&c==1||x==-1&&c==3)&&(A=!0),h=h.sub(S),f=f.sub(S),A)break}if(h.sub(f).div(2).abs().gt(S.mul(1.5))&&(k=!0),S=h.sub(f).div(2).abs(),f.gt("1e18")||f.eq(C))break}if(f.gt("1e18")||!I||y==fe(1,10,1))break;c==1?g=y:c==3&&(m=y),c++}h=g,f=fe(1,1,-18);for(var F=f,E=e.dZero,P=!0;P;)if(h.eq(fe(1,10,1))?E=f.mul(2):E=h.add(f).div(2),e.pow(10,E).recip().tetrate(t,1,!0).gt(this)?f=E:h=E,E.eq(F)?P=!1:F=E,f.gt("1e18"))return new e(e.dNaN);if(E.eq_tolerance(g,1e-15)){if(m.eq(fe(1,10,1)))return new e(e.dNaN);for(h=fe(1,10,1),f=m,F=f,E=e.dZero,P=!0;P;)if(h.eq(fe(1,10,1))?E=f.mul(2):E=h.add(f).div(2),e.pow(10,E).recip().tetrate(t,1,!0).gt(this)?f=E:h=E,E.eq(F)?P=!1:F=E,f.gt("1e18"))return new e(e.dNaN);return E.pow10().recip()}else return E.pow10().recip()}}},{key:"pentate",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:2,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ve(1,0,1),n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;a=new e(a);var s=t;t=Math.floor(t);var o=s-t,i=e.dZero,l=e.dZero;if(o!==0)if(a.eq(e.dOne))++t,a=e.fromNumber(o);else return this.pentate(a.penta_log(this,void 0,n).plus(s).toNumber(),1,n);if(t>0)for(var p=0;p<t;){if(l=i,i=a,a=this.tetrate(a.toNumber(),e.dOne,n),++p,this.gt(0)&&this.lte(1)&&a.gt(0)&&a.lte(1))return this.tetrate(t-p,a,n);if(a.eq(i)||a.eq(l)&&p%2==t%2||!isFinite(a.layer)||!isFinite(a.mag))return a.normalize();if(p>1e4)return a}else for(var u=0;u<-t;++u){if(i=a,a=a.slog(this,void 0,n),a.eq(i)||!isFinite(a.layer)||!isFinite(a.mag))return a.normalize();if(u>100)return a}return a}},{key:"penta_log",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:10,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:100,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(t=new e(t),t.lte(1))return new e(e.dNaN);if(this.eq(1))return ve(0,0,0);if(this.eq(e.dInf))return new e(e.dInf);var s=new e(1),o=0,i=1;if(this.lt(-1)){if(this.lte(-2))return new e(e.dNaN);var l=t.tetrate(this.toNumber(),1,n);if(this.eq(l))return new e(e.dNegInf);if(this.gt(l))return new e(e.dNaN)}if(this.gt(1)){for(;s.lt(this);)if(o++,s=e.tetrate(t,s.toNumber(),1,n),o>1e3)return new e(e.dNaN)}else for(;s.gt(this);)if(o--,s=e.slog(s,t,n),o>100)return new e(e.dNaN);for(var p=1;p<a;++p){var u=t.pentate(o,e.dOne,n);if(u.eq(this))break;var c=u.gt(this);if(i=Math.abs(i)*(c?-1:1),o+=i,i/=2,i===0)break}return e.fromNumber(o)}},{key:"linear_penta_root",value:function(t){return t==1?this:t<0?new e(e.dNaN):this.eq(e.dInf)?new e(e.dInf):this.isFinite()?t>0&&t<1?this.root(t):this.eq(1)?ve(1,0,1):this.lt(0)?new e(e.dNaN):this.lt(1)?this.linear_sroot(t):e.increasingInverse(function(a){return e.pentate(a,t,1,!0)})(this):new e(e.dNaN)}},{key:"sin",value:function(){return this.mag<0?new e(this):this.layer===0?e.fromNumber(Math.sin(this.sign*this.mag)):ve(0,0,0)}},{key:"cos",value:function(){return this.mag<0?ve(1,0,1):this.layer===0?e.fromNumber(Math.cos(this.sign*this.mag)):ve(0,0,0)}},{key:"tan",value:function(){return this.mag<0?new e(this):this.layer===0?e.fromNumber(Math.tan(this.sign*this.mag)):ve(0,0,0)}},{key:"asin",value:function(){return this.mag<0?new e(this):this.layer===0?e.fromNumber(Math.asin(this.sign*this.mag)):new e(e.dNaN)}},{key:"acos",value:function(){return this.mag<0?e.fromNumber(Math.acos(this.toNumber())):this.layer===0?e.fromNumber(Math.acos(this.sign*this.mag)):new e(e.dNaN)}},{key:"atan",value:function(){return this.mag<0?new e(this):this.layer===0?e.fromNumber(Math.atan(this.sign*this.mag)):e.fromNumber(Math.atan(this.sign*(1/0)))}},{key:"sinh",value:function(){return this.exp().sub(this.negate().exp()).div(2)}},{key:"cosh",value:function(){return this.exp().add(this.negate().exp()).div(2)}},{key:"tanh",value:function(){return this.sinh().div(this.cosh())}},{key:"asinh",value:function(){return e.ln(this.add(this.sqr().add(1).sqrt()))}},{key:"acosh",value:function(){return e.ln(this.add(this.sqr().sub(1).sqrt()))}},{key:"atanh",value:function(){return this.abs().gte(1)?new e(e.dNaN):e.ln(this.add(1).div(e.fromNumber(1).sub(this))).div(2)}},{key:"ascensionPenalty",value:function(t){return t===0?new e(this):this.root(e.pow(10,t))}},{key:"egg",value:function(){return this.add(9)}},{key:"lessThanOrEqualTo",value:function(t){return this.cmp(t)<1}},{key:"lessThan",value:function(t){return this.cmp(t)<0}},{key:"greaterThanOrEqualTo",value:function(t){return this.cmp(t)>-1}},{key:"greaterThan",value:function(t){return this.cmp(t)>0}}],[{key:"fromComponents",value:function(t,a,n){return new e().fromComponents(t,a,n)}},{key:"fromComponents_noNormalize",value:function(t,a,n){return new e().fromComponents_noNormalize(t,a,n)}},{key:"fromMantissaExponent",value:function(t,a){return new e().fromMantissaExponent(t,a)}},{key:"fromMantissaExponent_noNormalize",value:function(t,a){return new e().fromMantissaExponent_noNormalize(t,a)}},{key:"fromDecimal",value:function(t){return new e().fromDecimal(t)}},{key:"fromNumber",value:function(t){return new e().fromNumber(t)}},{key:"fromString",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return new e().fromString(t,a)}},{key:"fromValue",value:function(t){return new e().fromValue(t)}},{key:"fromValue_noAlloc",value:function(t){if(t instanceof e)return t;if(typeof t=="string"){var a=e.fromStringCache.get(t);return a!==void 0?a:e.fromString(t)}else return typeof t=="number"?e.fromNumber(t):ve(0,0,0)}},{key:"abs",value:function(t){return q(t).abs()}},{key:"neg",value:function(t){return q(t).neg()}},{key:"negate",value:function(t){return q(t).neg()}},{key:"negated",value:function(t){return q(t).neg()}},{key:"sign",value:function(t){return q(t).sign}},{key:"sgn",value:function(t){return q(t).sign}},{key:"round",value:function(t){return q(t).round()}},{key:"floor",value:function(t){return q(t).floor()}},{key:"ceil",value:function(t){return q(t).ceil()}},{key:"trunc",value:function(t){return q(t).trunc()}},{key:"add",value:function(t,a){return q(t).add(a)}},{key:"plus",value:function(t,a){return q(t).add(a)}},{key:"sub",value:function(t,a){return q(t).sub(a)}},{key:"subtract",value:function(t,a){return q(t).sub(a)}},{key:"minus",value:function(t,a){return q(t).sub(a)}},{key:"mul",value:function(t,a){return q(t).mul(a)}},{key:"multiply",value:function(t,a){return q(t).mul(a)}},{key:"times",value:function(t,a){return q(t).mul(a)}},{key:"div",value:function(t,a){return q(t).div(a)}},{key:"divide",value:function(t,a){return q(t).div(a)}},{key:"recip",value:function(t){return q(t).recip()}},{key:"reciprocal",value:function(t){return q(t).recip()}},{key:"reciprocate",value:function(t){return q(t).reciprocate()}},{key:"mod",value:function(t,a){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return q(t).mod(a,n)}},{key:"modulo",value:function(t,a){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return q(t).modulo(a,n)}},{key:"modular",value:function(t,a){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return q(t).modular(a,n)}},{key:"cmp",value:function(t,a){return q(t).cmp(a)}},{key:"cmpabs",value:function(t,a){return q(t).cmpabs(a)}},{key:"compare",value:function(t,a){return q(t).cmp(a)}},{key:"isNaN",value:(function(r){function t(a){return r.apply(this,arguments)}return t.toString=function(){return r.toString()},t})(function(r){return r=q(r),isNaN(r.sign)||isNaN(r.layer)||isNaN(r.mag)})},{key:"isFinite",value:(function(r){function t(a){return r.apply(this,arguments)}return t.toString=function(){return r.toString()},t})(function(r){return r=q(r),isFinite(r.sign)&&isFinite(r.layer)&&isFinite(r.mag)})},{key:"eq",value:function(t,a){return q(t).eq(a)}},{key:"equals",value:function(t,a){return q(t).eq(a)}},{key:"neq",value:function(t,a){return q(t).neq(a)}},{key:"notEquals",value:function(t,a){return q(t).notEquals(a)}},{key:"lt",value:function(t,a){return q(t).lt(a)}},{key:"lte",value:function(t,a){return q(t).lte(a)}},{key:"gt",value:function(t,a){return q(t).gt(a)}},{key:"gte",value:function(t,a){return q(t).gte(a)}},{key:"max",value:function(t,a){return q(t).max(a)}},{key:"min",value:function(t,a){return q(t).min(a)}},{key:"minabs",value:function(t,a){return q(t).minabs(a)}},{key:"maxabs",value:function(t,a){return q(t).maxabs(a)}},{key:"clamp",value:function(t,a,n){return q(t).clamp(a,n)}},{key:"clampMin",value:function(t,a){return q(t).clampMin(a)}},{key:"clampMax",value:function(t,a){return q(t).clampMax(a)}},{key:"cmp_tolerance",value:function(t,a,n){return q(t).cmp_tolerance(a,n)}},{key:"compare_tolerance",value:function(t,a,n){return q(t).cmp_tolerance(a,n)}},{key:"eq_tolerance",value:function(t,a,n){return q(t).eq_tolerance(a,n)}},{key:"equals_tolerance",value:function(t,a,n){return q(t).eq_tolerance(a,n)}},{key:"neq_tolerance",value:function(t,a,n){return q(t).neq_tolerance(a,n)}},{key:"notEquals_tolerance",value:function(t,a,n){return q(t).notEquals_tolerance(a,n)}},{key:"lt_tolerance",value:function(t,a,n){return q(t).lt_tolerance(a,n)}},{key:"lte_tolerance",value:function(t,a,n){return q(t).lte_tolerance(a,n)}},{key:"gt_tolerance",value:function(t,a,n){return q(t).gt_tolerance(a,n)}},{key:"gte_tolerance",value:function(t,a,n){return q(t).gte_tolerance(a,n)}},{key:"pLog10",value:function(t){return q(t).pLog10()}},{key:"absLog10",value:function(t){return q(t).absLog10()}},{key:"log10",value:function(t){return q(t).log10()}},{key:"log",value:function(t,a){return q(t).log(a)}},{key:"log2",value:function(t){return q(t).log2()}},{key:"ln",value:function(t){return q(t).ln()}},{key:"logarithm",value:function(t,a){return q(t).logarithm(a)}},{key:"pow",value:function(t,a){return q(t).pow(a)}},{key:"pow10",value:function(t){return q(t).pow10()}},{key:"root",value:function(t,a){return q(t).root(a)}},{key:"factorial",value:function(t,a){return q(t).factorial()}},{key:"gamma",value:function(t,a){return q(t).gamma()}},{key:"lngamma",value:function(t,a){return q(t).lngamma()}},{key:"exp",value:function(t){return q(t).exp()}},{key:"sqr",value:function(t){return q(t).sqr()}},{key:"sqrt",value:function(t){return q(t).sqrt()}},{key:"cube",value:function(t){return q(t).cube()}},{key:"cbrt",value:function(t){return q(t).cbrt()}},{key:"tetrate",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:2,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ve(1,0,1),s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return q(t).tetrate(a,n,s)}},{key:"iteratedexp",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:2,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ve(1,0,1),s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return q(t).iteratedexp(a,n,s)}},{key:"iteratedlog",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:10,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return q(t).iteratedlog(a,n,s)}},{key:"layeradd10",value:function(t,a){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return q(t).layeradd10(a,n)}},{key:"layeradd",value:function(t,a){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:10,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return q(t).layeradd(a,n,s)}},{key:"slog",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:10,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return q(t).slog(a,100,n)}},{key:"lambertw",value:function(t,a){return q(t).lambertw(a)}},{key:"ssqrt",value:function(t){return q(t).ssqrt()}},{key:"linear_sroot",value:function(t,a){return q(t).linear_sroot(a)}},{key:"pentate",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:2,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ve(1,0,1),s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return q(t).pentate(a,n,s)}},{key:"penta_log",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:10,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return q(t).penta_log(a,100,n)}},{key:"linear_penta_root",value:function(t,a){return q(t).linear_penta_root(a)}},{key:"sin",value:function(t){return q(t).sin()}},{key:"cos",value:function(t){return q(t).cos()}},{key:"tan",value:function(t){return q(t).tan()}},{key:"asin",value:function(t){return q(t).asin()}},{key:"acos",value:function(t){return q(t).acos()}},{key:"atan",value:function(t){return q(t).atan()}},{key:"sinh",value:function(t){return q(t).sinh()}},{key:"cosh",value:function(t){return q(t).cosh()}},{key:"tanh",value:function(t){return q(t).tanh()}},{key:"asinh",value:function(t){return q(t).asinh()}},{key:"acosh",value:function(t){return q(t).acosh()}},{key:"atanh",value:function(t){return q(t).atanh()}},{key:"affordGeometricSeries",value:function(t,a,n,s){return this.affordGeometricSeries_core(q(t),q(a),q(n),s)}},{key:"sumGeometricSeries",value:function(t,a,n,s){return this.sumGeometricSeries_core(t,q(a),q(n),s)}},{key:"affordArithmeticSeries",value:function(t,a,n,s){return this.affordArithmeticSeries_core(q(t),q(a),q(n),q(s))}},{key:"sumArithmeticSeries",value:function(t,a,n,s){return this.sumArithmeticSeries_core(q(t),q(a),q(n),q(s))}},{key:"efficiencyOfPurchase",value:function(t,a,n){return this.efficiencyOfPurchase_core(q(t),q(a),q(n))}},{key:"randomDecimalForTesting",value:function(t){if(Math.random()*20<1)return ve(0,0,0);var a=Math.random()>.5?1:-1;if(Math.random()*20<1)return ve(a,0,1);var n=Math.floor(Math.random()*(t+1)),s=n===0?Math.random()*616-308:Math.random()*16;Math.random()>.9&&(s=Math.trunc(s));var o=Math.pow(10,s);return Math.random()>.9&&(o=Math.trunc(o)),fe(a,n,o)}},{key:"affordGeometricSeries_core",value:function(t,a,n,s){var o=a.mul(n.pow(s));return e.floor(t.div(o).mul(n.sub(1)).add(1).log10().div(n.log10()))}},{key:"sumGeometricSeries_core",value:function(t,a,n,s){return a.mul(n.pow(s)).mul(e.sub(1,n.pow(t))).div(e.sub(1,n))}},{key:"affordArithmeticSeries_core",value:function(t,a,n,s){var o=a.add(s.mul(n)),i=o.sub(n.div(2)),l=i.pow(2);return i.neg().add(l.add(n.mul(t).mul(2)).sqrt()).div(n).floor()}},{key:"sumArithmeticSeries_core",value:function(t,a,n,s){var o=a.add(s.mul(n));return t.div(2).mul(o.mul(2).plus(t.sub(1).mul(n)))}},{key:"efficiencyOfPurchase_core",value:function(t,a,n){return t.div(a).add(t.div(n))}},{key:"slog_critical",value:function(t,a){return t>10?a-1:e.critical_section(t,a,du)}},{key:"tetrate_critical",value:function(t,a){return e.critical_section(t,a,uu)}},{key:"critical_section",value:function(t,a,n){a*=10,a<0&&(a=0),a>10&&(a=10),t<2&&(t=2),t>10&&(t=10);for(var s=0,o=0,i=0;i<hr.length;++i)if(hr[i]==t){s=n[i][Math.floor(a)],o=n[i][Math.ceil(a)];break}else if(hr[i]<t&&hr[i+1]>t){var l=(t-hr[i])/(hr[i+1]-hr[i]);s=n[i][Math.floor(a)]*(1-l)+n[i+1][Math.floor(a)]*l,o=n[i][Math.ceil(a)]*(1-l)+n[i+1][Math.ceil(a)]*l;break}var p=a-Math.floor(a);return s<=0||o<=0?s*(1-p)+o*p:Math.pow(t,Math.log(s)/Math.log(t)*(1-p)+Math.log(o)/Math.log(t)*p)}},{key:"excess_slog",value:function(t,a){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;t=q(t),a=q(a);var s=a;if(a=a.toNumber(),a==1||a<=0)return[new e(e.dNaN),0];if(a>1.444667861009766)return[t.slog(a,100,n),0];var o=e.ln(a).neg(),i=o.lambertw().div(o),l=e.dInf;if(a>1&&(l=o.lambertw(!1).div(o)),a>1.444667861009099&&(i=l=e.fromNumber(Math.E)),t.lt(i))return[t.slog(a,100,n),0];if(t.eq(i))return[new e(e.dInf),0];if(t.eq(l))return[new e(e.dNegInf),2];if(t.gt(l)){var p=l.mul(2),u=s.pow(p),c=0;if(t.gte(p)&&t.lt(u))c=0;else if(t.gte(u)){var g=u;for(c=1;g.lt(t);)if(g=s.pow(g),c=c+1,g.layer>3){var m=Math.floor(t.layer-g.layer+1);g=s.iteratedexp(m,g,n),c=c+m}g.gt(t)&&(g=g.log(a),c=c-1)}else if(t.lt(p)){var h=p;for(c=0;h.gt(t);)h=h.log(a),c=c-1}for(var f=0,v=0,S=.5,b=p,T=e.dZero;S>1e-16;){if(v=f+S,b=p.pow(1-v).mul(u.pow(v)),T=e.iteratedexp(a,c,b),T.eq(t))return[new e(c+v),2];T.lt(t)&&(f+=S),S/=2}return T.neq_tolerance(t,1e-7)?[new e(e.dNaN),0]:[new e(c+f),2]}if(t.lt(l)&&t.gt(i)){var w=i.mul(l).sqrt(),$=s.pow(w),R=0;if(t.lte(w)&&t.gt($))R=0;else if(t.lte($)){var x=$;for(R=1;x.gt(t);)x=s.pow(x),R=R+1;x.lt(t)&&(x=x.log(a),R=R-1)}else if(t.gt(w)){var y=w;for(R=0;y.lt(t);)y=y.log(a),R=R-1}for(var k=0,C=0,I=.5,_=w,A=e.dZero;I>1e-16;){if(C=k+I,_=w.pow(1-C).mul($.pow(C)),A=e.iteratedexp(a,R,_),A.eq(t))return[new e(R+C),1];A.gt(t)&&(k+=I),I/=2}return A.neq_tolerance(t,1e-7)?[new e(e.dNaN),0]:[new e(R+k),1]}throw new Error("Unhandled behavior in excess_slog")}},{key:"increasingInverse",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:120,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:e.dLayerMax.neg(),o=arguments.length>4&&arguments[4]!==void 0?arguments[4]:e.dLayerMax,i=arguments.length>5&&arguments[5]!==void 0?arguments[5]:e.dLayerMax.neg(),l=arguments.length>6&&arguments[6]!==void 0?arguments[6]:e.dLayerMax;return function(p){if(p=new e(p),s=new e(s),o=new e(o),i=new e(i),l=new e(l),p.isNan()||o.lt(s)||p.lt(i)||p.gt(l))return new e(e.dNaN);var u=function(re){return new e(re)},c=!0;if(o.lt(0))c=!1;else if(s.gt(0))c=!0;else{var g=t(e.dZero);if(g.eq(p))return ve(0,0,0);c=p.gt(g),a&&(c=!c)}var m=c,h;if(c){if(o.lt(gr))c=!0;else if(s.gt(gr))c=!1;else{var f=t(new e(gr));c=p.lt(f),a&&(c=!c)}if(c){h=!0;var v=e.pow(10,rt).recip();if(o.lt(v))c=!1;else if(s.gt(v))c=!0;else{var S=t(new e(v));c=p.gt(S),a&&(c=!c)}if(c)u=function(re){return e.pow(10,re).recip()};else{var b=e.tetrate(10,rt);if(o.lt(b))c=!1;else if(s.gt(b))c=!0;else{var T=t(new e(b));c=p.gt(T),a&&(c=!c)}c?u=function(re){return e.tetrate(10,new e(re).toNumber()).recip()}:u=function(re){return new e(re).gt(Math.log10(Number.MAX_VALUE))?e.dZero:e.tetrate(10,e.pow(10,re).toNumber()).recip()}}}else{if(h=!1,o.lt(rt))c=!0;else if(s.gt(rt))c=!1;else{var w=t(new e(rt));c=p.lt(w),a&&(c=!c)}if(c)u=function(re){return new e(re)};else{var $=e.pow(10,rt);if(o.lt($))c=!0;else if(s.gt($))c=!1;else{var R=t(new e($));c=p.lt(R),a&&(c=!c)}if(c)u=function(re){return e.pow(10,re)};else{var x=e.tetrate(10,rt);if(o.lt(x))c=!0;else if(s.gt(x))c=!1;else{var y=t(new e(x));c=p.lt(y),a&&(c=!c)}c?u=function(re){return e.tetrate(10,new e(re).toNumber())}:u=function(re){return new e(re).gt(Math.log10(Number.MAX_VALUE))?e.dInf:e.tetrate(10,e.pow(10,re).toNumber())}}}}}else{if(h=!0,o.lt(-gr))c=!1;else if(s.gt(-gr))c=!0;else{var k=t(new e(-gr));c=p.gt(k),a&&(c=!c)}if(c){var C=e.pow(10,rt).recip().neg();if(o.lt(C))c=!0;else if(s.gt(C))c=!1;else{var I=t(new e(C));c=p.lt(I),a&&(c=!c)}if(c)u=function(re){return e.pow(10,re).recip().neg()};else{var _=e.tetrate(10,rt).neg();if(o.lt(_))c=!0;else if(s.gt(_))c=!1;else{var A=t(new e(_));c=p.lt(A),a&&(c=!c)}c?u=function(re){return e.tetrate(10,new e(re).toNumber()).recip().neg()}:u=function(re){return new e(re).gt(Math.log10(Number.MAX_VALUE))?e.dZero:e.tetrate(10,e.pow(10,re).toNumber()).recip().neg()}}}else{if(h=!1,o.lt(-rt))c=!1;else if(s.gt(-rt))c=!0;else{var F=t(new e(-rt));c=p.gt(F),a&&(c=!c)}if(c)u=function(re){return e.neg(re)};else{var E=e.pow(10,rt).neg();if(o.lt(E))c=!1;else if(s.gt(E))c=!0;else{var P=t(new e(E));c=p.gt(P),a&&(c=!c)}if(c)u=function(re){return e.pow(10,re).neg()};else{var V=e.tetrate(10,rt).neg();if(o.lt(V))c=!1;else if(s.gt(V))c=!0;else{var j=t(new e(V));c=p.gt(j),a&&(c=!c)}c?u=function(re){return e.tetrate(10,new e(re).toNumber()).neg()}:u=function(re){return new e(re).gt(Math.log10(Number.MAX_VALUE))?e.dNegInf:e.tetrate(10,e.pow(10,re).toNumber()).neg()}}}}}for(var B=m!=h!=a,Z=B?function(ie,re){return e.gt(ie,re)}:function(ie,re){return e.lt(ie,re)},oe=.001,U=!1,O=!1,K=1,se=e.dOne,be=0,G=!1,L=1;L<n;++L){G=!1,be=K,se=u(K),se.gt(o)&&(se=o,G=!0),se.lt(s)&&(se=s,G=!0);var Y=t(se);if(Y.eq(p)&&!G)break;var X=Z(Y,p);if(L>1&&O!=X&&(U=!0),O=X,U?oe/=2:oe*=2,X!=B&&se.eq(o)||X==B&&se.eq(s))return new e(e.dNaN);if(oe=Math.abs(oe)*(X?-1:1),K+=oe,oe===0||be==K)break}return u(K)}}}]),e})();d.dZero=ve(0,0,0);d.dOne=ve(1,0,1);d.dNegOne=ve(-1,0,1);d.dTwo=ve(1,0,2);d.dTen=ve(1,0,10);d.dNaN=ve(Number.NaN,Number.NaN,Number.NaN);d.dInf=ve(1,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);d.dNegInf=ve(-1,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);d.dNumberMax=fe(1,0,Number.MAX_VALUE);d.dNumberMin=fe(1,0,Number.MIN_VALUE);d.dLayerSafeMax=fe(1,Number.MAX_SAFE_INTEGER,rt-1);d.dLayerSafeMin=fe(1,Number.MAX_SAFE_INTEGER,-8999999999999999);d.dLayerMax=fe(1,Number.MAX_VALUE,rt-1);d.dLayerMin=fe(1,Number.MAX_VALUE,-8999999999999999);d.fromStringCache=new au(lu);q=d.fromValue_noAlloc;fe=d.fromComponents;ve=d.fromComponents_noNormalize;d.fromMantissaExponent;d.fromMantissaExponent_noNormalize;const mt=e=>e instanceof d?e:new d(e),ue=new d(0),Sa=new d(1),ot=e=>e.toNumber(),Xa=(e,r,t)=>a=>{if(a<=0)return Sa;const n=Math.min(a,e);return new d(1+Math.pow(n,r)*t)},H=e=>`${e.replace(/^\//,"./")}`,Ze={1:{tier:1,name:"T1 Mana Gem",icon:H("icons/t1 gem.png"),effect:{type:"flat",value:new d(.1)},recipe:[{type:"mana",amount:new d(0)}],craftTime:1,visibleByDefault:!0},2:{tier:2,name:"T2 Mana Gem",icon:H("icons/t2 gem.png"),effect:{type:"multiplier",value:new d(2)},recipe:[{type:"gem",tier:1,amount:new d(10)}],craftTime:2,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:1,amount:100}},3:{tier:3,name:"T3 Mana Gem",icon:H("icons/t3 gem.png"),effect:{type:"multiplier",value:new d(2)},recipe:[{type:"gem",tier:2,amount:new d(50)}],craftTime:4,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:2,amount:500}},4:{tier:4,name:"T4 Mana Gem",icon:H("icons/t4 gem.png"),effect:{type:"multiplier",value:new d(3)},recipe:[{type:"gem",tier:3,amount:new d(200)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:3,amount:2e3}},5:{tier:5,name:"T5 Mana Gem",icon:H("icons/t5 gem.png"),effect:{type:"multiplier",value:new d(4)},recipe:[{type:"gem",tier:4,amount:new d(500)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:4,amount:5e3}},6:{tier:6,name:"T6 Mana Gem",icon:H("icons/t6 gem.png"),effect:{type:"multiplier",value:new d(5)},recipe:[{type:"gem",tier:5,amount:new d(1e3)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:5,amount:1e4}},7:{tier:7,name:"T7 Mana Gem",icon:H("icons/t7 gem.png"),effect:{type:"multiplier",value:new d(10)},recipe:[{type:"gem",tier:6,amount:new d(2500)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:6,amount:25e3}},8:{tier:8,name:"T8 Mana Gem",icon:H("icons/t8 gem.png"),effect:{type:"multiplier",value:new d(20)},recipe:[{type:"gem",tier:7,amount:new d(1e4)}],craftTime:10,visibleByDefault:!1,unlockRequirement:{type:"craft",tier:7,amount:1e5}}},gt=[1,2,3,4,5,6,7,8],ea={1:{tier:1,name:"T1 Flask",icon:H("icons/t1 flask.png"),recipe:[{type:"gem",tier:1,amount:new d(10)}],craftTime:5},2:{tier:2,name:"T2 Flask",icon:H("icons/t2 flask.png"),recipe:[{type:"gem",tier:2,amount:new d(20)}],craftTime:10},3:{tier:3,name:"T3 Flask",icon:H("icons/t3 flask.png"),recipe:[{type:"gem",tier:3,amount:new d(30)}],craftTime:15},4:{tier:4,name:"T4 Flask",icon:H("icons/t4 flask.png"),recipe:[{type:"gem",tier:4,amount:new d(40)}],craftTime:20},5:{tier:5,name:"T5 Flask",icon:H("icons/t5 flask.png"),recipe:[{type:"gem",tier:5,amount:new d(50)}],craftTime:25},6:{tier:6,name:"T6 Flask",icon:H("icons/t6 flask.png"),recipe:[{type:"gem",tier:6,amount:new d(60)}],craftTime:30},7:{tier:7,name:"T7 Flask",icon:H("icons/t7 flask.png"),recipe:[{type:"gem",tier:7,amount:new d(70)}],craftTime:35},8:{tier:8,name:"T8 Flask",icon:H("icons/t8 flask.png"),recipe:[{type:"gem",tier:8,amount:new d(80)}],craftTime:40}},Mt=[1,2,3,4,5,6,7,8],fu={manaModifier:void 0,craftTimeMultiplier:1,flaskRecipeMultiplier:1,sacrificeCap:2e4,sacrificeBatchSize:1,calculateSacrificeBonus:Xa(2e4,.4,.1)},gu={t1_knight:{id:"t1_knight",name:"T1 Knight",icon:H("icons/t1 knight.png"),recipe:[{type:"gem",tier:1,amount:new d(100)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:1,amount:1e4},unitRole:"strength",strengthMultiplier:1,strengthExponent:.8},t4_knight:{id:"t4_knight",name:"T4 Knight",icon:H("icons/t4 knight.png"),recipe:[{type:"gem",tier:4,amount:new d(1e3)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:4,amount:1e5},unitRole:"strength",strengthMultiplier:20,strengthExponent:.8},t7_knight:{id:"t7_knight",name:"T7 Knight",icon:H("icons/t7 knight.png"),recipe:[{type:"gem",tier:7,amount:new d(1e4)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:7,amount:1e6},unitRole:"strength",strengthMultiplier:400,strengthExponent:.8},t2_boat:{id:"t2_boat",name:"T2 Boat",icon:H("icons/t2 boat.png"),recipe:[{type:"gem",tier:2,amount:new d(500)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:2,amount:5e4},unitRole:"speed",strengthMultiplier:1,strengthExponent:.6},t5_boat:{id:"t5_boat",name:"T5 Boat",icon:H("icons/t5 boat.png"),recipe:[{type:"gem",tier:5,amount:new d(5e3)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:5,amount:5e5},unitRole:"speed",strengthMultiplier:5,strengthExponent:.6},t3_beacon:{id:"t3_beacon",name:"T3 Beacon",icon:H("icons/t3 beacon.png"),recipe:[{type:"gem",tier:3,amount:new d(1e3)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:3,amount:1e5},unitRole:"taunt",strengthMultiplier:1,strengthExponent:.6},t6_beacon:{id:"t6_beacon",name:"T6 Beacon",icon:H("icons/t6 beacon.png"),recipe:[{type:"gem",tier:6,amount:new d(1e4)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:6,amount:1e6},unitRole:"taunt",strengthMultiplier:10,strengthExponent:.6}},hu=["t1_knight","t2_boat","t3_beacon","t4_knight","t5_boat","t6_beacon","t7_knight"],Bs=1,vu=.1,bu=5,xu=(e,r)=>1,yu=[{id:"shard_1",name:"Shard 1",difficulty:5,duration:60,rewards:{artifactShards:1},group:"Shards"},{id:"shard_2",name:"Shard 2",difficulty:1e3,duration:3600,rewards:{artifactShards:150},group:"Shards",unlockRequirement:"shard_1"},{id:"nullstone_1",name:"Ancient Ruins",difficulty:5e4,duration:10800,rewards:{nullstone:1},group:"Nullstones",unlockRequirement:"shard_2"},{id:"shard_3",name:"Shard 3",difficulty:5e5,duration:21600,rewards:{artifactShards:1e5},group:"Shards",unlockRequirement:"shard_2"},{id:"shard_4",name:"Shard 4",difficulty:1e8,duration:21600,rewards:{artifactShards:1e6},group:"Shards",unlockRequirement:"shard_3"},{id:"heroic_shard_affinity",name:"Shard Affinity",duration:1800,rewards:{},group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:5e5,difficultyScaling:2.4,rewardType:"shard_drops",rewardScaling:1.1}},{id:"heroic_prime_mastery",name:"Prime Realm Mastery",duration:1800,rewards:{},group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:5e5,difficultyScaling:2.4,rewardType:"realm1_output",rewardScaling:1.1}},{id:"heroic_war_mastery",name:"Realm of War Mastery",duration:1800,rewards:{},group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:5e5,difficultyScaling:2.4,rewardType:"realm2_output",rewardScaling:1.1}},{id:"heroic_creatures",name:"Heroic Creatures",duration:1800,rewards:{},group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:1e11,difficultyScaling:5,rewardType:"creature_production",rewardScaling:1.1}}],$t=["t1_ring","t2_ring","t3_ring","t4_ring","t5_ring","t6_ring","t7_ring","t8_ring","combat_artifact","crafting_speed","army_banner","breeding_artifact","knight_duplication"],Be={t1_ring:{id:"t1_ring",type:"ring",tier:1,name:"T1 Ring",icon:H("icons/t1 ring.png"),description:"Amplifies T1 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:40,cost:{artifactShards:new d(10),mythicFragments:new d(0),gems:new d(0)}},t2_ring:{id:"t2_ring",type:"ring",tier:2,name:"T2 Ring",icon:H("icons/t2 ring.png"),description:"Amplifies T2 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:40,cost:{artifactShards:new d(50),mythicFragments:new d(0),gems:new d(0)}},t3_ring:{id:"t3_ring",type:"ring",tier:3,name:"T3 Ring",icon:H("icons/t3 ring.png"),description:"Amplifies T3 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:40,cost:{artifactShards:new d(500),mythicFragments:new d(0),gems:new d(0)}},t4_ring:{id:"t4_ring",type:"ring",tier:4,name:"T4 Ring",icon:H("icons/t4 ring.png"),description:"Amplifies T4 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:40,cost:{artifactShards:new d(1e4),mythicFragments:new d(0),gems:new d(0)}},t5_ring:{id:"t5_ring",type:"ring",tier:5,name:"T5 Ring",icon:H("icons/t5 ring.png"),description:"Amplifies T5 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:40,cost:{artifactShards:new d(1e5),mythicFragments:new d(0),gems:new d(0)}},t6_ring:{id:"t6_ring",type:"ring",tier:6,name:"T6 Ring",icon:H("icons/t6 ring.png"),description:"Amplifies T6 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:40,cost:{artifactShards:new d(1e6),mythicFragments:new d(0),gems:new d(0)}},t7_ring:{id:"t7_ring",type:"ring",tier:7,name:"T7 Ring",icon:H("icons/t7 ring.png"),description:"Amplifies T7 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:40,cost:{artifactShards:new d(1e7),mythicFragments:new d(0),gems:new d(0)}},t8_ring:{id:"t8_ring",type:"ring",tier:8,name:"T8 Ring",icon:H("icons/t8 ring.png"),description:"Amplifies T8 gem production (x1.3 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.35,costScaling:3,maxLevel:40,cost:{artifactShards:new d(1e8),mythicFragments:new d(0),gems:new d(0)}},combat_artifact:{id:"combat_artifact",type:"combat",tier:0,name:"Combat Artifact",icon:H("icons/combat artifact.png"),description:"Increases combat strength (x1.1 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.1,costScaling:3,maxLevel:40,cost:{artifactShards:new d(50),mythicFragments:new d(0),gems:new d(0)}},crafting_speed:{id:"crafting_speed",type:"crafting_speed",tier:0,name:"Crafting Speed",icon:H("icons/crafting speed.png"),description:"Increases crafting speed (+5% per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.05,costScaling:2.5,maxLevel:40,cost:{artifactShards:new d(200),mythicFragments:new d(0),gems:new d(0)}},army_banner:{id:"army_banner",type:"mythic",tier:0,name:"Army Banner",icon:H("icons/army banner.png"),description:"Increases expedition unit output (x1.5 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.5,costScaling:5,maxLevel:40,cost:{artifactShards:new d(0),mythicFragments:new d(10),gems:new d(0)}},breeding_artifact:{id:"breeding_artifact",type:"mythic",tier:0,name:"Breeding Artifact",icon:H("icons/breeding artifact.png"),description:"Multiplies amount produced by R3 creatures each cycle (x1.2 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.2,costScaling:5,maxLevel:40,cost:{artifactShards:new d(0),mythicFragments:new d(1e3),gems:new d(0)}},knight_duplication:{id:"knight_duplication",type:"knight_output",tier:0,name:"Knight Duplication",icon:H("icons/knight duplication.png"),description:"Increases knight output (x1.4 per level)",baseInputMultiplier:new d(1),baseOutputMultiplier:new d(1),upgradeBonus:.4,costScaling:3,maxLevel:40,cost:{artifactShards:new d(1e18),mythicFragments:new d(0),gems:new d(0)}}};new d(1e15),new d(1e30),new d(1e60),new d(1e120),new d(1e240),new d("1e480"),new d("1e1000"),new d("1e2000");const wu=Object.freeze(Object.defineProperty({__proto__:null,ALL_ARTIFACT_IDS:$t,ALL_MILITARY_UNIT_IDS:hu,ARTIFACTS:Be,COMPLETIONS_TO_UNLOCK:bu,EXPEDITIONS:yu,MAX_SUCCESS_RATE:Bs,MILITARY_UNITS:gu,MIN_SUCCESS_RATE:vu,MODIFIERS:fu,calculateQuestBonus:xu},Symbol.toStringTag,{value:"Module"})),Su={manaModifier:e=>e.sqrt(),craftTimeMultiplier:4,flaskRecipeMultiplier:4,sacrificeCap:2e5,sacrificeBatchSize:10,calculateSacrificeBonus:Xa(2e5,.5,.02)},Tu={t1_sword:{id:"t1_sword",name:"T1 Sword",icon:H("icons/t1 sword.png"),recipe:[{type:"gem",tier:1,amount:new d(1e3)}],craftTime:10,unlockRequirement:{type:"lifetime_gems",tier:1,amount:1e4},unitRole:"strength",strengthMultiplier:10,strengthExponent:.8},t2_sword:{id:"t2_sword",name:"T2 Sword",icon:H("icons/t2 sword.png"),recipe:[{type:"gem",tier:2,amount:new d(1e4)}],craftTime:15,unlockRequirement:{type:"lifetime_gems",tier:2,amount:1e5},unitRole:"strength",strengthMultiplier:100,strengthExponent:.8},t3_sword:{id:"t3_sword",name:"T3 Sword",icon:H("icons/t3 sword.png"),recipe:[{type:"gem",tier:3,amount:new d(1e5)}],craftTime:20,unlockRequirement:{type:"lifetime_gems",tier:3,amount:1e6},unitRole:"strength",strengthMultiplier:1e3,strengthExponent:.8},t4_sword:{id:"t4_sword",name:"T4 Sword",icon:H("icons/t4 sword.png"),recipe:[{type:"gem",tier:4,amount:new d(4e5)}],craftTime:30,unlockRequirement:{type:"lifetime_gems",tier:4,amount:4e6},unitRole:"strength",strengthMultiplier:1e4,strengthExponent:.8},t5_sword:{id:"t5_sword",name:"T5 Sword",icon:H("icons/t5 sword.png"),recipe:[{type:"gem",tier:5,amount:new d(16e5)}],craftTime:45,unlockRequirement:{type:"lifetime_gems",tier:5,amount:16e6},unitRole:"strength",strengthMultiplier:1e5,strengthExponent:.8},t6_sword:{id:"t6_sword",name:"T6 Sword",icon:H("icons/t6 sword.png"),recipe:[{type:"gem",tier:6,amount:new d(64e5)}],craftTime:60,unlockRequirement:{type:"lifetime_gems",tier:6,amount:64e6},unitRole:"strength",strengthMultiplier:1e6,strengthExponent:.8}},ku=["t1_sword","t2_sword","t3_sword","t4_sword","t5_sword","t6_sword"],$u=1,Ru=.1,Cu=15,Sl=[{id:"t1_quest",name:"T1 Quest",difficulty:50,duration:60,rewards:{questBonusTiers:[1]},group:"Output Bonuses"},{id:"t2_quest",name:"T2 Quest",difficulty:500,duration:60,rewards:{questBonusTiers:[1,2]},group:"Output Bonuses",unlockRequirement:"t1_quest"},{id:"t3_quest",name:"T3 Quest",difficulty:5e3,duration:60,rewards:{questBonusTiers:[1,2,3]},group:"Output Bonuses",unlockRequirement:"t2_quest"},{id:"t4_quest",name:"T4 Quest",difficulty:5e4,duration:60,rewards:{questBonusTiers:[1,2,3,4]},group:"Output Bonuses",unlockRequirement:"t3_quest"},{id:"t5_quest",name:"T5-T6 Quest",difficulty:2e6,duration:60,rewards:{questBonusTiers:[5,6]},group:"Output Bonuses",unlockRequirement:"t4_quest"}],Mu=(e,r)=>{let t=1;for(const a of Sl){const n=a.rewards.questBonusTiers;if(n&&n.includes(e)){const s=r[a.id]||0;s>0&&(t+=Math.sqrt(s*.1))}}return t},Iu=Object.freeze(Object.defineProperty({__proto__:null,ALL_MILITARY_UNIT_IDS:ku,COMPLETIONS_TO_UNLOCK:Cu,EXPEDITIONS:Sl,MAX_SUCCESS_RATE:$u,MILITARY_UNITS:Tu,MIN_SUCCESS_RATE:Ru,MODIFIERS:Su,calculateQuestBonus:Mu},Symbol.toStringTag,{value:"Module"})),Eu={manaModifier:void 0,craftTimeMultiplier:1,flaskRecipeMultiplier:1,sacrificeCap:2e4,sacrificeBatchSize:1,calculateSacrificeBonus:Xa(2e4,.4,.1)},Au={pixie:{id:"pixie",name:"Pixie",icon:H("icons/pixie.png"),recipe:[],craftTime:0,unlockRequirement:{type:"lifetime_gems",tier:1,amount:0},unitRole:"strength",strengthMultiplier:1,strengthExponent:.8}},_u=["pixie"],qu=1,Nu=.1,Lu=20,Uu=[{id:"r3_mine_1",name:"Mine",difficulty:100,duration:120,rewards:{arcaneBars:1},group:"Mine"},{id:"r3_forest_1",name:"Forest",difficulty:100,duration:120,rewards:{arcaneLogs:1},group:"Forest"},{id:"r3_mine_2",name:"Mine II",difficulty:1e4,duration:240,rewards:{arcaneBars:25},group:"Mine",unlockRequirement:"r3_mine_1"},{id:"r3_forest_2",name:"Forest II",difficulty:1e4,duration:240,rewards:{arcaneLogs:25},group:"Forest",unlockRequirement:"r3_forest_1"},{id:"r3_mine_3",name:"Mine III",difficulty:1e6,duration:480,rewards:{arcaneBars:625},group:"Mine",unlockRequirement:"r3_mine_2"},{id:"r3_forest_3",name:"Forest III",difficulty:1e6,duration:480,rewards:{arcaneLogs:625},group:"Forest",unlockRequirement:"r3_forest_2"},{id:"r3_mine_4",name:"Mine IV",difficulty:1e8,duration:960,rewards:{arcaneBars:15625},group:"Mine",unlockRequirement:"r3_mine_3"},{id:"r3_forest_4",name:"Forest IV",difficulty:1e8,duration:960,rewards:{arcaneLogs:15625},group:"Forest",unlockRequirement:"r3_forest_3"},{id:"r3_mine_5",name:"Mine V",difficulty:1e10,duration:1920,rewards:{arcaneBars:390625},group:"Mine",unlockRequirement:"r3_mine_4"},{id:"r3_forest_5",name:"Forest V",difficulty:1e10,duration:1920,rewards:{arcaneLogs:390625},group:"Forest",unlockRequirement:"r3_forest_4"},{id:"r3_heroic_soul_mastery",name:"Soul Mastery",duration:300,rewards:{},group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:1e8,difficultyScaling:10,rewardType:"soul_production",rewardScaling:1.2}},{id:"r3_heroic_creature_mastery",name:"Creature Mastery",duration:300,rewards:{},group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:1e8,difficultyScaling:10,rewardType:"creature_production",rewardScaling:1.2}},{id:"r3_heroic_realm_mastery",name:"Realm Mastery",duration:300,rewards:{},group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:1e8,difficultyScaling:10,rewardType:"realm_mastery",rewardScaling:1.2}}],Pu=(e,r)=>1,Tl={produces:"pixie",amountPerCycle:1,cycleDuration:10},Fu={produces:"arcane_warden",amountPerCycle:1,cycleDuration:15},Ou={produces:"eidolon",amountPerCycle:1,cycleDuration:20},Bu={produces:"mana_wisp",amountPerCycle:1,cycleDuration:25},Du={produces:"anima_core",amountPerCycle:1,cycleDuration:30},Hu={produces:"luminary",amountPerCycle:1,cycleDuration:35},dr={arcane_warden:Tl,eidolon:Fu,mana_wisp:Ou,anima_core:Bu,luminary:Du,emperor:Hu},xo={};for(const[e,r]of Object.entries(dr))xo[r.produces]=e;const kl=100,Ds={arcane_warden:{requiredRecipe:"pixie",lifetimeThreshold:100},eidolon:{requiredRecipe:"arcane_warden",lifetimeThreshold:800},mana_wisp:{requiredRecipe:"eidolon",lifetimeThreshold:6400},anima_core:{requiredRecipe:"mana_wisp",lifetimeThreshold:51200},luminary:{requiredRecipe:"anima_core",lifetimeThreshold:409600},emperor:{requiredRecipe:"luminary",lifetimeThreshold:5e6,requiredHeroicTrial:1}},qa={arcane_dwelling:{population:1},arcane_well:{population:0,soulProductionMultiplier:1.25}},ht={arcane_sanctum:{creatureProductionMultiplier:2,baseTicks:1e4,secondsPerTick:3,tickCost:[{recipeId:"arcane_bar",amount:1},{recipeId:"arcane_log",amount:1}],costEscalation:10},enchanting_tower:{creatureProductionMultiplier:1,baseTicks:1e4,secondsPerTick:3,tickCost:[{recipeId:"arcane_bar",amount:100},{recipeId:"arcane_log",amount:100}],costEscalation:10,gemProductionMultiplier:2,gemProductionTargetRealms:["realm1","realm2","realmU"]},speed_pylon:{creatureProductionMultiplier:1,baseTicks:1e5,secondsPerTick:3,tickCost:[{recipeId:"arcane_bar",amount:10},{recipeId:"arcane_log",amount:10}],costEscalation:3,workerSpeedMultiplier:1.3},ancient_valor:{creatureProductionMultiplier:1,baseTicks:1e4,secondsPerTick:3,tickCost:[{recipeId:"arcane_bar",amount:100},{recipeId:"arcane_log",amount:100}],costEscalation:10,strengthMultiplier:1.5,minGlobalTier:5}},Vu=e=>{e.arcane_soul={id:"arcane_soul",category:"magical_creature",name:"Arcane Soul",icon:H("icons/arcane soul.png"),recipe:[],craftTime:5,realmId:"realm3",ignoreModifiers:!0,outputMultipliers:[{type:"inventory",source:"forge_enhancer",formula:r=>1+r,label:"Forge Enhancer",maxGlobalTier:2},{type:"inventory",source:"soulforge",formula:r=>Math.max(1,r),label:"Soulforge Mastery",minGlobalTier:3},{type:"inventory",source:"arcane_well",formula:r=>Math.pow(1.25,r),label:"Arcane Well"},{type:"ascension",source:"asc_arcane_soul_prod",formula:r=>Math.pow(1.3,r),label:"Ascension"}]},e.pixie={id:"pixie",category:"magical_creature",name:"Pixie",icon:H("icons/pixie.png"),recipe:[{type:"recipe",recipeId:"arcane_soul",amount:new d(1)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.arcane_warden={id:"arcane_warden",category:"magical_creature",name:"Arcane Warden",icon:H("icons/arcane warden.png"),recipe:[{type:"recipe",recipeId:"pixie",amount:new d(100)},{type:"recipe",recipeId:"arcane_soul",amount:new d(10)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.eidolon={id:"eidolon",category:"magical_creature",name:"Eidolon",icon:H("icons/eidolon.png"),recipe:[{type:"recipe",recipeId:"arcane_warden",amount:new d(800)},{type:"recipe",recipeId:"arcane_soul",amount:new d(80)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.mana_wisp={id:"mana_wisp",category:"magical_creature",name:"Mana Wisp",icon:H("icons/mana wisp.png"),recipe:[{type:"recipe",recipeId:"eidolon",amount:new d(6400)},{type:"recipe",recipeId:"arcane_soul",amount:new d(640)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.anima_core={id:"anima_core",category:"magical_creature",name:"Anima Core",icon:H("icons/anima core.png"),recipe:[{type:"recipe",recipeId:"mana_wisp",amount:new d(51200)},{type:"recipe",recipeId:"arcane_soul",amount:new d(5120)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.luminary={id:"luminary",category:"magical_creature",name:"Luminary",icon:H("icons/luminary.png"),recipe:[{type:"recipe",recipeId:"anima_core",amount:new d(409600)},{type:"recipe",recipeId:"arcane_soul",amount:new d(40960)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.emperor={id:"emperor",category:"magical_creature",name:"Emperor",icon:H("icons/emperor.png"),recipe:[{type:"recipe",recipeId:"luminary",amount:new d(5e6)},{type:"recipe",recipeId:"arcane_soul",amount:new d(1e6)}],craftTime:0,realmId:"realm3",ignoreModifiers:!0}},hi=new d(100),ju=1.7,vi=new d(5e3),Gu=2.5,Wu=e=>{e.arcane_dwelling={id:"arcane_dwelling",category:"building",name:"Arcane Dwelling",icon:H("icons/arcane dwelling.png"),recipe:[{type:"recipe",recipeId:"arcane_bar",amount:hi},{type:"recipe",recipeId:"arcane_log",amount:hi}],craftTime:0,realmId:"realm3",ignoreModifiers:!0,escalatingCost:ju},e.arcane_well={id:"arcane_well",category:"building",name:"Arcane Well",icon:H("icons/arcane well.png"),recipe:[{type:"recipe",recipeId:"arcane_bar",amount:vi},{type:"recipe",recipeId:"arcane_log",amount:vi}],craftTime:0,realmId:"realm3",ignoreModifiers:!0,escalatingCost:Gu}},Ku=e=>{e.arcane_sanctum={id:"arcane_sanctum",category:"arcane_wonder",name:"Arcane Sanctum",icon:H("icons/arcane sanctum.png"),recipe:[],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.enchanting_tower={id:"enchanting_tower",category:"arcane_wonder",name:"Enchanting Tower",icon:H("icons/enchanting tower.png"),recipe:[],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.speed_pylon={id:"speed_pylon",category:"arcane_wonder",name:"Speed Pylon",icon:H("icons/speed pylon.png"),recipe:[],craftTime:0,realmId:"realm3",ignoreModifiers:!0},e.ancient_valor={id:"ancient_valor",category:"arcane_wonder",name:"Ancient Valor",icon:H("icons/ancient valor.png"),recipe:[],craftTime:0,realmId:"realm3",ignoreModifiers:!0}},Ir={pickaxe:{expeditionGroup:"Mine",exponent:.6,rewardDivisor:7,difficultyDivisor:30},axe:{expeditionGroup:"Forest",exponent:.6,rewardDivisor:7,difficultyDivisor:30}},Yu=e=>{e.pickaxe={id:"pickaxe",category:"equipment",name:"Pickaxe",icon:H("icons/pickaxe.png"),recipe:[],craftTime:1,realmId:"realm3",ignoreModifiers:!0},e.axe={id:"axe",category:"equipment",name:"Axe",icon:H("icons/axe.png"),recipe:[],craftTime:1,realmId:"realm3",ignoreModifiers:!0}},Mn=(e,r)=>{var a,n;let t=1;for(const[s,o]of Object.entries(qa)){if(!o.creatureProductionMultiplier||o.creatureProductionMultiplier===1)continue;const i=((a=e[s])==null?void 0:a.toNumber())??0;i>0&&(t*=Math.pow(o.creatureProductionMultiplier,i))}for(const[s,o]of Object.entries(ht)){const i=((n=e[s])==null?void 0:n.toNumber())??0;i>0&&(t*=Math.pow(o.creatureProductionMultiplier,i))}return r&&r>0&&(t*=Math.pow(1.2,r)),t},zu=e=>e.amountPerCycle/e.cycleDuration,Xu=e=>{var t;return 1+(((t=e.forge_enhancer)==null?void 0:t.toNumber())??0)},ir=e=>{var t;let r=1;for(const[a,n]of Object.entries(ht)){if(!n.workerSpeedMultiplier||n.workerSpeedMultiplier===1)continue;const s=((t=e[a])==null?void 0:t.toNumber())??0;s>0&&(r*=Math.pow(n.workerSpeedMultiplier,s))}return r},yo=e=>{var t;let r=1;for(const[a,n]of Object.entries(ht)){if(!n.strengthMultiplier||n.strengthMultiplier===1)continue;const s=((t=e[a])==null?void 0:t.toNumber())??0;s>0&&(r*=Math.pow(n.strengthMultiplier,s))}return r},$l=(e,r)=>{var a;let t=1;for(const[n,s]of Object.entries(ht)){if(!s.gemProductionMultiplier||s.gemProductionMultiplier===1||s.gemProductionTargetRealms&&!s.gemProductionTargetRealms.includes(r))continue;const o=((a=e[n])==null?void 0:a.toNumber())??0;o>0&&(t*=Math.pow(s.gemProductionMultiplier,o))}return t},jr=[{id:"asc_arcane_soul_prod",name:"Arcane Soul Production",description:"Increases arcane soul production",effectDescription:e=>e===0?"x1":`x${Math.pow(1.3,e).toFixed(2)}`,baseCost:5,costScaling:2.2,maxLevel:20},{id:"asc_production_speed",name:"Production Speed",description:"Increases creature production speed",effectDescription:e=>e===0?"x1":`x${(1+e*.1).toFixed(1)}`,baseCost:5,costScaling:2,maxLevel:30},{id:"asc_pixie_strength",name:"Pixie Strength",description:"Increases pixie combat strength",effectDescription:e=>e===0?"+0":`+${(e*.3).toFixed(1)}`,baseCost:10,costScaling:3,maxLevel:10},{id:"asc_t8_gem_prod",name:"T8 Gem Production",description:"Multiplies T8 gem production (all realms)",effectDescription:e=>e===0?"x1":`x${Math.pow(2,e)}`,baseCost:50,costScaling:3.5,maxLevel:15},{id:"asc_bigger_dwelling",name:"Bigger Dwelling",description:"Each arcane dwelling provides additional population",effectDescription:e=>e===0?"+0":`+${e}`,baseCost:30,costScaling:3,maxLevel:9}],zn=Object.fromEntries(jr.map(e=>[e.id,e])),Za=1e5,wo=()=>({ascendedSouls:0,upgrades:{},lifetimePixies:0,totalAscensions:0}),Xn=e=>Math.floor(Math.sqrt(e/Za)),In=e=>e>=Za,En=(e,r)=>{const t=zn[e];return Math.floor(t.baseCost*Math.pow(t.costScaling,r))},Ft=(e,r)=>e.upgrades[r]??0,wn=(e,r=0)=>zn[e].maxLevel+r,Zu=e=>Math.pow(1.3,Ft(e,"asc_arcane_soul_prod")),Na=e=>1+Ft(e,"asc_production_speed")*.1,La=e=>Ft(e,"asc_pixie_strength")*.3,Qu=e=>Math.pow(2,Ft(e,"asc_t8_gem_prod")),Gt=e=>Ft(e,"asc_bigger_dwelling"),Rl=new d(1e9),Cl=10,Ml=1e9,Ua="gem_8",Ju=new d(1e6),ed=10,td=1e6,An="luminary",Il=new d(1e9),El=10,Al=1e9,Pa="gem_8",_l=e=>{e.soulforge={id:"soulforge",category:"special",name:"Soulforge",icon:H("icons/soulforge.png"),recipe:[{type:"recipe",recipeId:Ua,amount:Rl}],craftTime:0,unlockCondition:{recipeId:Ua,threshold:Ml},ignoreModifiers:!0,escalatingCost:Cl,targetRealm:"realm3"},e.forge_enhancer={id:"forge_enhancer",category:"special",name:"Forge Enhancer",icon:H("icons/forge enhancer.png"),recipe:[{type:"recipe",recipeId:Pa,amount:Il}],craftTime:0,unlockCondition:{recipeId:Pa,threshold:Al},ignoreModifiers:!0,escalatingCost:El,targetRealm:"realm3"},e.soulcaster={id:"soulcaster",category:"special",name:"Soulcaster",icon:H("icons/soulcaster.png"),recipe:[{type:"recipe",recipeId:An,amount:Ju}],craftTime:0,unlockCondition:{recipeId:An,threshold:td},ignoreModifiers:!0,escalatingCost:ed,targetRealm:"realm3"},Vu(e),Wu(e),Yu(e),Ku(e)},rd=Object.freeze(Object.defineProperty({__proto__:null,ALL_MILITARY_UNIT_IDS:_u,ASCENSION_UPGRADES:jr,ASCENSION_UPGRADE_MAP:zn,COMPLETIONS_TO_UNLOCK:Lu,CREATURE_PRODUCTION:dr,EQUIPMENT_CONFIGS:Ir,EXPEDITIONS:Uu,FORGE_ENHANCER_BASE_COST:Il,FORGE_ENHANCER_ESCALATION_FACTOR:El,FORGE_ENHANCER_INGREDIENT_RECIPE_ID:Pa,FORGE_ENHANCER_UNLOCK_THRESHOLD:Al,MAX_SUCCESS_RATE:qu,MILITARY_UNITS:Au,MIN_PIXIES_TO_ASCEND:Za,MIN_SUCCESS_RATE:Nu,MODIFIERS:Eu,SOULFORGE_BASE_COST:Rl,SOULFORGE_ESCALATION_FACTOR:Cl,SOULFORGE_INGREDIENT_RECIPE_ID:Ua,SOULFORGE_UNLOCK_THRESHOLD:Ml,WARDEN_PRODUCTION:Tl,calculateQuestBonus:Pu,canAscend:In,createDefaultAscensionState:wo,getAscensionArcaneSoulMult:Zu,getAscensionDwellingBonus:Gt,getAscensionGain:Xn,getAscensionPixieStrengthBonus:La,getAscensionProductionSpeedMult:Na,getAscensionT8GemMult:Qu,getAscensionUpgradeCost:En,getAscensionUpgradeLevel:Ft,getCreatureRatePerSecond:zu,getForgeEnhancerMultiplier:Xu,registerRealm3Recipes:_l},Symbol.toStringTag,{value:"Module"})),ad={manaModifier:void 0,craftTimeMultiplier:1,flaskRecipeMultiplier:1,sacrificeCap:1/0,sacrificeBatchSize:1,calculateSacrificeBonus:Xa(1/0,.4,.1)},Sn=100,nd={u_t1_knight:{id:"u_t1_knight",name:"T1 Knight",icon:H("icons/t1 knight.png"),recipe:[{type:"gem",tier:1,amount:new d(100)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:1,amount:1e4},unitRole:"strength",strengthMultiplier:1*Sn,strengthExponent:.8},u_t4_knight:{id:"u_t4_knight",name:"T4 Knight",icon:H("icons/t4 knight.png"),recipe:[{type:"gem",tier:4,amount:new d(1e3)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:4,amount:1e5},unitRole:"strength",strengthMultiplier:20*Sn,strengthExponent:.8},u_t7_knight:{id:"u_t7_knight",name:"T7 Knight",icon:H("icons/t7 knight.png"),recipe:[{type:"gem",tier:7,amount:new d(1e4)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:7,amount:1e6},unitRole:"strength",strengthMultiplier:400*Sn,strengthExponent:.8},u_t2_boat:{id:"u_t2_boat",name:"T2 Boat",icon:H("icons/t2 boat.png"),recipe:[{type:"gem",tier:2,amount:new d(500)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:2,amount:5e4},unitRole:"speed",strengthMultiplier:1,strengthExponent:.6},u_t5_boat:{id:"u_t5_boat",name:"T5 Boat",icon:H("icons/t5 boat.png"),recipe:[{type:"gem",tier:5,amount:new d(5e3)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:5,amount:5e5},unitRole:"speed",strengthMultiplier:5,strengthExponent:.6},u_t3_beacon:{id:"u_t3_beacon",name:"T3 Beacon",icon:H("icons/t3 beacon.png"),recipe:[{type:"gem",tier:3,amount:new d(1e3)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:3,amount:1e5},unitRole:"taunt",strengthMultiplier:1,strengthExponent:.6},u_t6_beacon:{id:"u_t6_beacon",name:"T6 Beacon",icon:H("icons/t6 beacon.png"),recipe:[{type:"gem",tier:6,amount:new d(1e4)}],craftTime:1,unlockRequirement:{type:"lifetime_gems",tier:6,amount:1e6},unitRole:"taunt",strengthMultiplier:10,strengthExponent:.6},u_t8_captain:{id:"u_t8_captain",name:"T8 Captain",icon:H("icons/t8 captain.png"),recipe:[{type:"gem",tier:8,amount:new d(1e15)}],craftTime:120,unlockRequirement:{type:"lifetime_gems",tier:8,amount:1e15},unitRole:"captain",strengthMultiplier:1,strengthExponent:.5},u_portal_knight:{id:"u_portal_knight",name:"Portal Knight",icon:H("icons/portal knight.png"),recipe:[{type:"military",unitId:"u_t7_knight",amount:new d(1e11)}],craftTime:60,unlockRequirement:{type:"lifetime_gems",tier:7,amount:1e6},unitRole:"strength",strengthMultiplier:0,strengthExponent:0,ignoreModifiers:!0,excludeFromExpeditions:!0}},sd=["u_t1_knight","u_t2_boat","u_t3_beacon","u_t4_knight","u_t5_boat","u_t6_beacon","u_t7_knight","u_t8_captain","u_portal_knight"],od=1,id=.1,ld=5,cd=(e,r)=>1,ud=[{id:"shard_1",name:"Shard 1",difficulty:1e8,duration:21600,rewards:{artifactShards:1e6},group:"Shards"},{id:"shard_2",name:"Shard 2",difficulty:2e9,duration:21600,rewards:{artifactShards:4e7},group:"Shards",unlockRequirement:"shard_1"},{id:"shard_3",name:"Shard 3",difficulty:4e10,duration:21600,rewards:{artifactShards:16e8},group:"Shards",unlockRequirement:"shard_2"},{id:"fragment_1",name:"Fragment 1",difficulty:1e14,duration:259200,rewards:{mythicFragments:1},group:"Fragments"},{id:"heroic_shard_affinity",name:"Shard Affinity",duration:1800,rewards:{},group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:5e5,difficultyScaling:2.4,rewardType:"shard_drops",rewardScaling:1.1}},{id:"heroic_unified_mastery",name:"Unified Realm Mastery",duration:1800,rewards:{},group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:5e5,difficultyScaling:2.4,rewardType:"realm1_output",rewardScaling:1.1}},{id:"heroic_creatures",name:"Heroic Creatures",duration:1800,rewards:{},group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:1e11,difficultyScaling:5,rewardType:"creature_production",rewardScaling:1.1}},{id:"heroic_portal",name:"Portal",duration:86400,rewards:{},group:"Heroic Expeditions",unlockRequirement:"none",heroic:{baseDifficulty:1e20,difficultyScaling:1,rewardType:"portal",rewardScaling:1,maxVictories:1}}],dd=Object.freeze(Object.defineProperty({__proto__:null,ALL_ARTIFACT_IDS:$t,ALL_MILITARY_UNIT_IDS:sd,ARTIFACTS:Be,COMPLETIONS_TO_UNLOCK:ld,EXPEDITIONS:ud,MAX_SUCCESS_RATE:od,MILITARY_UNITS:nd,MIN_SUCCESS_RATE:id,MODIFIERS:ad,UNIFIED_KNIGHT_STRENGTH_BUFF:Sn,calculateQuestBonus:cd},Symbol.toStringTag,{value:"Module"})),md={manaModifier:void 0,craftTimeMultiplier:1,flaskRecipeMultiplier:1,sacrificeCap:2e4,sacrificeBatchSize:1,calculateSacrificeBonus:Xa(2e4,.4,.1)},pd={},fd=[],gd=[],hd=1,vd=.1,bd=0,xd=(e,r)=>1,yd=Object.freeze(Object.defineProperty({__proto__:null,ALL_MILITARY_UNIT_IDS:fd,COMPLETIONS_TO_UNLOCK:bd,EXPEDITIONS:gd,MAX_SUCCESS_RATE:hd,MILITARY_UNITS:pd,MIN_SUCCESS_RATE:vd,MODIFIERS:md,calculateQuestBonus:xd},Symbol.toStringTag,{value:"Module"})),St=["realm1","realm2","realm3","realmU","realm4"],wd=["realm1","realm2","realm3"],Sd=["realm1","realm2","realm3","realmU"],Td={realm1:"Prime Realm",realm2:"Realm of War",realm3:"Realm of Magic",realmU:"Unified Realm",realm4:"Realm of Earth"},De=e=>{switch(e){case"realm1":return wu;case"realm2":return Iu;case"realm3":return rd;case"realmU":return dd;case"realm4":return yd}},He={};function ql(e,r,t,a){return e==="mana"?{type:"mana",amount:t}:e==="military"?{type:"recipe",recipeId:a,amount:t}:{type:"recipe",recipeId:`gem_${r}`,amount:t}}for(const e of gt){const r=Ze[e],t=`gem_${e}`;He[t]={id:t,category:"gem",name:r.name,icon:r.icon,tier:e,recipe:r.recipe.map(a=>ql(a.type,a.tier,a.amount)),craftTime:r.craftTime,visibleByDefault:r.visibleByDefault,unlockCondition:r.unlockRequirement?{recipeId:`gem_${r.unlockRequirement.tier}`,threshold:r.unlockRequirement.amount}:void 0,manaEffect:r.effect}}He.gem_8.outputMultipliers=[{type:"ascension",source:"asc_t8_gem_prod",formula:e=>Math.pow(2,e),label:"Ascension: T8 Gem",realmFilter:["realm1","realm2","realmU"]}];for(const e of Mt){const r=ea[e],t=`flask_${e}`;He[t]={id:t,category:"flask",name:r.name,icon:r.icon,tier:e,recipe:r.recipe.map(a=>({type:"recipe",recipeId:`gem_${a.tier}`,amount:a.amount})),craftTime:r.craftTime,unlockCondition:{recipeId:`gem_${e}`,threshold:500}}}for(const e of St){const r=De(e),t=r.MILITARY_UNITS;for(const a of r.ALL_MILITARY_UNIT_IDS){const n=t[a];He[a]||(He[a]={id:a,category:"military",name:n.name,icon:n.icon,recipe:n.recipe.map(s=>ql(s.type,s.tier,s.amount,s.unitId)),craftTime:n.craftTime,unlockCondition:{recipeId:`gem_${n.unlockRequirement.tier}`,threshold:n.unlockRequirement.amount},unitRole:n.unitRole,strengthMultiplier:n.strengthMultiplier,strengthExponent:n.strengthExponent,realmId:e,...e==="realm2"&&n.unlockRequirement.tier>=4?{crossRealmPooling:{minGlobalTier:2,targetRealms:["realm1"]}}:{},...n.ignoreModifiers?{ignoreModifiers:!0}:{}})}}He.artifact_shard={id:"artifact_shard",category:"expedition_reward",name:"Artifact Shard",icon:H("icons/artifact shard.png"),recipe:[],craftTime:0};He.nullstone={id:"nullstone",category:"expedition_reward",name:"Nullstone",icon:H("icons/nullstone.png"),recipe:[],craftTime:0};He.arcane_bar={id:"arcane_bar",category:"expedition_reward",name:"Arcane Bar",icon:H("icons/arcane bar.png"),recipe:[],craftTime:0,realmId:"realm3"};He.arcane_log={id:"arcane_log",category:"expedition_reward",name:"Arcane Log",icon:H("icons/arcane log.png"),recipe:[],craftTime:0,realmId:"realm3"};He.mythic_fragment={id:"mythic_fragment",category:"expedition_reward",name:"Mythic Fragment",icon:H("icons/mythic fragment.png"),recipe:[],craftTime:0};_l(He);const vt=He,At=Object.keys(He),me=e=>{const r=He[e];if(!r)throw new Error(`Unknown recipe: ${e}`);return r},Zn=e=>At.filter(r=>{const t=He[r];return t.category==="expedition_reward"||t.category==="special"||t.category==="equipment"||t.craftTime===0?!1:t.category==="magical_creature"?t.realmId===e:e==="realm3"&&(t.category==="gem"||t.category==="flask")?!1:t.category!=="military"?!0:t.realmId===e});gt.map(e=>`gem_${e}`);Mt.map(e=>`flask_${e}`);const kd=e=>At.filter(r=>He[r].category==="military"&&He[r].realmId===e);At.filter(e=>He[e].category==="military");const Nl=["artifact_shard","nullstone","mythic_fragment"],So=e=>At.filter(r=>He[r].category==="magical_creature"&&He[r].realmId===e),bi=e=>At.filter(r=>He[r].category==="building"&&He[r].realmId===e),_n=e=>At.filter(r=>He[r].category==="equipment"&&He[r].realmId===e),qn=e=>At.filter(r=>He[r].category==="arcane_wonder"&&He[r].realmId===e),xi=e=>`gem_${e}`,$d=e=>`flask_${e}`,Qa=()=>{const e={};for(const r of At)e[r]=new d(0);return e},D=(e,r)=>e[r]??new d(0),tt=(e,r,t)=>{e[r]=D(e,r).add(t)},qe=(e,r,t)=>{e[r]=d.max(D(e,r).sub(t),0)},Ja=(e,r,t)=>D(e,r).gte(t),Rd=e=>{const r={};for(const t of Object.keys(e)){const a=e[t];a&&!a.eq(0)&&(r[t]=a.toString())}return r},Cd=e=>{const r=Qa();for(const[t,a]of Object.entries(e))a&&t in r&&(r[t]=new d(a));return r},en=()=>{const e={};for(const r of At)e[r]={assignment:0,progress:0,lifetimeProduced:ue};return e},Md=e=>{const r={};for(const[t,a]of Object.entries(e))(a.assignment!==0||a.progress!==0||!a.lifetimeProduced.eq(0))&&(r[t]={a:a.assignment,p:a.progress,l:a.lifetimeProduced.toString()});return r},Id=e=>{const r=en();for(const[t,a]of Object.entries(e))if(t in r){const n=typeof a.l=="string"?new d(a.l):new d(a.l??0);r[t]={assignment:a.a??0,progress:a.p??0,lifetimeProduced:n}}return r},st=(e,r)=>{var o;const t=me(e);if(t.visibleByDefault||!t.unlockCondition)return!0;const{recipeId:a,threshold:n}=t.unlockCondition;return(((o=r[a])==null?void 0:o.lifetimeProduced)??ue).gte(n)},Ur=(e,r)=>{for(const t of e)if(!st(t,r))return t;return null},fs=(e,r)=>{var o;const t=me(e);if(!t.unlockCondition)return null;const{recipeId:a,threshold:n}=t.unlockCondition;return{current:(((o=r[a])==null?void 0:o.lifetimeProduced)??ue).toNumber(),required:n}},Oe=(e,r)=>{var t,a;return((a=(t=e[r])==null?void 0:t.lifetimeProduced)==null?void 0:a.toNumber())??0},Ed=e=>{var t;let r=0;for(const a of At)r+=((t=e[a])==null?void 0:t.assignment)??0;return r},Ll=(e,r)=>e-Ed(r),Xt=e=>{const r={};for(const t of gt)r[t]=D(e,`gem_${t}`);return r},ia=e=>{const r={};for(const t of Mt)r[t]=D(e,`flask_${t}`);return r},cr=e=>{const r={};for(const t of At)me(t).category==="military"&&(r[t]=D(e,t));return r},To=(e,r)=>{var s;const t={},a={},n={};for(const o of r){const i=e[o];t[o]=(i==null?void 0:i.assignment)??0,a[o]=(i==null?void 0:i.progress)??0,n[o]=((s=i==null?void 0:i.lifetimeProduced)==null?void 0:s.toNumber())??0}return{crafterAssignments:t,craftProgress:a,lifetimeCrafted:n}},mr={crafters:{id:"crafters",name:"Crafter",description:"Unlock a crafter for gem production",baseCost:new d(1),costExponent:10,maxLevel:300}},Ul=Object.keys(mr),Ad=[[{tier:1,amount:new d(50)}],[{tier:1,amount:new d(200)},{tier:2,amount:new d(100)}],[{tier:2,amount:new d(300)},{tier:3,amount:new d(200)}],[{tier:3,amount:new d(400)},{tier:4,amount:new d(300)}],[{tier:4,amount:new d(500)},{tier:5,amount:new d(400)}],[{tier:5,amount:new d(600)},{tier:6,amount:new d(500)}],[{tier:6,amount:new d(700)},{tier:7,amount:new d(600)}],[{tier:7,amount:new d(800)},{tier:8,amount:new d(700)}]],_d=Array.from({length:16},(e,r)=>{const t=Math.floor(r/2)+1,a=r%2===0?10:50;return[{tier:t,amount:new d(a)}]}),fn=(e,r=5e4)=>Array.from({length:10},(t,a)=>[{tier:e,amount:new d(r).mul(d.pow(4,a))}]),gs=e=>Array.from({length:8},(r,t)=>[{tier:e,amount:new d(1e4).mul(d.pow(1.4,t))},{tier:e,amount:new d(1e3).mul(d.pow(1.4,t)),recipeId:`t${e}_sword`}]),qd=[[{tier:1,amount:new d(10)}],[{tier:1,amount:new d(25)}],[{tier:1,amount:new d(50)}],[{tier:2,amount:new d(10)}],[{tier:2,amount:new d(25)}],[{tier:2,amount:new d(50)}],[{tier:3,amount:new d(10)}],[{tier:3,amount:new d(25)}],[{tier:3,amount:new d(50)}],[{tier:4,amount:new d(100)}]],Nd=[[{tier:1,amount:new d(100)},{tier:2,amount:new d(100)}],[{tier:1,amount:new d(500)},{tier:2,amount:new d(500)}],[{tier:2,amount:new d(100)},{tier:3,amount:new d(100)}],[{tier:2,amount:new d(500)},{tier:3,amount:new d(500)}],[{tier:3,amount:new d(100)},{tier:4,amount:new d(100)}],[{tier:3,amount:new d(500)},{tier:4,amount:new d(500)}],[{tier:4,amount:new d(100)},{tier:5,amount:new d(100)}],[{tier:4,amount:new d(500)},{tier:5,amount:new d(500)}],[{tier:5,amount:new d(100)},{tier:6,amount:new d(100)}],[{tier:5,amount:new d(500)},{tier:6,amount:new d(500)}]],Ld=[[{tier:1,amount:new d(50)}],[{tier:1,amount:new d(100)}],[{tier:1,amount:new d(250)}],[{tier:2,amount:new d(50)}],[{tier:2,amount:new d(100)}],[{tier:2,amount:new d(250)}],[{tier:3,amount:new d(50)}],[{tier:3,amount:new d(100)}],[{tier:3,amount:new d(250)}],[{tier:4,amount:new d(1e3)}]],Pl={craftersGuild:{id:"craftersGuild",name:"Crafter's Guild",description:"The first 30 crafters boost all crafters' output",tooltip:`Each of the first 30 crafters multiplies ALL crafting output (does not increase consumption).
Lv1: x1.03 per crafter, +0.005 per additional level.
Total multiplier = (1 + bonus) ^ min(total crafters, 30).
Applies to gems, flasks, and military.`,costs:Ad},gemManufacturing:{id:"gemManufacturing",name:"Gem Manufacturing",description:"Increases all gem output",tooltip:`Multiplies ALL gem crafting output by x1.2 per level.
Does not affect flask or military output.
Does not increase consumption.`,costs:_d},t1KnightStrength:{id:"t1KnightStrength",name:"T1 Knight Strength",description:"Increases T1 Knight combat strength",tooltip:`Multiplies T1 Knight combat strength by x1.3 per level.
Max 10 levels.`,costs:fn(1,1e3)},t4KnightStrength:{id:"t4KnightStrength",name:"T4 Knight Strength",description:"Increases T4 Knight combat strength",tooltip:`Multiplies T4 Knight combat strength by x1.3 per level.
Max 10 levels.`,costs:fn(4)},t7KnightStrength:{id:"t7KnightStrength",name:"T7 Knight Strength",description:"Increases T7 Knight combat strength",tooltip:`Multiplies T7 Knight combat strength by x1.3 per level.
Max 10 levels.`,costs:fn(7)},unifiedKnightStrength:{id:"unifiedKnightStrength",name:"Knight Strength",description:"Increases all Knight combat strength",tooltip:`Multiplies all Knight combat strength by x1.3 per level.
Max 10 levels.
Unified Realm only.`,costs:fn(7)},cheaperGems:{id:"cheaperGems",name:"Cheaper Gems",description:"Reduces gem input requirements",tooltip:`Reduces gem crafting input costs by 5% per level (additive).
Max 10 levels.
At max level, gems cost 50% less to craft.`,costs:qd},cheaperFlasks:{id:"cheaperFlasks",name:"Cheaper Flasks",description:"Reduces flask input requirements",tooltip:`Reduces flask crafting input costs by 5% per level (additive).
Max 10 levels.
At max level, flasks cost 50% less to craft.`,costs:Ld},cheaperMilitary:{id:"cheaperMilitary",name:"Cheaper Expedition Units",description:"Reduces military input requirements",tooltip:`Reduces military crafting input costs by 5% per level (additive).
Max 10 levels.
At max level, expedition units cost 50% less to craft.`,costs:Nd},t4SwordEfficiency:{id:"t4SwordEfficiency",name:"Cheaper T4 Swords",description:"Reduces T4 Sword input costs",tooltip:`Reduces T4 Sword crafting input costs by 12% per level (additive).
Max 8 levels.
At max level, T4 Swords cost 96% less to craft.`,costs:gs(4)},t5SwordEfficiency:{id:"t5SwordEfficiency",name:"Cheaper T5 Swords",description:"Reduces T5 Sword input costs",tooltip:`Reduces T5 Sword crafting input costs by 12% per level (additive).
Max 8 levels.
At max level, T5 Swords cost 96% less to craft.`,costs:gs(5)},t6SwordEfficiency:{id:"t6SwordEfficiency",name:"Cheaper T6 Swords",description:"Reduces T6 Sword input costs",tooltip:`Reduces T6 Sword crafting input costs by 12% per level (additive).
Max 8 levels.
At max level, T6 Swords cost 96% less to craft.`,costs:gs(6)},sacrificeMulti:{id:"sacrificeMulti",name:"Altar Sacrifice Multi",description:"Sacrifice more items per cycle",tooltip:`Multiplies altar sacrifice consumption and count by x1.3 per level.
Unified Realm only.`,costs:Array.from({length:10},(e,r)=>[{tier:8,amount:new d(1e6).mul(d.pow(10,r))}])}},Ud=1.3,ko=Object.keys(Pl),Qn=[...Ul,...ko],Zt={...Pl},Fl=(e,r,t)=>e[r].gte(t),$o=(e,r,t,a)=>{const n=t==="realm1"?e:r,s=t==="realm1"?r:e,o={...n};for(const i of Object.keys(s)){const l=vt[i];l!=null&&l.crossRealmPooling&&a>=l.crossRealmPooling.minGlobalTier&&(!l.crossRealmPooling.targetRealms||l.crossRealmPooling.targetRealms.includes(t))&&(o[i]=(o[i]||new d(0)).add(s[i]||new d(0)))}return o},Pd=(e,r,t,a,n)=>{const s=$o(e,r,a,n);for(const o of Object.keys(t)){const i=t[o]??ue;if(i.gt(0)&&(s[o]||new d(0)).lt(i))return!1}return!0},Fd=(e,r,t,a,n)=>{let s={...e},o={...r};for(const i of Object.keys(t)){let l=t[i]??ue;if(l.lte(0))continue;const p=vt[i];if((p==null?void 0:p.crossRealmPooling)&&n>=p.crossRealmPooling.minGlobalTier&&(!p.crossRealmPooling.targetRealms||p.crossRealmPooling.targetRealms.includes(a))){const c=a==="realm1"?s:o,g=a==="realm1"?o:s,m=c[i]||ue,h=d.min(l,m);h.gt(0)&&(c[i]=(c[i]||ue).sub(h),l=l.sub(h)),l.gt(0)&&(g[i]=(g[i]||ue).sub(l)),a==="realm1"?(s=c,o=g):(o=c,s=g)}else{const c=a==="realm1"?s:o;c[i]=(c[i]||ue).sub(l)}}return{realm1:s,realm2:o}},Ro=()=>{const e={};for(const r of Qn)e[r]=0;return e},Od=e=>{const r={};for(const t of Qn)e[t]!==0&&(r[t]=e[t]);return r},Bd=e=>{const r=Ro();for(const t of Qn)e[t]!==void 0&&(r[t]=e[t]);return r},Kt=(e,r,t=0)=>{if(r in mr){const a=mr[r];return e[r]>=a.maxLevel}if(r in Zt){const a=Zt[r];return e[r]>=a.costs.length}return!0},Dd=(e,r=0)=>e in mr?mr[e].maxLevel:e in Zt?Zt[e].costs.length:0,Hd=(e,r)=>{const t=mr[e];return r>=t.maxLevel?null:t.baseCost.mul(d.pow(t.costExponent,r))},la=(e,r)=>{const t=Zt[e];return!t||r>=t.costs.length?null:t.costs[r]},Co=(e,r,t=0)=>{if(r in mr){const a=Hd(r,e[r]);return a?{type:"mana",amount:a}:null}if(r in Zt){const a=la(r,e[r]);return!a||a.length===0?null:{type:"flask",tier:a[0].tier,amount:a[0].amount}}return null},tn=(e,r,t,a,n,s=0,o)=>{if(r in mr){const i=Co(e,r);return i?t.gte(i.amount):!1}if(r in Zt){const i=la(r,e[r]);return i?i.every(l=>l.recipeId&&o?D(o,l.recipeId).gte(l.amount):Fl(n,l.tier,l.amount)):!1}return!1},Nn=e=>1+(e.crafters??0),Vd=.03,jd=.005,Gd=30,Mo=e=>{const r=e.craftersGuild??0;if(r<=0)return new d(1);const t=Math.min(Nn(e),Gd),a=Vd+jd*(r-1);return new d(1+a).pow(t)},Wd=1.2,Io=e=>{const r=e.gemManufacturing??0;return r<=0?new d(1):new d(Wd).pow(r)},Eo=.05,Ao=e=>{const r=e.cheaperGems??0;return r<=0?new d(1):new d(1-Eo*r)},_o=e=>{const r=e.cheaperFlasks??0;return r<=0?new d(1):new d(1-Eo*r)},qo=e=>{const r=e.cheaperMilitary??0;return r<=0?new d(1):new d(1-Eo*r)},Kd=.12,Yd={t4_sword:"t4SwordEfficiency",t5_sword:"t5SwordEfficiency",t6_sword:"t6SwordEfficiency"},zr=["t4SwordEfficiency","t5SwordEfficiency","t6SwordEfficiency"],No=(e,r)=>{const t=Yd[r];if(!t)return new d(1);const a=e[t]??0;return a<=0?new d(1):new d(1-Kd*a)},ca=e=>{const r=e.sacrificeMulti??0;return r<=0?1:Math.pow(Ud,r)},yi=(e,r)=>new d(1),Fa=(e,r)=>new d(1),Hs=(e,r)=>new d(1),wi=e=>new d(1),Si=e=>new d(1),Jn=e=>1,zd=e=>1,rn=(e,r)=>0,Xd=1.3,Zd={t1_knight:"t1KnightStrength",t4_knight:"t4KnightStrength",t7_knight:"t7KnightStrength",u_t1_knight:"unifiedKnightStrength",u_t4_knight:"unifiedKnightStrength",u_t7_knight:"unifiedKnightStrength"},Xr=["t1KnightStrength","t4KnightStrength","t7KnightStrength","unifiedKnightStrength"],ua=(e,r)=>{const t=Zd[r];if(!t)return 1;const a=e[t]??0;return a<=0?1:Math.pow(Xd,a)},an=e=>De(e).MILITARY_UNITS,bt=e=>De(e).ALL_MILITARY_UNIT_IDS,Lo=(e,r,t)=>{const a=vt[e];return!(!(a!=null&&a.crossRealmPooling)||t<a.crossRealmPooling.minGlobalTier||a.crossRealmPooling.targetRealms&&!a.crossRealmPooling.targetRealms.includes(r))},Qd=(e,r)=>{const t=[];for(const a of St)if(a!==e)for(const n of De(a).ALL_MILITARY_UNIT_IDS)Lo(n,e,r)&&t.push(n);return t},Bt=(e,r)=>{const t=De(e).ALL_MILITARY_UNIT_IDS,a=Qd(e,r);return a.length>0?[...t,...a]:[...t]},er=(e,r)=>{const t={};Object.assign(t,De(e).MILITARY_UNITS);for(const a of St){if(a===e)continue;const n=De(a).MILITARY_UNITS;for(const s of Object.keys(n))Lo(s,e,r)&&(t[s]=n[s])}return t},Jd=(e,r)=>{for(const t of St)if(t!==e){for(const a of De(t).ALL_MILITARY_UNIT_IDS)if(Lo(a,e,r))return!0}return!1},em=()=>{const e={};for(const r of St){const t=De(r).MILITARY_UNITS;Object.assign(e,t)}return e},Rt=e=>De(e).EXPEDITIONS,Uo=e=>De(e).COMPLETIONS_TO_UNLOCK,es=e=>De(e).calculateQuestBonus,Ol=10,Bl=40,Dl=20,ta={1:{manaRequirement:new d(1e20),crafterSpeedMultiplier:1.2},2:{manaRequirement:new d(1e20),crafterSpeedMultiplier:7/6},3:{manaRequirement:new d(1e20),crafterSpeedMultiplier:1},4:{manaRequirement:new d(0),crafterSpeedMultiplier:1},5:{manaRequirement:new d(0),crafterSpeedMultiplier:1}},Vs=5,Ln=new d(1e20),Hl=!0,Tt=e=>e>=5?20:e>=4?5:1,ar=10,Oa=6,Un=e=>{const r=Be[e];return r?r.maxLevel:40},ts=(e,r,t=1/0)=>{if(r>=t)return{artifactShards:new d(1/0),mythicFragments:new d(1/0),gems:new d(1/0)};const a=d.pow(e.costScaling,r);return{artifactShards:e.cost.artifactShards.mul(a),mythicFragments:e.cost.mythicFragments.mul(a),gems:new d(0)}},Po=e=>Be[e].type==="mythic",tm=(e,r)=>{const t=Be[e];return d.pow(1+t.upgradeBonus,r)},Vl=(e,r,t)=>{if(!t)return{inputMultiplier:new d(1),outputMultiplier:new d(1)};const a=Be[e],n=tm(e,r),s=a.baseOutputMultiplier.mul(n);return{inputMultiplier:new d(1),outputMultiplier:s}},Fo=()=>{const e={},r={};for(const t of $t)e[t]=!1,r[t]=0;return{owned:e,upgradeLevels:r,slotted:[],slotCount:0}},rm=e=>({owned:e.owned,upgradeLevels:e.upgradeLevels,slotted:e.slotted,slotCount:e.slotCount}),am=e=>{const r=Fo(),t=e==null?void 0:e.owned,a=e==null?void 0:e.upgradeLevels;if(t&&typeof t=="object"&&Object.keys(t).some(l=>l.startsWith("artifact_t")))return r;const n={},s={};for(const o of $t)n[o]=(t==null?void 0:t[o])??!1,s[o]=(a==null?void 0:a[o])??0;return{owned:n,upgradeLevels:s,slotted:Array.isArray(e==null?void 0:e.slotted)?e.slotted.filter(o=>$t.includes(o)):[],slotCount:(e==null?void 0:e.slotCount)??0}},xt=(e,r)=>e.owned[r]===!0,jl=(e,r,t=0)=>{const a=Be[e];return a?a.cost.mythicFragments.gt(0)?t>=a.cost.mythicFragments.toNumber():r>=a.cost.artifactShards.toNumber():!1},Gl=(e,r,t,a=1/0,n=0)=>{if(r>=a)return!1;const s=Be[e];if(!s)return!1;const o=ts(s,r,a);return s.cost.mythicFragments.gt(0)?n>=o.mythicFragments.toNumber():t>=o.artifactShards.toNumber()},Wl=(e,r)=>{let t=new d(1);for(const a of $t){if(Be[a].tier!==r)continue;const{inputMultiplier:s}=Vl(a,e.upgradeLevels[a]??0,e.owned[a]??!1);t=t.mul(s)}return t},Oo=(e,r)=>{let t=new d(1);for(const a of $t){if(Be[a].tier!==r)continue;const{outputMultiplier:s}=Vl(a,e.upgradeLevels[a]??0,e.owned[a]??!1);t=t.mul(s)}return t},da=e=>{const r="combat_artifact";if(!e.owned[r])return 1;const t=e.upgradeLevels[r]??0;return t<=0?1:Math.pow(1+Be[r].upgradeBonus,t)},Kl=e=>{const r="crafting_speed";if(!e.owned[r])return 1;const t=e.upgradeLevels[r]??0;return t<=0?1:1+Be[r].upgradeBonus*t},Bo=e=>{const r="knight_duplication";if(!e.owned[r])return new d(1);const t=e.upgradeLevels[r]??0;return t<=0?new d(1):d.pow(1+Be[r].upgradeBonus,t)},Do=e=>{const r="army_banner";if(!e.owned[r])return new d(1);const t=e.upgradeLevels[r]??0;return t<=0?new d(1):d.pow(1+Be[r].upgradeBonus,t)},nm=(e,r,t=0)=>{const a=Be[e];return a.cost.mythicFragments.gt(0)?[{type:"mythic_fragments",icon:H("icons/mythic fragment.png"),amount:a.cost.mythicFragments,have:new d(t),canAfford:t>=a.cost.mythicFragments.toNumber()}]:[{type:"shards",icon:H("icons/artifact shard.png"),amount:a.cost.artifactShards,have:new d(r),canAfford:r>=a.cost.artifactShards.toNumber()}]},sm=(e,r,t,a,n=0)=>{const s=Be[e],o=ts(s,r,t);return s.cost.mythicFragments.gt(0)?[{type:"mythic_fragments",icon:H("icons/mythic fragment.png"),amount:o.mythicFragments,have:new d(n),canAfford:n>=o.mythicFragments.toNumber()}]:[{type:"shards",icon:H("icons/artifact shard.png"),amount:o.artifactShards,have:new d(a),canAfford:a>=o.artifactShards.toNumber()}]},om=1e3,im=100,lm=.2,cm=.01,Yl=()=>({prestigeCounts:{},autoPrestige:{}}),um=e=>({prestigeCounts:e.prestigeCounts,autoPrestige:e.autoPrestige}),dm=e=>{const r=e.prestigeCounts||{},t=e.autoPrestige||{};return{prestigeCounts:r,autoPrestige:t}},rs=e=>new d(om).mul(new d(im).pow(e)),as=(e,r,t)=>{const a=rs(t);return r.gte(a)},zl=(e,r)=>{const t=e[r]||0;return new d(1+t*lm)},Xl=e=>{let r=0;for(const t of Object.values(e))r+=t;return new d(1+r*cm)},at=(e,r)=>zl(e,r).mul(Xl(e)),Zl=()=>{const e={};for(const r of gt)e[`gem_${r}`]=0;for(const r of Mt)e[`flask_${r}`]=0;for(const r of St)for(const t of bt(r))e[`military_${t}`]=0;return e.artifact_shard=0,e.nullstone=0,e.mythic_fragment=0,e},Ho=()=>({tier:0,sacrificeCounts:Zl(),activeSacrifice:null,sacrificeProgress:0,activeSacrifices:[]}),js=e=>e>=1,Ql=(e,r,t)=>{const a=e[`gem_${r}`]||0;return t(a)},Jl=(e,r,t)=>{const a=e[`flask_${r}`]||0;return t(a)},nn=(e,r)=>{const t=e.artifact_shard||0;return r(t)},ns=(e,r)=>{const t=e.nullstone||0;return r(t)},sn=(e,r)=>{const t=e.mythic_fragment||0;return r(t)},ec=(e,r,t)=>{const a=e[`military_${r}`]||0;return t(a)},mm=e=>{const r={};for(const[t,a]of Object.entries(e.sacrificeCounts))a>0&&(r[t]=a);return{tier:e.tier,sacrificeCounts:r,activeSacrifice:e.activeSacrifice,sacrificeProgress:e.sacrificeProgress,...e.activeSacrifices.length>0?{activeSacrifices:e.activeSacrifices}:{}}},pm=e=>{const t={...Ho().sacrificeCounts};if(e.sacrificeCounts)for(const[a,n]of Object.entries(e.sacrificeCounts))a in t&&typeof n=="number"&&(t[a]=n);return{tier:e.tier??0,sacrificeCounts:t,activeSacrifice:e.activeSacrifice??null,sacrificeProgress:e.sacrificeProgress??0,activeSacrifices:e.activeSacrifices??[]}},ss=()=>({activeExpeditions:{},completionsPerExpedition:{},expeditionSetups:{},expeditionLog:[],pendingRepeats:{},portalBuilt:!1,heroicVictories:{}}),Ti=e=>{const r={};for(const[t,a]of Object.entries(e))r[t]=(a==null?void 0:a.toString())??"0";return r},fm=e=>{const r={};for(const[a,n]of Object.entries(e.activeExpeditions))r[a]=n.map(s=>({...s,assignedUnits:Ti(s.assignedUnits)}));const t={};for(const[a,n]of Object.entries(e.expeditionSetups))t[a]={...n,assignedUnits:Ti(n.assignedUnits)};return{activeExpeditions:r,completionsPerExpedition:e.completionsPerExpedition,expeditionSetups:t,expeditionLog:e.expeditionLog,pendingRepeats:e.pendingRepeats,portalBuilt:e.portalBuilt,heroicVictories:e.heroicVictories}},ki={expedition_2:null,expedition_3:"expedition_2",expedition_4:"expedition_3",expedition_5:"expedition_4"},$i={expedition_1:"shard_1",expedition_2:"shard_2",expedition_3:"nullstone_1",expedition_4:"shard_3"},gm=(e,r)=>r.some(t=>t in e),hm=e=>{const r=[e.expeditionSetups,e.activeExpeditions,e.completionsPerExpedition,e.pendingRepeats];for(const t of r)if(t&&"expedition_5"in t)return!0;return!1},vm=e=>{const r=[e.expeditionSetups,e.activeExpeditions,e.completionsPerExpedition,e.pendingRepeats];for(const t of r)if(t&&gm(t,["expedition_1","expedition_2","expedition_3","expedition_4"]))return!0;return!1},bm=(e,r,t)=>{let a=e;return r&&a in ki&&(a=ki[a]??null,a===null)?null:(t&&a in $i&&(a=$i[a]),a)},xm=e=>{const r=hm(e),t=vm(e)||r,a=g=>r||t?bm(g,r,t):g,n={};if(e.expeditionSetups)for(const[g,m]of Object.entries(e.expeditionSetups)){const h=a(g);if(!h)continue;const f={},v=m.assignedUnits;if(v)for(const S of Object.keys(v))f[S]=mt(v[S]);n[h]={assignedUnits:f,assignedEquipment:m.assignedEquipment,repeatIfUnitsAvailable:m.repeatIfUnitsAvailable||!1,repeatUntilVictory:m.repeatUntilVictory||void 0,repeatAt100:m.repeatAt100||void 0}}const s={};if(e.activeExpeditions)for(const[g,m]of Object.entries(e.activeExpeditions)){const h=a(g);h&&(s[h]=m.map(f=>{const v={},S=f.assignedUnits;if(S)for(const b of Object.keys(S))v[b]=mt(S[b]);return{...f,expeditionId:h,assignedUnits:v}}))}const o=e.completionsPerExpedition||{},i={};for(const[g,m]of Object.entries(o)){const h=a(g);h&&(i[h]=(i[h]||0)+m)}const l=e.pendingRepeats||{},p={};for(const[g,m]of Object.entries(l)){const h=a(g);h&&(p[h]=m)}const u=e.expeditionLog||[],c=[];for(const g of u){const m=a(g.expeditionId);m&&c.push({...g,expeditionId:m})}return{activeExpeditions:s,completionsPerExpedition:i,expeditionSetups:n,expeditionLog:c,pendingRepeats:p,portalBuilt:e.portalBuilt||!1,heroicVictories:e.heroicVictories||{}}},ma=(e,r="realm1")=>an(r)[e]||em()[e]||null,ur=(e,r,t=0)=>{const a=Bt(r,t);let n=ue;for(const s of a){const o=ma(s,r);if(!o||o.unitRole!=="captain")continue;const i=e[s];i&&(n=n.add(i instanceof d?i:mt(i)))}return n.lte(0)?1:n.add(1).pow(.4).toNumber()},Vo=(e,r,t="realm1",a=0,n=1)=>{if(r.lte(0))return ue;const s=ma(e,t);return s?r.pow(s.strengthExponent).mul((s.strengthMultiplier+a)*n):ue},ym=(e,r,t="realm1",a=0,n=1)=>{const s=ma(e,t);return!s||s.unitRole!=="strength"?ue:Vo(e,r,t,a,n)},jo=(e,r)=>{const t=e[r];return t?t instanceof d?t:mt(t):ue},yt=(e,r="realm1",t,a,n=0,s=0,o=1)=>{let i=ue;const l=ur(e,r,n),p=Bt(r,n);for(const c of p){const g=(t?rn():0)+s;let m=ym(c,jo(e,c),r,g,l);if(t){const h=ua(t,c);h>1&&(m=m.mul(h))}i=i.add(m)}const u=a?da(a):1;return i.mul(u).mul(o)},Gs=(e,r="realm1",t,a,n=0,s=0,o=1)=>yt(e,r,t,a,n,s,o).toNumber(),wm=(e,r,t,a,n,s=0,o=0,i=1)=>{const l=new d(r),p=[];for(const f of Object.keys(e)){if(!e[f]||e[f].lte(0))continue;const v=ma(f,t);v&&(v.unitRole==="strength"||v.unitRole==="captain")&&p.push(f)}const u=f=>{const v={};for(const[S,b]of Object.entries(e))!b||b.lte(0)||(p.includes(S)?v[S]=d.ceil(b.mul(f)):v[S]=b);return v};if(yt(e,t,a,n,s,o,i).gte(l))return{...e};let g=1,m=2;const h=1e4;for(;m<=h;){const f=u(new d(m));if(yt(f,t,a,n,s,o,i).gte(l))break;g=m,m=m*2}if(m>h){const f=u(new d(h));if(yt(f,t,a,n,s,o,i).lt(l))return null;m=h}for(;g<m;){const f=Math.floor((g+m)/2),v=u(new d(f));yt(v,t,a,n,s,o,i).gte(l)?m=f:g=f+1}return u(new d(m))},Pn=(e,r="realm1",t=0)=>{let a=ue;const n=Bt(r,t);for(const s of n){const o=ma(s,r);!o||o.unitRole!=="speed"||(a=a.add(Vo(s,jo(e,s),r)))}return a.toNumber()},It=(e,r="realm1",t=0)=>{let a=ue;const n=Bt(r,t);for(const s of n){const o=ma(s,r);!o||o.unitRole!=="taunt"||(a=a.add(Vo(s,jo(e,s),r)))}return a.toNumber()},Qt=e=>1+e/Bl,Fn=e=>1+e/Dl,Sm=e=>1+e/Ol,ra=(e,r,t="realm1",a=0)=>{const n=Rt(t),s=Uo(t),o=n.findIndex(u=>u.id===e);if(o===0)return!0;const i=n[o];if(!i)return!1;if(i.heroic)return $m(a);if(!i.unlockRequirement)return!0;const l=n.find(u=>u.id===i.unlockRequirement);return l?(r[l.id]||0)>=s:!1},Tm=(e,r,t,a="realm1",n={})=>{const s=r[e]||[],o=nt(e,a);return o!=null&&o.heroic?!(s.length>0||o.heroic.maxVictories!==void 0&&(n[e]||0)>=o.heroic.maxVictories):!(s.length>=t)},km=(e="realm1")=>{const r={},t=bt(e);for(const a of t)r[a]=ue;return r},Go=()=>({assignedUnits:km(),repeatIfUnitsAvailable:!0}),nt=(e,r="realm1")=>Rt(r).find(a=>a.id===e),Ws=(e,r)=>{const t=e/r*Bs;return Math.min(t,Bs)},aa=(e,r="realm1",t=0,a=1)=>{const n=nt(e,r),s=n?n.duration*1e3:6e4;return Math.round(s/(Sm(t)*a))},fr=(e,r)=>{if(!e.heroic)return e.difficulty??0;const t=r[e.id]||0;return Math.round(e.heroic.baseDifficulty*Math.pow(e.heroic.difficultyScaling,t))},pa=(e,r="realm1")=>{var n;const t=Rt(r);let a=1;for(const s of t)if(((n=s.heroic)==null?void 0:n.rewardType)==="shard_drops"){const o=e[s.id]||0;o>0&&(a*=Math.pow(s.heroic.rewardScaling,o))}return a},Er=(e,r,t="realm1")=>{var o;const a=Rt(t),n=r==="realm1"||r==="realmU"?"realm1_output":"realm2_output";let s=1;for(const i of a)if(((o=i.heroic)==null?void 0:o.rewardType)===n){const l=e[i.id]||0;l>0&&(s*=Math.pow(i.heroic.rewardScaling,l))}return s},$m=e=>e>=2,Ba=(e,r="realm3")=>{var n;const t=Rt(r);let a=1;for(const s of t)if(((n=s.heroic)==null?void 0:n.rewardType)==="soul_production"){const o=e[s.id]||0;o>0&&(a*=Math.pow(s.heroic.rewardScaling,o))}return a},lr=(e,r="realm3")=>{var n;const t=Rt(r);let a=1;for(const s of t)if(((n=s.heroic)==null?void 0:n.rewardType)==="creature_production"){const o=e[s.id]||0;o>0&&(a*=Math.pow(s.heroic.rewardScaling,o))}return a},on=(e,r="realm3")=>{var n;const t=Rt(r);let a=1;for(const s of t)if(((n=s.heroic)==null?void 0:n.rewardType)==="realm_mastery"){const o=e[s.id]||0;o>0&&(a*=Math.pow(s.heroic.rewardScaling,o))}return a},Da=(e,r,t,a,n,s,o=1,i=0)=>{const l=pa(t,s),p=at(a.prestigeCounts,"artifact_shard").toNumber(),u=at(a.prestigeCounts,"nullstone").toNumber(),c=De(s).MODIFIERS.calculateSacrificeBonus,g=nn(n,c).toNumber(),m=ns(n,c).toNumber(),h=Tt(i),f={};if(e.artifactShards&&(f.artifactShards=Math.round(e.artifactShards*r*l*p*g*h)),e.nullstone&&(f.nullstone=Math.round(e.nullstone*r*u*m*h)),e.mythicFragments){const v=at(a.prestigeCounts,"mythic_fragment").toNumber(),S=sn(n,c).toNumber();f.mythicFragments=Math.round(e.mythicFragments*r*v*S*h)}return e.arcaneBars&&(f.arcaneBars=Math.ceil(e.arcaneBars*o*h)),e.arcaneLogs&&(f.arcaneLogs=Math.ceil(e.arcaneLogs*o*h)),e.questBonusTiers&&(f.questBonusTiers=e.questBonusTiers),f},On=(e,r)=>{let t=1;for(const[a,n]of Object.entries(e)){if(n<=0)continue;const s=Ir[a];!s||s.expeditionGroup!==r||(t+=Math.pow(n,s.exponent)/s.rewardDivisor)}return t},Jt=(e,r)=>{let t=1;for(const[a,n]of Object.entries(e)){if(n<=0)continue;const s=Ir[a];!s||s.expeditionGroup!==r||(t+=Math.pow(n,s.exponent)/s.difficultyDivisor)}return t},tc=e=>Object.keys(Ir).filter(r=>Ir[r].expeditionGroup===e),Ut=(e="realm1")=>({mana:new d(0),recipeInventory:Qa(),recipeCrafting:en(),upgrades:Ro(),autoBuyUpgrades:{},autoBuyCreatures:{},autoBuyCreatureLimits:{},combat:ss(),artifacts:Fo(),altar:Ho(),prestige:Yl(),creatureUpgrades:{},creatureUnlocks:{},workshopAssignments:{},wonderAssignments:{},ascension:wo(),soulcasterAllocations:{gem_tower:0,military_tower:0},towerProgress:{gem_tower:0,military_tower:0},towerLevels:{gem_tower:0,military_tower:0},heroicTrialCompleted:0,autoAllResearch:!1,autoAllPrestige:!1,autoAllSacrifice:!1}),Wo=()=>({realms:{realm1:Ut("realm1"),realm2:Ut("realm2"),realm3:Ut("realm3"),realmU:Ut("realmU"),realm4:Ut("realm4")},activeRealm:"realm1",realm2Unlocked:!1,realm3Unlocked:!1,realmUUnlocked:!1,globalTier:0,lastFrameTimestamp:Date.now(),lastSaveTimestamp:0,paused:!1,backgroundImageOff:!1,tabHighlightingOff:!1,uiScale:1,totalPlaytime:0,skippedTime:0,gameTimeOffsetMs:0,timeWarpCharges:0,villageUnlocked:!1,collapsedSections:[],dismissedTips:[],earthPortalBuilt:!1,scientificNotationThreshold:1e15,hideMaxUpgrades:!0,breedingArtifactUnlocked:!1,knightDuplicationUnlocked:!1,ascensionCapBonus:0}),os=(e,r)=>{let t=e[1].mul(Ze[1].effect.value);for(const a of gt.slice(1)){const n=e[a];if(n.gt(0)){const s=Ze[a],o=new d(1).add(n.mul(s.effect.value.sub(1)));t=t.mul(o)}}return r&&(t=r(t)),t},Ri=(e,r,t,a)=>{const n=os(r,a);return e.add(n.mul(t))},Ko=(e,r)=>e==="crafting"?`gem_${r}`:e==="flaskCrafting"?`flask_${r}`:String(r),Yo=(e,r)=>{const t=e.activeRealm,a=e.realms[t],n={...a,...r(a)};return{realms:{...e.realms,[t]:n}}},rc=e=>{const r=Nn(e.upgrades);return Ll(r,e.recipeCrafting)},hs=(e,r,t)=>(a,n)=>{const s=r(),o=J(s),i=Ko(e,a),l=o.recipeCrafting[i],p=rc(o),u=(l==null?void 0:l.assignment)??0;let c=u+n;c=Math.max(0,c),c=Math.min(u+p,c),c!==u&&t(Yo(s,g=>({recipeCrafting:{...g.recipeCrafting,[i]:{...g.recipeCrafting[i],assignment:c}}})))},vs=(e,r,t)=>a=>{const n=r(),s=J(n),o=Ko(e,a),i=s.recipeCrafting[o],l=rc(s),u=((i==null?void 0:i.assignment)??0)+l;t(Yo(n,c=>({recipeCrafting:{...c.recipeCrafting,[o]:{...c.recipeCrafting[o],assignment:u}}})))},bs=(e,r,t)=>a=>{const n=r(),s=Ko(e,a);t(Yo(n,o=>({recipeCrafting:{...o.recipeCrafting,[s]:{...o.recipeCrafting[s],assignment:0,progress:0}}})))},ac=(e,r)=>{const t=e.activeRealm,a=e.realms[t],n={...a,...r(a)};return{realms:{...e.realms,[t]:n}}},Rm=(e,r)=>t=>{const a=e();if((t==="unifiedKnightStrength"||t==="sacrificeMulti")&&a.activeRealm!=="realmU"||Xr.includes(t)&&t!=="unifiedKnightStrength"&&a.activeRealm!=="realm1"||zr.includes(t)&&a.activeRealm!=="realm2")return!1;const n=J(a),s=a.globalTier,o=Xt(n.recipeInventory),i=ia(n.recipeInventory);if(Kt(n.upgrades,t,s)||!tn(n.upgrades,t,n.mana,o,i,s,n.recipeInventory))return!1;let l=n.mana;const p={...n.recipeInventory};if(t in Zt){const u=la(t,n.upgrades[t]);if(!u)return!1;for(const c of u)if(c.recipeId)qe(p,c.recipeId,c.amount);else{const g=$d(c.tier);qe(p,g,c.amount)}}else{const u=Co(n.upgrades,t,s);if(!u)return!1;u.type==="mana"&&(l=l.sub(u.amount))}return r(ac(a,()=>({mana:l,recipeInventory:p,upgrades:{...n.upgrades,[t]:n.upgrades[t]+1}}))),!0},Cm=(e,r)=>t=>{const a=e(),n=J(a),s=n.autoBuyUpgrades[t]??!1;r(ac(a,()=>({autoBuyUpgrades:{...n.autoBuyUpgrades,[t]:!s}})))},zo=(e,r)=>{const t=e.activeRealm,a=e.realms[t],n={...a,...r(a)};return{realms:{...e.realms,[t]:n}}},Mm=(e,r)=>(t,a)=>{const n=e(),s=J(n),o={...s.combat.pendingRepeats};!a.repeatIfUnitsAvailable&&!a.repeatUntilVictory&&!a.repeatAt100&&delete o[t],r(zo(n,()=>({combat:{...s.combat,expeditionSetups:{...s.combat.expeditionSetups,[t]:a},pendingRepeats:o}})))},Im=(e,r)=>(t,a,n=!1)=>{const s=e(),o=J(s),i=Bt(s.activeRealm,s.globalTier),l=nt(t,s.activeRealm);if(!l||!ra(t,o.combat.completionsPerExpedition,s.activeRealm,s.globalTier))return!1;const p=Jn(o.upgrades);if(!Tm(t,o.combat.activeExpeditions,p,s.activeRealm,o.combat.heroicVictories))return!1;let u=!1,c=!1;if(l.heroic){const j=o.combat.expeditionSetups[t];u=(j==null?void 0:j.repeatUntilVictory)||!1,c=(j==null?void 0:j.repeatAt100)||!1,n=u||c}const g=j=>{const B=a[j];return B?B instanceof d?B:mt(B):ue},m={};for(const j of i)m[j]=g(j);const h=Pn(m,s.activeRealm,s.globalTier),f=It(m,s.activeRealm,s.globalTier),v=Qt(f),S=Fn(f),b=l.heroic?fr(l,o.combat.heroicVictories):l.difficulty??0,T=o.combat.expeditionSetups[t],w={};if(T!=null&&T.assignedEquipment&&l.group)for(const[j,B]of Object.entries(T.assignedEquipment))B>0&&(w[j]=B);const $=l.group?Jt(w,l.group):1,R=l.group?On(w,l.group):1,x=b*v*$,y=s.activeRealm==="realm3"?La(s.realms.realm3.ascension):0,k=yo(s.realms.realm3.recipeInventory),C=Gs(m,s.activeRealm,o.upgrades,o.artifacts,s.globalTier,y,k);if(C<=0)return!1;let I=null,_=null,A={...o.recipeInventory},F=!1;if(s.activeRealm==="realm3"||s.activeRealm==="realmU"){for(const j of i){const B=m[j]??ue;if(B.gt(0)&&(o.recipeInventory[j]??new d(0)).lt(B))return!1}for(const[j,B]of Object.entries(w))if(B>0&&D(A,j).lt(B))return!1;for(const j of i){const B=m[j]??ue;B.gt(0)&&qe(A,j,B)}for(const[j,B]of Object.entries(w))B>0&&qe(A,j,new d(B))}else{const j=cr(s.realms.realm1.recipeInventory),B=cr(s.realms.realm2.recipeInventory);if(!Pd(j,B,m,s.activeRealm,s.globalTier))return!1;const Z=Fd(j,B,m,s.activeRealm,s.globalTier),oe=s.activeRealm==="realm1"?"realm2":"realm1",U=oe==="realm1"?j:B,O=oe==="realm1"?Z.realm1:Z.realm2;for(const K of i){const se=U[K]??new d(0),be=O[K]??new d(0);if(!se.eq(be)){F=!0;break}}if(F){I={...s.realms.realm1.recipeInventory},_={...s.realms.realm2.recipeInventory};for(const K of i)if((m[K]??ue).gt(0)){const be=j[K]??new d(0),G=Z.realm1[K]??new d(0),L=be.sub(G);L.gt(0)&&qe(I,K,L);const Y=B[K]??new d(0),X=Z.realm2[K]??new d(0),ie=Y.sub(X);ie.gt(0)&&qe(_,K,ie)}}else for(const K of i){const se=m[K]??ue;se.gt(0)&&qe(A,K,se)}}const E=s.activeRealm==="realm3"?ir(o.recipeInventory):1,P={expeditionId:t,assignedUnits:m,strength:C,successRate:Ws(C,x),startTime:Date.now()+(s.gameTimeOffsetMs??0),duration:aa(t,s.activeRealm,h,E),repeatIfUnitsAvailable:n,...u?{repeatUntilVictory:!0}:{},...c?{repeatAt100:!0}:{},speed:h,tauntMultiplier:S,assignedEquipment:Object.keys(w).length>0?w:void 0,equipmentMultiplier:R!==1?R:void 0},V=o.combat.activeExpeditions[t]||[];return r(F&&I&&_?{realms:{...s.realms,realm1:{...s.realms.realm1,recipeInventory:I},realm2:{...s.realms.realm2,recipeInventory:_},[s.activeRealm]:{...s.realms[s.activeRealm],recipeInventory:s.activeRealm==="realm1"?I:_,combat:{...o.combat,activeExpeditions:{...o.combat.activeExpeditions,[t]:[...V,P]}}}}}:zo(s,()=>({recipeInventory:A,combat:{...o.combat,activeExpeditions:{...o.combat.activeExpeditions,[t]:[...V,P]}}}))),!0},Em=(e,r)=>t=>{const a=e(),n=J(a),s=Bt(a.activeRealm,a.globalTier),o=n.combat.activeExpeditions[t]||[],i={...n.recipeInventory};for(const c of o){for(const g of s){const m=c.assignedUnits[g]??ue;m.gt(0)&&tt(i,g,m)}if(c.assignedEquipment)for(const[g,m]of Object.entries(c.assignedEquipment))m>0&&tt(i,g,new d(m))}const l={...n.combat.activeExpeditions};delete l[t];const p={...n.combat.expeditionSetups};delete p[t];const u={...n.combat.pendingRepeats};delete u[t],r(zo(a,()=>({recipeInventory:i,combat:{...n.combat,activeExpeditions:l,expeditionSetups:p,pendingRepeats:u}})))},Ha=1e3,nc=(e,r)=>{const t=e.activeRealm,a=e.realms[t],n={...a,...r(a)};return{realms:{...e.realms,[t]:n}}},Am=(e,r)=>t=>{const a=e(),n=J(a),s=Be[t];if(!s||xt(n.artifacts,t))return!1;const o=D(n.recipeInventory,"artifact_shard").toNumber(),i=D(n.recipeInventory,"mythic_fragment").toNumber();if(!jl(t,o,i))return!1;const l={...n.recipeInventory};return Po(t)?qe(l,"mythic_fragment",s.cost.mythicFragments):qe(l,"artifact_shard",s.cost.artifactShards),r(nc(a,()=>({recipeInventory:l,artifacts:{...n.artifacts,owned:{...n.artifacts.owned,[t]:!0},upgradeLevels:{...n.artifacts.upgradeLevels,[t]:1}}}))),!0},_m=(e,r)=>t=>{const a=e(),n=J(a),s=Be[t];if(!s||!xt(n.artifacts,t))return!1;const o=n.artifacts.upgradeLevels[t]??0,i=Un(t);if(o>=i)return!1;const l=D(n.recipeInventory,"artifact_shard").toNumber(),p=D(n.recipeInventory,"mythic_fragment").toNumber();if(!Gl(t,o,l,i,p))return!1;const u=ts(s,o,i),c={...n.recipeInventory};return Po(t)?qe(c,"mythic_fragment",u.mythicFragments):qe(c,"artifact_shard",u.artifactShards),r(nc(a,()=>({recipeInventory:c,artifacts:{...n.artifacts,upgradeLevels:{...n.artifacts.upgradeLevels,[t]:o+1}}}))),!0},qm=(e,r)=>t=>{const a=e(),n=a.realms.realm1,s=a.realms.realm2;if(!xt(n.artifacts,t)||D(n.recipeInventory,"nullstone").toNumber()<Ha)return!1;const i=n.artifacts.upgradeLevels[t]??0,l=xt(s.artifacts,t),p=s.artifacts.upgradeLevels[t]??0;if(l&&i<=p)return!1;const u={...n.recipeInventory};qe(u,"nullstone",new d(Ha));const c={...n.artifacts,owned:{...n.artifacts.owned,[t]:!1},upgradeLevels:{...n.artifacts.upgradeLevels,[t]:0}},g={...s.artifacts,owned:{...s.artifacts.owned,[t]:!0},upgradeLevels:{...s.artifacts.upgradeLevels,[t]:i}};return r({realms:{...a.realms,realm1:{...n,recipeInventory:u,artifacts:c},realm2:{...s,artifacts:g}}}),!0},Nm=2e4,sc=5,oc=gt.map(e=>({id:`gem_${e}`,type:"gem",tier:e,name:`T${e} Mana Gem`})),ic=Mt.map(e=>({id:`flask_${e}`,type:"flask",tier:e,name:`T${e} Flask`})),lc={id:"artifact_shard",type:"expedition_reward",name:"Artifact Shard"},cc={id:"nullstone",type:"expedition_reward",name:"Nullstone"},uc={id:"mythic_fragment",type:"expedition_reward",name:"Mythic Fragment"},Ra=e=>{const r=bt(e),t=an(e);return[...oc,...ic,...r.filter(a=>!t[a].ignoreModifiers).map(a=>({id:`military_${a}`,type:"military",militaryId:a,name:t[a].name})),...e==="realm1"||e==="realmU"?[lc]:[],...e==="realm1"?[cc]:[],...e==="realmU"?[uc]:[]]},na=e=>{if(e.startsWith("gem_")){const r=parseInt(e.slice(4));return oc.find(t=>t.tier===r)}if(e.startsWith("flask_")){const r=parseInt(e.slice(6));return ic.find(t=>t.tier===r)}if(e.startsWith("military_")){const r=e.slice(9);return{id:e,type:"military",militaryId:r,name:r}}if(e==="artifact_shard")return lc;if(e==="nullstone")return cc;if(e==="mythic_fragment")return uc},Bn=(e,r,t,a,n)=>{const s=r+1;if(s>Vs)return!1;const o=ta[s];if(!o)return!1;if(t!==void 0){if(s>=4){if(t!=="realm4")return!1}else if(s===3){if(t!=="realm3")return!1}else if(s===2&&Hl){if(t!=="realm2")return!1}else if(t!=="realm1")return!1}return s===5?(n??0)>=Oa:s===4?(n??0)>=3:s===3?(a??new d(0)).gte(Ln):e.gte(o.manaRequirement)},Ca=e=>e>=4?"realm4":e===3?"realm3":e===2&&Hl?"realm2":"realm1",Lm=e=>{let r=1;for(let t=1;t<=e;t++)ta[t]&&(r*=ta[t].crafterSpeedMultiplier);return r},Ci=["soulforge","forge_enhancer","soulcaster",...Object.keys(ht)],Um=(e,r)=>{const t=Ut("realm3"),a=Xn(e.ascension.lifetimePixies),n=Qa();for(const u of Ci)e.recipeInventory[u]&&(n[u]=e.recipeInventory[u]);const s=en();for(const u of Ci)e.recipeCrafting[u]&&(s[u]={...e.recipeCrafting[u]});e.recipeCrafting.arcane_soul&&(s.arcane_soul={...e.recipeCrafting.arcane_soul});const i={...ss(),portalBuilt:e.combat.portalBuilt,heroicVictories:e.combat.heroicVictories,completionsPerExpedition:e.combat.completionsPerExpedition},l={...e.ascension,ascendedSouls:e.ascension.ascendedSouls+a,lifetimePixies:0,totalAscensions:e.ascension.totalAscensions+1},p={...e.altar,tier:r,activeSacrifice:null,sacrificeProgress:0};return{...t,mana:new d(0),recipeInventory:n,recipeCrafting:s,altar:p,prestige:e.prestige,combat:i,ascension:l,creatureUpgrades:{},creatureUnlocks:{},workshopAssignments:{},wonderAssignments:{}}},Ma=(e,r)=>{const t=e.activeRealm,a=e.realms[t],n={...a,...r(a)};return{realms:{...e.realms,[t]:n}}},Mi=(e,r,t,a="realm1")=>{const n=Ut(a),s={...e.altar,tier:r,activeSacrifice:null,sacrificeProgress:0},o={...n,altar:s,prestige:e.prestige,ascension:e.ascension,combat:{...n.combat,portalBuilt:e.combat.portalBuilt,heroicVictories:e.combat.heroicVictories,completionsPerExpedition:e.combat.completionsPerExpedition},...t&&{artifacts:e.artifacts}};if(t){const i=e.recipeCrafting.artifact_shard;i&&o.recipeCrafting.artifact_shard&&(o.recipeCrafting.artifact_shard.lifetimeProduced=i.lifetimeProduced);const l=e.recipeCrafting.nullstone;l&&o.recipeCrafting.nullstone&&(o.recipeCrafting.nullstone.lifetimeProduced=l.lifetimeProduced);const p=e.recipeCrafting.mythic_fragment;p&&o.recipeCrafting.mythic_fragment&&(o.recipeCrafting.mythic_fragment.lifetimeProduced=p.lifetimeProduced)}return o},dc={t1_knight:"u_t1_knight",t4_knight:"u_t4_knight",t7_knight:"u_t7_knight",t2_boat:"u_t2_boat",t5_boat:"u_t5_boat",t3_beacon:"u_t3_beacon",t6_beacon:"u_t6_beacon"},gn=e=>dc[e]||e,Ii=e=>{if(e.startsWith("military_")){const r=e.slice(9),t=dc[r];if(t)return`military_${t}`}return e},Pm=(e,r)=>{const t=Zl(),a=Nm;for(const n of Object.keys(e)){const s=Ii(n);t[s]=Math.max(t[s]||0,Math.min(e[n]||0,a))}for(const n of Object.keys(r)){const s=Ii(n);t[s]=Math.max(t[s]||0,Math.min(r[n]||0,a))}return t},Fm=(e,r)=>{const t={},a={};for(const n of Object.keys(e.prestigeCounts)){const s=gn(n);t[s]=Math.max(t[s]||0,e.prestigeCounts[n]||0)}for(const n of Object.keys(r.prestigeCounts)){const s=gn(n);t[s]=Math.max(t[s]||0,r.prestigeCounts[n]||0)}for(const n of Object.keys(e.autoPrestige)){const s=gn(n);a[s]=a[s]||e.autoPrestige[n]}for(const n of Object.keys(r.autoPrestige)){const s=gn(n);a[s]=a[s]||r.autoPrestige[n]}return{prestigeCounts:t,autoPrestige:a}},Om=e=>{let r=new d(0);for(const t of $t){if(!e.artifacts.owned[t])continue;const a=Be[t],n=e.artifacts.upgradeLevels[t]??0;r=r.add(a.cost.artifactShards);for(let s=0;s<n;s++){const o=a.cost.artifactShards.mul(d.pow(a.costScaling,s));r=r.add(o)}}return r},Bm=(e,r,t)=>{const a=Ut("realmU"),n=Pm(e.altar.sacrificeCounts,r.altar.sacrificeCounts),s={tier:t,sacrificeCounts:n,activeSacrifice:null,sacrificeProgress:0,activeSacrifices:[]},o=Fm(e.prestige,r.prestige);delete o.prestigeCounts.nullstone,delete o.autoPrestige.nullstone;const i=Om(r),l={...e.artifacts},p={...a.recipeInventory},u=D(e.recipeInventory,"artifact_shard");p.artifact_shard=u.add(i);const c={},g={heroic_shard_affinity:"heroic_shard_affinity",heroic_prime_mastery:"heroic_unified_mastery",heroic_creatures:"heroic_creatures"},m={};for(const[T,w]of Object.entries(e.combat.heroicVictories)){const $=g[T];$&&(m[$]=Math.max(m[$]||0,w))}const h={...a.recipeCrafting},f=e.recipeCrafting.artifact_shard,v=r.recipeCrafting.artifact_shard;if(f||v){const T=(f==null?void 0:f.lifetimeProduced)??new d(0),w=(v==null?void 0:v.lifetimeProduced)??new d(0);h.artifact_shard={assignment:0,progress:0,lifetimeProduced:d.max(T,w)}}const S=e.recipeCrafting.mythic_fragment,b=r.recipeCrafting.mythic_fragment;if(S||b){const T=(S==null?void 0:S.lifetimeProduced)??new d(0),w=(b==null?void 0:b.lifetimeProduced)??new d(0);h.mythic_fragment={assignment:0,progress:0,lifetimeProduced:d.max(T,w)}}return{...a,recipeInventory:p,recipeCrafting:h,altar:s,prestige:o,artifacts:l,combat:{...a.combat,portalBuilt:e.combat.portalBuilt||r.combat.portalBuilt,heroicVictories:m,completionsPerExpedition:c}}},Dm=(e,r)=>()=>{const t=e(),a=J(t),n=t.globalTier+1,s=Ca(n);if(t.activeRealm!==s)return!1;const o=n===3?D(a.recipeInventory,"pixie"):new d(0),i=t.realms.realm4.heroicTrialCompleted;if(!Bn(a.mana,t.globalTier,t.activeRealm,o,i))return!1;const l=n>=2;if(n===4||n===5){const p=t.realms.realm4.heroicTrialCompleted,u={};for(const c of["realm1","realm2","realm3","realmU","realm4"])u[c]=Ut(c);return u.realmU={...u.realmU,combat:{...u.realmU.combat,portalBuilt:!0}},u.realm4={...u.realm4,heroicTrialCompleted:p},r({realms:u,activeRealm:"realmU",realm2Unlocked:!1,realm3Unlocked:!0,realmUUnlocked:!0,earthPortalBuilt:!1,breedingArtifactUnlocked:p>=2,knightDuplicationUnlocked:p>=4,ascensionCapBonus:0,villageUnlocked:!1,globalTier:n,lastFrameTimestamp:Date.now(),lastSaveTimestamp:0}),!0}if(n===3){const p=t.realms.realm1,u=t.realms.realm2,c=t.realms.realm3,g=Bm(p,u,n),m=Um(c,n);r({realms:{...t.realms,realm1:t.realms.realm1,realm2:t.realms.realm2,realm3:m,realmU:g},activeRealm:"realmU",realmUUnlocked:!0,globalTier:n,lastFrameTimestamp:Date.now(),lastSaveTimestamp:0})}else if(n===2){const p={};for(const u of wd){const c=t.realms[u];p[u]=Mi(c,n,l,u)}p.realmU=t.realms.realmU,p.realm4=t.realms.realm4,r({realms:p,globalTier:n,lastFrameTimestamp:Date.now(),lastSaveTimestamp:0})}else{const p=Mi(a,n,l,t.activeRealm);r({realms:{...t.realms,[t.activeRealm]:p},globalTier:n,lastFrameTimestamp:Date.now(),lastSaveTimestamp:0})}return!0},Hm=(e,r)=>t=>{const a=e(),n=J(a);if(a.globalTier<1)return!1;const s=na(t);if(!s)return!1;const i=De(a.activeRealm).MODIFIERS.sacrificeCap;if(isFinite(i)&&(n.altar.sacrificeCounts[t]||0)>=i)return!1;let l=null;if(s.type==="gem"&&s.tier!==void 0?l=`gem_${s.tier}`:s.type==="flask"&&s.tier!==void 0?l=`flask_${s.tier}`:s.type==="military"&&s.militaryId!==void 0?l=s.militaryId:s.type==="expedition_reward"&&(l=t),!(l?D(n.recipeInventory,l).gte(1):!1))return!1;if(a.activeRealm==="realmU"){const u=n.altar.activeSacrifices.includes(t);return r(u?Ma(a,()=>({altar:{...n.altar,activeSacrifices:n.altar.activeSacrifices.filter(c=>c!==t)}})):Ma(a,()=>({altar:{...n.altar,activeSacrifices:[...n.altar.activeSacrifices,t]}}))),!0}return r(Ma(a,()=>({altar:{...n.altar,activeSacrifice:t,sacrificeProgress:0}}))),!0},Vm=(e,r)=>t=>{const a=e(),n=J(a);if(a.activeRealm==="realmU"&&t){r(Ma(a,()=>({altar:{...n.altar,activeSacrifices:n.altar.activeSacrifices.filter(s=>s!==t)}})));return}r(Ma(a,()=>({altar:{...n.altar,activeSacrifice:null,sacrificeProgress:0}})))},jm=(e,r)=>t=>{const a=e(),n=a.activeRealm,s=J(a),o=D(s.recipeInventory,t),i=s.prestige.prestigeCounts[t]||0;if(!as(t,o,i))return!1;const l=rs(i),p={...s.recipeInventory};p[t]=o.sub(l);const u={...s.prestige.prestigeCounts};return u[t]=i+1,r(c=>({realms:{...c.realms,[n]:{...c.realms[n],recipeInventory:p,prestige:{...c.realms[n].prestige,prestigeCounts:u}}}})),!0},Gm=(e,r)=>t=>{const a=e(),n=a.activeRealm,o=J(a).prestige.autoPrestige[t]??!1;r(i=>({realms:{...i.realms,[n]:{...i.realms[n],prestige:{...i.realms[n].prestige,autoPrestige:{...i.realms[n].prestige.autoPrestige,[t]:!o}}}}}))},Ks=e=>{var n;const r=me("soulforge"),t=((n=e.recipeCrafting.soulforge)==null?void 0:n.lifetimeProduced)??0,a=new d(r.escalatingCost??10).pow(t);return r.recipe[0].amount.mul(a)},Wm=(e,r)=>()=>{var c;const t=e(),a=t.globalTier>=3?"realmU":"realm1",n=t.realms[a],s=t.realms.realm3,o=Ks(s);if(!Ja(n.recipeInventory,Ua,o))return!1;const i={...n.recipeInventory};qe(i,Ua,o);const l={...s.recipeInventory};tt(l,"soulforge",new d(1));const p={...s.recipeCrafting},u=((c=p.soulforge)==null?void 0:c.lifetimeProduced)??ue;return p.soulforge={...p.soulforge??{assignment:0,progress:0,lifetimeProduced:ue},lifetimeProduced:u.add(1)},r({realms:{...t.realms,[a]:{...n,recipeInventory:i},realm3:{...s,recipeInventory:l,recipeCrafting:p}}}),!0},Ys=e=>{const r=me("forge_enhancer"),t=Oe(e.recipeCrafting,"forge_enhancer"),a=new d(r.escalatingCost??10).pow(t);return r.recipe[0].amount.mul(a)},Km=(e,r)=>()=>{var u;const t=e(),a=t.realms.realm2,n=t.realms.realm3,s=Ys(n);if(!Ja(a.recipeInventory,Pa,s))return!1;const o={...a.recipeInventory};qe(o,Pa,s);const i={...n.recipeInventory};tt(i,"forge_enhancer",new d(1));const l={...n.recipeCrafting},p=((u=l.forge_enhancer)==null?void 0:u.lifetimeProduced)??ue;return l.forge_enhancer={...l.forge_enhancer??{assignment:0,progress:0,lifetimeProduced:ue},lifetimeProduced:p.add(1)},r({realms:{...t.realms,realm2:{...a,recipeInventory:o},realm3:{...n,recipeInventory:i,recipeCrafting:l}}}),!0},zs=e=>{const r=me("soulcaster"),t=Oe(e.recipeCrafting,"soulcaster"),a=new d(r.escalatingCost??10).pow(t);return r.recipe[0].amount.mul(a)},Ym=(e,r)=>()=>{var l;const t=e(),a=t.realms.realm3,n=zs(a);if(!Ja(a.recipeInventory,An,n))return!1;const s={...a.recipeInventory};qe(s,An,n),tt(s,"soulcaster",new d(1));const o={...a.recipeCrafting},i=((l=o.soulcaster)==null?void 0:l.lifetimeProduced)??ue;return o.soulcaster={...o.soulcaster??{assignment:0,progress:0,lifetimeProduced:ue},lifetimeProduced:i.add(1)},r({realms:{...t.realms,realm3:{...a,recipeInventory:s,recipeCrafting:o}}}),!0},Gr=(e,r,t=0)=>{const a=Ds[e];return a?a.requiredHeroicTrial&&t<a.requiredHeroicTrial?!1:Oe(r,a.requiredRecipe)>=a.lifetimeThreshold:!0},zm=(e,r)=>e==="one"?d.min(new d(1),d.floor(r)):e==="ten_percent"?d.max(1,d.floor(r.mul(.1))):d.floor(r),Xm=(e,r)=>{const t=me(r);if(t.recipe.length===0)return new d(1/0);let a=new d(1/0);for(const n of t.recipe)if(n.recipeId){const s=D(e,n.recipeId);a=d.min(a,d.floor(s.div(n.amount)))}return a},Zm=(e,r,t)=>{const a=me(r);for(const n of a.recipe)n.recipeId&&qe(e,n.recipeId,n.amount.mul(t))},Qm=(e,r)=>t=>{var c;const a=e(),n=a.realms.realm3,s=me(t);if(s.category!=="building")return!1;const o=((c=n.recipeCrafting[t])==null?void 0:c.lifetimeProduced)??0,i=new d(s.escalatingCost??1).pow(o),l={...n.recipeInventory};for(const g of s.recipe)if(g.recipeId){const m=g.amount.mul(i);if(!Ja(l,g.recipeId,m))return!1}for(const g of s.recipe)g.recipeId&&qe(l,g.recipeId,g.amount.mul(i));tt(l,t,new d(1));const p={...n.recipeCrafting},u=p[t]??{assignment:0,progress:0,lifetimeProduced:ue};return p[t]={...u,lifetimeProduced:u.lifetimeProduced.add(1)},r({realms:{...a.realms,realm3:{...n,recipeInventory:l,recipeCrafting:p}}}),!0},Jm=(e,r)=>(t,a)=>{const n=e(),s=n.realms.realm3;if(!Gr(t,s.recipeCrafting,n.realms.realm4.heroicTrialCompleted))return!1;const o=Xm(s.recipeInventory,t),i=d.min(zm(a,o),o);if(i.lte(0))return!1;const l={...s.recipeInventory};Zm(l,t,i),tt(l,t,i);const p={...s.recipeCrafting},u=p[t]??{assignment:0,progress:0,lifetimeProduced:ue};return p[t]={...u,lifetimeProduced:u.lifetimeProduced.add(i)},r({realms:{...n.realms,realm3:{...s,recipeInventory:l,recipeCrafting:p}}}),!0},ep=(e,r)=>t=>{const a=e(),n=a.realms.realm3,s=n.autoBuyCreatures[t]??!1;r({realms:{...a.realms,realm3:{...n,autoBuyCreatures:{...n.autoBuyCreatures,[t]:!s}}}})},tp=(e,r)=>(t,a)=>{const n=e(),s=n.realms.realm3;r({realms:{...n.realms,realm3:{...s,autoBuyCreatureLimits:{...s.autoBuyCreatureLimits,[t]:a}}}})},Ei=["soulforge","forge_enhancer","soulcaster",...Object.keys(ht)],rp=(e,r)=>()=>{const t=e(),a=t.realms.realm3;if(!In(a.ascension.lifetimePixies))return!1;const n=Xn(a.ascension.lifetimePixies);if(n<=0)return!1;const s=Qa();for(const c of Ei)a.recipeInventory[c]&&(s[c]=a.recipeInventory[c]);const o=en();for(const c of Ei)a.recipeCrafting[c]&&(o[c]={...a.recipeCrafting[c]});a.recipeCrafting.arcane_soul&&(o.arcane_soul={...a.recipeCrafting.arcane_soul});const l={...ss(),portalBuilt:a.combat.portalBuilt,heroicVictories:a.combat.heroicVictories,completionsPerExpedition:a.combat.completionsPerExpedition},p={...a.ascension,ascendedSouls:a.ascension.ascendedSouls+n,lifetimePixies:0,totalAscensions:a.ascension.totalAscensions+1},u={};return r({realms:{...t.realms,realm3:{...a,mana:new d(0),recipeInventory:s,recipeCrafting:o,combat:l,creatureUpgrades:{},creatureUnlocks:{},workshopAssignments:{},wonderAssignments:u,ascension:p}}}),!0},ap=(e,r)=>t=>{const a=e(),n=a.realms.realm3;if(!zn[t])return!1;const o=Ft(n.ascension,t),i=wn(t,a.ascensionCapBonus);if(o>=i)return!1;const l=En(t,o);if(n.ascension.ascendedSouls<l)return!1;const p={...n.ascension,ascendedSouls:n.ascension.ascendedSouls-l,upgrades:{...n.ascension.upgrades,[t]:o+1}};return r({realms:{...a.realms,realm3:{...n,ascension:p}}}),!0},Dn="1.29",ba=e=>({mana:e.mana.toString(),recipeInventory:Rd(e.recipeInventory),recipeCrafting:Md(e.recipeCrafting),upgrades:Od(e.upgrades),autoBuyUpgrades:e.autoBuyUpgrades,autoBuyCreatures:e.autoBuyCreatures,autoBuyCreatureLimits:e.autoBuyCreatureLimits,combat:fm(e.combat),artifacts:rm(e.artifacts),altar:mm(e.altar),prestige:um(e.prestige),creatureUpgrades:e.creatureUpgrades,creatureUnlocks:e.creatureUnlocks,workshopAssignments:e.workshopAssignments,wonderAssignments:e.wonderAssignments,ascension:e.ascension,soulcasterAllocations:e.soulcasterAllocations,towerProgress:e.towerProgress,towerLevels:e.towerLevels,heroicTrialCompleted:e.heroicTrialCompleted,autoAllResearch:e.autoAllResearch,autoAllPrestige:e.autoAllPrestige,autoAllSacrifice:e.autoAllSacrifice}),xa=(e,r="realm1")=>{var i,l;if(!e)return Ut(r);const t=e.artifacts?am(e.artifacts):Fo(),a=e.combat?xm(e.combat):ss(),n=e.recipeInventory?Cd(e.recipeInventory):Qa(),s=e.recipeCrafting?Id(e.recipeCrafting):en();let o=e.upgrades?Bd(e.upgrades):Ro();if((i=e.upgrades)!=null&&i.r1MilitaryStrength&&!((l=e.upgrades)!=null&&l.t1KnightStrength)){const p=e.upgrades.r1MilitaryStrength;o={...o,t1KnightStrength:p,t4KnightStrength:p,t7KnightStrength:p}}return{mana:new d(e.mana||0),recipeInventory:n,recipeCrafting:s,upgrades:o,autoBuyUpgrades:e.autoBuyUpgrades||{},autoBuyCreatures:e.autoBuyCreatures||{},autoBuyCreatureLimits:e.autoBuyCreatureLimits||{},combat:a,artifacts:t,altar:e.altar?pm(e.altar):Ho(),prestige:e.prestige?dm(e.prestige):Yl(),creatureUpgrades:e.creatureUpgrades||{},creatureUnlocks:e.creatureUnlocks||{},workshopAssignments:e.workshopAssignments||{},wonderAssignments:e.wonderAssignments||{},ascension:e.ascension?e.ascension:wo(),soulcasterAllocations:e.soulcasterAllocations||{gem_tower:0,military_tower:0},towerProgress:e.towerProgress||{gem_tower:0,military_tower:0},towerLevels:e.towerLevels||{gem_tower:0,military_tower:0},heroicTrialCompleted:e.heroicTrialCompleted??0,autoAllResearch:e.autoAllResearch??!1,autoAllPrestige:e.autoAllPrestige??!1,autoAllSacrifice:e.autoAllSacrifice??!1}},mc=e=>JSON.stringify({version:Dn,realms:{realm1:ba(e.realms.realm1),realm2:ba(e.realms.realm2),realm3:ba(e.realms.realm3),realmU:ba(e.realms.realmU),realm4:ba(e.realms.realm4)},activeRealm:e.activeRealm,realm2Unlocked:e.realm2Unlocked,realm3Unlocked:e.realm3Unlocked,realmUUnlocked:e.realmUUnlocked,globalTier:e.globalTier,backgroundImageOff:e.backgroundImageOff,uiScale:e.uiScale,lastFrameTimestamp:e.lastFrameTimestamp,totalPlaytime:e.totalPlaytime,skippedTime:e.skippedTime,timeWarpCharges:e.timeWarpCharges,villageUnlocked:e.villageUnlocked,collapsedSections:e.collapsedSections,dismissedTips:e.dismissedTips,paused:e.paused,earthPortalBuilt:e.earthPortalBuilt,scientificNotationThreshold:e.scientificNotationThreshold,hideMaxUpgrades:e.hideMaxUpgrades,breedingArtifactUnlocked:e.breedingArtifactUnlocked,knightDuplicationUnlocked:e.knightDuplicationUnlocked,ascensionCapBonus:e.ascensionCapBonus}),pc=e=>{var r,t,a,n;try{const s=JSON.parse(e),o=s.version||null;if(!o)return{state:null,incompatible:!0,savedVersion:o};if(parseFloat(o)<.4)return{state:null,incompatible:!0,savedVersion:o};if(!s.realms||!((r=s.realms.realm1)!=null&&r.recipeInventory))return{state:null,incompatible:!0,savedVersion:o};const i=St.includes(s.activeRealm)?s.activeRealm:"realm1",l=xa(s.realms.realm1,"realm1"),p=xa(s.realms.realm2,"realm2"),u=xa(((t=s.realms)==null?void 0:t.realm3)??null,"realm3"),c=xa(((a=s.realms)==null?void 0:a.realmU)??null,"realmU"),g=xa(((n=s.realms)==null?void 0:n.realm4)??null,"realm4"),m=s.globalTier??l.altar.tier;return(s.realmUUnlocked??!1)&&!c.combat.portalBuilt&&(c.combat={...c.combat,portalBuilt:!0}),{state:{realms:{realm1:l,realm2:p,realm3:u,realmU:c,realm4:g},activeRealm:i,realm2Unlocked:s.realm2Unlocked??!1,realm3Unlocked:s.realm3Unlocked??!1,realmUUnlocked:s.realmUUnlocked??!1,globalTier:m,backgroundImageOff:s.backgroundImageOff??!1,uiScale:s.uiScale??1,lastFrameTimestamp:s.lastFrameTimestamp||Date.now(),totalPlaytime:s.totalPlaytime??0,skippedTime:s.skippedTime??0,timeWarpCharges:s.timeWarpCharges??0,villageUnlocked:s.villageUnlocked??!1,collapsedSections:Array.isArray(s.collapsedSections)?s.collapsedSections:[],dismissedTips:Array.isArray(s.dismissedTips)?s.dismissedTips:[],paused:s.paused??!1,earthPortalBuilt:s.earthPortalBuilt??!1,scientificNotationThreshold:s.scientificNotationThreshold??1e15,hideMaxUpgrades:s.hideMaxUpgrades??!0,breedingArtifactUnlocked:s.breedingArtifactUnlocked??!1,knightDuplicationUnlocked:s.knightDuplicationUnlocked??!1,ascensionCapBonus:s.ascensionCapBonus??0},incompatible:!1,savedVersion:o}}catch{return{state:null,incompatible:!1,savedVersion:null}}},Va="evercraft-save",ja="evercraft-last-frame",Ga="evercraft-last-save",np=5e3;let Xo=!1,Zo=0;const sp=()=>Xo,op=()=>Zo,Ai=()=>{Xo=!1,Zo=0},Xs=()=>Dn,ip=e=>()=>{localStorage.removeItem(Va),localStorage.removeItem(ja),localStorage.removeItem(Ga),e(Wo())},lp=e=>()=>{const r=e(),t=mc(r);return btoa(t)},cp=(e,r,t)=>a=>{try{const n=atob(a),s=pc(n);if(s.incompatible){let o=0;try{o=JSON.parse(n).globalTier??0}catch{}const i=Wo();return r(i),localStorage.removeItem(Va),localStorage.removeItem(ja),localStorage.removeItem(Ga),t(!0),{success:!1,incompatible:!0,oldTier:o}}return s.state?(r({...s.state}),t(!0),{success:!0,incompatible:!1}):{success:!1,incompatible:!1}}catch{return{success:!1,incompatible:!1}}},up=(e,r)=>(t=!1)=>{const a=e(),n=Date.now();!t&&n-a.lastSaveTimestamp<np||(localStorage.setItem(Va,mc(a)),localStorage.setItem(ja,a.lastFrameTimestamp.toString()),localStorage.setItem(Ga,n.toString()),r({lastSaveTimestamp:n}))},dp=e=>()=>{const r=localStorage.getItem(Va),t=localStorage.getItem(ja),a=localStorage.getItem(Ga);if(r){const n=pc(r);if(n.state||localStorage.setItem("evercraft-save-corrupt",r),n.incompatible){try{Zo=JSON.parse(r).globalTier??0}catch{}Xo=!0,localStorage.removeItem(Va),localStorage.removeItem(ja),localStorage.removeItem(Ga);return}n.state&&e({...n.state,lastFrameTimestamp:t?parseInt(t,10):Date.now(),lastSaveTimestamp:a?parseInt(a,10):0})}},Wa={gem_tower:{id:"gem_tower",name:"Gem Tower",icon:H("icons/gem tower.png"),description:"Increases gem output across all realms",baseCost:1e3,costScaling:3,effectBase:1.2,affectsCategory:"gem"},military_tower:{id:"military_tower",name:"Military Tower",icon:H("icons/military tower.png"),description:"x2 military input and output per level (Unified Realm only)",baseCost:1e3,costScaling:3,effectBase:2,affectsCategory:"military"}},xr=["gem_tower","military_tower"],Hn=(e,r)=>e.baseCost*Math.pow(e.costScaling,r),hn=(e,r)=>Math.pow(e.effectBase,r),Ia=[{index:0,name:"Trial of Wisdom",cost:100,rewardDescription:"Unlock the Emperor in Realm of Magic"},{index:1,name:"Trial of Life",cost:1e3,rewardDescription:"Unlock the Breeding Artifact in Unified Realm"},{index:2,name:"Trial of Dominion",cost:1e4,rewardDescription:"Enable Tier 4 reset"},{index:3,name:"Trial of Duplication",cost:1e5,rewardDescription:"Unlock the Knight Duplication artifact in Unified Realm",requiredTier:4},{index:4,name:"Trial of Alchemy",cost:1e6,rewardDescription:"x10 flask output across all realms",requiredTier:4},{index:5,name:"Trial of Valor",cost:1e7,rewardDescription:"Enable Tier 5 reset",requiredTier:4},{index:6,name:"Heroic Trial",cost:1e12,rewardDescription:"TBD",requiredTier:5}],mp=4,pp=10,fc=e=>e>mp?pp:1;H("icons/heroic trial.png");const fp=H("icons/portal knight.png"),gp=(e,r)=>({setSoulcasterAllocation:(t,a)=>{const n=r(),s=n.realms.realm4,o=n.realms.realm3.recipeInventory,i=ot(D(o,"soulcaster")),l=Math.max(0,Math.floor(a)),p=t==="gem_tower"?"military_tower":"gem_tower",u=s.soulcasterAllocations[p],c=Math.min(l,Math.max(0,i-u));e({realms:{...n.realms,realm4:{...s,soulcasterAllocations:{...s.soulcasterAllocations,[t]:c}}}})},completeHeroicTrial:()=>{const t=r(),a=t.realms.realm4,n=a.heroicTrialCompleted;if(n>=Ia.length)return!1;const s=Ia[n];if(s.requiredTier&&t.globalTier<s.requiredTier)return!1;const o=t.realms.realmU;if(ot(D(o.recipeInventory,"u_portal_knight"))<s.cost)return!1;const l={...o.recipeInventory};qe(l,"u_portal_knight",new d(s.cost));const p={};return n===1&&(p.breedingArtifactUnlocked=!0),n===3&&(p.knightDuplicationUnlocked=!0),e({...p,realms:{...t.realms,realmU:{...o,recipeInventory:l},realm4:{...a,heroicTrialCompleted:n+1}}}),!0}}),hp=new Set(["t1_knight","t4_knight","t7_knight","u_t1_knight","u_t4_knight","u_t7_knight"]),gc=e=>hp.has(e),Ar=(e,r)=>{if(!r)return 1;for(const t of Object.keys(Wa)){const a=Wa[t];if(a.affectsCategory===e){const n=r[t]??0;if(n>0)return Math.pow(a.effectBase,n)}}return 1},hc=(e,r)=>{if(e.realmFilter&&r.realmId&&!e.realmFilter.includes(r.realmId)||e.minGlobalTier!==void 0&&(r.globalTier??0)<e.minGlobalTier||e.maxGlobalTier!==void 0&&(r.globalTier??0)>e.maxGlobalTier)return Sa;if(e.type==="inventory"&&r.recipeInventory){const t=ot(r.recipeInventory[e.source]??ue);return mt(e.formula(t))}if(e.type==="ascension"&&r.ascension){const t=r.ascension.upgrades[e.source]??0;return mt(e.formula(t))}return Sa},_i=(e,r,t)=>{const a=Fa(),n=t?Wl(t,r):new d(1);return a.mul(n)},Vn=(e,r,t,a,n,s,o,i,l)=>{const p=me(e);let u;if(p.ignoreModifiers)u=new d(1);else{const c=p.tier,g=p.category,m=Mo(r);u=new d(o).mul(m),g==="gem"&&c?u=u.mul(Fa()).mul(Hs()).mul(yi()).mul(Oo(t,c)).mul(c<=4?wi():1).mul(c>=5&&c<=6?Si():1).mul(Ql(a.sacrificeCounts,c,n)).mul(s).mul(Io(r)):g==="flask"&&c?u=u.mul(Fa()).mul(Hs()).mul(yi()).mul(c<=4?wi():1).mul(c>=5&&c<=6?Si():1).mul(Jl(a.sacrificeCounts,c,n)).mul(s):g==="military"&&(u=u.mul(ec(a.sacrificeCounts,e,n)).mul(Do(t)),gc(e)&&(u=u.mul(Bo(t)))),i&&(u=u.mul(at(i.prestigeCounts,e)))}if(p.outputMultipliers&&l)for(const c of p.outputMultipliers){const g=hc(c,l);g.eq(1)||(u=u.mul(g))}if(p.category==="gem"&&(l!=null&&l.r3Inventory)&&l.realmId){const c=$l(l.r3Inventory,l.realmId);c!==1&&(u=u.mul(c))}if(l!=null&&l.r4TowerLevels){if(p.category==="gem"){const c=Ar("gem",l.r4TowerLevels);c!==1&&(u=u.mul(c))}if(p.category==="military"&&l.realmId==="realmU"){const c=Ar("military",l.r4TowerLevels);c!==1&&(u=u.mul(c))}}if(l!=null&&l.globalTier&&l.globalTier>=4&&(u=u.mul(Tt(l.globalTier))),p.category==="flask"&&(l==null?void 0:l.heroicTrialCompleted)!==void 0){const c=fc(l.heroicTrialCompleted);c!==1&&(u=u.mul(c))}return u},xs=(e,r,t,a,n,s,o,i,l,p)=>{const u=me(e),c=u.tier,g=u.category,m=[];if(!u.ignoreModifiers&&((g==="gem"||g==="flask")&&c?(m.push({label:"Production mult",value:Fa()}),m.push({label:"Yield mult",value:Hs()}),g==="gem"?(m.push({label:"Artifact output",value:Oo(t,c)}),m.push({label:"Sacrifice bonus",value:Ql(a.sacrificeCounts,c,n)}),m.push({label:"Gem Manufacturing",value:Io(r)})):m.push({label:"Sacrifice bonus",value:Jl(a.sacrificeCounts,c,n)}),m.push({label:"Quest bonus",value:new d(s)})):g==="military"&&(m.push({label:"Sacrifice bonus",value:ec(a.sacrificeCounts,e,n)}),m.push({label:"Army Banner",value:Do(t)}),gc(e)&&m.push({label:"Knight Duplication",value:Bo(t)})),m.push({label:"Heroic mastery",value:new d(o)}),p!==void 0&&p!==1&&m.push({label:"Realm of Magic Heroic",value:new d(p)}),m.push({label:"Crafter's Guild",value:Mo(r)}),m.push({label:"Prestige",value:i?at(i.prestigeCounts,e):new d(1)}),g==="gem"&&(l!=null&&l.r3Inventory)&&l.realmId)){const f=$l(l.r3Inventory,l.realmId);m.push({label:"Enchanting Tower",value:new d(f)})}if(l!=null&&l.r4TowerLevels){if(g==="gem"){const f=Ar("gem",l.r4TowerLevels);f!==1&&m.push({label:"Gem Tower",value:new d(f)})}if(g==="military"&&(l==null?void 0:l.realmId)==="realmU"){const f=Ar("military",l.r4TowerLevels);f!==1&&m.push({label:"Military Tower",value:new d(f)})}}if(l!=null&&l.globalTier&&l.globalTier>=4){const f=Tt(l.globalTier);m.push({label:`Tier ${l.globalTier>=5?5:4} bonus`,value:new d(f)})}if(u.outputMultipliers&&l)for(const f of u.outputMultipliers){const v=hc(f,l);m.push({label:f.label,value:v})}if(g==="flask"&&(l==null?void 0:l.heroicTrialCompleted)!==void 0){const f=fc(l.heroicTrialCompleted);f!==1&&m.push({label:"Trial of Alchemy",value:new d(f)})}const h=m.reduce((f,v)=>f.mul(v.value),new d(1));return{multipliers:m,total:h}},ys=(e,r,t,a,n)=>{const s=me(e),o=s.tier,i=s.category,l=[];if(!s.ignoreModifiers&&((i==="gem"||i==="flask")&&o&&(l.push({label:"Production mult",value:Fa()}),l.push({label:"Artifact input",value:Wl(t,o)})),i==="gem"&&l.push({label:"Cheaper Gems",value:Ao(r)}),i==="flask"&&(l.push({label:"Flask recipe mult",value:new d(a)}),l.push({label:"Cheaper Flasks",value:_o(r)})),i==="military")){l.push({label:"Cheaper Expedition Units",value:qo(r)});const u=No(r,e);u.eq(1)||l.push({label:"Sword Efficiency",value:u})}if(i==="military"&&(n==null?void 0:n.realmId)==="realmU"&&n.r4TowerLevels){const u=Ar("military",n.r4TowerLevels);u!==1&&l.push({label:"Military Tower",value:new d(u)})}const p=l.reduce((u,c)=>u.mul(c.value),new d(1));return{multipliers:l,total:p}},Ea=(e,r,t,a,n)=>{const s=me(e);if(s.ignoreModifiers)return s.recipe.map(l=>{let p=l.amount;if(s.category==="military"&&(n==null?void 0:n.realmId)==="realmU"&&n.r4TowerLevels){const u=Ar("military",n.r4TowerLevels);u!==1&&(p=p.mul(u))}return{type:l.type,recipeId:l.recipeId,amount:p}});const o=s.tier,i=s.category;return s.recipe.map(l=>{let p=l.amount;if(i==="gem"&&o){if(!(o===1&&l.type==="mana")){const c=_i(r,o,t);p=p.mul(c)}p=p.mul(Ao(r))}else if(i==="flask"&&o){const u=_i(r,o,t);p=p.mul(u).mul(a),p=p.mul(_o(r))}else if(i==="military"&&(p=p.mul(qo(r)),p=p.mul(No(r,e)),(n==null?void 0:n.realmId)==="realmU"&&n.r4TowerLevels)){const u=Ar("military",n.r4TowerLevels);u!==1&&(p=p.mul(u))}return{type:l.type,recipeId:l.recipeId,amount:p}})},Qo=(e,r,t,a,n)=>{const s=me(e);if(s.ignoreModifiers)return 1;let i=Lm(a)/n;return s.category==="military"&&(i*=zd()),i*=Kl(t),i},Jo=(e,r,t,a,n,s,o,i,l,p,u,c,g,m,h=1,f=1)=>{const v=es(l),S=p.completionsPerExpedition??{};let b=new d(0);const T={},w=Zn(l);for(const R of w){T[R]=new d(0);const x=e[R];if(!x||x.assignment<=0)continue;const y=me(R),k=y.tier??0,C=v?v(k,S):1,_=Qo(R,r,t,n,s)/y.craftTime;let A=Vn(R,r,t,a,o,C,c,g,m);R==="arcane_soul"&&h!==1&&(A=A.mul(h)),y.category==="gem"&&f!==1&&(A=A.mul(f)),T[R]=T[R].add(new d(x.assignment).mul(_).mul(A));const F=Ea(R,r,t,u,{realmId:l,r4TowerLevels:m==null?void 0:m.r4TowerLevels});for(const E of F){const P=E.amount.mul(x.assignment).mul(_);E.type==="mana"?b=b.sub(P):E.recipeId&&(T[E.recipeId]||(T[E.recipeId]=new d(0)),T[E.recipeId]=T[E.recipeId].sub(P))}}const $=a.activeSacrifices.length>0?a.activeSacrifices:a.activeSacrifice?[a.activeSacrifice]:[];for(const R of $){let x=null;R.startsWith("military_")?x=R.replace("military_",""):x=R,x&&T[x]!==void 0?T[x]=T[x].sub(new d(i)):x&&(T[x]=new d(-i))}return{mana:b,recipes:T}},vp=(e,r,t=1,a=0,n=0)=>{const s={};let o=ue;const i=Tt(n),l=mt(Mn(e,a)*t*i),p=mt(r?Na(r):1);for(const[u,c]of Object.entries(dr)){const g=e[u]??ue;if(g.lte(0))continue;const m=mt(c.amountPerCycle/c.cycleDuration).mul(g).mul(l).mul(p);c.produces==="mana"?o=o.add(m):s[c.produces]=(s[c.produces]??ue).add(m)}return{recipes:s,mana:o}},bp=10080*60*1e3,GAME_SPEED_MULT=50,qi=(e,r,t,a)=>{for(const n of e){const s=n.amount.mul(r);if(n.type==="mana"){if(t.lt(s))return!1}else if(n.recipeId&&!Ja(a,n.recipeId,s))return!1}return!0},xp=(e,r,t,a)=>{let n=t;for(const s of e){const o=s.amount.mul(r);s.type==="mana"?n=n.sub(o):s.recipeId&&qe(a,s.recipeId,o)}return n},yp=(e,r,t,a,n,s={},o,i,l={},p="realm1",u,c=0,g=0,m=1)=>{var je;const h=De(e),f=h.MODIFIERS.craftTimeMultiplier,v=h.MODIFIERS.flaskRecipeMultiplier,S=h.MODIFIERS.manaModifier,b=h.MODIFIERS.calculateSacrificeBonus,T=h.MODIFIERS.sacrificeCap,w=h.MODIFIERS.sacrificeBatchSize*ca(r.upgrades),$=es(e),R=Er(s,e,p);let x=r.mana;const y={};for(const[ae,ne]of Object.entries(r.recipeInventory))y[ae]=ne;const k={};for(const[ae,ne]of Object.entries(r.recipeCrafting))k[ae]={...ne};const C=Zn(e),I=e!=="realm3"&&(i!=null&&i.realm3)?i.realm3:void 0,_={recipeInventory:y,ascension:o,realmId:e,r3Inventory:I,globalTier:n,r4TowerLevels:u,heroicTrialCompleted:g},A={},F={},E={};for(const ae of C){const pe=me(ae).tier??0,z=$?$(pe,r.combat.completionsPerExpedition):1;A[ae]=Ea(ae,r.upgrades,r.artifacts,v,{realmId:e,r4TowerLevels:u}),F[ae]=Vn(ae,r.upgrades,r.artifacts,r.altar,b,z,R,r.prestige,_),E[ae]=Qo(ae,r.upgrades,r.artifacts,n,f)}if(e!=="realm3"){const ae=on(l);if(ae!==1)for(const ne of C)me(ne).category==="gem"&&(F[ne]=F[ne].mul(ae))}if(e==="realm3"&&F.arcane_soul){const ae=Ba(r.combat.heroicVictories);ae!==1&&(F.arcane_soul=F.arcane_soul.mul(ae))}const P=ae=>{const ne=k[ae];if(!ne||ne.assignment<=0)return!1;const pe=A[ae];if(!qi(pe,ne.assignment,x,y))return!1;x=xp(pe,ne.assignment,x,y);const z=F[ae].mul(ne.assignment);return tt(y,ae,z),ne.lifetimeProduced=ne.lifetimeProduced.add(z),ne.progress=0,!0},V=()=>{for(const ae of C){const ne=k[ae];ne&&ne.progress>=1&&P(ae)}},j=()=>Xt(y);let B=t/1e3;const oe=B>600,U={};let O={...r.combat},K=0;const se=[],be=Jn(r.upgrades);let G=0;const L=So(e);let Y=Mn(y,c);e==="realm3"&&(Y*=lr(r.combat.heroicVictories),Y*=lr(s,p));const X=Tt(n);X>1&&(Y*=X);const ie=e==="realm3"?Na(r.ascension):1;let re=ue;const ce=ae=>{for(const ne of L){const pe=dr[ne];if(!pe)continue;const z=ot(D(y,ne));if(z<=0)continue;const de=k[ne]??{assignment:z,progress:0,lifetimeProduced:ue};k[ne]=de,de.assignment=z,de.progress+=ae*ie/pe.cycleDuration;const we=Math.floor(de.progress);if(we>0){const xe=new d(we*z).mul(pe.amountPerCycle).mul(Y);if(pe.produces==="mana")x=x.add(xe);else{tt(y,pe.produces,xe);const Re=k[pe.produces]??{assignment:0,progress:0,lifetimeProduced:ue};k[pe.produces]=Re,Re.lifetimeProduced=Re.lifetimeProduced.add(xe),pe.produces==="pixie"&&(re=re.add(xe))}de.progress-=we}}},Ne=_n(e),Ve={...r.workshopAssignments},ke=ir(y),Ce=ae=>{for(const ne of Ne){const pe=Ve[ne]||0;if(pe<=0)continue;const z=me(ne),de=k[ne]??{assignment:pe,progress:0,lifetimeProduced:ue};k[ne]=de,de.assignment=pe,de.progress+=ae*ke/z.craftTime;const we=Math.floor(de.progress);if(we>0){const xe=new d(we*pe*X);tt(y,ne,xe),de.lifetimeProduced=de.lifetimeProduced.add(xe),de.progress-=we}}},Xe=qn(e),W={...r.wonderAssignments},le=ae=>{for(const ne of Xe){const pe=W[ne]||0;if(pe<=0)continue;const z=ht[ne];if(!z)continue;const de=ot(D(y,ne)),we=Math.pow(z.costEscalation,de),xe=z.baseTicks*we,Re=k[ne]??{assignment:pe,progress:0,lifetimeProduced:ue};k[ne]=Re,Re.assignment=pe;const We=pe*ke/z.secondsPerTick;let Ie=ae*We;for(const pt of z.tickCost){const tr=pt.amount,Nr=ot(D(y,pt.recipeId).div(tr));Ie=Math.min(Ie,Nr)}if(Ie<=0)continue;const _t=Re.progress*xe,qr=xe-_t;Ie=Math.min(Ie,qr);for(const pt of z.tickCost){const tr=pt.amount*Ie;qe(y,pt.recipeId,new d(tr))}Re.progress+=Ie/xe,Re.progress>=1-1e-9&&(tt(y,ne,new d(1)),Re.lifetimeProduced=Re.lifetimeProduced.add(1),Re.progress=0)}},ge=e==="realm3"?ke:1,Se=ae=>{var ne;for(;;){if(G++,G>1e4){console.error(`[processRealm ${e}] expedition loop exceeded 10000 iterations, breaking!`);break}let pe=ae+1,z=null,de=-1;for(const[Ae,Ye]of Object.entries(O.activeExpeditions))for(let ze=0;ze<Ye.length;ze++){const Ge=Ye[ze],Qe=Ge.startTime+Ge.duration;Qe<=ae&&Qe<pe&&(pe=Qe,z=Ae,de=ze)}if(z===null)break;const we=O.activeExpeditions[z],xe=we[de],We=Math.random()<xe.successRate,Te=nt(z,e);let Ie,_t=0,qr=0,pt=0;if(We&&Te){Ie=Te.rewards;const Ae=xe.tauntMultiplier??1,Ye=Tt(n),ze=pa(O.heroicVictories,e),Ge=at(r.prestige.prestigeCounts,"artifact_shard").toNumber(),Qe=at(r.prestige.prestigeCounts,"nullstone").toNumber(),lt=nn(r.altar.sacrificeCounts,b).toNumber(),ga=ns(r.altar.sacrificeCounts,b).toNumber();_t=Math.round((Ie.artifactShards||0)*Ae*ze*Ge*lt*Ye),qr=Math.round((Ie.nullstone||0)*Ae*Qe*ga*Ye),_t>0&&(tt(y,"artifact_shard",new d(_t)),k.artifact_shard&&(k.artifact_shard.lifetimeProduced=k.artifact_shard.lifetimeProduced.add(_t))),K+=qr;const ln=at(r.prestige.prestigeCounts,"mythic_fragment").toNumber(),cn=sn(r.altar.sacrificeCounts,b).toNumber();pt=Math.round((Ie.mythicFragments||0)*Ae*ln*cn*Ye),pt>0&&(tt(y,"mythic_fragment",new d(pt)),k.mythic_fragment&&(k.mythic_fragment.lifetimeProduced=k.mythic_fragment.lifetimeProduced.add(pt)));const ha=xe.equipmentMultiplier??1,un=Math.ceil((Ie.arcaneBars||0)*ha*Ye),dn=Math.ceil((Ie.arcaneLogs||0)*ha*Ye);if(un>0&&tt(y,"arcane_bar",new d(un)),dn>0&&tt(y,"arcane_log",new d(dn)),O={...O,completionsPerExpedition:{...O.completionsPerExpedition,[z]:(O.completionsPerExpedition[z]||0)+1}},Te.heroic){const mn=O.heroicVictories[z]||0,va=Te.heroic.maxVictories;(va===void 0||mn<va)&&(O={...O,heroicVictories:{...O.heroicVictories,[z]:mn+1}})}}const tr=xe.equipmentMultiplier??1,Nr=Ie&&{...Ie,...Ie.artifactShards?{artifactShards:_t}:{},...Ie.nullstone?{nullstone:qr}:{},...Ie.mythicFragments?{mythicFragments:pt}:{},...Ie.arcaneBars?{arcaneBars:Math.ceil(Ie.arcaneBars*tr*X)}:{},...Ie.arcaneLogs?{arcaneLogs:Math.ceil(Ie.arcaneLogs*tr*X)}:{}};se.push({expeditionId:z,success:We,successRate:xe.successRate,timestamp:pe,rewards:Nr});const Ht=[...we];if(Ht.splice(de,1),Ht.length>0)O={...O,activeExpeditions:{...O.activeExpeditions,[z]:Ht}};else{const{[z]:Ae,...Ye}=O.activeExpeditions;if(O={...O,activeExpeditions:Ye},Te!=null&&Te.heroic&&O.expeditionSetups[z]&&!(xe.repeatUntilVictory&&!We||xe.repeatAt100&&We)){const{[z]:Ge,...Qe}=O.expeditionSetups;O={...O,expeditionSetups:Qe}}}if(xe.repeatIfUnitsAvailable&&!(xe.repeatUntilVictory&&We)&&!(xe.repeatAt100&&!We)){const Ae=O.expeditionSetups[z];if(Ae&&(Ae.repeatIfUnitsAvailable||Ae.repeatUntilVictory||Ae.repeatAt100)&&Te){const Ye=e==="realm3"?La(r.ascension):0,ze=Te.heroic?Math.round(Te.heroic.baseDifficulty*Math.pow(Te.heroic.difficultyScaling,O.heroicVictories[z]||0)):Te.difficulty??0;let Ge=Ae.assignedUnits;if(Ae.repeatAt100&&Te.heroic){const ct=wm(Ae.assignedUnits,ze,e,r.upgrades,r.artifacts,n,Ye,m);if(!ct){const{[z]:ut,...qt}=O.expeditionSetups;O={...O,expeditionSetups:qt};continue}Ge=ct,O={...O,expeditionSetups:{...O.expeditionSetups,[z]:{...Ae,assignedUnits:ct}}}}let Qe=!0;for(const[ct,ut]of Object.entries(Ge)){const qt=ut??ue;if(qt.lte(0))continue;const Ct=vt[ct],Nt=(Ct==null?void 0:Ct.crossRealmPooling)&&n>=Ct.crossRealmPooling.minGlobalTier&&(!Ct.crossRealmPooling.targetRealms||Ct.crossRealmPooling.targetRealms.includes(e));if(Nt&&i){const pn=Ct.realmId,Lr=((ne=U[pn])==null?void 0:ne[ct])??ue;if((i[pn]?D(i[pn],ct).sub(Lr):ue).lt(qt)){Qe=!1;break}}else if(Nt){Qe=!1;break}else if(D(y,ct).lt(qt)){Qe=!1;break}}const lt=Ae.assignedEquipment||{};for(const[ct,ut]of Object.entries(lt))if(ut>0&&D(y,ct).lt(ut)){Qe=!1;break}const ga=O.activeExpeditions[z]||[],ln=ga.length<be,cn=Pn(Ge,e,n),ha=It(Ge,e,n),un=Qt(ha),dn=Fn(ha),mn=Te.group?Jt(lt,Te.group):1,va=Te.group?On(lt,Te.group):1,eu=ze*un*mn,mi=Gs(Ge,e,r.upgrades,r.artifacts,n,Ye,m);if(Qe&&ln){for(const[ut,qt]of Object.entries(Ge)){const Ct=qt??ue;if(Ct.lte(0))continue;const Nt=vt[ut];if((Nt==null?void 0:Nt.crossRealmPooling)&&n>=Nt.crossRealmPooling.minGlobalTier&&(!Nt.crossRealmPooling.targetRealms||Nt.crossRealmPooling.targetRealms.includes(e))){const Lr=Nt.realmId;U[Lr]||(U[Lr]={}),U[Lr][ut]=(U[Lr][ut]??ue).add(Ct)}else qe(y,ut,Ct)}for(const[ut,qt]of Object.entries(lt))qt>0&&qe(y,ut,new d(qt));const ct={expeditionId:z,assignedUnits:{...Ge},strength:mi,successRate:Ws(mi,eu),startTime:pe,duration:aa(z,e,cn,ge),repeatIfUnitsAvailable:!0,...Ae.repeatUntilVictory?{repeatUntilVictory:!0}:{},...Ae.repeatAt100?{repeatAt100:!0}:{},speed:cn,tauntMultiplier:dn,assignedEquipment:Object.keys(lt).length>0?{...lt}:void 0,equipmentMultiplier:va!==1?va:void 0};O={...O,activeExpeditions:{...O.activeExpeditions,[z]:[...ga,ct]}}}else if(!Qe&&ln)if(Ae.repeatAt100){const{[z]:ct,...ut}=O.expeditionSetups;O={...O,expeditionSetups:ut}}else{const ct=O.pendingRepeats[z]||0;O={...O,pendingRepeats:{...O.pendingRepeats,[z]:ct+1}}}}}}};if(oe){const ne={};for(const de of C){const we=k[de];if(!we||we.assignment<=0||!st(de,k))continue;const xe=me(de),Re=E[de],Te=60/(xe.craftTime/Re)*we.assignment;ne[de]={costs:A[de].map(Ie=>({...Ie,amount:Ie.amount.mul(Te)})),output:F[de].mul(Te)}}let pe=0,z=a-t;for(;B>0;){if(pe++,pe>2e5){console.error(`[processRealm ${e}] crafting loop exceeded 200000 iterations, breaking!`);break}const de=Math.min(60,B),we=de/60;z+=de*1e3,e!=="realm3"&&(x=Ri(x,j(),new d(de),S));const xe=[];for(const Re in ne){const We=ne[Re];if(qi(We.costs.map(Te=>({...Te,amount:Te.amount.mul(we)})),1,x,y)){for(const Te of We.costs){const Ie=Te.amount.mul(we);Te.type==="mana"?x=x.sub(Ie):Te.recipeId&&qe(y,Te.recipeId,Ie)}xe.push(Re)}}for(const Re of xe){const We=ne[Re].output.mul(we);tt(y,Re,We);const Te=k[Re];Te&&(Te.lifetimeProduced=Te.lifetimeProduced.add(We))}ce(de),Se(z),Ce(de),le(de),B-=de}for(const de of C){const we=k[de];we&&(we.progress=0)}}else{let ae=0;for(;B>0;){if(ae++,ae>2e5){console.error(`[processRealm ${e}] crafting loop exceeded 200000 iterations, breaking!`);break}V();let ne=B,pe=null;for(const z of C){const de=k[z];if(!de||de.assignment<=0||!st(z,k)||de.progress>=1)continue;const we=me(z),xe=E[z]/we.craftTime,Re=(1-de.progress)/xe;Re<=ne&&(ne=Re,pe=z)}for(const z of L){const de=dr[z];if(!de)continue;const we=ot(D(y,z));if(we<=0)continue;const xe=k[z]??{assignment:we,progress:0,lifetimeProduced:ue};k[z]=xe;const Re=xe.progress%1,We=(Re<1e-9?1:1-Re)*de.cycleDuration;We<ne&&(ne=We,pe=null)}e!=="realm3"&&(x=Ri(x,j(),new d(ne),S)),ce(ne),Ce(ne),le(ne);for(const z of C){const de=k[z];if(!de||de.assignment<=0||!st(z,k)||de.progress>=1)continue;const we=me(z),xe=E[z]/we.craftTime;de.progress+=ne*xe}if(B-=ne,pe===null){if(B<=0)break;continue}P(pe)||(k[pe].progress=1)}for(const ne of C){const pe=k[ne];pe&&(pe.progress=Math.min(1,pe.progress))}}if(Se(a),se.length>0){const ae=[...O.expeditionLog,...se],ne={};for(const z of ae)ne[z.expeditionId]||(ne[z.expeditionId]=[]),ne[z.expeditionId].push(z);const pe=[];for(const z of Object.values(ne))pe.push(...z.slice(-20));pe.sort((z,de)=>z.timestamp-de.timestamp),O={...O,expeditionLog:pe}}for(const[ae,ne]of Object.entries(O.pendingRepeats)){if(ne<=0)continue;const pe=O.expeditionSetups[ae],z=nt(ae,e);if(!pe||!z)continue;const de=O.activeExpeditions[ae]||[];if(de.length>=be)continue;const we=Pn(pe.assignedUnits,e,n),xe=It(pe.assignedUnits,e,n),Re=Qt(xe),We=Fn(xe),Te=pe.assignedEquipment||{},Ie=z.group?Jt(Te,z.group):1,_t=z.group?On(Te,z.group):1,pt=(z.heroic?Math.round(z.heroic.baseDifficulty*Math.pow(z.heroic.difficultyScaling,O.heroicVictories[ae]||0)):z.difficulty??0)*Re*Ie,tr=e==="realm3"?La(r.ascension):0,Nr=Gs(pe.assignedUnits,e,r.upgrades,r.artifacts,n,tr,m);let Ht=!0;for(const[Vt,Ae]of Object.entries(pe.assignedUnits)){const Ye=Ae??ue;if(Ye.lte(0))continue;const ze=vt[Vt],Ge=(ze==null?void 0:ze.crossRealmPooling)&&n>=ze.crossRealmPooling.minGlobalTier&&(!ze.crossRealmPooling.targetRealms||ze.crossRealmPooling.targetRealms.includes(e));if(Ge&&i){const Qe=ze.realmId,lt=((je=U[Qe])==null?void 0:je[Vt])??ue;if((i[Qe]?D(i[Qe],Vt).sub(lt):ue).lt(Ye)){Ht=!1;break}}else if(Ge){Ht=!1;break}else if(D(y,Vt).lt(Ye)){Ht=!1;break}}for(const[Vt,Ae]of Object.entries(Te))if(Ae>0&&D(y,Vt).lt(Ae)){Ht=!1;break}if(Ht){for(const[Ae,Ye]of Object.entries(pe.assignedUnits)){const ze=Ye??ue;if(ze.lte(0))continue;const Ge=vt[Ae];if((Ge==null?void 0:Ge.crossRealmPooling)&&n>=Ge.crossRealmPooling.minGlobalTier&&(!Ge.crossRealmPooling.targetRealms||Ge.crossRealmPooling.targetRealms.includes(e))){const lt=Ge.realmId;U[lt]||(U[lt]={}),U[lt][Ae]=(U[lt][Ae]??ue).add(ze)}else qe(y,Ae,ze)}for(const[Ae,Ye]of Object.entries(Te))Ye>0&&qe(y,Ae,new d(Ye));const Vt={expeditionId:ae,assignedUnits:{...pe.assignedUnits},strength:Nr,successRate:Ws(Nr,pt),startTime:a,duration:aa(ae,e,we,ge),repeatIfUnitsAvailable:!0,...pe.repeatUntilVictory?{repeatUntilVictory:!0}:{},speed:we,tauntMultiplier:We,assignedEquipment:Object.keys(Te).length>0?{...Te}:void 0,equipmentMultiplier:_t!==1?_t:void 0};O={...O,activeExpeditions:{...O.activeExpeditions,[ae]:[...de,Vt]},pendingRepeats:{...O.pendingRepeats,[ae]:ne-1}}}}let he={...r.altar};const Fe=ae=>ae?ae.type==="military"&&ae.militaryId?ae.militaryId:ae.type==="expedition_reward"?ae.id:ae.tier!==void 0?`${ae.type}_${ae.tier}`:null:null,Me=(ae,ne)=>ae.type==="gem"&&ae.tier===1?D(y,ne).gt(sc+w-1):D(y,ne).gte(w);if(he.activeSacrifices.length>0&&n>=1){const ae=t/1e3;let ne=he.sacrificeProgress+ae,pe={...he.sacrificeCounts};for(;ne>=1;){let z=!1;for(const de of he.activeSacrifices){const we=na(de);if(!we)continue;const xe=Fe(we);xe&&Me(we,xe)&&(qe(y,xe,new d(w)),pe[de]=(pe[de]||0)+w,z=!0)}if(!z){ne=1;break}ne-=1}he={...he,sacrificeProgress:ne,sacrificeCounts:pe}}else if(he.activeSacrifice&&n>=1){const ae=na(he.activeSacrifice);if(ae)if((he.sacrificeCounts[he.activeSacrifice]||0)>=T)he={...he,activeSacrifice:null,sacrificeProgress:0};else{const pe=t/1e3;let z=he.sacrificeProgress+pe,de={...he.sacrificeCounts};for(;z>=1;){const we=Fe(ae);let xe=!1;if(we&&(xe=Me(ae,we)),!xe){he={...he,sacrificeProgress:1,sacrificeCounts:de};break}const Re=de[he.activeSacrifice]||0;if(Re>=T){he={...he,activeSacrifice:null,sacrificeProgress:0,sacrificeCounts:de};break}const We=Math.min(w,T-Re);we&&qe(y,we,new d(We)),de[he.activeSacrifice]=Re+We,z-=1}he.activeSacrifice&&(he={...he,sacrificeProgress:z,sacrificeCounts:de})}}const Le=e==="realm3"&&re.gt(0)?{...r.ascension,lifetimePixies:r.ascension.lifetimePixies+ot(re)}:r.ascension;return{updatedRealmState:{mana:x,recipeInventory:y,recipeCrafting:k,upgrades:r.upgrades,autoBuyUpgrades:r.autoBuyUpgrades,autoBuyCreatures:r.autoBuyCreatures,autoBuyCreatureLimits:r.autoBuyCreatureLimits,combat:O,artifacts:r.artifacts,altar:he,prestige:r.prestige,creatureUpgrades:r.creatureUpgrades,creatureUnlocks:r.creatureUnlocks,workshopAssignments:r.workshopAssignments,wonderAssignments:r.wonderAssignments,ascension:Le,soulcasterAllocations:r.soulcasterAllocations,towerProgress:r.towerProgress,towerLevels:r.towerLevels,heroicTrialCompleted:r.heroicTrialCompleted,autoAllResearch:r.autoAllResearch,autoAllPrestige:r.autoAllPrestige,autoAllSacrifice:r.autoAllSacrifice},nullstoneEarned:K,crossRealmDeductions:U}},wp=()=>{var u,c;const e=M.getState(),r=Date.now();if(e.paused){M.setState({lastFrameTimestamp:r}),e.saveToStorage();return}let t=r-e.lastFrameTimestamp;if(t=Math.min(t,bp),t<=0){M.setState({lastFrameTimestamp:r}),e.saveToStorage();return}const gto=(e.gameTimeOffsetMs??0)+t*(GAME_SPEED_MULT-1),gameNow=r+gto,ruSpeedDelta=t*GAME_SPEED_MULT,a={};let n=0;const s=e.globalTier>=3?"realmU":"realm1",o=e.realms[s].combat.heroicVictories,i=e.realms.realm3.combat.heroicVictories,l=[],p={};for(const g of St)p[g]=e.realms[g].recipeInventory;for(const g of Sd){let m=e.realms[g];if(g==="realm3"){const S=ot(D(m.recipeInventory,"soulforge")),b=((u=m.recipeCrafting.arcane_soul)==null?void 0:u.assignment)??0;S!==b&&(m={...m,recipeCrafting:{...m.recipeCrafting,arcane_soul:{...m.recipeCrafting.arcane_soul??{progress:0,lifetimeProduced:ue},assignment:S}}})}const h=e.realms.realmU.artifacts.upgradeLevels.breeding_artifact??0,f=yo(e.realms.realm3.recipeInventory),v=yp(g,m,ruSpeedDelta,gameNow,e.globalTier,o,e.realms.realm3.ascension,p,i,s,e.realms.realm4.towerLevels,h,e.realms.realm4.heroicTrialCompleted,f);a[g]=v.updatedRealmState,n+=v.nullstoneEarned,l.push(v.crossRealmDeductions)}for(const g of l)for(const[m,h]of Object.entries(g)){const f=a[m].recipeInventory;for(const[v,S]of Object.entries(h))qe(f,v,S??ue)}{const g=e.realms.realm4,m=((c=a.realm3)==null?void 0:c.recipeInventory)??e.realms.realm3.recipeInventory,h=ot(D(m,"soulcaster")),f=ruSpeedDelta/1e3;let v=g.soulcasterAllocations.gem_tower,S=g.soulcasterAllocations.military_tower;const b=v+S;if(b>h){const R=h/Math.max(b,1);v=Math.floor(v*R),S=Math.floor(S*R)}const T={...g.towerProgress},w={...g.towerLevels},$={gem_tower:v,military_tower:S};for(const R of xr){const x=R==="gem_tower"?v:S;if(x<=0)continue;const y=Wa[R];let k=T[R]+x*x*f,C=w[R],I=Hn(y,C);for(;k>=I;)k-=I,C++,I=Hn(y,C);T[R]=k,w[R]=C}a.realm4={...g,soulcasterAllocations:$,towerProgress:T,towerLevels:w}}if(n>0){const g=a.realm1.recipeInventory,m=a.realm1.recipeCrafting;tt(g,"nullstone",new d(n)),m.nullstone&&(m.nullstone.lifetimeProduced=m.nullstone.lifetimeProduced.add(n))}if(M.setState({realms:a,lastFrameTimestamp:r,totalPlaytime:e.totalPlaytime+t,gameTimeOffsetMs:gto}),e.globalTier>=1){const g=M.getState(),m=J(g),h=g.globalTier;for(const f of Qn)(f==="unifiedKnightStrength"||f==="sacrificeMulti")&&g.activeRealm!=="realmU"||Xr.includes(f)&&f!=="unifiedKnightStrength"&&g.activeRealm!=="realm1"||zr.includes(f)&&g.activeRealm!=="realm2"||(m.autoBuyUpgrades[f]||m.autoAllResearch)&&(Kt(m.upgrades,f,h)||tn(m.upgrades,f,m.mana,Xt(m.recipeInventory),ia(m.recipeInventory),h,m.recipeInventory)&&M.getState().purchaseUpgrade(f))}if(e.globalTier>=4){const g=M.getState(),m=g.realms.realm3,h=[];for(const v of So("realm3"))!m.autoBuyCreatures[v]||!Gr(v,m.recipeCrafting,g.realms.realm4.heroicTrialCompleted)||me(v).recipe.length===0||h.push(v);let f=-1;for(let v=h.length-1;v>=0;v--){const S=me(h[v]);let b=!0,T=!0;for(const w of S.recipe){if(!w.recipeId)continue;D(m.recipeInventory,w.recipeId).lt(w.amount)&&(w.recipeId==="arcane_soul"?T=!1:b=!1)}if(b&&!T){f=v;break}}for(let v=h.length-1;v>=0;v--){const S=h[v];if(f>=0&&v<f)continue;const b=xo[S];if(b){const T=m.autoBuyCreatureLimits[S]??kl;if(T>0&&D(M.getState().realms.realm3.recipeInventory,b).gte(T))continue}M.getState().buyCreature(S,"all")}}if(e.globalTier>=2)for(const g of St){const h=M.getState().realms[g],{autoPrestige:f,prestigeCounts:v}=h.prestige,S=h.autoAllPrestige?Object.keys(h.recipeInventory).filter(b=>{const T=vt[b];return T&&(T.category!=="military"||!T.ignoreModifiers)}):Object.keys(f).filter(b=>f[b]);for(const b of S){const T=D(h.recipeInventory,b),w=v[b]||0;if(as(b,T,w)){const $=rs(w),R={...h.recipeInventory};R[b]=T.sub($);const x={...v};x[b]=w+1,M.setState(y=>({realms:{...y.realms,[g]:{...y.realms[g],recipeInventory:R,prestige:{...y.realms[g].prestige,prestigeCounts:x}}}}))}}}{const g=M.getState(),m=g.realms[g.activeRealm];if(m.autoAllSacrifice){const h=De(g.activeRealm);if(!isFinite(h.MODIFIERS.sacrificeCap)){const f=Ra(g.activeRealm);for(const v of f)m.altar.activeSacrifices.includes(v.id)||M.getState().startSacrifice(v.id)}}}e.saveToStorage()},vr=(e,r)=>{const t=e.activeRealm,a=e.realms[t],n={...a,...r(a)};return{realms:{...e.realms,[t]:n}}},M=ru()((e,r)=>{const t=up(r,e);return{...Wo(),setMana:a=>{e(n=>vr(n,()=>({mana:a})))},addMana:a=>{e(n=>vr(n,s=>({mana:s.mana.add(a)})))},spendMana:a=>{const n=r();return J(n).mana.gte(a)?(e(o=>vr(o,i=>({mana:i.mana.sub(a)}))),!0):!1},addGem:(a,n)=>{e(s=>vr(s,o=>{const i=xi(a),l={...o.recipeInventory};return tt(l,i,n),{recipeInventory:l}}))},removeGem:(a,n)=>{e(s=>vr(s,o=>{const i=xi(a),l={...o.recipeInventory};return qe(l,i,n),{recipeInventory:l}}))},getManaPerSecond:()=>{const a=J(r());return os(Xt(a.recipeInventory))},assignCrafter:hs("crafting",r,e),assignAllCrafters:vs("crafting",r,e),unassignAllCrafters:bs("crafting",r,e),assignFlaskCrafter:hs("flaskCrafting",r,e),assignAllFlaskCrafters:vs("flaskCrafting",r,e),unassignAllFlaskCrafters:bs("flaskCrafting",r,e),assignMilitaryCrafter:hs("militaryCrafting",r,e),assignAllMilitaryCrafters:vs("militaryCrafting",r,e),unassignAllMilitaryCrafters:bs("militaryCrafting",r,e),getTotalCrafters:()=>{const a=J(r());return Nn(a.upgrades)},getAvailableCrafters:()=>{const a=J(r());return Ll(Nn(a.upgrades),a.recipeCrafting)},purchaseUpgrade:Rm(r,e),toggleAutoBuy:Cm(r,e),startExpedition:Im(r,e),saveExpeditionSetup:Mm(r,e),clearExpedition:Em(r,e),craftArtifact:Am(r,e),upgradeArtifact:_m(r,e),shipArtifact:qm(r,e),prestigeRecipe:jm(r,e),toggleAutoPrestige:Gm(r,e),togglePause:()=>{e(a=>({paused:!a.paused}))},toggleBackgroundImage:()=>{e(a=>({backgroundImageOff:!a.backgroundImageOff}))},toggleTabHighlighting:()=>{e(a=>({tabHighlightingOff:!a.tabHighlightingOff}))},setUiScale:a=>{e({uiScale:Math.max(.5,Math.min(1.3,a))})},setScientificNotationThreshold:a=>{e({scientificNotationThreshold:a})},tierReset:Dm(r,e),startSacrifice:Hm(r,e),stopSacrifice:Vm(r,e),setActiveRealm:a=>{const n=r();a==="realm2"&&!n.realm2Unlocked||a==="realm3"&&!n.realm3Unlocked||a==="realm4"&&!n.earthPortalBuilt||e({activeRealm:a})},unlockRealm2:()=>{e({realm2Unlocked:!0})},unlockRealm3:()=>{e({realm3Unlocked:!0})},setWorkshopAssignment:(a,n)=>{e(s=>vr(s,o=>({workshopAssignments:{...o.workshopAssignments,[a]:Math.max(0,n)}})))},setWonderAssignment:(a,n)=>{e(s=>vr(s,o=>({wonderAssignments:{...o.wonderAssignments,[a]:Math.max(0,n)}})))},craftSoulforge:Wm(r,e),craftForgeEnhancer:Km(r,e),craftSoulcaster:Ym(r,e),buyCreature:Jm(r,e),buyBuilding:Qm(r,e),toggleAutoBuyCreature:ep(r,e),setAutoBuyCreatureLimit:tp(r,e),ascend:rp(r,e),purchaseAscensionUpgrade:ap(r,e),...gp(e,r),hardReset:ip(e),exportSave:lp(r),importSave:cp(r,e,t),saveToStorage:t,loadFromStorage:dp(e)}}),ft=[{suffix:"k",value:1e3},{suffix:"m",value:1e6},{suffix:"b",value:1e9},{suffix:"t",value:1e12},{suffix:"qa",value:1e15},{suffix:"qi",value:1e18},{suffix:"sx",value:1e21},{suffix:"sp",value:1e24},{suffix:"oc",value:1e27},{suffix:"no",value:1e30},{suffix:"dc",value:1e33},{suffix:"ud",value:1e36}];let ei=1e15;const Sp=e=>{ei=e},vc=(e,r)=>{const t=mt(e),a=t.exponent,n=Math.max(r,1);let s=n;Number.isFinite(a)&&a>=100&&(s=Math.max(s,2));let o=t.toExponential(s).replace("e+","e");if(s>n){const l=o.match(/^(-?\d+\.\d+)(e.+)$/);l&&(o=parseFloat(l[1]).toFixed(n)+l[2])}const i=o.match(/^(-?\d+\.?\d*)(e.+)$/);return i&&(o=parseFloat(i[1]).toFixed(n)+i[2]),o},Tp=(e,r)=>e<10?e.toFixed(2)+r:e<100?e.toFixed(1)+r:e.toFixed(0)+r,kp=(e,r)=>e<10?e.toFixed(1)+r:e.toFixed(0)+r,N=(e,r)=>{const t=mt(e),a=ei,n=r!==void 0;if(!t.isFinite()||t.abs().gte(a))return(t.lt(0)?"-":"")+vc(t.abs(),n?r:1);const s=t.toNumber(),o=Math.abs(s),i=s<0?"-":"";if(o<1e3)return n?i+o.toFixed(r):o<10?i+o.toFixed(2):o<100?i+o.toFixed(1):i+o.toFixed(0);for(let l=ft.length-1;l>=0;l--)if(!(ft[l].value>=a)&&o>=ft[l].value){const p=o/ft[l].value;return n?i+p.toFixed(r)+ft[l].suffix:i+Tp(p,ft[l].suffix)}return i+o.toFixed(n?r:0)},te=e=>{const r=mt(e),t=ei;if(!r.isFinite()||r.abs().gte(t))return(r.lt(0)?"-":"")+vc(r.abs(),0);const a=r.toNumber(),n=Math.abs(a),s=a<0?"-":"";if(n<1e3)return s+Math.floor(n).toString();for(let o=ft.length-1;o>=0;o--)if(!(ft[o].value>=t)&&n>=ft[o].value)return s+kp(n/ft[o].value,ft[o].suffix);return s+Math.floor(n).toString()},Ta={};for(const{suffix:e,value:r}of ft)Ta[e]=r;const vn=e=>{const r=e.trim().toLowerCase();if(r==="")return null;const t=r.slice(-2);if(Ta[t])try{const n=new d(r.slice(0,-2));return n.isFinite()?n.mul(Ta[t]).floor():null}catch{return null}const a=r[r.length-1];if(Ta[a])try{const n=new d(r.slice(0,-1));return n.isFinite()?n.mul(Ta[a]).floor():null}catch{return null}try{const n=new d(r);return n.isFinite()?n.floor():null}catch{return null}},Cr=e=>{const r=e instanceof d?e.toNumber():e;return r===0?"":`${r>0?"+":""}${N(r)}/s`},$p=e=>{if(e===0)return"";const r=e>0?"+":"",t=Math.abs(e),a=e<0?"-":"";let n;return t<100?n=a+t.toFixed(2):n=N(e),`${r}${n}/s`},Rp=e=>{const r=e instanceof d?e.toNumber():e;return r===0?"":`${r>0?"+":""}${N(r)}`},Cp=e=>{if(!Number.isFinite(e)||e<0)return"never";if(e<1)return"<1s";if(e<60)return`${Math.ceil(e)}s`;if(e<3600){const a=Math.floor(e/60),n=Math.ceil(e%60);return n>0?`${a}m ${n}s`:`${a}m`}if(e<86400){const a=Math.floor(e/3600),n=Math.ceil(e%3600/60);return n>0?`${a}h ${n}m`:`${a}h`}const r=Math.floor(e/86400),t=Math.ceil(e%86400/3600);return t>0?`${r}d ${t}h`:`${r}d`},is=(e,r,t)=>{const a=e instanceof d?e.toNumber():e,s=(r instanceof d?r.toNumber():r)-a;return s<=0?"Can afford now":t<=0?"Can afford in: never":`Can afford in: ${Cp(s/t)}`},sa=(e,r,t="arcane")=>e?"border-muted--30 text-muted--50 line-through cursor-not-allowed":r?`border-${t} text-${t} hover-bg-${t}--20 cursor-pointer`:"border-muted--30 text-muted--50 cursor-not-allowed",Ni=(e,r,t="arcane")=>e||!r?"border-muted--30 cursor-not-allowed":`border-${t} hover-bg-${t}--20 cursor-pointer`,bc=()=>{let e="";return r=>r===e?!1:(e=r,!0)},Zr=(e,r,t=!1)=>{e&&(e.style.width=`${r*100}%`,e.className=`h-full craft-progress-fill${t?" blocked":""}`)},xc=e=>`absolute inset-0 ${e>=1?"bg-steel--40":"bg-steel--30"}`,Yt=(e,r)=>`<div ${r} class="${xc(e)}" style="width: ${e*100}%"></div>`,zt=(e,r,t=!1)=>{e&&(t?e.style.display="none":(e.style.display="",e.style.width=`${r*100}%`,e.className=xc(r)))},Mp=e=>e===0?"":`<span class="text-xs font-mono ${e>0?"text-positive":"text-red"}">${Cr(e)}</span>`,jt=(e,r)=>{e&&(e.innerHTML=Mp(r))},Ip=(e,r)=>{if(!e)return;if(r===0){e.innerHTML="";return}const t=r>0?"text-positive":"text-red";e.innerHTML=`<span class="text-xs font-mono ${t}">${$p(r)}</span>`},ti=(e,r,t,a="")=>e.map((n,s)=>`
    <span class="flex items-center gap-1">
      ${s>0?'<span class="text-text mx-1">+</span>':""}
      <img src="${n.icon}" alt="${n.alt}" style="width: 40px; height: 40px;" class="object-contain">
      <span class="text-text text-sm" data-${r}recipe-amount="${t}-${s}">${n.amount.eq(0)?"free":N(n.amount)}${a}</span>
    </span>
  `).join(""),dt=(e,r,t)=>{let a="";r&&(a+=`<div class="tooltip-title">${r}</div>`,a+='<div class="tooltip-divider"></div>');for(const s of e)a+='<div class="tooltip-row">',a+=`<span class="tooltip-label">${s.label}</span>`,s.value!==void 0&&(a+=`<span class="tooltip-value ${s.valueClass??""}">${s.value}</span>`),a+="</div>";return`<span class="hover-tooltip-wrapper">${t??'<span class="text-muted cursor-help">?</span>'}<div class="hover-tooltip">${a}</div></span>`},Ee={Inventory:1,Crafting:2,Upgrades:4,Combat:8,Artifacts:16,Altar:32,Tier:64,Realm:128,Prestige:512,Ascension:256,TabBar:1024,Village:2048,Camp:4096},Ep=Object.values(Ee).reduce((e,r)=>e|r,0);let yr=0,Zs=Ee.Crafting;const Ap=e=>{yr|=e},yc=()=>{yr=Ep},Qs=e=>{Zs=e,Ap(e)},Aa=new Map,Ka=(e,r)=>{Aa.set(e,r)},wc=e=>{Aa.delete(e)},_p=()=>{var e,r,t;yr!==0&&(yr&Ee.Inventory&&((e=Aa.get(Ee.Inventory))==null||e()),yr&Ee.TabBar&&((r=Aa.get(Ee.TabBar))==null||r()),yr&Zs&&((t=Aa.get(Zs))==null||t()),yr=0)},qp={arcane_soul:"SOUL",arcane_warden:"WARD"},Np=(e,r)=>qp[e]??r.slice(0,4).toUpperCase(),Lp=(e,r,t,a=0)=>{const n=e[1],s=n.mul(Ze[1].effect.value),o=[];let i=s;for(const u of gt.slice(1)){const c=e[u];if(c.gt(0)){const g=Ze[u],m=new d(1).add(c.mul(g.effect.value.sub(1)));o.push({tier:u,count:c,individualMultiplier:g.effect.value,tierMultiplier:m}),i=i.mul(m)}}const l=t!==void 0,p=t?t(i):i;return{baseGeneration:s,t1Count:n,multipliers:o,preModifierTotal:i,hasModifier:l,totalGeneration:p,craftingRate:r.toNumber(),pixieRate:a,netRate:p.add(r).toNumber()+a}},ws=e=>{const r={};for(const t of Object.values(e.activeExpeditions))for(const a of t){if(!a.repeatIfUnitsAvailable)continue;const n=a.duration/1e3;if(!(n<=0))for(const[s,o]of Object.entries(a.assignedUnits)){const i=o??ue;i.lte(0)||(r[s]=(r[s]||0)+i.toNumber()/n)}}return r},Up=(e,r,t,a,n)=>{let s=0,o=0,i=0,l=0,p=0;const u=pa(e.heroicVictories,r),c=at(t.prestigeCounts,"artifact_shard").toNumber(),g=at(t.prestigeCounts,"nullstone").toNumber(),m=De(r).MODIFIERS.calculateSacrificeBonus,h=nn(a,m).toNumber(),f=ns(a,m).toNumber(),v=at(t.prestigeCounts,"mythic_fragment").toNumber(),S=sn(a,m).toNumber();for(const[b,T]of Object.entries(e.activeExpeditions))for(const w of T){if(!w.repeatIfUnitsAvailable)continue;const $=nt(b,r);if(!$)continue;const R=w.tauntMultiplier??1,x=Tt(n),y=$.rewards.artifactShards||0,k=$.rewards.nullstone||0,C=Math.round(y*R*u*c*h*x),I=Math.round(k*R*g*f*x),_=w.duration/1e3;if(_>0){s+=C*w.successRate/_,o+=I*w.successRate/_;const A=$.rewards.mythicFragments||0,F=Math.round(A*R*v*S*x);i+=F*w.successRate/_;const E=w.equipmentMultiplier??1,P=$.rewards.arcaneBars||0,V=$.rewards.arcaneLogs||0;l+=P*E*x*w.successRate/_,p+=V*E*x*w.successRate/_}}return{shardsPerSecond:s,nullstonePerSecond:o,mythicFragmentsPerSecond:i,arcaneBarsPerSecond:l,arcaneLogsPerSecond:p}},et={gems:!1,flasks:!1,military:!1,expeditions:!1,creatures:!1};let ye=null,oa=!1,Tn=null,kn=null;const Pp=e=>{const r=Tn;if(!r)return;const t=r.querySelector("[data-tooltip-t1]");if(t){const p=t.querySelector(".tooltip-label"),u=t.querySelector(".tooltip-value");p&&(p.innerHTML=`<img src="${Ze[1].icon}" class="tooltip-icon"> ${N(e.t1Count)} T1 gems  ${N(Ze[1].effect.value)}/s`),u&&(u.textContent=`+${N(e.baseGeneration)}/s`)}const a=r.querySelector("[data-tooltip-multipliers]");if(a)if(e.multipliers.length>0){a.classList.remove("hidden");let p='<div class="tooltip-section">Multipliers</div>';for(const u of e.multipliers)p+='<div class="tooltip-row">',p+='<span class="tooltip-label">',p+=`<img src="${Ze[u.tier].icon}" class="tooltip-icon"> `,p+=`${N(u.count)} T${u.tier} gems`,p+="</span>",p+=`<span class="tooltip-value text-gold"> x${N(u.tierMultiplier)} multiplier</span>`,p+="</div>";a.innerHTML=p}else a.classList.add("hidden");const n=r.querySelector("[data-tooltip-mana-globe]");n&&n.classList.add("hidden");const s=r.querySelector("[data-tooltip-modifier]");if(s)if(e.hasModifier){s.classList.remove("hidden");const p=s.querySelector(".tooltip-label"),u=s.querySelector(".tooltip-value");p&&(p.textContent=`${N(e.preModifierTotal)} (R2 effect)`),u&&(u.textContent=`=${N(e.totalGeneration)}/s`)}else s.classList.add("hidden");const o=r.querySelector("[data-tooltip-crafting]");if(o)if(e.craftingRate!==0){o.classList.remove("hidden");const p=o.querySelector(".tooltip-label"),u=o.querySelector(".tooltip-value");p&&(p.textContent=`Crafting ${e.craftingRate>0?"production":"consumption"}`),u&&(u.textContent=Cr(e.craftingRate),u.className=`tooltip-value ${e.craftingRate>0?"text-positive":"text-red"}`)}else o.classList.add("hidden");const i=r.querySelector("[data-tooltip-pixie]");if(i)if(e.pixieRate>0){i.classList.remove("hidden");const p=i.querySelector(".tooltip-label"),u=i.querySelector(".tooltip-value");p&&(p.textContent="Pixie generation"),u&&(u.textContent=Cr(e.pixieRate))}else i.classList.add("hidden");const l=r.querySelector("[data-tooltip-total]");if(l){const p=l.querySelector(".tooltip-value");p&&(p.textContent=Cr(e.netRate),p.className=`tooltip-value ${e.netRate>=0?"text-positive":"text-red"}`)}},Fp=()=>{let e='<div class="mana-tooltip">';return e+='<div class="tooltip-title">Mana Generation Breakdown</div>',e+='<div class="tooltip-divider"></div>',e+='<div class="tooltip-row" data-tooltip-t1>',e+='<span class="tooltip-label"></span>',e+='<span class="tooltip-value text-positive"></span>',e+="</div>",e+='<div class="tooltip-divider"></div>',e+="<div data-tooltip-multipliers></div>",e+='<div class="tooltip-row hidden" data-tooltip-mana-globe>',e+='<span class="tooltip-label"></span>',e+='<span class="tooltip-value text-gold"></span>',e+="</div>",e+='<div class="tooltip-row hidden" data-tooltip-modifier>',e+='<span class="tooltip-label text-red"></span>',e+='<span class="tooltip-value text-red"></span>',e+="</div>",e+='<div class="tooltip-divider"></div>',e+='<div class="tooltip-row hidden" data-tooltip-crafting>',e+='<span class="tooltip-label"></span>',e+='<span class="tooltip-value"></span>',e+="</div>",e+='<div class="tooltip-row hidden" data-tooltip-pixie>',e+='<span class="tooltip-label"></span>',e+='<span class="tooltip-value text-positive"></span>',e+="</div>",e+='<div class="tooltip-divider"></div>',e+='<div class="tooltip-row tooltip-total" data-tooltip-total>',e+='<span class="tooltip-label">Net mana rate</span>',e+='<span class="tooltip-value"></span>',e+="</div>",e+="</div>",e},Op=()=>{const e=me("arcane_soul");let r='<div class="mana-tooltip soul-tooltip">';if(r+='<div class="tooltip-title">Arcane Soul Production Breakdown</div>',r+='<div class="tooltip-divider"></div>',r+='<div class="tooltip-row" data-soul-tooltip-base>',r+='<span class="tooltip-label"></span>',r+='<span class="tooltip-value text-positive"></span>',r+="</div>",e.outputMultipliers)for(const t of e.outputMultipliers)r+=`<div class="tooltip-row hidden" data-soul-tooltip-mult="${t.source}">`,r+='<span class="tooltip-label"></span>',r+='<span class="tooltip-value text-gold"></span>',r+="</div>";return r+='<div class="tooltip-row hidden" data-soul-tooltip-heroic>',r+='<span class="tooltip-label">Soul Mastery</span>',r+='<span class="tooltip-value text-gold"></span>',r+="</div>",r+='<div class="tooltip-divider"></div>',r+='<div class="tooltip-row tooltip-total" data-soul-tooltip-total>',r+='<span class="tooltip-label">Net soul rate</span>',r+='<span class="tooltip-value"></span>',r+="</div>",r+="</div>",r},Bp=(e,r,t,a=1,n=0)=>{var g;const s=kn;if(!s)return;const o=D(e,"soulforge").toNumber(),i=me("arcane_soul"),l=o>0?o/i.craftTime:0,p=s.querySelector("[data-soul-tooltip-base]");if(p){const m=p.querySelector(".tooltip-label"),h=p.querySelector(".tooltip-value"),f=me("soulforge");m&&(m.innerHTML=`<img src="${f.icon}" class="tooltip-icon"> ${N(o)} soulforge${o!==1?"s":""}  ${N(1/i.craftTime)}/s`),h&&(h.textContent=`+${N(l)}/s`)}if(i.outputMultipliers)for(const m of i.outputMultipliers){const h=s.querySelector(`[data-soul-tooltip-mult="${m.source}"]`);if(!h)continue;if(m.minGlobalTier!==void 0&&n<m.minGlobalTier){h.classList.add("hidden");continue}if(m.maxGlobalTier!==void 0&&n>m.maxGlobalTier){h.classList.add("hidden");continue}let f=0,v=m.label;if(m.type==="inventory"){f=((g=e[m.source])==null?void 0:g.toNumber())??0;const b=me(m.source);v=`${N(f)} ${b.name}${f!==1?"s":""}`}else m.type==="ascension"&&t&&(f=t.upgrades[m.source]??0);const S=m.formula(f);if(S!==1){h.classList.remove("hidden");const b=h.querySelector(".tooltip-label"),T=h.querySelector(".tooltip-value");if(m.type==="inventory"){const w=me(m.source);b&&(b.innerHTML=`<img src="${w.icon}" class="tooltip-icon"> ${v}`)}else b&&(b.textContent=m.label);T&&(T.textContent=`x${S.toFixed(2)} multiplier`)}else h.classList.add("hidden")}const u=s.querySelector("[data-soul-tooltip-heroic]");if(u)if(a>1){u.classList.remove("hidden");const m=u.querySelector(".tooltip-value");m&&(m.textContent=`x${a.toFixed(2)} multiplier`)}else u.classList.add("hidden");const c=s.querySelector("[data-soul-tooltip-total]");if(c){const m=c.querySelector(".tooltip-value");m&&(m.textContent=Cr(r),m.className=`tooltip-value ${r>=0?"text-positive":"text-red"}`)}},or=(e,r)=>{const t=et[e];return`
    <div class="flex items-center gap-2 py-1 px-1 border-b border-muted--30 cursor-pointer hover-bg-panel--50" data-collapse-toggle="${e}">
      <span class="text-steel text-xs w-4">${t?"+":""}</span>
      <span class="text-gold text-sm font-mono">${r}</span>
    </div>
  `},Dp=()=>{if(!ye)return;const e=M.getState(),r=D(e.realms.realm3.recipeInventory,"soulcaster"),t=D(e.realms.realmU.recipeInventory,"u_portal_knight"),a=e.realms.realm4,n=a.towerLevels.gem_tower,s=a.towerLevels.military_tower,o=`r4|${r.toString()}|${t.toString()}|${n}|${s}`;if(oa&&ye.dataset.structureKey===o)return;const i=me("soulcaster"),l=vt.u_portal_knight;ye.innerHTML=`
    <div class="inventory-sections overflow-y-auto pr-2" style="flex: 1; min-height: 0;">
      ${or("r4resources","Resources")}
      <table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>
          <tr>
            <td class="text-text text-sm">SOUL</td>
            <td>
              <img src="${i.icon}" alt="Soulcaster" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-r4-soulcaster>${N(r)}</td>
            <td></td>
          </tr>
          <tr>
            <td class="text-text text-sm">PKNT</td>
            <td>
              <img src="${(l==null?void 0:l.icon)??""}" alt="Portal Knight" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-r4-portal-knight>${N(t)}</td>
            <td></td>
          </tr>
        </tbody>
      </table>
      ${or("r4towers","Towers")}
      <div class="px-2 py-1 text-sm">
        <div class="flex justify-between"><span class="text-steel">Gem Tower</span><span class="text-cyan font-mono">Lv.${n}</span></div>
        <div class="flex justify-between"><span class="text-steel">Military Tower</span><span class="text-cyan font-mono">Lv.${s}</span></div>
      </div>
    </div>
  `,ye.dataset.structureKey=o,oa=!0},Js=()=>{if(!ye)return;const e=M.getState();if(e.activeRealm==="realm4"){Dp();return}const r=J(e),{mana:t,recipeInventory:a,recipeCrafting:n,upgrades:s,artifacts:o,altar:i}=r,l=Xt(a),p=ia(a),u=cr(a),c=Jd(e.activeRealm,e.globalTier),g=er(e.activeRealm,e.globalTier),m=Bt(e.activeRealm,e.globalTier),h=To(n,m),f=De(e.activeRealm),v=f.MODIFIERS.manaModifier,S=e.activeRealm==="realm3",b=S?new d(0):os(l,v),T=e.globalTier>=3?"realmU":"realm1",w=Er(e.realms[T].combat.heroicVictories,e.activeRealm,T),$=S?Ba(r.combat.heroicVictories):1,R=S?1:on(e.realms.realm3.combat.heroicVictories),x=e.activeRealm!=="realm3"?e.realms.realm3.recipeInventory:void 0,y={recipeInventory:a,ascension:e.realms.realm3.ascension,realmId:e.activeRealm,r3Inventory:x,globalTier:e.globalTier,r4TowerLevels:e.realms.realm4.towerLevels,heroicTrialCompleted:e.realms.realm4.heroicTrialCompleted},k=Jo(n,s,o,i,e.globalTier,f.MODIFIERS.craftTimeMultiplier,f.MODIFIERS.calculateSacrificeBonus,f.MODIFIERS.sacrificeBatchSize*ca(s),e.activeRealm,r.combat,f.MODIFIERS.flaskRecipeMultiplier,w,r.prestige,y,$,R),C=S?0:b.add(k.mana).toNumber(),I=S?null:Lp(l,k.mana,v),_=gt.filter(W=>{if(Oe(n,`gem_${W}`)===0)return!1;const le=l[W].toNumber(),ge=(k.recipes[`gem_${W}`]??new d(0)).toNumber();return le!==0||ge!==0}),A=Mt.filter(W=>Oe(n,`flask_${W}`)>0),F=c?$o(cr(e.realms.realm1.recipeInventory),cr(e.realms.realm2.recipeInventory),e.activeRealm,e.globalTier):u,E=m.filter(W=>{if(Oe(n,W)===0)return!1;const le=(F[W]||new d(0)).toNumber(),ge=(k.recipes[W]||new d(0)).toNumber();return le!==0||ge!==0}),P=Mt.some(W=>st(`flask_${W}`,n)),V=m.some(W=>(h.lifetimeCrafted[W]??0)>0),j=Oe(n,"artifact_shard")>0,B=e.activeRealm==="realm1"&&Oe(e.realms.realm1.recipeCrafting,"nullstone")>0,Z=Oe(n,"mythic_fragment")>0,oe=D(a,"arcane_bar").gt(0),U=D(a,"arcane_log").gt(0),O=j||B||Z||oe||U,se=So(e.activeRealm).filter(W=>S&&W==="arcane_soul"?!1:D(a,W).gt(0)||W==="arcane_soul"&&D(a,"soulforge").gt(0)),be=se.length>0,L=_n(e.activeRealm).filter(W=>D(a,W).gt(0)),Y=L.length>0,X=_.join(","),ie=A.join(","),re=E.join(","),ce=se.join(","),Ne=L.join(","),Ve=`${et.gems}|${et.flasks}|${et.military}|${et.expeditions}|${et.creatures}|${et.equipment}`,ke=`${P}|${V}|${j}|${B}|${Z}|${oe}|${U}|${be}|${Y}`,Ce=`${Ve}|${ke}|${X}|${ie}|${re}|${ce}|${Ne}|${e.activeRealm}`;if(!oa||ye.dataset.structureKey!==Ce){let W=`
      <div class="inventory-sections overflow-y-auto pr-2" style="flex: 1; min-height: 0;">`;if(S){const le=me("arcane_soul");W+=`
      <div class="soul-row-wrapper">
        <table style="table-layout: fixed; width: 100%;">
          <colgroup>
            <col style="width: 50px;">
            <col style="width: 36px;">
            <col style="width: 70px;">
            <col>
          </colgroup>
          <tbody>
            <tr>
              <td class="text-text text-sm pr-2">SOUL</td>
              <td>
                <img src="${le.icon}" alt="Arcane Soul" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-r3-soul-value></td>
              <td class="text-right" data-r3-soul-rate></td>
            </tr>
          </tbody>
        </table>
        ${Op()}
      </div>`}else W+=`
      <div class="mana-row-wrapper">
        <table style="table-layout: fixed; width: 100%;">
          <colgroup>
            <col style="width: 50px;">
            <col style="width: 36px;">
            <col style="width: 70px;">
            <col>
          </colgroup>
          <tbody>
            <tr class="mana-row">
              <td class="text-text text-sm pr-2">Mana</td>
              <td>
                <img src="${H("icons/mana.png")}" alt="Mana" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-mana-value></td>
              <td class="text-right" data-mana-rate></td>
            </tr>
          </tbody>
        </table>
        ${Fp()}
      </div>`;if(W+=`
    `,e.activeRealm!=="realm3"&&(W+=or("gems","Gems"),!et.gems)){if(W+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`,_.length===0)W+='<tr><td colspan="4" class="py-1 text-muted text-sm text-center">No gems yet</td></tr>';else for(const le of _)W+=`
            <tr data-gem-row="${le}">
              <td class="text-text text-sm">T${le}</td>
              <td>
                <img src="${Ze[le].icon}" alt="${Ze[le].name}" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-gem-count="${le}"></td>
              <td class="text-right" data-gem-rate="${le}"></td>
            </tr>
          `;W+="</tbody></table>"}if(P&&e.activeRealm!=="realm3"&&(W+=or("flasks","Flasks"),!et.flasks)){if(W+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`,A.length===0)W+='<tr><td colspan="4" class="py-1 text-muted text-sm text-center">No flasks yet</td></tr>';else for(const le of A)W+=`
            <tr data-flask-row="${le}">
              <td class="text-text text-sm">T${le}</td>
              <td>
                <img src="${ea[le].icon}" alt="${ea[le].name}" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-flask-count="${le}"></td>
              <td class="text-right" data-flask-rate="${le}"></td>
            </tr>
          `;W+="</tbody></table>"}if(V&&e.activeRealm!=="realm3"&&(W+=or("military","Expedition Units"),!et.military)){if(W+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`,E.length===0)W+='<tr><td colspan="4" class="py-1 text-muted text-sm text-center">No units yet</td></tr>';else for(const le of E)W+=`
            <tr data-military-row="${le}">
              <td class="text-text text-sm">${g[le].name.slice(0,2)}</td>
              <td>
                <img src="${g[le].icon}" alt="${g[le].name}" style="width: 32px; height: 32px;" class="object-contain">
              </td>
              <td class="text-text font-mono text-sm" data-military-count="${le}"></td>
              <td class="text-right" data-military-rate="${le}"></td>
            </tr>
          `;W+="</tbody></table>"}if(be&&(W+=or("creatures","Magical Creatures"),!et.creatures)){W+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`;for(const le of se){const ge=me(le);W+=`
          <tr>
            <td class="text-text text-sm">${Np(le,ge.name)}</td>
            <td>
              <img src="${ge.icon}" alt="${ge.name}" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-creature-count="${le}"></td>
            <td class="text-right" data-creature-rate="${le}"></td>
          </tr>
        `}W+="</tbody></table>"}if(Y&&(W+=or("equipment","Expedition Equipment"),!et.equipment)){W+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`;for(const le of L){const ge=me(le),Se=le==="pickaxe"?"PICK":le==="axe"?"AXE":le.slice(0,4).toUpperCase();W+=`
          <tr>
            <td class="text-text text-sm">${Se}</td>
            <td>
              <img src="${ge.icon}" alt="${ge.name}" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-equipment-count="${le}"></td>
            <td class="text-right" data-equipment-rate="${le}"></td>
          </tr>
        `}W+="</tbody></table>"}O&&(W+=or("expeditions","Expedition Loot"),et.expeditions||(W+=`<table style="table-layout: fixed; width: 100%;">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 36px;">
          <col style="width: 70px;">
          <col>
        </colgroup>
        <tbody>`,j&&(W+=`
          <tr>
            <td class="text-text text-sm">SHRD</td>
            <td>
              <img src="${H("icons/artifact shard.png")}" alt="Artifact Shards" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-combat-shards></td>
            <td class="text-right" data-combat-shards-rate></td>
          </tr>
        `),B&&(W+=`
          <tr>
            <td class="text-text text-sm">NULS</td>
            <td>
              <img src="${H("icons/nullstone.png")}" alt="Nullstone" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-combat-nullstone></td>
            <td class="text-right" data-combat-nullstone-rate></td>
          </tr>
        `),Z&&(W+=`
          <tr>
            <td class="text-text text-sm">MYTH</td>
            <td>
              <img src="${H("icons/mythic fragment.png")}" alt="Mythic Fragment" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-combat-mythic-fragments></td>
            <td class="text-right" data-combat-mythic-fragments-rate></td>
          </tr>
        `),oe&&(W+=`
          <tr>
            <td class="text-text text-sm">BAR</td>
            <td>
              <img src="${H("icons/arcane bar.png")}" alt="Arcane Bar" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-combat-arcane-bars></td>
            <td class="text-right" data-combat-arcane-bars-rate></td>
          </tr>
        `),U&&(W+=`
          <tr>
            <td class="text-text text-sm">LOG</td>
            <td>
              <img src="${H("icons/arcane log.png")}" alt="Arcane Log" style="width: 32px; height: 32px;" class="object-contain">
            </td>
            <td class="text-text font-mono text-sm" data-combat-arcane-logs></td>
            <td class="text-right" data-combat-arcane-logs-rate></td>
          </tr>
        `),W+="</tbody></table>")),W+="</div>",ye.innerHTML=W,ye.dataset.structureKey=Ce,oa=!0,S||Vp(),S&&jp()}if(S){const W=ye.querySelector("[data-r3-soul-value]");W&&(W.textContent=N(D(a,"arcane_soul")));const le=ye.querySelector("[data-r3-soul-rate]");if(le){const ge=(k.recipes.arcane_soul??new d(0)).toNumber();ge!==0?le.innerHTML=`<span class="text-xs font-mono ${ge>0?"text-positive":"text-red"}">${Cr(ge)}</span>`:le.innerHTML="",Bp(a,ge,e.realms.realm3.ascension,$,e.globalTier)}}else{const W=ye.querySelector("[data-mana-value]");W&&(W.textContent=N(t));const le=ye.querySelector("[data-mana-rate]");if(le)if(C!==0){const Se=t.gte(1e100)?Rp(C):Cr(C);le.innerHTML=`<span class="text-xs font-mono ${C>0?"text-positive":"text-red"}">${Se}</span>`}else le.innerHTML="";I&&Pp(I)}for(const W of _){const le=l[W].toNumber(),ge=(k.recipes[`gem_${W}`]??new d(0)).toNumber(),Se=ye.querySelector(`[data-gem-count="${W}"]`);Se&&(Se.textContent=N(le)),jt(ye.querySelector(`[data-gem-rate="${W}"]`),ge)}for(const W of A){const le=p[W].toNumber(),ge=(k.recipes[`flask_${W}`]??new d(0)).toNumber(),Se=ye.querySelector(`[data-flask-count="${W}"]`);Se&&(Se.textContent=N(le)),jt(ye.querySelector(`[data-flask-rate="${W}"]`),ge)}const Xe=ws(r.combat);for(const W of St){if(W===e.activeRealm)continue;const le=ws(e.realms[W].combat);for(const[ge,Se]of Object.entries(le)){if(Se<=0)continue;const he=vt[ge],Fe=(he==null?void 0:he.realmId)===e.activeRealm,Me=c&&(he==null?void 0:he.realmId)===W;(Fe||Me)&&(Xe[ge]=(Xe[ge]||0)+Se)}}for(const W of E){const le=(F[W]||new d(0)).toNumber(),ge=(k.recipes[W]||new d(0)).toNumber()-(Xe[W]||0),Se=ye.querySelector(`[data-military-count="${W}"]`);Se&&(Se.textContent=N(le)),jt(ye.querySelector(`[data-military-rate="${W}"]`),ge)}if(!et.expeditions){const W=ye.querySelector("[data-combat-shards]");W&&(W.textContent=N(D(a,"artifact_shard").toNumber()));const le=ye.querySelector("[data-combat-nullstone]");le&&(le.textContent=te(D(e.realms.realm1.recipeInventory,"nullstone").toNumber()));const ge=Up(r.combat,e.activeRealm,r.prestige,r.altar.sacrificeCounts,e.globalTier),Se=(k.recipes.artifact_shard??new d(0)).toNumber(),he=(k.recipes.nullstone??new d(0)).toNumber();jt(ye.querySelector("[data-combat-shards-rate]"),ge.shardsPerSecond+Se),jt(ye.querySelector("[data-combat-nullstone-rate]"),ge.nullstonePerSecond+he);const Fe=ye.querySelector("[data-combat-mythic-fragments]");Fe&&(Fe.textContent=N(D(a,"mythic_fragment").toNumber()));const Me=(k.recipes.mythic_fragment??new d(0)).toNumber();jt(ye.querySelector("[data-combat-mythic-fragments-rate]"),ge.mythicFragmentsPerSecond+Me);let Le=0,$e=0;if(S)for(const ne of qn("realm3")){const pe=r.wonderAssignments[ne]||0;if(pe<=0)continue;const z=ht[ne];if(!z)continue;const de=pe/z.secondsPerTick;for(const we of z.tickCost){const xe=we.amount*de;we.recipeId==="arcane_bar"&&(Le+=xe),we.recipeId==="arcane_log"&&($e+=xe)}}const je=ye.querySelector("[data-combat-arcane-bars]");je&&(je.textContent=N(D(a,"arcane_bar").toNumber())),jt(ye.querySelector("[data-combat-arcane-bars-rate]"),(ge.arcaneBarsPerSecond??0)-Le);const ae=ye.querySelector("[data-combat-arcane-logs]");ae&&(ae.textContent=N(D(a,"arcane_log").toNumber())),jt(ye.querySelector("[data-combat-arcane-logs-rate]"),(ge.arcaneLogsPerSecond??0)-$e)}if(!et.creatures){const W=S?ws(r.combat):{},le=S?lr(r.combat.heroicVictories)*lr(e.realms[T].combat.heroicVictories,T):1,ge=e.realms.realmU.artifacts.upgradeLevels.breeding_artifact??0,Se=S?vp(a,e.realms.realm3.ascension,le,ge,e.globalTier):{recipes:{}};for(const he of se){const Fe=D(a,he),Me=ye.querySelector(`[data-creature-count="${he}"]`);Me&&(Me.textContent=N(Fe));let Le=ot(Se.recipes[he]??ue);Le-=W[he]||0,jt(ye.querySelector(`[data-creature-rate="${he}"]`),Le)}}if(!et.equipment){const W={};for(const ge of Object.values(r.combat.activeExpeditions))for(const Se of ge){if(!Se.repeatIfUnitsAvailable||!Se.assignedEquipment)continue;const he=Se.duration/1e3;if(!(he<=0))for(const[Fe,Me]of Object.entries(Se.assignedEquipment))Me<=0||(W[Fe]=(W[Fe]||0)+Me/he)}const le=ir(a);for(const ge of L){const Se=D(a,ge),he=ye.querySelector(`[data-equipment-count="${ge}"]`);he&&(he.textContent=N(Se));const Fe=r.workshopAssignments[ge]||0,Me=me(ge),Le=Tt(e.globalTier),$e=(Fe>0?Fe*le*Le/Me.craftTime:0)-(W[ge]||0);Ip(ye.querySelector(`[data-equipment-rate="${ge}"]`),$e)}}};let Li=!1;const Hp=e=>{const t=e.target.closest("[data-collapse-toggle]");if(t){const a=t.getAttribute("data-collapse-toggle");et[a]=!et[a],oa=!1,Js()}};let Pr=!1,Ss=null;const Vp=()=>{const e=ye==null?void 0:ye.querySelector(".mana-row-wrapper"),r=ye==null?void 0:ye.querySelector(".mana-tooltip");if(!e||!r)return;Tn&&Tn.remove(),document.body.appendChild(r),Tn=r,Ss&&Ss();const t=n=>{const s=e.contains(n.target);if(s&&!Pr){const o=e.getBoundingClientRect();r.style.top=`${o.bottom+4}px`,r.style.left=`${o.left}px`,r.classList.add("visible"),Pr=!0}else!s&&Pr&&(r.classList.remove("visible"),Pr=!1)},a=()=>{Pr&&(r.classList.remove("visible"),Pr=!1)};document.addEventListener("mousemove",t),document.addEventListener("mouseleave",a),Ss=()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseleave",a)}};let Fr=!1,Ts=null;const jp=()=>{const e=ye==null?void 0:ye.querySelector(".soul-row-wrapper"),r=ye==null?void 0:ye.querySelector(".soul-tooltip");if(!e||!r)return;kn&&kn.remove(),document.body.appendChild(r),kn=r,Ts&&Ts();const t=n=>{const s=e.contains(n.target);if(s&&!Fr){const o=e.getBoundingClientRect();r.style.top=`${o.bottom+4}px`,r.style.left=`${o.left}px`,r.classList.add("visible"),Fr=!0}else!s&&Fr&&(r.classList.remove("visible"),Fr=!1)},a=()=>{Fr&&(r.classList.remove("visible"),Fr=!1)};document.addEventListener("mousemove",t),document.addEventListener("mouseleave",a),Ts=()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseleave",a)}},Ui=()=>{ye=document.getElementById("inventory"),ye&&(oa=!1,Li||(ye.addEventListener("click",Hp),Li=!0),Js(),Ka(Ee.Inventory,Js))},Ot={},Gp=()=>{const{collapsedSections:e}=M.getState();for(const r of e)Ot[r]=!1};let eo=!1;const Wp=()=>{eo||(eo=!0,Gp())},Kp=()=>{const e=Object.entries(Ot).filter(([,r])=>!r).map(([r])=>r);M.setState({collapsedSections:e})},Et=(e,r,t,a=!0,n="")=>{Wp(),Ot[e]===void 0&&(Ot[e]=a);const s=Ot[e];return`
    <div>
      <div class="w-full flex items-center" style="padding: 8px 12px; gap: 10px;">
        <button
          data-action="toggle-collapsible"
          data-id="${e}"
          class="hover-opacity-100"
          style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; opacity: 0.6; cursor: pointer; color: var(--color-steel); font-size: 16px;"
        >
          ${s?"":"+"}
        </button>
        <span style="color: var(--color-steel);">${r}</span>
        ${n?`<div class="ml-auto">${n}</div>`:""}
      </div>
      <div data-collapsible-content="${e}" class="p-3 pt-0" style="${s?"":"display: none;"}">${t}</div>
    </div>
  `},Yp=e=>{Ot[e]=!Ot[e],Kp()},zp=()=>{for(const e of Object.keys(Ot))delete Ot[e];eo=!1};document.addEventListener("click",e=>{const t=e.target.closest('[data-action="toggle-collapsible"]');if(t){const a=t.getAttribute("data-id");Yp(a);const n=Ot[a];t.textContent=n?"":"+";const s=document.querySelector(`[data-collapsible-content="${a}"]`);s&&(s.style.display=n?"":"none")}});const Dt=(e,r,t)=>{let a=null;const n=()=>{var o;(o=t==null?void 0:t.onCleanup)==null||o.call(t),wc(e),a=null};return{cleanup:n,render:o=>{n(),a=o;const i=r(a);Ka(e,()=>{a&&i()}),i()},getContainer:()=>a}},Xp={forge_enhancer:"Multiplies Arcane Soul output by 1 + count. Crafted in the Realm of War from T8 gems.",soulforge:"After unification, each soulforge multiplies output by its own count (total = count).",arcane_well:"Multiplies Arcane Soul output by x1.25 per building. Built in the Village tab.",asc_arcane_soul_prod:"Multiplies Arcane Soul output by x1.3 per ascension level."},Pi=(e,r,t,a,n,s,o,i,l,p=0)=>{var f,v;const u=dr[e];if(!u)return"";const c=me(u.produces),g=u.amountPerCycle/u.cycleDuration;let m=`<div class="tooltip-title">${c.name} Production</div><div class="tooltip-divider"></div>`;m+=`<div class="tooltip-row"><span class="tooltip-label">Base rate</span><span class="tooltip-value">${N(u.amountPerCycle)} / ${u.cycleDuration}s</span></div>`,m+=`<div class="tooltip-row"><span class="tooltip-label">Owned</span><span class="tooltip-value text-positive">x${N(r)}</span></div>`;for(const[S,b]of Object.entries(ht)){if(b.creatureProductionMultiplier===1)continue;const T=((f=i[S])==null?void 0:f.toNumber())??0;if(T<=0)continue;const w=Math.pow(b.creatureProductionMultiplier,T),$=me(S);m+=`<div class="tooltip-row"><span class="tooltip-label">${$.name} (x${T})</span><span class="tooltip-value text-steel">x${N(w)}</span></div>`}for(const[S,b]of Object.entries(qa)){if(!b.creatureProductionMultiplier||b.creatureProductionMultiplier===1)continue;const T=((v=i[S])==null?void 0:v.toNumber())??0;if(T<=0)continue;const w=Math.pow(b.creatureProductionMultiplier,T),$=me(S);m+=`<div class="tooltip-row"><span class="tooltip-label">${$.name} (x${T})</span><span class="tooltip-value text-steel">x${N(w)}</span></div>`}if(a>1&&(m+=`<div class="tooltip-row"><span class="tooltip-label">Heroic (R3)</span><span class="tooltip-value text-steel">x${N(a)}</span></div>`),n>1&&(m+=`<div class="tooltip-row"><span class="tooltip-label">Heroic (${s})</span><span class="tooltip-value text-steel">x${N(n)}</span></div>`),p>0){const S=Math.pow(1.2,p);m+=`<div class="tooltip-row"><span class="tooltip-label">Breeding Artifact (lv${p})</span><span class="tooltip-value text-steel">x${N(S)}</span></div>`}if(l>=4){const S=Tt(l);m+=`<div class="tooltip-row"><span class="tooltip-label">Tier ${l>=5?5:4} bonus</span><span class="tooltip-value text-steel">x${S}</span></div>`}o>1&&(m+=`<div class="tooltip-row"><span class="tooltip-label">Ascension speed</span><span class="tooltip-value text-steel">x${N(o)}</span></div>`);const h=g*r.toNumber()*t*o;return m+=`<div class="tooltip-row"><span class="tooltip-label">Total</span><span class="tooltip-value text-gold">${N(h)}/s</span></div>`,m},ya=[{recipeId:"pixie"},{recipeId:"arcane_warden"},{recipeId:"eidolon"},{recipeId:"mana_wisp"},{recipeId:"anima_core"},{recipeId:"luminary"},{recipeId:"emperor"}],Fi=(e,r)=>r.every(t=>t.recipeId?D(e,t.recipeId).gte(t.amount):!0),Zp=e=>e.map(r=>{if(r.recipeId){const t=me(r.recipeId);return`<img src="${t.icon}" alt="${t.name}" style="width: 40px; height: 40px;" class="object-contain"><span>${N(r.amount)}</span>`}return""}).filter(Boolean).join(""),Qp=e=>{const r=()=>{var K,se,be;const t=M.getState(),a=J(t),{recipeCrafting:n}=a,s=D(a.recipeInventory,"soulforge"),o=me("soulforge"),i=me("arcane_soul"),l=n.arcane_soul,p=(l==null?void 0:l.progress)??0,u=p>=1,c=s.toNumber(),g={recipeInventory:a.recipeInventory,ascension:a.ascension,realmId:"realm3",globalTier:t.globalTier,r4TowerLevels:t.realms.realm4.towerLevels,heroicTrialCompleted:t.realms.realm4.heroicTrialCompleted},m=t.globalTier>=3?"realmU":"realm1",h=Er(t.realms[m].combat.heroicVictories,"realm3",m),f=Ba(a.combat.heroicVictories),v=Vn("arcane_soul",a.upgrades,a.artifacts,a.altar,()=>new d(1),1,h,a.prestige,g).mul(f),S=c>0?c*v.toNumber()/i.craftTime:0;let b='<div class="mobile-scroll-x">';b+='<table class="text-sm font-mono valign-mid r3-soul-table" style="table-layout: fixed; width: 750px">',b+="<colgroup>",b+='<col style="width: 230px">',b+='<col style="width: 75px">',b+='<col style="width: 280px">',b+='<col style="width: 130px">',b+='<col style="width: 60px">',b+="</colgroup>",b+="<tbody>";const w=[{label:`Produces Arcane Souls passively. Crafted in the ${t.globalTier>=3?"Unified Realm":"Prime Realm"} from T8 gems.`},{label:"Production",value:`1 Arcane Soul / ${i.craftTime}s`},{label:"Cost escalation",value:`x${o.escalatingCost} per craft`}],$=`<img src="${o.icon}" alt="Soulforge" style="width: 40px; height: 40px;" class="object-contain">`,R='<span class="text-magenta">Soulforge</span>';b+='<tr style="background-color: var(--color-tooltip-bg)">',b+='<td class="py-2 px-2"><span class="inline-flex items-center gap-1.5">',b+=dt(w,"Soulforge",$),b+=dt(w,"Soulforge",R),b+="</span></td>",b+=`<td class="text-left px-2" data-r3-soulforge-count>x${te(c)}</td>`,b+='<td class="px-2"><span class="inline-flex items-center gap-1">',b+=`<img src="${i.icon}" alt="Arcane Soul" style="width: 40px; height: 40px;" class="object-contain">`,b+='<span class="text-gold">Arcane Soul</span>',b+=`<span class="text-positive" data-r3-rate>${c>0?`(${N(S)}/s)`:""}</span>`,b+="</span></td>",b+='<td class="px-2"><div class="inline-flex items-center gap-2">',b+='<div class="h-4 overflow-hidden craft-progress-bg" style="width: 80px">',b+=`<div data-r3-progress-bar="arcane_soul" class="h-full craft-progress-fill${u?" blocked":""}" style="width: ${p*100}%"></div>`,b+="</div></div></td>",b+=`<td class="px-2 text-steel text-xs" data-r3-craft-time="arcane_soul">${N(i.craftTime)}s</td>`,b+="</tr>";let x=0;if(i.outputMultipliers)for(const G of i.outputMultipliers){if(G.minGlobalTier!==void 0&&t.globalTier<G.minGlobalTier||G.maxGlobalTier!==void 0&&t.globalTier>G.maxGlobalTier)continue;let L=0,Y=0;if(G.type==="inventory"?(Y=((K=a.recipeInventory[G.source])==null?void 0:K.toNumber())??0,L=G.formula(Y)):G.type==="ascension"&&a.ascension&&(Y=a.ascension.upgrades[G.source]??0,L=G.formula(Y)),L<=1)continue;const X=vt[G.source],ie=(X==null?void 0:X.icon)??(G.type==="ascension"?H("icons/ascended souls.png"):null),re=Xp[G.source],ce=re?[{label:re}]:void 0,Ne=x%2===0?"var(--color-row-odd)":"var(--color-tooltip-bg)";b+=`<tr style="background-color: ${Ne}" data-r3-mult-row="${G.source}">`,b+='<td class="py-2 px-2"><span class="inline-flex items-center gap-1.5">';const Ve=ie?`<img src="${ie}" alt="${G.label}" style="width: 40px; height: 40px;" class="object-contain">`:"",ke=`<span class="text-magenta">${G.label}</span>`;ce?(Ve&&(b+=dt(ce,G.label,Ve)),b+=dt(ce,G.label,ke)):b+=Ve+ke,b+="</span></td>",b+=`<td class="text-left px-2" data-r3-mult-count="${G.source}">x${te(Y)}</td>`,b+=`<td class="px-2" colspan="3"><span class="inline-flex items-center gap-1" data-r3-mult-value="${G.source}"><img src="${i.icon}" alt="Arcane Soul" style="width: 40px; height: 40px;" class="object-contain"> <span class="text-positive">x${L.toFixed(2)}</span></span></td>`,b+="</tr>",x++}if(f>1){const G=x%2===0?"var(--color-row-odd)":"var(--color-tooltip-bg)",L=[{label:"Multiplies Arcane Soul output by x1.2 per Soul Mastery heroic victory."}],Y=`<img src="${H("icons/arcane soul.png")}" alt="Soul Mastery" style="width: 40px; height: 40px;" class="object-contain">`,X='<span class="text-magenta">Soul Mastery</span>';b+=`<tr style="background-color: ${G}" data-r3-mult-row="heroic_soul">`,b+='<td class="py-2 px-2"><span class="inline-flex items-center gap-1.5">',b+=dt(L,"Soul Mastery",Y),b+=dt(L,"Soul Mastery",X),b+="</span></td>";const ie=a.combat.heroicVictories.r3_heroic_soul_mastery??0;b+=`<td class="text-left px-2" data-r3-mult-count="heroic_soul">x${te(ie)}</td>`,b+=`<td class="px-2" colspan="3"><span class="inline-flex items-center gap-1" data-r3-mult-value="heroic_soul"><img src="${i.icon}" alt="Arcane Soul" style="width: 40px; height: 40px;" class="object-contain"> <span class="text-positive">x${f.toFixed(2)}</span></span></td>`,b+="</tr>",x++}if(b+="</tbody></table>",b+="</div>",s.eq(0)){const G=t.globalTier>=3?"Unified Realm":"Prime Realm";b+=`<div class="text-muted text-sm mt-4">Craft Soulforges in the ${G} to begin generating Arcane Souls.</div>`}const y=G=>`border-${G} text-${G} hover-bg-${G}--20 cursor-pointer`,k="border-muted--30 text-muted cursor-not-allowed",C=["var(--color-tooltip-bg)","var(--color-row-odd)"],I=Na(a.ascension),_=lr(a.combat.heroicVictories),A=lr(t.realms[m].combat.heroicVictories,m),F=_*A,E=t.globalTier>=3?"RU":"R1",P=t.realms.realmU.artifacts.upgradeLevels.breeding_artifact??0,V=Tt(t.globalTier),j=Mn(a.recipeInventory,P)*F*V,B=t.globalTier>=4,Z=B?"grid-template-columns: 180px 75px 120px 145px 200px 180px 50px 90px; gap: 0 16px; padding: 0 12px;":"grid-template-columns: 180px 75px 120px 145px 200px 180px; gap: 0 16px; padding: 0 12px;",oe=t.realms.realm4.heroicTrialCompleted,U=(G,L)=>{var Le;if(!Gr(G.recipeId,n,oe)){const $e=Ds[G.recipeId];if(!$e||$e.requiredHeroicTrial&&oe<$e.requiredHeroicTrial||!Gr($e.requiredRecipe,n,oe))return"";const je=((Le=n[$e.requiredRecipe])==null?void 0:Le.lifetimeProduced)??0,ae=me($e.requiredRecipe);return`<div data-r3-creature-locked="${G.recipeId}" class="r3-creature-row py-2 px-2" style="background-color: ${C[L%2]}">
            <span class="text-muted text-sm">???  Craft ${te($e.lifetimeThreshold)} ${ae.name}s (<span data-r3-locked-progress="${G.recipeId}">${te(je)}</span>/${te($e.lifetimeThreshold)})</span>
        </div>`}const Y=me(G.recipeId),X=D(a.recipeInventory,G.recipeId),ie=dr[G.recipeId],re=n[G.recipeId],ce=(re==null?void 0:re.progress)??0,Ne=Y.recipe.length>0,Ve=Ne?Zp(Y.recipe):'<span class="text-positive text-xs">Free</span>',ke=!Ne||Fi(a.recipeInventory,Y.recipe),Ce=ke?y("cyan"):k,Xe=ie?ie.amountPerCycle*j:0,W=ie?Pi(G.recipeId,X,j,_,A,E,I,a.recipeInventory,t.globalTier,P):"",le=ie?`<span class="hover-tooltip-wrapper"><span class="inline-flex items-center gap-1 text-positive">
            <img src="${me(ie.produces).icon}" alt="${me(ie.produces).name}" style="width: 40px; height: 40px;" class="object-contain">
            <span data-r3-produces="${G.recipeId}">${N(new d(Xe))}</span>
          </span><div class="hover-tooltip" data-r3-produce-tooltip="${G.recipeId}">${W}</div></span>`:'<span class="text-muted text-xs"></span>',ge=ie?`<div class="inline-flex items-center gap-2">
            <div class="h-4 overflow-hidden craft-progress-bg" style="width: 80px">
              <div data-r3-progress-bar="${G.recipeId}" class="h-full craft-progress-fill" style="width: ${ce*100}%"></div>
            </div>
            <span class="text-steel text-xs" data-r3-cycle-time="${G.recipeId}">${N(ie.cycleDuration/I)}s</span>
          </div>`:"",Se=Ne?`<button data-action="buy-creature" data-creature="${G.recipeId}" data-mode="one" class="px-2 py-1 text-xs font-mono border ${Ce}" ${ke?"":"disabled"}>1</button>
           <button data-action="buy-creature" data-creature="${G.recipeId}" data-mode="ten_percent" class="px-2 py-1 text-xs font-mono border ${Ce}" ${ke?"":"disabled"}>10%</button>
           <button data-action="buy-creature" data-creature="${G.recipeId}" data-mode="all" class="px-2 py-1 text-xs font-mono border ${Ce}" ${ke?"":"disabled"}>100%</button>`:`<button data-action="buy-creature" data-creature="${G.recipeId}" data-mode="one" class="px-2 py-1 text-xs font-mono border ${y("cyan")}">+1</button>`,he=B&&Ne?`<div class="text-center"><input type="checkbox" data-action="toggle-auto-creature" data-creature="${G.recipeId}" ${a.autoBuyCreatures[G.recipeId]?"checked":""}></div>`:B?"<div></div>":"",Fe=xo[G.recipeId],Me=B&&Ne&&Fe?(()=>{const $e=a.autoBuyCreatureLimits[G.recipeId]??kl,je=me(Fe);return`<div class="text-center inline-flex items-center gap-1 justify-center">
              <img src="${je.icon}" alt="${je.name}" style="width: 16px; height: 16px;" class="object-contain" title="${je.name}">
              <span class="text-steel text-xs"></span>
              <input type="number" min="0" value="${$e}" data-action="set-creature-limit" data-creature="${G.recipeId}" class="text-xs font-mono text-center" style="width: 50px; background: var(--color-row-odd); border: 1px solid var(--color-muted-30); color: var(--color-text); padding: 1px 4px;">
            </div>`})():B?"<div></div>":"";return`<div data-r3-creature-row="${G.recipeId}" class="r3-creature-row items-center py-1" style="${Z} background-color: ${C[L%2]}">
        <div class="r3-creature-info">
          <div>
            <span class="inline-flex items-center gap-1.5">
              <img src="${Y.icon}" alt="${Y.name}" style="width: 40px; height: 40px;" class="object-contain">
              <span class="text-cyan">${Y.name}</span>
            </span>
          </div>
          <div class="text-left" data-r3-count="${G.recipeId}">${N(X)}</div>
          <div>${le}</div>
          <div>${ge}</div>
        </div>
        <div class="r3-creature-controls">
          <div><span class="inline-flex items-center gap-1">${Ve}</span></div>
          <div class="text-center"><div class="inline-flex items-center gap-1">${Se}</div></div>
          ${he}
          ${Me}
        </div>
      </div>`};if(b+=`<div class="mt-4">
      <div class="r3-creature-table-header text-steel text-sm font-mono border-b border-muted--30" style="${Z}">
        <div class="r3-creature-info">
          <div class="py-1">Creature</div>
          <div class="py-1">Owned</div>
          <div class="py-1">Produces</div>
          <div class="py-1">Progress</div>
        </div>
        <div class="r3-creature-controls">
          <div class="py-1">Cost</div>
          <div class="py-1 text-center">Buy</div>
          ${B?'<div class="py-1 text-center"><button data-action="toggle-all-auto-creature" class="text-steel text-xs cursor-pointer hover-text-cyan" style="background: none; border: none; padding: 0;">Auto</button></div>':""}
          ${B?'<div class="py-1 text-center hover-tooltip-wrapper"><span class="text-steel text-xs">Stop at</span><div class="hover-tooltip" style="width: 200px; white-space: normal;">Stop auto-buying when the next-tier creature reaches this count</div></div>':""}
        </div>
      </div>
      ${ya.map((G,L)=>U(G,L)).join("")}
    </div>`,st("soulcaster",n)){const G=me("soulcaster"),L=me("luminary"),Y=D(a.recipeInventory,"soulcaster"),X=zs(a),ie=D(a.recipeInventory,"luminary"),re=ie.gte(X),ce=Math.min(1,ie.div(X).toNumber()),Ne=re?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed";b+=`
        <div class="mt-4 flex items-center gap-4 py-2 px-3" style="background-color: var(--color-tooltip-bg)" data-soulcaster-section>
          <img src="${G.icon}" alt="Soulcaster" style="width: 40px; height: 40px;" class="object-contain">
          <div class="flex-1">
            <span class="text-magenta font-mono text-sm">Soulcaster</span>
            <span class="text-steel text-xs ml-2">Casts souls into the Realm of Earth</span>
          </div>
          <span class="text-sm text-text font-mono" data-soulcaster-count>Owned: ${N(Y)}</span>
          <button
            data-action="craft-soulcaster"
            ${re?"":"disabled"}
            class="relative px-3 py-1 text-sm font-mono border overflow-hidden ${Ne}"
            style="min-width: 180px;"
          >
            ${Yt(ce,"data-soulcaster-progress")}
            <span class="relative z-10 flex items-center justify-center gap-2">
              Forge -
              <span class="inline-flex items-center gap-1">
                <span data-soulcaster-cost>${N(X)}</span>
                <img src="${L.icon}" alt="Luminary" style="width: 20px; height: 20px;" class="object-contain">
              </span>
            </span>
          </button>
        </div>
      `}e.innerHTML=b,e.querySelectorAll('[data-action="buy-creature"]').forEach(G=>{G.addEventListener("click",()=>{const L=G.getAttribute("data-creature"),Y=G.getAttribute("data-mode");M.getState().buyCreature(L,Y)})}),e.querySelectorAll('[data-action="toggle-auto-creature"]').forEach(G=>{G.addEventListener("change",()=>{const L=G.getAttribute("data-creature");M.getState().toggleAutoBuyCreature(L)})}),(se=e.querySelector('[data-action="toggle-all-auto-creature"]'))==null||se.addEventListener("click",()=>{const L=M.getState().realms.realm3,Y=ya.filter(ie=>me(ie.recipeId).recipe.length>0).map(ie=>ie.recipeId),X=Y.every(ie=>L.autoBuyCreatures[ie]);for(const ie of Y){const re=L.autoBuyCreatures[ie]??!1;(X?re:!re)&&M.getState().toggleAutoBuyCreature(ie)}}),e.querySelectorAll('[data-action="set-creature-limit"]').forEach(G=>{G.addEventListener("change",()=>{const L=G.getAttribute("data-creature"),Y=Math.max(0,parseInt(G.value)||0);G.value=String(Y),M.getState().setAutoBuyCreatureLimit(L,Y)})}),(be=e.querySelector('[data-action="craft-soulcaster"]'))==null||be.addEventListener("click",()=>{M.getState().craftSoulcaster()})};return r(),()=>{var A,F;const t=M.getState(),a=J(t),s=D(a.recipeInventory,"soulforge").toNumber(),o=me("arcane_soul"),i={recipeInventory:a.recipeInventory,ascension:a.ascension,realmId:"realm3",globalTier:t.globalTier,r4TowerLevels:t.realms.realm4.towerLevels,heroicTrialCompleted:t.realms.realm4.heroicTrialCompleted},l=t.globalTier>=3?"realmU":"realm1",p=Er(t.realms[l].combat.heroicVictories,"realm3",l),u=Ba(a.combat.heroicVictories),c=Vn("arcane_soul",a.upgrades,a.artifacts,a.altar,()=>new d(1),1,p,a.prestige,i).mul(u),g=s>0?s*c.toNumber()/o.craftTime:0,m=e.querySelector("[data-r3-soulforge-count]");m&&(m.textContent=`x${te(s)}`);let h=!1;if(o.outputMultipliers)for(const E of o.outputMultipliers){if(E.minGlobalTier!==void 0&&t.globalTier<E.minGlobalTier||E.maxGlobalTier!==void 0&&t.globalTier>E.maxGlobalTier)continue;let P=0,V=0;E.type==="inventory"?(V=((A=a.recipeInventory[E.source])==null?void 0:A.toNumber())??0,P=E.formula(V)):E.type==="ascension"&&a.ascension&&(V=a.ascension.upgrades[E.source]??0,P=E.formula(V));const j=P>1,B=e.querySelector(`[data-r3-mult-row="${E.source}"]`);if(j&&!B||!j&&B){h=!0;break}if(B){const Z=e.querySelector(`[data-r3-mult-count="${E.source}"]`);Z&&(Z.textContent=`x${te(V)}`);const oe=e.querySelector(`[data-r3-mult-value="${E.source}"]`);if(oe){const U=oe.querySelector(".text-positive");U&&(U.textContent=`x${P.toFixed(2)}`)}}}if(!h){const E=u>1,P=e.querySelector('[data-r3-mult-row="heroic_soul"]');if(E&&!P||!E&&P)h=!0;else if(P){const V=a.combat.heroicVictories.r3_heroic_soul_mastery??0,j=e.querySelector('[data-r3-mult-count="heroic_soul"]');j&&(j.textContent=`x${te(V)}`);const B=e.querySelector('[data-r3-mult-value="heroic_soul"]');if(B){const Z=B.querySelector(".text-positive");Z&&(Z.textContent=`x${u.toFixed(2)}`)}}}if(h){r();return}const f=e.querySelector("[data-r3-rate]");f&&(f.textContent=s>0?`(${N(g)}/s)`:"");const v=a.recipeCrafting.arcane_soul,S=(v==null?void 0:v.progress)??0,b=S>=1;Zr(e.querySelector('[data-r3-progress-bar="arcane_soul"]'),S,b);const T=Na(a.ascension),w=lr(a.combat.heroicVictories),$=lr(t.realms[l].combat.heroicVictories,l),R=w*$,x=t.globalTier>=3?"RU":"R1",y=t.realms.realmU.artifacts.upgradeLevels.breeding_artifact??0,k=Tt(t.globalTier),C=Mn(a.recipeInventory,y)*R*k;for(const E of ya){const P=me(E.recipeId),V=D(a.recipeInventory,E.recipeId),j=dr[E.recipeId],B=Gr(E.recipeId,a.recipeCrafting,t.realms.realm4.heroicTrialCompleted),Z=e.querySelector(`[data-r3-count="${E.recipeId}"]`);if(Z&&(Z.textContent=N(V)),j){const oe=e.querySelector(`[data-r3-produces="${E.recipeId}"]`);oe&&(oe.textContent=N(new d(j.amountPerCycle*C)));const U=e.querySelector(`[data-r3-produce-tooltip="${E.recipeId}"]`);U&&(U.innerHTML=Pi(E.recipeId,V,C,w,$,x,T,a.recipeInventory,t.globalTier,y));const O=a.recipeCrafting[E.recipeId],K=(O==null?void 0:O.progress)??0;Zr(e.querySelector(`[data-r3-progress-bar="${E.recipeId}"]`),K,!1);const se=e.querySelector(`[data-r3-cycle-time="${E.recipeId}"]`);se&&(se.textContent=`${N(j.cycleDuration/T)}s`)}if(B&&P.recipe.length>0){const oe=Fi(a.recipeInventory,P.recipe);e.querySelectorAll(`[data-action="buy-creature"][data-creature="${E.recipeId}"]`).forEach(O=>{const K=O;oe?(K.disabled=!1,K.className="px-2 py-1 text-xs font-mono border border-cyan text-cyan hover-bg-cyan--20 cursor-pointer"):(K.disabled=!0,K.className="px-2 py-1 text-xs font-mono border border-muted--30 text-muted cursor-not-allowed")});const U=e.querySelector(`[data-action="toggle-auto-creature"][data-creature="${E.recipeId}"]`);U&&(U.checked=a.autoBuyCreatures[E.recipeId]??!1)}}for(const E of ya){const P=e.querySelector(`[data-r3-locked-progress="${E.recipeId}"]`);if(P){const V=Ds[E.recipeId];if(V){const j=((F=a.recipeCrafting[V.requiredRecipe])==null?void 0:F.lifetimeProduced)??0;P.textContent=te(j)}}}for(const E of ya){const P=Gr(E.recipeId,a.recipeCrafting,t.realms.realm4.heroicTrialCompleted),V=e.querySelector(`[data-r3-creature-row="${E.recipeId}"]`);if(P&&!V){r();return}}const I=st("soulcaster",a.recipeCrafting),_=e.querySelector("[data-soulcaster-section]");if(I&&!_){r();return}if(_&&I){const E=D(a.recipeInventory,"soulcaster"),P=zs(a),V=D(a.recipeInventory,"luminary"),j=V.gte(P),B=Math.min(1,V.div(P).toNumber()),Z=e.querySelector("[data-soulcaster-count]");Z&&(Z.textContent=`Owned: ${N(E)}`);const oe=e.querySelector("[data-soulcaster-cost]");oe&&(oe.textContent=N(P)),zt(e.querySelector("[data-soulcaster-progress]"),B);const U=e.querySelector('[data-action="craft-soulcaster"]');if(U){U.disabled=!j;const O=j?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed";U.className=`relative px-3 py-1 text-sm font-mono border overflow-hidden ${O}`}}}},ks=e=>{const r=M.getState(),t=J(r),a=De(r.activeRealm),n=me(e),s=Qo(e,t.upgrades,t.artifacts,r.globalTier,a.MODIFIERS.craftTimeMultiplier);return n.craftTime/s},Or=(e,r,t)=>`<span class="text-text" style="display: inline-block; width: 68px">${e}</span><span class="${t}">(${r}/s)</span>`,Jp="grid-template-columns: 120px 210px 20px 235px 90px 110px 55px 70px; gap: 16px; padding-left: 12px;",ri=(e,r)=>{const t=r%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)",a=e.type==="gem"?"assign-crafter":e.type==="flask"?"assign-flask-crafter":"assign-military-crafter",n=e.type==="military"?`data-id="${e.id}"`:`data-tier="${e.id}"`,s=e.type==="gem"?"":e.type==="flask"?"flask-":"military-",o=`
    <div class="recipe-row items-center py-1" style="${Jp} background-color: ${t}">
      <div class="craft-row-info">
        <div class="text-gold text-sm whitespace-nowrap">${e.name}</div>
        <div class="flex items-center"><span class="hover-tooltip-wrapper">${e.ingredients}<div class="hover-tooltip" data-${s}input-tooltip="${e.id}">${e.inputTooltipHtml??""}</div></span></div>
        <div class="text-text text-center"></div>
        <div class="flex items-center gap-1 mr-2.5">
          <span class="hover-tooltip-wrapper"><span class="flex items-center gap-1"><img src="${e.icon}" alt="${e.name}" style="width: 40px; height: 40px;" class="object-contain"><span class="text-text text-sm" data-${s}recipe-output="${e.id}">${e.outputAmount}</span></span><div class="hover-tooltip" data-${s}output-tooltip="${e.id}">${e.outputTooltipHtml??""}</div></span>
        </div>
      </div>
      <div class="craft-row-controls">
        <div class="flex items-center gap-1">
          <button data-action="${a}" ${n} data-delta="-1000000" class="craft-all-btn text-red hover-text-white hover-bg-red--20 font-mono text-xs font-bold border border-text focus-outline-none relative" style="width: 28px; height: 28px;"><span class="absolute inset-0 flex items-center justify-center"></span></button>
          <button data-action="${a}" ${n} data-delta="-1" class="text-red hover-text-white hover-bg-red--20 font-mono text-xl font-bold border border-text focus-outline-none relative" style="width: 28px; height: 28px;"><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;"></span></button>
          <span data-${s}crafter-count="${e.id}" class="text-positive text-center font-mono text-sm w-8">${te(e.assigned)}</span>
          <button data-action="${a}" ${n} data-delta="1" class="text-positive hover-text-white hover-bg-positive--20 font-mono text-xl font-bold border border-text focus-outline-none relative" style="width: 28px; height: 28px;"><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;">+</span></button>
          <button data-action="${a}" ${n} data-delta="1000000" class="craft-all-btn text-positive hover-text-white hover-bg-positive--20 font-mono text-xs font-bold border border-text focus-outline-none relative" style="width: 28px; height: 28px;"><span class="absolute inset-0 flex items-center justify-center">++</span></button>
        </div>
        <div class="w-24 h-4 overflow-hidden craft-progress-bg">
          <div data-${s}progress-bar="${e.id}" class="h-full craft-progress-fill${e.blocked?" blocked":""}" style="width: ${e.progress*100}%"></div>
        </div>
        <div class="text-sm text-text" data-${s}craft-time="${e.id}">${N(e.craftTime)}s</div>
        <div class="text-sm text-positive">${e.effectText||""}</div>
      </div>
    </div>`,i=`
    <div class="unlock-row unlock-progress-bg text-steel text-sm py-1" style="background-color: ${t}">
      <div data-${s}unlock-bar="${e.recipeId}" class="unlock-progress-fill h-full" style="width: 0%; background-color: ${t}"></div>
      <div class="unlock-progress-label">
        <span>Craft</span>
        ${e.unlockIcon?`<img src="${e.unlockIcon}" alt="" style="width: 40px; height: 40px;" class="object-contain">`:""}
        <span data-${s}unlock-progress="${e.recipeId}">to unlock</span>
      </div>
    </div>`;return`<div data-row-state="${e.rowState}" data-recipe-row="${e.recipeId}">${o}${i}</div>`},Br=(e,r,t,a,n,s,o)=>{const i=[];i.push({label:r,value:N(t)});for(const p of a){const u=p.value instanceof d?p.value:new d(p.value);u.eq(1)||i.push({label:p.label,value:`x${N(u)}`,valueClass:"text-steel"})}n>1&&i.push({label:"Crafters",value:`x${n}`,valueClass:"text-positive"}),n>0?(i.push({label:"Craft speed",value:`${N(s)}/s`,valueClass:"text-steel"}),i.push({label:"Total",value:`${N(o)}/s`,valueClass:"text-gold"})):i.push({label:"Total",value:N(o),valueClass:"text-gold"});let l=`<div class="tooltip-title">${e}</div><div class="tooltip-divider"></div>`;for(const p of i)l+=`<div class="tooltip-row"><span class="tooltip-label">${p.label}</span>`,p.value!==void 0&&(l+=`<span class="tooltip-value ${p.valueClass??""}">${p.value}</span>`),l+="</div>";return l},ai=e=>{const r=me(e);return r.unlockCondition?me(r.unlockCondition.recipeId).icon:void 0},ef=(e,r,t)=>{const a=Ze[e],n=`gem_${e}`,s=a.effect.type==="flat"?`+${N(a.effect.value)}/s`:`x${N(a.effect.value)}`,o=a.recipe.map(i=>({icon:i.type==="mana"?H("icons/mana.png"):Ze[i.tier].icon,alt:i.type==="mana"?"Mana":`T${i.tier}`,amount:new d(0)}));return ri({type:"gem",id:String(e),recipeId:n,name:a.name,icon:a.icon,ingredients:ti(o,"",e,""),outputAmount:"",assigned:0,progress:0,blocked:!1,craftTime:0,effectText:s,rowState:t,unlockIcon:ai(n)},r)},tf=(e,r,t)=>{const a=ea[e],n=`flask_${e}`,s=a.recipe.map(o=>({icon:Ze[o.tier].icon,alt:`T${o.tier}`,amount:new d(0)}));return ri({type:"flask",id:String(e),recipeId:n,name:a.name,icon:a.icon,ingredients:ti(s,"flask-",e,""),outputAmount:"",assigned:0,progress:0,blocked:!1,craftTime:0,rowState:t,unlockIcon:ai(n)},r)},rf=(e,r,t)=>{const a=M.getState(),n=an(a.activeRealm),s=n[e],o=e,i=s.recipe.map(l=>{var p,u;return{icon:l.type==="mana"?H("icons/mana.png"):l.type==="military"?((p=n[l.unitId])==null?void 0:p.icon)??H("icons/mana.png"):Ze[l.tier].icon,alt:l.type==="mana"?"Mana":l.type==="military"?((u=n[l.unitId])==null?void 0:u.name)??l.unitId:`T${l.tier}`,amount:new d(0)}});return ri({type:"military",id:e,recipeId:o,name:s.name,icon:s.icon,ingredients:ti(i,"military-",e,""),outputAmount:"",assigned:0,progress:0,blocked:!1,craftTime:0,rowState:t,unlockIcon:ai(o)},r)};let bn=null,$s=null,Rs=null,Oi=!1,Bi=!1,xn=null;const af=e=>{const r=()=>{var $,R,x,y;xn=null;const t=M.getState(),a=J(t),{recipeCrafting:n}=a,s=gt.map(k=>`gem_${k}`),o=Mt.map(k=>`flask_${k}`),i=bt(t.activeRealm),l=a.combat.portalBuilt,p=l?i:i.filter(k=>k!=="u_portal_knight");bn=Ur(s,n),$s=Ur(o,n),Rs=Ur(p,n);let u=0,c=gt.map(k=>{const C=`gem_${k}`,_=st(C,n)?"unlocked":C===bn?"locked":"hidden",A=_!=="hidden"?u++:0;return ef(k,A,_)}).join("");const g=!bn,m=t.activeRealm==="realm1"||t.activeRealm==="realmU",h=m&&st("soulforge",n),f=m&&g&&!h;if(Oi=h,f){const k=u%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)";c+=`
      <div class="unlock-progress-bg text-steel text-sm py-1">
        <div data-soulforge-unlock-bar class="unlock-progress-fill h-full" style="width: 0%; background-color: ${k}"></div>
        <div class="unlock-progress-label">
          <span>Craft</span>
          <img src="${Ze[8].icon}" alt="T8" style="width: 40px; height: 40px;" class="object-contain">
          <span data-soulforge-unlock-progress>to unlock</span>
        </div>
      </div>
    `}if(h){const k=me("soulforge"),C=t.realms.realm3,I=D(C.recipeInventory,"soulforge"),_=Ks(C),A=D(a.recipeInventory,"gem_8"),F=A.gte(_),E=Math.min(1,A.div(_).toNumber()),P=u%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)",V=F?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed";c+=`
      <div class="flex items-center gap-4 py-2 px-3" style="background-color: ${P}">
        <img src="${k.icon}" alt="Soulforge" style="width: 40px; height: 40px;" class="object-contain">
        <div class="flex-1">
          <span class="text-magenta font-mono text-sm">Soulforge</span>
          <span class="text-steel text-xs ml-2">Forges arcane souls in the Realm of Magic</span>
        </div>
        <span class="text-sm text-text font-mono" data-soulforge-count>Owned: ${N(I)}</span>
        <button
          data-action="craft-soulforge"
          ${F?"":"disabled"}
          class="relative px-3 py-1 text-sm font-mono border overflow-hidden ${V}"
          style="min-width: 180px;"
        >
          ${Yt(E,"data-soulforge-progress")}
          <span class="relative z-10 flex items-center justify-center gap-2">
            Forge -
            <span class="inline-flex items-center gap-1">
              <span data-soulforge-cost>${N(_)}</span>
              <img src="${Ze[8].icon}" alt="T8" style="width: 20px; height: 20px;" class="object-contain">
            </span>
          </span>
        </button>
      </div>
    `}const v=t.activeRealm==="realm2"&&t.globalTier<3,S=v&&st("forge_enhancer",n),b=v&&g&&!S;if(Bi=S,b){const k=(u+(h?1:0))%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)";c+=`
      <div class="unlock-progress-bg text-steel text-sm py-1">
        <div data-forge-enhancer-unlock-bar class="unlock-progress-fill h-full" style="width: 0%; background-color: ${k}"></div>
        <div class="unlock-progress-label">
          <span>Craft</span>
          <img src="${Ze[8].icon}" alt="T8" style="width: 40px; height: 40px;" class="object-contain">
          <span data-forge-enhancer-unlock-progress>to unlock</span>
        </div>
      </div>
    `}if(S){const k=me("forge_enhancer"),C=t.realms.realm3,I=D(C.recipeInventory,"forge_enhancer"),_=Ys(C),A=D(a.recipeInventory,"gem_8"),F=A.gte(_),E=Math.min(1,A.div(_).toNumber()),P=(u+(h?1:0))%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)",V=F?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed";c+=`
      <div class="flex items-center gap-4 py-2 px-3" style="background-color: ${P}">
        <img src="${k.icon}" alt="Forge Enhancer" style="width: 40px; height: 40px;" class="object-contain">
        <div class="flex-1">
          <span class="text-magenta font-mono text-sm">Forge Enhancer</span>
          <span class="text-steel text-xs ml-2">Multiplies Arcane Soul output by 1 + count</span>
        </div>
        <span class="text-sm text-text font-mono" data-forge-enhancer-count>Owned: ${N(I)}</span>
        <button
          data-action="craft-forge-enhancer"
          ${F?"":"disabled"}
          class="relative px-3 py-1 text-sm font-mono border overflow-hidden ${V}"
          style="min-width: 180px;"
        >
          ${Yt(E,"data-forge-enhancer-progress")}
          <span class="relative z-10 flex items-center justify-center gap-2">
            Forge -
            <span class="inline-flex items-center gap-1">
              <span data-forge-enhancer-cost>${N(_)}</span>
              <img src="${Ze[8].icon}" alt="T8" style="width: 20px; height: 20px;" class="object-contain">
            </span>
          </span>
        </button>
      </div>
    `}const T=`<div class="mobile-scroll-x">${c}</div>`;if(t.activeRealm==="realm3"){xn=Qp(e);return}{let k=`
    <div class="mb-4 flex items-center gap-2 text-sm font-mono">
      <span class="text-steel">Crafters:</span>
      <span class="text-gold" data-crafters-available></span>
      <span class="text-muted">/</span>
      <span class="text-text" data-crafters-total></span>
      <span class="text-muted ml-2">|</span>
      <span class="text-steel ml-2">Buy crafter</span>
      <span class="hover-tooltip-wrapper">
        <button
          data-action="purchase-crafter"
          disabled
          class="relative px-2 py-1 text-sm font-mono border overflow-hidden ${Ni(!1,!1)}"
        >
          ${Yt(0,"data-crafter-progress")}
          <span class="relative z-10 flex items-center gap-1">
            <img src="${H("icons/mana.png")}" alt="Mana" class="w-5 h-5 object-contain">
            <span data-crafter-cost class="text-text"></span>
          </span>
        </button>
        <div class="hover-tooltip tooltip-compact" data-crafter-afford></div>
      </span>
    </div>
  `;t.dismissedTips.includes("crafter-rightclick")||(k+=`
      <div data-tip="crafter-rightclick" class="mb-4 flex items-center gap-2 text-sm">
        <button data-action="dismiss-tip" data-tip-id="crafter-rightclick" class="text-muted hover-text-positive cursor-pointer border-none bg-transparent" title="Dismiss tip">&#x2714;</button>
        <span class="text-muted craft-tip-desktop">Tip: right-click crafter buttons to assign/unassign all crafters</span>
        <span class="text-muted craft-tip-mobile">Tip: use ++ /  to assign/unassign all crafters</span>
      </div>
    `),k+=Et("mana-gems","Mana gems",T);const I=Oe(n,"gem_1"),_=I>=100;let A=0;const E=`<div class="mobile-scroll-x">${Mt.map(oe=>{const U=`flask_${oe}`,K=st(U,n)?"unlocked":U===$s?"locked":"hidden",se=K!=="hidden"?A++:0;return tf(oe,se,K)}).join("")}</div>`;k+=`<div class="mt-4" data-section="flasks" ${_?"":'style="display: none"'}>${Et("research-flasks","Research flasks",E)}</div>`;const P=bt(t.activeRealm),V=I>=500;let j=0;const Z=`<div class="mobile-scroll-x">${P.map(oe=>{const U=oe,K=(U==="u_portal_knight"&&!l?!1:st(U,n))?"unlocked":U===Rs?"locked":"hidden",se=K!=="hidden"?j++:0;return rf(oe,se,K)}).join("")}</div>`;k+=`<div class="mt-4" data-section="military" ${V?"":'style="display: none"'}>${Et("military","Expedition Units",Z)}</div>`,e.innerHTML=k}e.addEventListener("contextmenu",k=>k.preventDefault());const w=k=>Math.abs(k)>1;e.querySelectorAll('[data-action="assign-crafter"]').forEach(k=>{k.addEventListener("click",()=>{const C=parseInt(k.getAttribute("data-tier")),I=parseInt(k.getAttribute("data-delta"));w(I)?I>0?M.getState().assignAllCrafters(C):M.getState().unassignAllCrafters(C):M.getState().assignCrafter(C,I)}),k.addEventListener("contextmenu",C=>{C.preventDefault();const I=parseInt(k.getAttribute("data-tier"));parseInt(k.getAttribute("data-delta"))>0?M.getState().assignAllCrafters(I):M.getState().unassignAllCrafters(I)})}),e.querySelectorAll('[data-action="assign-flask-crafter"]').forEach(k=>{k.addEventListener("click",()=>{const C=parseInt(k.getAttribute("data-tier")),I=parseInt(k.getAttribute("data-delta"));w(I)?I>0?M.getState().assignAllFlaskCrafters(C):M.getState().unassignAllFlaskCrafters(C):M.getState().assignFlaskCrafter(C,I)}),k.addEventListener("contextmenu",C=>{C.preventDefault();const I=parseInt(k.getAttribute("data-tier"));parseInt(k.getAttribute("data-delta"))>0?M.getState().assignAllFlaskCrafters(I):M.getState().unassignAllFlaskCrafters(I)})}),e.querySelectorAll('[data-action="assign-military-crafter"]').forEach(k=>{k.addEventListener("click",()=>{const C=k.getAttribute("data-id"),I=parseInt(k.getAttribute("data-delta"));w(I)?I>0?M.getState().assignAllMilitaryCrafters(C):M.getState().unassignAllMilitaryCrafters(C):M.getState().assignMilitaryCrafter(C,I)}),k.addEventListener("contextmenu",C=>{C.preventDefault();const I=k.getAttribute("data-id");parseInt(k.getAttribute("data-delta"))>0?M.getState().assignAllMilitaryCrafters(I):M.getState().unassignAllMilitaryCrafters(I)})}),($=e.querySelector('[data-action="purchase-crafter"]'))==null||$.addEventListener("click",()=>{const k=M.getState();for(;k.purchaseUpgrade("crafters"););}),(R=e.querySelector('[data-action="craft-soulforge"]'))==null||R.addEventListener("click",()=>{M.getState().craftSoulforge()}),(x=e.querySelector('[data-action="craft-forge-enhancer"]'))==null||x.addEventListener("click",()=>{M.getState().craftForgeEnhancer()}),(y=e.querySelector('[data-action="dismiss-tip"]'))==null||y.addEventListener("click",k=>{var _;const C=k.currentTarget.getAttribute("data-tip-id"),I=M.getState();M.setState({dismissedTips:[...I.dismissedTips,C]}),(_=e.querySelector(`[data-tip="${C}"]`))==null||_.remove()})};return r(),()=>{const t=M.getState(),a=J(t);if(xn){xn();return}const{recipeCrafting:n}=a,s=a.combat.portalBuilt,o=gt.map(L=>`gem_${L}`),i=Mt.map(L=>`flask_${L}`),l=bt(t.activeRealm),p=Ur(o,n),u=Ur(i,n),c=s?l:l.filter(L=>L!=="u_portal_knight"),g=Ur(c,n),m=(L,Y,X)=>{let ie=0;for(const re of L){const ce=e.querySelector(`[data-recipe-row="${re}"]`);if(!ce)continue;const Ve=(re==="u_portal_knight"&&!s?!1:st(re,n))?"unlocked":re===Y?"locked":"hidden";if(ce.setAttribute("data-row-state",Ve),Ve!=="hidden"){const ke=ie%2===0?"var(--color-tooltip-bg)":"var(--color-row-odd)",Ce=ce.querySelector(".recipe-row"),Xe=ce.querySelector(".unlock-row");Ce&&(Ce.style.backgroundColor=ke),Xe&&(Xe.style.backgroundColor=ke);const W=ce.querySelector(`[data-${X}unlock-bar="${re}"]`);W&&(W.style.backgroundColor=ke),ie++}}};m(o,p,""),m(i,u,"flask-"),m(l,g,"military-"),bn=p,$s=u,Rs=g;const h=Oe(n,"gem_1"),f=e.querySelector('[data-section="flasks"]');f&&h>=100&&(f.style.display="");const v=e.querySelector('[data-section="military"]');v&&h>=500&&(v.style.display="");const S=t.getAvailableCrafters(),b=t.getTotalCrafters(),T=e.querySelector("[data-crafters-available]");T&&(T.textContent=te(S));const w=e.querySelector("[data-crafters-total]");w&&(w.textContent=te(b));const $=Co(a.upgrades,"crafters"),R=tn(a.upgrades,"crafters",a.mana,Xt(a.recipeInventory),ia(a.recipeInventory)),x=Kt(a.upgrades,"crafters"),y=x||!$?1:Math.min(1,a.mana.div($.amount).toNumber()),k=e.querySelector("[data-crafter-cost]");k&&$&&(k.textContent=N($.amount));const C=e.querySelector('[data-action="purchase-crafter"]');if(C){const L=Ni(x,R);C.className=`relative px-2 py-1 text-sm font-mono border overflow-hidden ${L}`,x||!R?C.setAttribute("disabled",""):C.removeAttribute("disabled")}zt(e.querySelector("[data-crafter-progress]"),y,x);const I=e.querySelector("[data-crafter-afford]");if(I)if(x)I.textContent="";else{const L=Xt(a.recipeInventory),Y=De(t.activeRealm),X=t.activeRealm!=="realm3"?os(L,Y.MODIFIERS.manaModifier).toNumber():0;I.textContent=$?is(a.mana,$.amount,X):""}const _=De(t.activeRealm),A=es(t.activeRealm),F=t.globalTier>=3?"realmU":"realm1",E=Er(t.realms[F].combat.heroicVictories,t.activeRealm,F),P=t.activeRealm!=="realm3"?on(t.realms.realm3.combat.heroicVictories):1,V=t.activeRealm!=="realm3"?t.realms.realm3.recipeInventory:void 0,j={recipeInventory:a.recipeInventory,ascension:t.realms.realm3.ascension,realmId:t.activeRealm,r3Inventory:V,globalTier:t.globalTier,r4TowerLevels:t.realms.realm4.towerLevels,heroicTrialCompleted:t.realms.realm4.heroicTrialCompleted};for(const L of gt){const Y=`gem_${L}`,X=n[Y],ie=(X==null?void 0:X.progress)??0,re=ie>=1,ce=(X==null?void 0:X.assignment)??0,Ne=Ze[L],Ve=A(L,a.combat.completionsPerExpedition),ke=ks(Y),Ce=1/ke;Zr(e.querySelector(`[data-progress-bar="${L}"]`),ie,re);const Xe=e.querySelector(`[data-crafter-count="${L}"]`);Xe&&(Xe.textContent=te(ce));const W=Ea(Y,a.upgrades,a.artifacts,1);W.forEach((Le,$e)=>{const je=e.querySelector(`[data-recipe-amount="${L}-${$e}"]`);if(je)if(Le.amount.eq(0))je.innerHTML="free";else{const ae=N(Le.amount);je.innerHTML=ce>0?`${Or(ae,N(Le.amount.mul(ce).mul(Ce)),"text-text")}`:ae}});const le=xs(Y,a.upgrades,a.artifacts,a.altar,_.MODIFIERS.calculateSacrificeBonus,Ve,E,a.prestige,j,P!==1?P:void 0),ge=le.total,Se=e.querySelector(`[data-recipe-output="${L}"]`);if(Se){const Le=N(ge);Se.innerHTML=ce>0?`${Or(Le,N(ge.mul(ce).mul(Ce)),"text-positive")}`:Le,Se.classList.toggle("text-positive",ce>0),Se.classList.toggle("text-text",ce<=0)}const he=e.querySelector(`[data-input-tooltip="${L}"]`);if(he){const Le=ys(Y,a.upgrades,a.artifacts,1),$e=Ne.recipe.length>0?Ne.recipe[0].amount:new d(0),je=W.length>0?ce>0?W[0].amount.mul(ce).mul(Ce):Le.total.mul($e):new d(0);he.innerHTML=Br(ce>0?"Input per second":"Input per craft","Base cost/craft",$e,Le.multipliers,ce,Ce,je)}const Fe=e.querySelector(`[data-output-tooltip="${L}"]`);Fe&&(Fe.innerHTML=Br(ce>0?"Output per second":"Output per craft","Base output/craft",new d(1),le.multipliers,ce,Ce,ce>0?ge.mul(ce).mul(Ce):ge));const Me=e.querySelector(`[data-craft-time="${L}"]`);Me&&(Me.textContent=`${N(ke)}s`)}for(const L of Mt){const Y=`flask_${L}`,X=n[Y],ie=(X==null?void 0:X.progress)??0,re=ie>=1,ce=(X==null?void 0:X.assignment)??0,Ne=ea[L],Ve=A(L,a.combat.completionsPerExpedition),ke=ks(Y),Ce=1/ke;Zr(e.querySelector(`[data-flask-progress-bar="${L}"]`),ie,re);const Xe=e.querySelector(`[data-flask-crafter-count="${L}"]`);Xe&&(Xe.textContent=te(ce));const W=_.MODIFIERS.flaskRecipeMultiplier,le=Ea(Y,a.upgrades,a.artifacts,W);le.forEach(($e,je)=>{const ae=e.querySelector(`[data-flask-recipe-amount="${L}-${je}"]`);if(ae)if($e.amount.eq(0))ae.innerHTML="free";else{const ne=N($e.amount);ae.innerHTML=ce>0?`${Or(ne,N($e.amount.mul(ce).mul(Ce)),"text-text")}`:ne}});const ge=xs(Y,a.upgrades,a.artifacts,a.altar,_.MODIFIERS.calculateSacrificeBonus,Ve,E,a.prestige,j),Se=ge.total,he=e.querySelector(`[data-flask-recipe-output="${L}"]`);if(he){const $e=N(Se);he.innerHTML=ce>0?`${Or($e,N(Se.mul(ce).mul(Ce)),"text-positive")}`:$e,he.classList.toggle("text-positive",ce>0),he.classList.toggle("text-text",ce<=0)}const Fe=e.querySelector(`[data-flask-input-tooltip="${L}"]`);if(Fe){const $e=ys(Y,a.upgrades,a.artifacts,W),je=Ne.recipe.length>0?Ne.recipe[0].amount:new d(0),ae=le.length>0?ce>0?le[0].amount.mul(ce).mul(Ce):$e.total.mul(je):new d(0);Fe.innerHTML=Br(ce>0?"Input per second":"Input per craft","Base cost/craft",je,$e.multipliers,ce,Ce,ae)}const Me=e.querySelector(`[data-flask-output-tooltip="${L}"]`);Me&&(Me.innerHTML=Br(ce>0?"Output per second":"Output per craft","Base output/craft",new d(1),ge.multipliers,ce,Ce,ce>0?Se.mul(ce).mul(Ce):Se));const Le=e.querySelector(`[data-flask-craft-time="${L}"]`);Le&&(Le.textContent=`${N(ke)}s`)}const B=(L,Y)=>{if(!L)return;const X=fs(L,n);if(!X)return;const ie=e.querySelector(`[data-${Y}unlock-progress="${L}"]`);ie&&(ie.textContent=`to unlock (${N(X.required-X.current)} more)`);const re=e.querySelector(`[data-${Y}unlock-bar="${L}"]`);re&&(re.style.width=`${Math.min(100,X.current/X.required*100)}%`)};B(p,""),B(u,"flask-");const Z=bt(t.activeRealm),oe=an(t.activeRealm);for(const L of Z){const Y=L,X=n[Y],ie=(X==null?void 0:X.progress)??0,re=ie>=1,ce=(X==null?void 0:X.assignment)??0,Ne=oe[L];if(!Ne)continue;const Ve=ks(Y),ke=1/Ve;Zr(e.querySelector(`[data-military-progress-bar="${L}"]`),ie,re);const Ce=e.querySelector(`[data-military-crafter-count="${L}"]`);Ce&&(Ce.textContent=te(ce));const Xe=Ea(Y,a.upgrades,a.artifacts,1,{realmId:t.activeRealm,r4TowerLevels:t.realms.realm4.towerLevels});Xe.forEach((Me,Le)=>{const $e=e.querySelector(`[data-military-recipe-amount="${L}-${Le}"]`);if($e)if(Me.amount.eq(0))$e.innerHTML="free";else{const je=N(Me.amount);$e.innerHTML=ce>0?`${Or(je,N(Me.amount.mul(ce).mul(ke)),"text-text")}`:je}});const W=xs(Y,a.upgrades,a.artifacts,a.altar,_.MODIFIERS.calculateSacrificeBonus,1,E,a.prestige,j),le=W.total,ge=e.querySelector(`[data-military-recipe-output="${L}"]`);if(ge){const Me=N(le);ge.innerHTML=ce>0?`${Or(Me,N(le.mul(ce).mul(ke)),"text-positive")}`:Me,ge.classList.toggle("text-positive",ce>0),ge.classList.toggle("text-text",ce<=0)}const Se=e.querySelector(`[data-military-input-tooltip="${L}"]`);if(Se){const Me=ys(Y,a.upgrades,a.artifacts,1,{realmId:t.activeRealm,r4TowerLevels:t.realms.realm4.towerLevels}),Le=Ne.recipe.length>0?Ne.recipe[0].amount:new d(0),$e=Xe.length>0?ce>0?Xe[0].amount.mul(ce).mul(ke):Me.total.mul(Le):new d(0);Se.innerHTML=Br(ce>0?"Input per second":"Input per craft","Base cost/craft",Le,Me.multipliers,ce,ke,$e)}const he=e.querySelector(`[data-military-output-tooltip="${L}"]`);he&&(he.innerHTML=Br(ce>0?"Output per second":"Output per craft","Base output/craft",new d(1),W.multipliers,ce,ke,ce>0?le.mul(ce).mul(ke):le));const Fe=e.querySelector(`[data-military-craft-time="${L}"]`);Fe&&(Fe.textContent=`${N(Ve)}s`)}B(g,"military-");const O=(t.activeRealm==="realm1"||t.activeRealm==="realmU")&&st("soulforge",n);if(O!==Oi){r();return}const K=e.querySelector("[data-soulforge-unlock-progress]");if(K){const L=fs("soulforge",n);if(L){K.textContent=`to unlock (${N(L.required-L.current)} more)`;const Y=e.querySelector("[data-soulforge-unlock-bar]");Y&&(Y.style.width=`${Math.min(100,L.current/L.required*100)}%`)}}if(O){const L=t.realms.realm3,Y=D(L.recipeInventory,"soulforge"),X=Ks(L),ie=D(a.recipeInventory,"gem_8"),re=ie.gte(X),ce=Math.min(1,ie.div(X).toNumber()),Ne=e.querySelector("[data-soulforge-count]");Ne&&(Ne.textContent=`Owned: ${N(Y)}`);const Ve=e.querySelector("[data-soulforge-cost]");Ve&&(Ve.textContent=N(X)),zt(e.querySelector("[data-soulforge-progress]"),ce);const ke=e.querySelector('[data-action="craft-soulforge"]');if(ke){ke.disabled=!re;const Ce=re?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed";ke.className=`relative px-4 py-2 text-sm font-mono border overflow-hidden ${Ce}`}}const be=t.activeRealm==="realm2"&&t.globalTier<3&&st("forge_enhancer",n);if(be!==Bi){r();return}const G=e.querySelector("[data-forge-enhancer-unlock-progress]");if(G){const L=fs("forge_enhancer",n);if(L){G.textContent=`to unlock (${N(L.required-L.current)} more)`;const Y=e.querySelector("[data-forge-enhancer-unlock-bar]");Y&&(Y.style.width=`${Math.min(100,L.current/L.required*100)}%`)}}if(be){const L=t.realms.realm3,Y=D(L.recipeInventory,"forge_enhancer"),X=Ys(L),ie=D(a.recipeInventory,"gem_8"),re=ie.gte(X),ce=Math.min(1,ie.div(X).toNumber()),Ne=e.querySelector("[data-forge-enhancer-count]");Ne&&(Ne.textContent=`Owned: ${N(Y)}`);const Ve=e.querySelector("[data-forge-enhancer-cost]");Ve&&(Ve.textContent=N(X)),zt(e.querySelector("[data-forge-enhancer-progress]"),ce);const ke=e.querySelector('[data-action="craft-forge-enhancer"]');if(ke){ke.disabled=!re;const Ce=re?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed";ke.className=`relative px-4 py-2 text-sm font-mono border overflow-hidden ${Ce}`}}}},Sc=Dt(Ee.Crafting,af),nf=Sc.cleanup,sf=Sc.render,Di=(e,r)=>{const t=M.getState();M.setState({realms:{...t.realms,[e]:{...t.realms[e],autoAllResearch:r}}})},of={t1KnightStrength:"t1_knight",t4KnightStrength:"t4_knight",t7KnightStrength:"t7_knight",unifiedKnightStrength:"u_t1_knight"},Hi={realm1:{t1KnightStrength:["t1_knight"],t4KnightStrength:["t4_knight"],t7KnightStrength:["t7_knight"]},realmU:{unifiedKnightStrength:["u_t1_knight","u_t4_knight","u_t7_knight"]}},to={t4SwordEfficiency:"t4_sword",t5SwordEfficiency:"t5_sword",t6SwordEfficiency:"t6_sword"},Vi=(e,r)=>{if(e==="craftersGuild")return Mo(r);if(e==="gemManufacturing")return Io(r);if(e==="cheaperGems")return Ao(r);if(e==="cheaperFlasks")return _o(r);if(e==="cheaperMilitary")return qo(r);if(e==="sacrificeMulti")return new d(ca(r));const t=of[e];if(t)return new d(ua(r,t));const a=to[e];return a?No(r,a):new d(1)},lf=(e,r,t,a)=>{const n=la(e,r);if(!n)return 1;let s=1;for(const o of n){let i;o.recipeId&&a?i=D(a,o.recipeId):i=t[o.tier];const l=o.amount.gt(0)?Math.min(1,i.div(o.amount).toNumber()):1;s=Math.min(s,l)}return s},cf=(e,r,t,a,n)=>{const s=la(e,r);if(!s)return"";let o=0,i=!1;for(const l of s){let p,u;l.recipeId&&n?(p=D(n,l.recipeId).toNumber(),u=a[l.recipeId]||0):(p=t[l.tier].toNumber(),u=a[`flask_${l.tier}`]||0);const c=l.amount.toNumber()-p;if(!(c<=0)){if(u<=0){i=!0;continue}o=Math.max(o,c/u)}}return i?"Can afford in: never":o<=0?"Can afford now":is(0,o,1)},uf=(e,r,t)=>{let a="";const n=t>=1;for(const s of e){const o=Zt[s],i=Kt(r,s,t),l=sa(i,!1);a+=`
      <tr data-upgrade-row="${s}" class="${i?"text-muted--50":""}">
        <td data-upgrade-name="${s}" class="w-76 ${i?"line-through":"text-gold"}">
          <span class="inline-flex items-center gap-1.5">
            ${dt(o.tooltip.split(`
`).map(p=>({label:p})))}
            ${o.name}
          </span>
        </td>
        <td data-upgrade-level="${s}" class="w-24 text-steel"></td>
        <td data-upgrade-cost="${s}" class="w-50"></td>
        <td data-upgrade-effect="${s}" class="w-48"></td>
        <td class="w-28">
          <span class="hover-tooltip-wrapper" style="display:block">
            <button
              data-action="purchase-upgrade"
              data-id="${s}"
              disabled
              class="relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${l}"
            >
              ${i?"":Yt(0,`data-upgrade-progress="${s}"`)}
              <span data-upgrade-btn-text="${s}" class="relative z-10">${i?"MAX":"Buy"}</span>
            </button>
            <div class="hover-tooltip tooltip-compact" data-upgrade-afford="${s}"></div>
          </span>
        </td>
        ${n?`<td class="w-20 text-center">
          ${i?"":`<input type="checkbox" data-action="toggle-autobuy" data-id="${s}" class="cursor-pointer accent-gold">`}
        </td>`:""}
      </tr>`}return a},df=(e,r,t,a)=>{if(e.length===0)return"";const n=e.every(o=>Kt(r,o,t));let s="";return n&&(s+='<div class="text-muted text-sm mb-4">All research upgrades maxed.</div>'),s+=`<div class="mobile-scroll-x"><table class="text-sm font-mono mb-6" data-upgrade-table="${a}">
    <thead>
      <tr class="text-steel border-b border-muted--30">
        <th class="w-76 text-left">Upgrade</th>
        <th class="w-24 text-left">Level</th>
        <th class="w-50 text-left">Cost</th>
        <th class="w-48 text-left">Effect</th>
        <th class="w-28"></th>
        ${t>=1?`<th class="w-20 text-center"><span data-action="toggle-all-autobuy" data-table="${a}" class="cursor-pointer text-steel hover-text-text" style="text-decoration: underline" title="Toggle all auto-buy"><span data-autobuy-header-check="${a}"></span> Auto</span></th>`:""}
      </tr>
    </thead>
    <tbody>${uf(e,r,t)}</tbody>
  </table></div>`,s},mf=e=>{let r=M.getState().activeRealm,t=M.getState().globalTier,a=0;const n=()=>{const o=M.getState().hideMaxUpgrades;e.querySelectorAll("[data-upgrade-row]").forEach(i=>{const l=i;o&&l.classList.contains("text-muted--50")?l.style.display="none":l.style.display=""})},s=()=>{var f;const o=M.getState(),i=J(o),{upgrades:l}=i,p=o.globalTier;if(r=o.activeRealm,t=p,o.activeRealm==="realm3"){e.innerHTML=`<div class="p-4 font-mono">
        <div class="text-steel text-sm mb-4">The Realm of Magic has no upgrades yet.</div>
      </div>`;return}const u=ko.filter(v=>{if(Xr.includes(v)){const S=Hi[o.activeRealm];if(!S)return!1;const b=S[v];if(!b||!b.some(T=>Oe(i.recipeCrafting,T)>0))return!1}if(zr.includes(v)){if(o.activeRealm!=="realm2")return!1;const S=to[v];if(S&&Oe(i.recipeCrafting,S)===0)return!1}return!(v==="sacrificeMulti"&&o.activeRealm!=="realmU")});a=u.filter(v=>Xr.includes(v)||zr.includes(v)).length;const c=u.some(v=>Kt(l,v,p));let g='<div class="p-4 font-mono">';c&&(g+=`<label class="inline-flex items-center gap-2 text-sm text-steel cursor-pointer mb-4">
        <input type="checkbox" data-action="toggle-hide-maxed" ${M.getState().hideMaxUpgrades?"checked":""} class="cursor-pointer accent-gold">
        Hide maxed upgrades
      </label>`),p>=1&&!o.dismissedTips.includes("research-auto-toggle")&&(g+=`
      <div data-tip="research-auto-toggle" class="mb-4 flex items-center gap-2 text-sm">
        <button data-action="dismiss-tip" data-tip-id="research-auto-toggle" class="text-muted hover-text-positive cursor-pointer border-none bg-transparent" title="Dismiss tip">&#x2714;</button>
        <span class="text-muted">Tip: click the Auto header to toggle all automations</span>
      </div>`),g+=df(u,l,p,"research"),g+="</div>",e.innerHTML=g;const m=e.querySelector('[data-action="toggle-hide-maxed"]');m&&m.addEventListener("change",()=>{M.setState({hideMaxUpgrades:m.checked}),n()}),n(),e.querySelectorAll('[data-action="purchase-upgrade"]').forEach(v=>{v.addEventListener("click",()=>{const S=v.getAttribute("data-id");M.getState().purchaseUpgrade(S)})});const h=J(M.getState());e.querySelectorAll('[data-action="toggle-autobuy"]').forEach(v=>{const S=v.getAttribute("data-id");v.checked=h.autoAllResearch||(h.autoBuyUpgrades[S]??!1),v.addEventListener("change",()=>{const b=M.getState();J(b).autoAllResearch&&!v.checked&&Di(b.activeRealm,!1),M.getState().toggleAutoBuy(S)})}),e.querySelectorAll('[data-action="toggle-all-autobuy"]').forEach(v=>{v.addEventListener("click",()=>{const S=v.getAttribute("data-table"),b=e.querySelector(`[data-upgrade-table="${S}"]`);if(!b)return;const T=[];b.querySelectorAll('[data-action="toggle-autobuy"]').forEach(x=>{T.push(x.getAttribute("data-id"))});const w=M.getState(),$=J(w),R=T.every(x=>$.autoBuyUpgrades[x]);for(const x of T){const y=$.autoBuyUpgrades[x]??!1;(R?y:!y)&&M.getState().toggleAutoBuy(x)}Di(w.activeRealm,!R)})}),(f=e.querySelector('[data-action="dismiss-tip"]'))==null||f.addEventListener("click",v=>{var T;const S=v.currentTarget.getAttribute("data-tip-id"),b=M.getState();M.setState({dismissedTips:[...b.dismissedTips,S]}),(T=e.querySelector(`[data-tip="${S}"]`))==null||T.remove()})};return s(),()=>{const o=M.getState(),i=J(o),{upgrades:l}=i,p=ia(i.recipeInventory),u=Xt(i.recipeInventory),c=o.globalTier;if(o.activeRealm==="realm3")return;const g=Xr.filter(R=>{const x=Hi[o.activeRealm],y=x==null?void 0:x[R];return y&&y.some(k=>Oe(i.recipeCrafting,k)>0)}).length+zr.filter(R=>{const x=to[R];return x&&Oe(i.recipeCrafting,x)>0}).length;if(o.activeRealm!==r||o.globalTier!==t||g!==a){s();return}const m=e.querySelectorAll("[data-upgrade-row]");for(const R of m){const x=R.getAttribute("data-upgrade-row");if(Kt(l,x,c)&&!R.classList.contains("text-muted--50")){s();return}}const h=De(o.activeRealm),f=c>=3?"realmU":"realm1",v=Er(o.realms[f].combat.heroicVictories,o.activeRealm,f),S=on(o.realms.realm3.combat.heroicVictories),b=o.realms.realm3.recipeInventory,T={recipeInventory:i.recipeInventory,ascension:o.realms.realm3.ascension,realmId:o.activeRealm,r3Inventory:b,globalTier:c,r4TowerLevels:o.realms.realm4.towerLevels,heroicTrialCompleted:o.realms.realm4.heroicTrialCompleted},w=Jo(i.recipeCrafting,l,i.artifacts,i.altar,c,h.MODIFIERS.craftTimeMultiplier,h.MODIFIERS.calculateSacrificeBonus,h.MODIFIERS.sacrificeBatchSize*ca(l),o.activeRealm,i.combat,h.MODIFIERS.flaskRecipeMultiplier,v,i.prestige,T,1,S),$={};for(const[R,x]of Object.entries(w.recipes))$[R]=x.toNumber();e.querySelectorAll("[data-upgrade-row]").forEach(R=>{const x=R.getAttribute("data-upgrade-row"),y=l[x],k=Dd(x,c),C=Kt(l,x,c),I=la(x,y),_=tn(l,x,i.mana,u,p,c,i.recipeInventory),A=C?1:lf(x,y,p,i.recipeInventory),F=e.querySelector(`[data-upgrade-level="${x}"]`);F&&(F.textContent=`${te(y)}/${te(k)}`);const E=e.querySelector(`[data-upgrade-cost="${x}"]`);E&&(C||!I?E.innerHTML="-":E.innerHTML=`<div class="flex items-center gap-2 flex-nowrap">${I.map(Z=>{const oe=Z.recipeId?Z.recipeId.replace("_"," "):`t${Z.tier} flask`,U=oe.replace(/\bt(\d)/g,"T$1").replace(/\b\w/g,K=>K.toUpperCase());let O;return Z.recipeId?O=D(i.recipeInventory,Z.recipeId).gte(Z.amount):O=Fl(p,Z.tier,Z.amount),`<div class="flex items-center gap-0.5">
              <img src="${H(`icons/${oe}.png`)}" alt="${U}" title="${U}" class="w-8 h-8 object-contain">
              <span class="${O?"text-text":"text-muted--50"}">${N(Z.amount)}</span>
            </div>`}).join("")}</div>`);const P=e.querySelector(`[data-upgrade-effect="${x}"]`);if(P){const Z=Vi(x,l);if(C)P.innerHTML=`<span class="text-steel">x${N(Z)}</span>`;else{const oe={...l,[x]:y+1},U=Vi(x,oe);P.innerHTML=`<span class="text-steel">x${N(Z)}</span><span class="text-muted">  </span><span class="text-positive">x${N(U)}</span>`}}const V=e.querySelector(`[data-action="purchase-upgrade"][data-id="${x}"]`);if(V){const Z=sa(C,_);V.className=`relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${Z}`,C||!_?V.setAttribute("disabled",""):V.removeAttribute("disabled");const oe=e.querySelector(`[data-upgrade-btn-text="${x}"]`);oe&&(oe.textContent=C?"MAX":"Buy"),zt(e.querySelector(`[data-upgrade-progress="${x}"]`),A,C)}const j=e.querySelector(`[data-upgrade-afford="${x}"]`);j&&(j.textContent=C?"":cf(x,y,p,$,i.recipeInventory));const B=e.querySelector(`[data-action="toggle-autobuy"][data-id="${x}"]`);B&&(B.checked=i.autoAllResearch||(i.autoBuyUpgrades[x]??!1))}),e.querySelectorAll("[data-autobuy-header-check]").forEach(R=>{const x=R.getAttribute("data-autobuy-header-check"),y=e.querySelector(`[data-upgrade-table="${x}"]`);if(!y)return;const k=[];y.querySelectorAll('[data-action="toggle-autobuy"]').forEach(I=>{k.push(I.getAttribute("data-id"))});const C=k.length>0&&k.every(I=>i.autoBuyUpgrades[I])||i.autoAllResearch;R.textContent=C?"":""}),n()}},Tc=Dt(Ee.Upgrades,mf),pf=Tc.cleanup,ff=Tc.render,ji=(e,r="w-10 h-10")=>e.map(t=>`
    <span class="inline-flex items-center gap-0.5">
      <img src="${t.icon}" alt="" class="${r} object-contain">
      <span class="${t.canAfford?"text-text":"text-red"}">${N(t.amount)}</span>
    </span>
  `).join(""),Gi=()=>{const e=M.getState(),r=J(e),{artifacts:t}=r;if(!$t.some(u=>t.owned[u]))return"";const n=[],s=u=>`<img src="${u}" alt="" style="width:40px;height:40px" class="object-contain">`;for(let u=1;u<=8;u++){const c=Oo(t,u);c.eq(1)||n.push(`<tr><td class="pr-2">${s(H(`icons/t${u} gem.png`))}</td><td class="text-positive">x${N(c)}</td><td class="pl-1 text-muted">gem output</td></tr>`)}const o=da(t);o>1&&n.push(`<tr><td class="pr-2">${s(H("icons/combat artifact.png"))}</td><td class="text-positive">x${N(o)}</td><td class="pl-1 text-muted">combat strength</td></tr>`);const i=Kl(t);i>1&&n.push(`<tr><td class="pr-2">${s(H("icons/crafting speed.png"))}</td><td class="text-positive">x${N(i)}</td><td class="pl-1 text-muted">craft speed</td></tr>`);const l=Do(t);l.eq(1)||n.push(`<tr><td class="pr-2">${s(H("icons/army banner.png"))}</td><td class="text-positive">x${N(l)}</td><td class="pl-1 text-muted">unit output</td></tr>`);const p=Bo(t);return p.eq(1)||n.push(`<tr><td class="pr-2">${s(H("icons/knight duplication.png"))}</td><td class="text-positive">x${N(p)}</td><td class="pl-1 text-muted">knight output</td></tr>`),n.length===0?"":`
    <div class="artifact-bonuses-box p-2 border border-muted--20" style="width:fit-content">
      <div class="text-xs text-muted mb-1">Active Bonuses</div>
      <table class="text-sm font-mono">
        ${n.join("")}
      </table>
    </div>
  `},Lt=(e,r)=>{const t=Be[e];if(t.type==="crafting_speed"){const n=1+t.upgradeBonus*r;return n===1?"x1":`x${N(n)}`}const a=Math.pow(1+t.upgradeBonus,r);return a===1?"x1":`x${N(a)}`},Dr=e=>{const r=Be[e];return r.type==="combat"?"combat strength":r.type==="crafting_speed"?"craft speed":r.type==="knight_output"?"knight output":r.type==="mythic"?"unit output":"gem output"},Wi=e=>{if(e.length===0)return 0;let r=1;for(const t of e)if(t.amount.gt(0)){const a=Math.min(1,t.have.div(t.amount).toNumber());a<r&&(r=a)}return r},jn=e=>{const r=M.getState(),t=J(r),a=xt(t.artifacts,e),n=t.artifacts.upgradeLevels[e]??0,s=Un(e);if(r.activeRealm==="realm2")return{costHtml:"",canAct:!1,action:"none",progress:0};const i=D(t.recipeInventory,"artifact_shard").toNumber(),l=D(t.recipeInventory,"mythic_fragment").toNumber();if(!a){const c=nm(e,i,l),g=jl(e,i,l);return{costHtml:ji(c),canAct:g,action:"buy",progress:Wi(c)}}if(n>=s)return{costHtml:"",canAct:!1,action:"maxed",progress:0};const p=sm(e,n,s,i,l),u=Gl(e,n,i,s,l);return{costHtml:ji(p),canAct:u,action:"upgrade",progress:Wi(p)}},gf=()=>{const e=M.getState(),r=J(e),a=De(e.activeRealm).MODIFIERS.calculateSacrificeBonus,n=pa(r.combat.heroicVictories,e.activeRealm),s=at(r.prestige.prestigeCounts,"artifact_shard").toNumber(),o=nn(r.altar.sacrificeCounts,a).toNumber(),i=at(r.prestige.prestigeCounts,"mythic_fragment").toNumber(),l=sn(r.altar.sacrificeCounts,a).toNumber();let p=0,u=0;for(const[c,g]of Object.entries(r.combat.activeExpeditions))for(const m of g){if(!m.repeatIfUnitsAvailable)continue;const h=nt(c,e.activeRealm);if(!h)continue;const f=m.tauntMultiplier??1,v=m.duration/1e3;if(v<=0)continue;const S=h.rewards.artifactShards||0,b=Math.round(S*f*n*s*o);p+=b*m.successRate/v;const T=h.rewards.mythicFragments||0,w=Math.round(T*f*i*l);u+=w*m.successRate/v}return{shardsPerSecond:p,mythicFragmentsPerSecond:u}},hf=["ring","general","mythic"],vf={ring:"Rings",general:"General",mythic:"Mythic"},bf=e=>{const r=Be[e];return r.type==="mythic"?"mythic":r.type==="combat"||r.type==="crafting_speed"||r.type==="knight_output"?"general":"ring"},Ki=()=>{const e=M.getState(),r=J(e),t=e.activeRealm==="realm2",a=e.activeRealm==="realmU";return t?$t.filter(n=>r.artifacts.owned[n]):$t.filter(n=>{const s=Be[n];return s.type==="mythic"?!a||n==="breeding_artifact"&&!e.breedingArtifactUnlocked?!1:r.artifacts.owned[n]?!0:Oe(r.recipeCrafting,"mythic_fragment")>0:s.type==="knight_output"?!a||n==="knight_duplication"&&!e.knightDuplicationUnlocked?!1:(r.artifacts.owned[n],!0):r.artifacts.owned[n]||e.realms.realm2.artifacts.owned[n]?!0:(s.tier===1,Oe(r.recipeCrafting,"artifact_shard")>0)})},Yi=e=>{const{costHtml:r,action:t}=jn(e);return t==="none"||t==="maxed"?"":`<span class="inline-flex items-center gap-1 text-xs">${r}</span>`},zi=e=>{const{canAct:r,action:t,progress:a}=jn(e);return t==="none"?"":t==="maxed"?'<span class="text-gold text-xs">MAX</span>':`
      <span class="hover-tooltip-wrapper">
        <button
          data-action="${t}-artifact"
          data-id="${e}"
          ${r?"":"disabled"}
          class="relative px-2 py-0.5 text-xs font-mono border overflow-hidden ${r?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed"} whitespace-nowrap"
        >${Yt(a,`data-forge-progress="${e}"`)}<span class="relative z-10">Forge</span></button>
        <div class="hover-tooltip tooltip-compact" data-forge-afford="${e}"></div>
      </span>
  `},xf=e=>{const r=()=>{const t=M.getState(),a=J(t),n=t.activeRealm==="realm2";if(!n&&Oe(a.recipeCrafting,"artifact_shard")===0){e.innerHTML=`
        <div class="flex items-center justify-center h-64">
          <div class="text-center text-muted">
            <div class="text-lg mb-2">You must get artifact shards from expeditions before you can craft artifacts</div>
          </div>
        </div>
      `;return}const s=Ki();if(s.length===0&&n){e.innerHTML=`
        <div class="p-4 font-mono">
          <h2 class="text-lg text-gold mb-2">Artifacts</h2>
          <div class="text-muted text-center py-8">
            No artifacts shipped yet. Use the Realm tab to ship artifacts from the Prime Realm.
          </div>
        </div>
      `;return}let o='<div class="p-4 font-mono">';if(o+='<div class="flex items-start gap-4 flex-wrap-mobile">',o+='<div class="flex-1 min-w-0">',o+='<h2 class="text-lg text-gold mb-2">Artifacts</h2>',o+=`<div class="text-sm text-steel mb-4">${n?"Artifacts shipped from the Prime Realm.":"Craft and upgrade artifacts with artifact shards from expeditions."}</div>`,!n){const l=Oe(a.recipeCrafting,"mythic_fragment")>0;o+=`
        <div class="text-sm mb-4">
          <span class="text-muted">Artifact Shards:</span>
          <span class="text-text" data-artifact-shards>${N(D(a.recipeInventory,"artifact_shard").toNumber())}</span>
          ${l?`
            <span class="ml-4 text-muted">Mythic Fragments:</span>
            <span class="text-text" data-mythic-fragments>${N(D(a.recipeInventory,"mythic_fragment").toNumber())}</span>
          `:""}
        </div>
      `}const i={ring:[],general:[],mythic:[]};for(const l of s)i[bf(l)].push(l);for(const l of hf){const p=i[l];if(p.length===0)continue;let u=`<div class="mobile-scroll-x"><table class="text-sm font-mono" style="table-layout:fixed" data-artifacts-table="${l}">
        <colgroup>
          <col style="width:200px">
          <col style="width:110px">
          <col style="width:320px">
          <col style="width:100px">
          <col style="width:80px">
        </colgroup>
        <thead>
          <tr class="text-steel border-b border-muted--30">
            <th class="text-left">Artifact</th>
            <th class="text-left">Level</th>
            <th class="text-left">Effect</th>
            <th class="text-left">Cost</th>
            <th class="text-right">Forge</th>
          </tr>
        </thead>
        <tbody>`;for(const c of p){const g=Be[c],m=xt(a.artifacts,c),h=a.artifacts.upgradeLevels[c]??0,f=Un(c),v=h>=f;let S="";if(m)if(v)S=`<span class="text-text">${Lt(c,h)}</span> <span class="text-muted">${Dr(c)}</span>`;else{const b=Lt(c,h),T=Lt(c,h+1),w=Dr(c);S=`<span class="text-text">${b}</span> <span class="text-steel"></span> <span class="text-positive">${T}</span> <span class="text-muted">${w}</span>`}else{const b=Lt(c,1),T=Dr(c);S=`<span class="text-text">${Lt(c,0)}</span> <span class="text-steel"></span> <span class="text-positive">${b}</span> <span class="text-muted">${T}</span>`}u+=`
          <tr data-artifact-row="${c}">
            <td class="py-1">
              <span class="inline-flex items-center gap-1.5">
                ${dt([{label:g.description}],g.name,`<img src="${g.icon}" alt="${g.name}" style="width: 48px; height: 48px;" class="object-contain cursor-help">`)}
                <span class="text-gold">${g.name}</span>
              </span>
            </td>
            <td class="text-steel" data-artifact-level="${c}">${m?`${h}/${f}`:"-"}</td>
            <td data-artifact-effect-cell="${c}">${S}</td>
            <td data-artifact-cost="${c}">${Yi(c)}</td>
            <td class="text-right" data-artifact-action="${c}">${zi(c)}</td>
          </tr>`}u+="</tbody></table></div>",o+=`<div class="mb-4">${Et(`artifacts-${l}`,vf[l],u)}</div>`}o+="</div>",o+=`<div data-artifacts-bonuses class="flex-shrink-0">${Gi()}</div>`,o+="</div>",o+="</div>",e.innerHTML=o,yf(e),e.querySelectorAll("[data-artifact-action]").forEach(l=>{const p=l.getAttribute("data-artifact-action"),{action:u}=jn(p);l.setAttribute("data-prev-action",u)})};return r(),()=>{const t=M.getState(),a=J(t),n=t.activeRealm==="realm2",s=e.querySelectorAll("[data-artifact-row]");let o=!1;const i=Ki();for(const g of i)if(!e.querySelector(`[data-artifact-row="${g}"]`)){o=!0;break}if(!o)for(const g of s){const m=g.getAttribute("data-artifact-row"),h=xt(a.artifacts,m),f=e.querySelector(`[data-artifact-level="${m}"]`);if(f&&f.textContent!=="-"!==h){o=!0;break}}if(!n&&Oe(a.recipeCrafting,"artifact_shard")>0&&!e.querySelector("[data-artifacts-bonuses]")&&(o=!0),o){r();return}const l=e.querySelector("[data-artifacts-bonuses]");l&&(l.innerHTML=Gi());const p=e.querySelector("[data-artifact-shards]");p&&(p.textContent=N(D(a.recipeInventory,"artifact_shard").toNumber()));const u=e.querySelector("[data-mythic-fragments]");u&&(u.textContent=N(D(a.recipeInventory,"mythic_fragment").toNumber()));const c=n?null:gf();for(const g of s){const m=g.getAttribute("data-artifact-row"),h=xt(a.artifacts,m),f=a.artifacts.upgradeLevels[m]??0,v=Un(m),S=f>=v,b=e.querySelector(`[data-artifact-level="${m}"]`);b&&(b.textContent=h?`${f}/${v}`:"-");const T=e.querySelector(`[data-artifact-effect-cell="${m}"]`);if(T){let R="";if(h)if(S)R=`<span class="text-text">${Lt(m,f)}</span> <span class="text-muted">${Dr(m)}</span>`;else{const x=Lt(m,f),y=Lt(m,f+1),k=Dr(m);R=`<span class="text-text">${x}</span> <span class="text-steel"></span> <span class="text-positive">${y}</span> <span class="text-muted">${k}</span>`}else{const x=Lt(m,1),y=Dr(m);R=`<span class="text-text">${Lt(m,0)}</span> <span class="text-steel"></span> <span class="text-positive">${x}</span> <span class="text-muted">${y}</span>`}T.innerHTML=R}const w=e.querySelector(`[data-artifact-cost="${m}"]`);w&&(w.innerHTML=Yi(m));const $=e.querySelector(`[data-artifact-action="${m}"]`);if($){const{canAct:R,action:x,progress:y}=jn(m),k=e.querySelector(`[data-forge-progress="${m}"]`);zt(k,y);const C=$.querySelector("button");if(C){const A=R?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed";C.className=`relative px-2 py-0.5 text-xs font-mono border overflow-hidden ${A} whitespace-nowrap`,C.disabled=!R;const F=$.querySelector(`[data-forge-afford="${m}"]`);if(F&&c&&(x==="buy"||x==="upgrade")){const E=Be[m],P=Po(m),V=P?D(a.recipeInventory,"mythic_fragment"):D(a.recipeInventory,"artifact_shard"),j=P?c.mythicFragmentsPerSecond:c.shardsPerSecond;let B;if(!xt(a.artifacts,m))B=P?E.cost.mythicFragments:E.cost.artifactShards;else{const Z=ts(E,f,v);B=P?Z.mythicFragments:Z.artifactShards}F.textContent=is(V,B,j)}}const I=$.getAttribute("data-prev-action")??"",_=x;if(I!==_){$.setAttribute("data-prev-action",_),$.innerHTML=zi(m);const A=$.querySelector("button");A&&A.addEventListener("click",F=>{F.stopPropagation(),kc(m)})}}}}},kc=e=>{const r=M.getState(),t=J(r);xt(t.artifacts,e)?M.getState().upgradeArtifact(e):M.getState().craftArtifact(e)},yf=e=>{e.querySelectorAll('[data-action="buy-artifact"], [data-action="upgrade-artifact"]').forEach(r=>{r.addEventListener("click",t=>{t.stopPropagation();const a=r.getAttribute("data-id");kc(a)})})},$c=Dt(Ee.Artifacts,xf),wf=$c.render,Sf=$c.cleanup,_r=e=>{const r=Math.ceil(e/1e3),t=Math.floor(r/60),a=r%60;if(t===0)return`${a}s`;if(t>=60){const n=Math.floor(t/60),s=t%60;return`${n}h ${s}m`}return`${t}m ${a}s`},Tf=e=>{const t=Date.now()-e,a=Math.floor(t/1e3),n=Math.floor(a/60),s=Math.floor(n/60);return s>0?`${s}h ago`:n>0?`${n}m ago`:`${a}s ago`},ls=(e,r="normal")=>{const t=[],a=r==="small"?40:32,n=`width: ${a}px; height: ${a}px;`,s=r==="small"?"text-muted":"text-xs text-muted",o=r==="small"?"font-size: 14px;":"";if(e.artifactShards&&t.push(`<span class="inline-flex items-center gap-1"><img src="${H("icons/artifact shard.png")}" style="${n}"><span class="${s}" style="${o}">${te(e.artifactShards)}</span></span>`),e.nullstone&&t.push(`<span class="inline-flex items-center gap-1"><img src="${H("icons/nullstone.png")}" style="${n}"><span class="${s}" style="${o}">${te(e.nullstone)}</span></span>`),e.mythicFragments&&t.push(`<span class="inline-flex items-center gap-1"><img src="${H("icons/mythic fragment.png")}" style="${n}"><span class="${s}" style="${o}">${te(e.mythicFragments)}</span></span>`),e.arcaneBars&&t.push(`<span class="inline-flex items-center gap-1"><img src="${H("icons/arcane bar.png")}" style="${n}"><span class="${s}" style="${o}">${te(e.arcaneBars)}</span></span>`),e.arcaneLogs&&t.push(`<span class="inline-flex items-center gap-1"><img src="${H("icons/arcane log.png")}" style="${n}"><span class="${s}" style="${o}">${te(e.arcaneLogs)}</span></span>`),e.questBonusTiers&&e.questBonusTiers.length>0){const i=e.questBonusTiers.length===1?`T${e.questBonusTiers[0]}`:`T${Math.min(...e.questBonusTiers)}-T${Math.max(...e.questBonusTiers)}`;t.push(`<span class="text-xs text-yellow">${i} Output Bonus</span>`)}return t.join(" ")},Rc=(e,r)=>{const t={};return e.artifactShards&&(t.artifactShards=e.artifactShards*r),e.nullstone&&(t.nullstone=e.nullstone*r),e.mythicFragments&&(t.mythicFragments=e.mythicFragments*r),e.arcaneBars&&(t.arcaneBars=e.arcaneBars*r),e.arcaneLogs&&(t.arcaneLogs=e.arcaneLogs*r),e.questBonusTiers&&(t.questBonusTiers=e.questBonusTiers),t},cs=(e,r,t=1)=>{if(r<=0)return"";const a=r/1e3,n=[];if(e.artifactShards){const s=e.artifactShards/a*t;n.push(`${N(s)}/s`)}if(e.nullstone){const s=e.nullstone/a*t;n.push(`${N(s)}/s`)}if(e.mythicFragments){const s=e.mythicFragments/a*t;n.push(`${N(s)}/s`)}if(e.arcaneBars){const s=e.arcaneBars/a*t;n.push(`${N(s)}/s`)}if(e.arcaneLogs){const s=e.arcaneLogs/a*t;n.push(`${N(s)}/s`)}return n.length===0?"":`(${n.join(", ")})`},ni=(e,r,t)=>e.unlockRequirement?r.find(a=>a.id===e.unlockRequirement):t>0?r[t-1]:void 0,ro=(e,r,t,a,n=0)=>{if(ra(e,t,a,n))return!(e==="heroic_war_mastery"&&!M.getState().realms.realm1.combat.portalBuilt||e==="heroic_creatures"&&!M.getState().realms[a].combat.portalBuilt);const s=r.find(l=>l.id===e);if(s!=null&&s.heroic)return!1;const o=r.findIndex(l=>l.id===e);if(!s)return!1;const i=ni(s,r,o);return i?ra(i.id,t,a,n):o===0},fa=()=>{const e=M.getState();if(e.activeRealm==="realm3"){const r=e.realms.realm3.recipeInventory,t={};for(const a of bt("realm3"))t[a]=r[a]||new d(0);return t}if(e.activeRealm==="realmU"){const r=e.realms.realmU.recipeInventory,t={};for(const a of bt("realmU"))t[a]=r[a]||new d(0);return t}return $o(cr(e.realms.realm1.recipeInventory),cr(e.realms.realm2.recipeInventory),e.activeRealm,e.globalTier)},Cc=(e,r)=>{const t=es(e);let a=!1;for(let s=1;s<=6;s++)if(t(s,r)>1){a=!0;break}if(!a)return"";let n='<div class="mb-4 p-3 border border-yellow--30 bg-yellow--5">';n+='<div class="text-sm font-bold text-yellow mb-2">Quest Output Bonuses</div>',n+='<div class="flex gap-4 text-xs">';for(let s=1;s<=6;s++){const o=t(s,r),i=o>1?`x${o.toFixed(2)}`:"",l=o>1?"text-yellow":"text-muted";n+=`<div class="flex flex-col items-center"><span class="text-muted">T${s}</span><span class="${l} font-mono">${i}</span></div>`}return n+="</div></div>",n},kt=()=>{const e=M.getState();return e.activeRealm==="realm3"?La(e.realms.realm3.ascension):0},pr=()=>{const e=M.getState();return yo(e.realms.realm3.recipeInventory)},Mc=()=>{const e=M.getState();return e.activeRealm!=="realm3"?1:ir(e.realms.realm3.recipeInventory)};let Ue=null,ee=Go();const Qr=e=>{const r=ee.assignedUnits[e];return r?r instanceof d?r:mt(r):ue},kf=()=>Ue,$f=()=>{Ue=null,ee=Go()},Rf=(e,r)=>{var o,i;const t=M.getState(),a=J(t);if(!ra(e,a.combat.completionsPerExpedition,t.activeRealm,t.globalTier))return;Ue=e;const n=nt(e,t.activeRealm),s=a.combat.expeditionSetups[e];if(s){let l={...s.assignedUnits};const p=er(t.activeRealm,t.globalTier);for(const u of Object.keys(l))(o=p[u])!=null&&o.excludeFromExpeditions&&delete l[u],n!=null&&n.heroic&&((i=p[u])==null?void 0:i.unitRole)==="taunt"&&delete l[u];ee={assignedUnits:l,assignedEquipment:s.assignedEquipment?{...s.assignedEquipment}:void 0,repeatIfUnitsAvailable:n!=null&&n.heroic?!1:s.repeatIfUnitsAvailable,repeatUntilVictory:n!=null&&n.heroic?s.repeatUntilVictory:void 0}}else ee=Go();Vf(r),it(r)},ao=e=>{Ue=null;const r=e.querySelector("[data-setup-modal]");r&&r.classList.add("hidden")},Cf=(e,r)=>{if(!Ue)return;const t=Ue;M.getState().saveExpeditionSetup(t,ee),ao(e),Ic(t),r()},Mf=(e,r)=>{var s;if(!Ue)return;const t=Ue,a=M.getState();(s=J(a).combat.activeExpeditions[t])!=null&&s.length&&a.clearExpedition(t),M.getState().saveExpeditionSetup(t,ee),Ic(t),r(),it(e)},Ic=e=>{const r=M.getState(),a=J(r).combat.expeditionSetups[e];a&&r.startExpedition(e,a.assignedUnits,a.repeatIfUnitsAvailable)},us=e=>{var a;const r=M.getState();return((a=er(r.activeRealm,r.globalTier)[e])==null?void 0:a.unitRole)??"strength"},Gn=e=>{if(!Ue)return;const r=M.getState(),t=J(r),a=nt(Ue,r.activeRealm);if(!a)return;const n=!!a.heroic,s=It(ee.assignedUnits,r.activeRealm,r.globalTier),o=Qt(s),i=a.group?Jt(ee.assignedEquipment||{},a.group):1,l=n?fr(a,t.combat.heroicVictories):a.difficulty??0,p=new d(l).mul(o).mul(i);if(yt(ee.assignedUnits,r.activeRealm,t.upgrades,t.artifacts,r.globalTier,kt(),pr()).lte(p))return;const c=Bt(r.activeRealm,r.globalTier),g=er(r.activeRealm,r.globalTier),m=c.filter(b=>{const T=g[b];return(T==null?void 0:T.unitRole)==="strength"&&Qr(b).gt(0)});if(m.length===0)return;let h=0,f=1,v=0;for(let b=0;b<50;b++){const T=(h+f)/2,w={...ee.assignedUnits};for(const R of m)w[R]=Qr(R).mul(T).floor().max(0);yt(w,r.activeRealm,t.upgrades,t.artifacts,r.globalTier,kt(),pr()).gte(p)?(v=T,f=T):h=T}const S={...ee.assignedUnits};for(const b of m)S[b]=Qr(b).mul(v).floor().max(0);ee={...ee,assignedUnits:S},it(e)},it=e=>{var oe;if(!Ue)return;const r=M.getState(),t=J(r),{upgrades:a}=t,n=fa(),s=nt(Ue,r.activeRealm);if(!s)return;const o=Pn(ee.assignedUnits,r.activeRealm,r.globalTier),i=It(ee.assignedUnits,r.activeRealm,r.globalTier),l=Qt(i),p=Fn(i),u=s.heroic?fr(s,t.combat.heroicVictories):s.difficulty??0,c=s.group?Jt(ee.assignedEquipment||{},s.group):1,g=s.group?On(ee.assignedEquipment||{},s.group):1,m=new d(u).mul(l).mul(c),h=m.toNumber(),f=yt(ee.assignedUnits,r.activeRealm,a,t.artifacts,r.globalTier,kt(),pr()),v=f.toNumber(),b=d.min(f.div(m),1).toNumber(),T=b>0,w=Bt(r.activeRealm,r.globalTier);for(const U of w){const O=(n[U]||{toNumber:()=>0}).toNumber(),K=e.querySelector(`[data-modal-available-${U}]`);K&&(K.textContent=te(O));const se=e.querySelector(`[data-modal-input-${U}]`);se&&document.activeElement!==se&&(se.value=te(ee.assignedUnits[U]||0))}const $=e.querySelector("[data-modal-strength]");$&&($.textContent=N(v),$.className=`font-mono ${T?"text-positive":"text-red"}`);const R=e.querySelector("[data-modal-success-rate]");R&&(R.textContent=`${(b*100).toFixed(1)}%`,R.className=`font-mono ${b>0?"text-positive":"text-red"}`);const x=Mc(),y=e.querySelector("[data-modal-speed]");if(y){const U=aa(Ue,r.activeRealm,o,x);y.textContent=o>0||x>1?`${_r(U)}`:"",y.className=`font-mono ${o>0||x>1?"text-cyan":"text-muted"}`}const k=e.querySelector("[data-modal-taunt-diff]");k&&(k.textContent=i>0?`x${l.toFixed(2)}`:"",k.className=`font-mono ${i>0?"text-magenta":"text-muted"}`);const C=e.querySelector("[data-modal-taunt-reward]");C&&(C.textContent=i>0?`x${p.toFixed(2)}`:"",C.className=`font-mono ${i>0?"text-magenta":"text-muted"}`);const I=e.querySelector("[data-modal-captain-buff]");if(I){const U=ur(ee.assignedUnits,r.activeRealm,r.globalTier);I.textContent=U>1?`x${U.toFixed(2)}`:"",I.className=`font-mono ${U>1?"text-gold":"text-muted"}`}const _=e.querySelector("[data-modal-equip-diff]");_&&(_.textContent=c>1?`x${c.toFixed(2)}`:"",_.className=`font-mono ${c>1?"text-gold":"text-muted"}`);const A=e.querySelector("[data-modal-equip-reward]");A&&(A.textContent=g>1?`x${g.toFixed(2)}`:"",A.className=`font-mono ${g>1?"text-gold":"text-muted"}`);const F=s.group?tc(s.group):[];for(const U of F){const O=D(t.recipeInventory,U).toNumber(),K=e.querySelector(`[data-modal-equip-available-${U}]`);K&&(K.textContent=te(O));const se=e.querySelector(`[data-modal-equip-input-${U}]`);se&&document.activeElement!==se&&(se.value=te(((oe=ee.assignedEquipment)==null?void 0:oe[U])||0))}const E=e.querySelector("[data-modal-effective-difficulty]");if(E){const U=l>1||c>1;E.textContent=te(Math.round(h)),E.className=U?"text-magenta font-mono":"font-mono"}const P=e.querySelector("[data-modal-effective-rewards]");if(P&&!!!s.heroic){const O=Da(s.rewards,p,t.combat.heroicVictories,t.prestige,t.altar.sacrificeCounts,r.activeRealm,g,r.globalTier);P.innerHTML=ls(O,"small"),p>1||g>1?P.classList.add("text-magenta"):P.classList.remove("text-magenta");const se=e.querySelector("[data-modal-rewards-rate]");if(se){const be=aa(Ue,r.activeRealm,o,x);se.textContent=cs(O,be,b)}}const V=e.querySelector("[data-repeat-checkbox]");V&&(V.checked=ee.repeatIfUnitsAvailable);const j=e.querySelector("[data-repeat-until-victory-checkbox]");j&&(j.checked=!!ee.repeatUntilVictory);const B=e.querySelector("[data-save-setup]");B&&(T?(B.disabled=!1,B.classList.remove("line-through","text-muted"),B.classList.add("text-steel","cursor-pointer")):(B.disabled=!0,B.classList.add("line-through","text-muted"),B.classList.remove("text-steel","cursor-pointer")));const Z=e.querySelector("[data-restart-setup]");Z&&((t.combat.activeExpeditions[Ue]||[]).length>0?(Z.classList.remove("hidden"),T?(Z.disabled=!1,Z.classList.remove("line-through","text-muted"),Z.classList.add("text-cyan","cursor-pointer")):(Z.disabled=!0,Z.classList.add("line-through","text-muted"),Z.classList.remove("text-cyan","cursor-pointer"))):Z.classList.add("hidden"))},no=(e,r,t)=>{if(!Ue)return;const a=M.getState(),n=nt(Ue,a.activeRealm);if(!n)return;const o=fa()[e]??ue;let l=Qr(e).add(r).max(0);l=d.min(l,o.floor());const p=!!n.heroic,u=us(e);if(r>0&&u==="strength"){const m=J(a),h=It(ee.assignedUnits,a.activeRealm,a.globalTier),f=Qt(h),v=n.group?Jt(ee.assignedEquipment||{},n.group):1,S=p?fr(n,m.combat.heroicVictories):n.difficulty??0,b=new d(S).mul(f).mul(v),T={...ee.assignedUnits,[e]:ue},w=yt(T,a.activeRealm,m.upgrades,m.artifacts,a.globalTier,kt(),pr()),$=b.sub(w);let R;if($.lte(0))R=ue;else{const y=er(a.activeRealm,a.globalTier)[e],k=rn(m.upgrades)+kt(),C=ur(ee.assignedUnits,a.activeRealm,a.globalTier),I=(((y==null?void 0:y.strengthMultiplier)??1)+k)*C,_=(y==null?void 0:y.strengthExponent)??1,A=da(m.artifacts),F=ua(m.upgrades,e),E=I*F*A;R=$.div(E).pow(1/_).ceil()}l=d.min(l,R)}const c=u==="taunt"?It(ee.assignedUnits,a.activeRealm,a.globalTier):0,g=u==="captain"?ur(ee.assignedUnits,a.activeRealm,a.globalTier):0;if(ee={...ee,assignedUnits:{...ee.assignedUnits,[e]:l}},u==="taunt"&&r<0&&It(ee.assignedUnits,a.activeRealm,a.globalTier)<c){Gn(t);return}if(u==="captain"&&r<0&&ur(ee.assignedUnits,a.activeRealm,a.globalTier)<g){Gn(t);return}it(t)},If=(e,r)=>{if(!Ue)return;const t=us(e);if(ee={...ee,assignedUnits:{...ee.assignedUnits,[e]:ue}},t==="taunt"||t==="captain"){Gn(r);return}it(r)},Xi=(e,r,t)=>{if(!Ue)return;const a=M.getState(),n=J(a),s=nt(Ue,a.activeRealm);if(!s)return;const i=fa()[e]??ue;let l=new d(r).floor().max(0);l=d.min(l,i.floor());const p=!!s.heroic,u=us(e);if(u==="strength"){const g=It(ee.assignedUnits,a.activeRealm,a.globalTier),m=Qt(g),h=s.group?Jt(ee.assignedEquipment||{},s.group):1,f=p?fr(s,n.combat.heroicVictories):s.difficulty??0,v=new d(f).mul(m).mul(h),S={...ee.assignedUnits,[e]:ue},b=yt(S,a.activeRealm,n.upgrades,n.artifacts,a.globalTier,kt(),pr()),T=v.sub(b);let w;if(T.lte(0))w=ue;else{const R=er(a.activeRealm,a.globalTier)[e],x=rn(n.upgrades)+kt(),y=ur(ee.assignedUnits,a.activeRealm,a.globalTier),k=(((R==null?void 0:R.strengthMultiplier)??1)+x)*y,C=(R==null?void 0:R.strengthExponent)??1,I=da(n.artifacts),_=ua(n.upgrades,e),A=k*_*I;w=T.div(A).pow(1/C).ceil()}l=d.min(l,w)}const c=Qr(e);if(ee={...ee,assignedUnits:{...ee.assignedUnits,[e]:l}},(u==="taunt"||u==="captain")&&l.lt(c)){Gn(t);return}it(t)},Ef=(e,r)=>{var T;if(!Ue)return;const t=M.getState(),a=J(t),n=nt(Ue,t.activeRealm);if(!n)return;const o=((T=fa()[e])==null?void 0:T.floor())??ue,i=!!n.heroic,l=o;if(us(e)!=="strength"){ee={...ee,assignedUnits:{...ee.assignedUnits,[e]:l}},it(r);return}const u=It(ee.assignedUnits,t.activeRealm,t.globalTier),c=Qt(u),g=n.group?Jt(ee.assignedEquipment||{},n.group):1,m=i?fr(n,a.combat.heroicVictories):n.difficulty??0,h=new d(m).mul(c).mul(g),f={...ee.assignedUnits,[e]:ue},v=yt(f,t.activeRealm,a.upgrades,a.artifacts,t.globalTier,kt(),pr()),S=h.sub(v);let b;if(S.lte(0))b=ue;else{const $=er(t.activeRealm,t.globalTier)[e],R=rn(a.upgrades)+kt(),x=ur(ee.assignedUnits,t.activeRealm,t.globalTier),y=((($==null?void 0:$.strengthMultiplier)??1)+R)*x,k=($==null?void 0:$.strengthExponent)??1,C=da(a.artifacts),I=ua(a.upgrades,e),_=y*I*C;b=d.min(l,S.div(_).pow(1/k).ceil())}ee={...ee,assignedUnits:{...ee.assignedUnits,[e]:b}},it(r)},Af=(e,r)=>{var A;if(!Ue)return;const t=M.getState(),a=J(t),n=nt(Ue,t.activeRealm);if(!n)return;const o=((A=fa()[e])==null?void 0:A.floor())??ue,i=!!n.heroic,l=It(ee.assignedUnits,t.activeRealm,t.globalTier),p=Qt(l),u=n.group?Jt(ee.assignedEquipment||{},n.group):1,c=i?fr(n,a.combat.heroicVictories):n.difficulty??0,g=new d(c).mul(p).mul(u),h=er(t.activeRealm,t.globalTier)[e],f=rn(a.upgrades)+kt(),v=ur(ee.assignedUnits,t.activeRealm,t.globalTier),S=(((h==null?void 0:h.strengthMultiplier)??1)+f)*v,b=(h==null?void 0:h.strengthExponent)??1,T=da(a.artifacts),$=yt(ee.assignedUnits,t.activeRealm,a.upgrades,a.artifacts,t.globalTier,kt(),pr()).div(g),R=d.min($.add(.1),1),x=g.mul(R),y={...ee.assignedUnits,[e]:ue},k=yt(y,t.activeRealm,a.upgrades,a.artifacts,t.globalTier,kt(),pr()),C=x.sub(k),I=ua(a.upgrades,e);let _;if(C.lte(0))_=ue;else{const F=S*I*T;_=d.min(o,C.div(F).pow(1/b).ceil())}ee={...ee,assignedUnits:{...ee.assignedUnits,[e]:_}},it(r)},Ec=e=>{const r=M.getState(),t=J(r),a=Oe(t.recipeCrafting,e);if(a<=0)return[1,10,100];const n=a*.01,s=Math.floor(Math.log10(Math.max(1,n))),o=Math.max(1,Math.pow(10,s));return[o/100,o/10,o]},_f=(e,r,t)=>{no(e,r,t)},qf=e=>{ee={...ee,repeatIfUnitsAvailable:!ee.repeatIfUnitsAvailable},it(e)},Nf=e=>{const r=!ee.repeatUntilVictory;ee={...ee,repeatUntilVictory:r,...r?{repeatAt100:void 0}:{}},it(e)},Lf=e=>{const r=!ee.repeatAt100;ee={...ee,repeatAt100:r,...r?{repeatUntilVictory:void 0}:{}},it(e)},Uf=(e,r,t)=>{var l;if(!Ue)return;const a=M.getState(),n=J(a),s=D(n.recipeInventory,e).toNumber(),o=((l=ee.assignedEquipment)==null?void 0:l[e])||0,i=Math.max(0,Math.min(Math.floor(s),o+r));ee={...ee,assignedEquipment:{...ee.assignedEquipment,[e]:i}},it(t)},Zi=(e,r,t)=>{if(!Ue)return;const a=M.getState(),n=J(a),s=D(n.recipeInventory,e).toNumber(),o=Math.max(0,Math.min(Math.floor(s),Math.floor(r)));ee={...ee,assignedEquipment:{...ee.assignedEquipment,[e]:o}},it(t)},Pf=(e,r)=>{Ue&&(ee={...ee,assignedEquipment:{...ee.assignedEquipment,[e]:0}},it(r))},Ff=(e,r)=>{const t={strength:[],speed:[],taunt:[],captain:[]};for(const a of e){const n=r[a];n&&t[n.unitRole].push(a)}return t},Of={strength:"Army",speed:"Fleet",taunt:"Beacons",captain:"Captains"},Bf={strength:"Increases combat strength, improving success rate",speed:"Reduces expedition duration",taunt:"Increases rewards (2x) and difficulty (1x)",captain:"Multiplies base strength of all knight units"},Df={strength:[{label:"Success rate",value:"strength / difficulty"},{label:"Capped at 100%"},{label:"On success",value:"all units lost, rewards granted"},{label:"On failure",value:"all units lost, no rewards"}],speed:[{label:"Duration",value:"base / (1 + speed / "+Ol+")"},{label:"Higher fleet value = faster expeditions"}],taunt:[{label:"Reward mult",value:"1 + taunt / "+Dl},{label:"Difficulty mult",value:"1 + taunt / "+Bl},{label:"Reward bonus is 2x the difficulty bonus"}],captain:[{label:"Buff",value:"(count+1)^0.4  base multiplier"},{label:"Affects strength units only (not beacons or boats)"}]},Hf=(e,r)=>{const t=[{label:Bf[e.unitRole]},{label:"Formula",value:`n^${e.strengthExponent}  ${N(e.strengthMultiplier)}`},...Df[e.unitRole]],a=`${r}<span class="text-muted cursor-help">?</span>`;return dt(t,e.name,a)},yn=(e,r,t,a)=>{if(r.length===0)return"";let n="";const s="h-6 text-xs border border-muted text-muted hover-border-steel hover-text-steel cursor-pointer";for(const i of r){const l=t[i],p=(a[i]??ue).toNumber(),u=Qr(i);if(p===0&&u.eq(0))continue;const c=`<img src="${l.icon}" alt="${l.name}" style="width: 32px; height: 32px;">`;let g;if(e==="strength")g=`
          <button data-modal-assign="clear" data-unit="${i}" class="${s}" style="width: 28px; display: flex; align-items: center; justify-content: center;" title="Remove all assigned units">--</button>
          <input type="text" data-modal-input-${i} data-unit="${i}" value="${te(u)}" class="w-16 h-6 text-center font-mono text-text text-sm bg-black border border-muted focus-border-cyan focus-outline-none">
          <button data-modal-assign="plus10" data-unit="${i}" class="${s}" style="min-width: 40px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add units to increase success rate by 10%">+10%</button>
          <button data-modal-assign="max" data-unit="${i}" class="${s}" style="min-width: 40px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add minimum units for 100% success rate">100%</button>
      `;else{const[m,h,f]=Ec(i);g=`
          <button data-modal-assign="clear" data-unit="${i}" class="${s}" style="width: 28px; display: flex; align-items: center; justify-content: center;" title="Remove all assigned units">--</button>
          <input type="text" data-modal-input-${i} data-unit="${i}" value="${te(u)}" class="w-16 h-6 text-center font-mono text-text text-sm bg-black border border-muted focus-border-cyan focus-outline-none">
          <span class="text-muted text-xs" style="line-height: 1;">+</span>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button data-modal-assign="static" data-unit="${i}" data-amount="${f}" class="${s}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add ${te(f)} units">${te(f)}</button>
            <button data-modal-assign="static" data-unit="${i}" data-amount="${h}" class="${s}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add ${te(h)} units">${te(h)}</button>
            <button data-modal-assign="static" data-unit="${i}" data-amount="${m}" class="${s}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;" title="Add ${te(m)} units">${te(m)}</button>
          </div>
      `}n+=`
      <div class="modal-unit-row flex items-center mb-1" style="gap: 20px;">
        <span class="flex items-center gap-1">
          ${Hf(l,c)}
        </span>
        <span class="text-muted text-xs font-mono" style="width: 48px;" data-modal-available-${i}>${te(p)}</span>
        <div class="modal-unit-controls flex items-center gap-1">
          ${g}
        </div>
      </div>
    `}return n?`
    <div class="min-w-0" style="flex: 1;">
      <div class="mb-2 pb-1 border-b border-muted--30">
        <span class="text-xs ${e==="strength"?"text-red":e==="speed"?"text-cyan":e==="captain"?"text-gold":"text-magenta"} font-bold">${Of[e]}</span>
      </div>
      ${n}
    </div>
  `:""},Vf=e=>{if(!Ue)return;const r=M.getState(),t=nt(Ue,r.activeRealm);if(!t)return;const a=J(r),n=fa(),s=Mc(),o=aa(t.id,r.activeRealm,0,s),i=t.heroic?fr(t,a.combat.heroicVictories):t.difficulty??0,l=!!t.heroic,p=pa(a.combat.heroicVictories,r.activeRealm);let u=t.rewards;p!==1&&t.rewards.artifactShards&&(u={...u,artifactShards:Math.round(t.rewards.artifactShards*p)});const c=Bt(r.activeRealm,r.globalTier),g=er(r.activeRealm,r.globalTier),m=c.filter(k=>{var C;return!((C=g[k])!=null&&C.excludeFromExpeditions)}),h=t.group?tc(t.group):[],f=Ff(m,g),v=f.speed.length>0,S=!l&&f.taunt.length>0,b=f.captain.length>0,T=1+(v?1:0)+(S?1:0),w=yn("strength",f.strength,g,n),$=v?yn("speed",f.speed,g,n):"",R=S?yn("taunt",f.taunt,g,n):"",x=b?yn("captain",f.captain,g,n):"",y=e.querySelector("[data-setup-modal]");if(y){const k=T>=3?"max-w-5xl":T>=2?"max-w-4xl":"max-w-2xl";y.innerHTML=`
      <div data-modal-backdrop class="fixed inset-0 bg-black--80 flex items-center justify-center z-50">
        <div class="bg-black border border-muted--50 p-6 ${k} w-full mx-4">
          <div class="flex items-center gap-3 mb-4">
            <div>
              <h3 class="text-gold font-bold">${t.name}</h3>
              <div class="text-xs text-muted">
                Difficulty: <span data-modal-effective-difficulty class="font-mono">${te(i)}</span>
                | Duration: ${_r(o)}
                | Done: ${l?a.combat.heroicVictories[t.id]||0:a.combat.completionsPerExpedition[t.id]||0}
              </div>
            </div>
            <button data-close-modal class="ml-auto text-muted hover-text-text text-2xl cursor-pointer">&times;</button>
          </div>

          <div class="mb-2">
            ${l?`<div class="text-xs text-muted">&#8226; ${t.heroic.rewardType==="shard_drops"?"Artifact shard drops":t.heroic.rewardType==="realm1_output"?"R1 output":t.heroic.rewardType==="realm2_output"?"R2 output":t.heroic.rewardType==="soul_production"?"Arcane soul production":t.heroic.rewardType==="creature_production"?"Creature production":t.heroic.rewardType==="realm_mastery"?"Gem production (all realms)":t.heroic.rewardType==="portal"?"Opens a portal to Realm 4":""}${t.heroic.rewardType==="portal"?"":` x${t.heroic.rewardScaling} per victory (compounding)`}</div>${t.heroic.rewardType==="portal"?'<div class="text-xs text-muted">&#8226; Can only be won once</div>':`<div class="text-xs text-muted">&#8226; Difficulty scales x${t.heroic.difficultyScaling} per victory</div>`}`:`<div class="flex items-center gap-2"><span class="text-xs text-muted">Rewards:</span> <span data-modal-effective-rewards>${ls(u,"small")}</span> <span data-modal-rewards-rate class="text-xs text-cyan font-mono">${cs(u,o)}</span></div>`}
          </div>

          <div class="mb-4">
            <div class="flex gap-4">
              ${w}
              ${$}
              ${R}
            </div>
            ${x?`<div style="margin-top: 8px;">${x}</div>`:""}
          </div>

          ${h.length>0?`<div class="mb-4">
            <div class="mb-2 pb-1 border-b border-muted--30">
              <span class="text-xs text-gold font-bold">Equipment</span>
            </div>
            ${h.filter(A=>{var P;const F=D(a.recipeInventory,A).toNumber(),E=((P=ee.assignedEquipment)==null?void 0:P[A])||0;return F>0||E>0}).map(A=>{var oe;const F=me(A),E=D(a.recipeInventory,A).toNumber(),P=((oe=ee.assignedEquipment)==null?void 0:oe[A])||0,V="h-6 text-xs border border-muted text-muted hover-border-steel hover-text-steel cursor-pointer",[j,B,Z]=Ec(A);return`<div class="modal-unit-row flex items-center mb-1" style="gap: 20px;">
                <span class="flex items-center gap-1">
                  ${(()=>{const U=Ir[A];if(U){const O=[{label:`Used in ${U.expeditionGroup} expeditions`},{label:"Reward mult",value:`1 + n^${U.exponent} / ${U.rewardDivisor}`},{label:"Difficulty mult",value:`1 + n^${U.exponent} / ${U.difficultyDivisor}`}],K=`<img src="${F.icon}" alt="${F.name}" style="width: 32px; height: 32px;"><span class="text-muted cursor-help">?</span>`;return dt(O,F.name,K)}return`<img src="${F.icon}" alt="${F.name}" style="width: 32px; height: 32px;"><span class="text-muted">${F.name}</span>`})()}
                </span>
                <span class="text-muted text-xs font-mono" style="width: 48px;" data-modal-equip-available-${A}>${te(E)}</span>
                <div class="modal-unit-controls flex items-center gap-1">
                  <button data-modal-equip-assign="clear" data-equip="${A}" class="${V}" style="width: 28px; display: flex; align-items: center; justify-content: center;" title="Remove all">--</button>
                  <input type="text" data-modal-equip-input-${A} data-equip="${A}" value="${te(P)}" class="w-16 h-6 text-center font-mono text-text text-sm bg-black border border-muted focus-border-cyan focus-outline-none">
                  <span class="text-muted text-xs" style="line-height: 1;">+</span>
                  <div style="display: flex; flex-direction: column; gap: 2px;">
                    <button data-modal-equip-assign="static" data-equip="${A}" data-amount="${Z}" class="${V}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;">${te(Z)}</button>
                    <button data-modal-equip-assign="static" data-equip="${A}" data-amount="${B}" class="${V}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;">${te(B)}</button>
                    <button data-modal-equip-assign="static" data-equip="${A}" data-amount="${j}" class="${V}" style="min-width: 36px; padding: 0 4px; display: flex; align-items: center; justify-content: center;">${te(j)}</button>
                  </div>
                </div>
              </div>`}).join("")}
          </div>`:""}

          <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-4 text-sm">
            <div class="flex items-center gap-2">
              <span class="text-muted text-xs">Strength:</span>
              <span data-modal-strength class="font-mono text-text">0</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-muted text-xs">Success:</span>
              <span data-modal-success-rate class="font-mono text-red">0%</span>
            </div>
            ${v||s>1?`<div class="flex items-center gap-2">
              <span class="text-muted text-xs">Duration:</span>
              <span data-modal-speed class="font-mono ${s>1?"text-cyan":"text-muted"}">${s>1&&!v?_r(o):""}</span>
            </div>`:""}
            ${S?`<div class="flex items-center gap-2">
              <span class="text-muted text-xs">Beacon Diff:</span>
              <span data-modal-taunt-diff class="font-mono text-muted"></span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-muted text-xs">Beacon Reward:</span>
              <span data-modal-taunt-reward class="font-mono text-muted"></span>
            </div>`:""}
            ${b?`<div class="flex items-center gap-2">
              <span class="text-muted text-xs">Captain Buff:</span>
              <span data-modal-captain-buff class="font-mono text-muted"></span>
            </div>`:""}
            ${h.length>0?`<div class="flex items-center gap-2">
              <span class="text-muted text-xs">Equip Diff:</span>
              <span data-modal-equip-diff class="font-mono text-muted"></span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-muted text-xs">Equip Reward:</span>
              <span data-modal-equip-reward class="font-mono text-muted"></span>
            </div>`:""}
          </div>

          <div class="mb-4">
            ${l?`<label class="flex items-center gap-2 cursor-pointer select-none mb-1">
              <input type="checkbox" data-repeat-until-victory-checkbox ${ee.repeatUntilVictory?"checked":""} class="w-4 h-4 accent-gold">
              <span class="text-sm text-text">Repeat until victory</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer select-none">
              <input type="checkbox" data-repeat-at-100-checkbox ${ee.repeatAt100?"checked":""} class="w-4 h-4 accent-gold">
              <span class="text-sm text-text">Repeat at 100%</span>
            </label>`:`<label class="flex items-center gap-2 cursor-pointer select-none">
              <input type="checkbox" data-repeat-checkbox ${ee.repeatIfUnitsAvailable?"checked":""} class="w-4 h-4 accent-cyan">
              <span class="text-sm text-text">Repeat if units available</span>
            </label>`}
          </div>

          <div class="flex gap-2">
            <button data-close-modal class="flex-1 px-4 py-2 border border-muted text-muted hover-border-text hover-text-text cursor-pointer">Cancel</button>
            <button data-restart-setup class="flex-1 px-4 py-2 border border-cyan text-cyan cursor-pointer hidden">Restart</button>
            <button data-save-setup class="flex-1 px-4 py-2 border border-steel text-steel cursor-pointer">Save and Start</button>
          </div>
        </div>
      </div>
    `,y.classList.remove("hidden");const C=y.querySelector("[data-repeat-checkbox]");C&&C.addEventListener("change",()=>{qf(e)});const I=y.querySelector("[data-repeat-until-victory-checkbox]");I&&I.addEventListener("change",()=>{Nf(e)});const _=y.querySelector("[data-repeat-at-100-checkbox]");_&&_.addEventListener("change",()=>{Lf(e)});for(const A of m){const F=y.querySelector(`[data-modal-input-${A}]`);F&&(F.addEventListener("change",()=>{const E=vn(F.value);E!==null&&Xi(A,E.toNumber(),e)}),F.addEventListener("keydown",E=>{if(E.key==="Enter"){const P=vn(F.value);P!==null&&Xi(A,P.toNumber(),e),F.blur()}}))}for(const A of h){const F=y.querySelector(`[data-modal-equip-input-${A}]`);F&&(F.addEventListener("change",()=>{const E=vn(F.value);E!==null&&Zi(A,E.toNumber(),e)}),F.addEventListener("keydown",E=>{if(E.key==="Enter"){const P=vn(F.value);P!==null&&Zi(A,P.toNumber(),e),F.blur()}}))}}},so=(e,r,t,a={})=>{const n=Rt(r);let s=`
    <select data-log-filter class="bg-black text-text border border-muted--30 text-xs px-2 py-1 rounded">
      <option value="all"${t==="all"?" selected":""}>All Expeditions</option>
  `;for(const u of n)(a[u.id]||0)!==0&&(s+=`<option value="${u.id}"${t===u.id?" selected":""}>${u.name}</option>`);s+="</select>";const i=(t==="all"?e:e.filter(u=>u.expeditionId===t)).slice(-20);if(i.length===0)return`
      <div class="flex items-center gap-3 mb-2">${s}</div>
      <div class="text-muted text-sm">No expeditions completed yet.</div>
    `;const l=[...i].reverse();let p=`
    <div class="flex items-center gap-3 mb-2">${s}</div>
    <table class="w-full border-collapse text-xs">
      <thead>
        <tr class="border-b border-muted--30 text-muted">
          <th class="py-1 px-2 text-left w-6"></th>
          <th class="py-1 px-2 text-left">Expedition</th>
          <th class="py-1 px-2 text-right">Chance</th>
          <th class="py-1 px-2 text-right">Rewards</th>
          <th class="py-1 px-2 text-right">Time</th>
        </tr>
      </thead>
      <tbody>
  `;for(const u of l){const c=nt(u.expeditionId,r),g=(c==null?void 0:c.name)||u.expeditionId,m=u.success?"text-positive":"text-red",h=u.success?"":"",f=`${(u.successRate*100).toFixed(0)}%`;let v="";if(u.success&&u.rewards){const S=[];u.rewards.artifactShards&&S.push(`<span class="inline-flex items-center gap-1"><img src="${H("icons/artifact shard.png")}" style="width: 32px; height: 32px;">+${te(u.rewards.artifactShards)}</span>`),u.rewards.nullstone&&S.push(`<span class="inline-flex items-center gap-1"><img src="${H("icons/nullstone.png")}" style="width: 32px; height: 32px;">+${te(u.rewards.nullstone)}</span>`),u.rewards.arcaneBars&&S.push(`<span class="inline-flex items-center gap-1"><img src="${H("icons/arcane bar.png")}" style="width: 32px; height: 32px;">+${te(u.rewards.arcaneBars)}</span>`),u.rewards.arcaneLogs&&S.push(`<span class="inline-flex items-center gap-1"><img src="${H("icons/arcane log.png")}" style="width: 32px; height: 32px;">+${te(u.rewards.arcaneLogs)}</span>`),u.rewards.mythicFragments&&S.push(`<span class="inline-flex items-center gap-1"><img src="${H("icons/mythic fragment.png")}" style="width: 32px; height: 32px;">+${te(u.rewards.mythicFragments)}</span>`),v=S.join(" ")}p+=`
      <tr class="border-b border-muted--20" data-log-entry="${u.timestamp}">
        <td class="py-1 px-2 ${m}">${h}</td>
        <td class="py-1 px-2 text-text">${g}</td>
        <td class="py-1 px-2 text-muted text-right">${f}</td>
        <td class="py-1 px-2 text-muted text-right">${v}</td>
        <td class="py-1 px-2 text-muted text-right" data-log-time="${u.timestamp}">${Tf(u.timestamp)}</td>
      </tr>
    `}return p+="</tbody></table>",p};let _e=null,Jr=null,wr=null,Sr="all",Ya="",oo="",io="";const jf=()=>{wc(Ee.Combat),Jr&&(clearInterval(Jr),Jr=null),wr&&_e&&(_e.removeEventListener("click",wr),wr=null),_e=null,$f(),Sr="all",Ya="",oo="",io=""},Ac=(e,r)=>{if(e.length===0)return"";let t="";for(let a=0;a<e.length;a++){const n=e[a],o=Date.now()-n.startTime,i=Math.max(0,n.duration-o),l=Math.min(o/n.duration,1),p=Math.round(l*100);t+=`
      <div data-progress-slot="${a}" class="flex items-center gap-2">
        <div class="w-16 h-2 bg-muted--30 overflow-hidden">
          <div data-progress-bar="${a}" class="h-full transition-none" style="width: ${p}%; min-width: ${p>0?"2px":"0"}; background-color: var(--color-cyan);"></div>
        </div>
        <span data-remaining-time="${a}" class="text-xs text-muted font-mono w-16 text-left">${_r(i)}</span>
      </div>
    `}return t},Gf=()=>{if(!_e)return;const e=M.getState(),r=J(e),{combat:t}=r,a=Rt(e.activeRealm);for(const n of a){const s=t.activeExpeditions[n.id]||[],o=_e.querySelector(`[data-expedition-row="${n.id}"]`);if(!o)continue;const i=o.querySelector("[data-progress-bars]");if(!i||i.querySelectorAll("[data-progress-slot]").length!==s.length)continue;const p=Date.now();for(let u=0;u<s.length;u++){const c=s[u],g=p-c.startTime,m=Math.max(0,c.duration-g),h=Math.round(Math.min(g/c.duration,1)*100),f=i.querySelector(`[data-progress-bar="${u}"]`);f&&(f.style.width=`${h}%`,f.style.minWidth=h>0?"2px":"0");const v=i.querySelector(`[data-remaining-time="${u}"]`);v&&(v.textContent=_r(m))}}},Wf=(e,r,t,a,n,s,o)=>{var u,c;const i=[a,String(n),s,o],l=Rt(a);for(const g of l){const m=e.activeExpeditions[g.id]||[];i.push(`${g.id}:${e.completionsPerExpedition[g.id]||0}:${m.length}:${e.heroicVictories[g.id]||0}:${e.pendingRepeats[g.id]||0}:${JSON.stringify(((u=e.expeditionSetups[g.id])==null?void 0:u.assignedUnits)||{})}:${((c=e.expeditionSetups[g.id])==null?void 0:c.repeatIfUnitsAvailable)||!1}`)}const p=bt(a);for(const g of p){const m=(r[g]||{toNumber:()=>0}).toNumber();i.push(`${g}:${Math.floor(m)}`)}for(const g of p)i.push(`lc${g}:${t.lifetimeCrafted[g]??0}`);return i.join("|")},wa=()=>{var S,b;if(!_e)return;const e=M.getState(),r=J(e),{combat:t}=r,a=bt(e.activeRealm),n=e.activeRealm==="realm3"?Object.fromEntries(a.map(T=>[T,r.recipeInventory[T]??new d(0)])):cr(r.recipeInventory),s=To(r.recipeCrafting,a),o=JSON.stringify(r.prestige.prestigeCounts),i=JSON.stringify(r.altar.sacrificeCounts),l=Wf(t,n,s,e.activeRealm,e.globalTier,o,i);if(l===oo)return;oo=l;const p=Rt(e.activeRealm),u=Uo(e.activeRealm);if(bt(e.activeRealm).some(T=>(s.lifetimeCrafted[T]??0)>0||D(r.recipeInventory,T).gt(0))&&!_e.querySelector("[data-expedition-row]")){$n(_e);return}Jn(r.upgrades);for(let T=0;T<p.length;T++){const w=p[T],$=_e.querySelector(`[data-expedition-row="${w.id}"]`);if(!$){if(ro(w.id,p,t.completionsPerExpedition,e.activeRealm,e.globalTier)){$n(_e);return}continue}const R=ra(w.id,t.completionsPerExpedition,e.activeRealm,e.globalTier),x=ro(w.id,p,t.completionsPerExpedition,e.activeRealm,e.globalTier),y=t.activeExpeditions[w.id]||[],k=t.completionsPerExpedition[w.id]||0;if(x)$.classList.remove("hidden");else{$.classList.add("hidden");continue}const C=$.querySelector("[data-setup-btn]");if(R&&!C&&!$.hasAttribute("data-heroic-maxed")){$n(_e);return}const I=$.querySelector("[data-locked-info]");if(I)if(R)I.classList.add("hidden");else{I.classList.remove("hidden");const V=ni(w,p,T);if(V){const j=t.completionsPerExpedition[V.id]||0,B=u-j;I.innerHTML=`<span class="text-red">&#128274;</span> ${B} more`}}const _=$.querySelector("[data-completions]");if(_&&(w.heroic?_.textContent=`${t.heroicVictories[w.id]||0}`:_.textContent=`${k}`),w.heroic){const V=t.heroicVictories[w.id]||0,j=w.heroic.maxVictories!==void 0&&V>=w.heroic.maxVictories;if(j&&$.hasAttribute("data-expedition-click")){if($.removeAttribute("data-expedition-click"),$.setAttribute("data-heroic-maxed",""),$.classList.remove("cursor-pointer","hover-border-steel","hover-bg-row-odd-bright","relative","flex-col"),$.classList.add("items-center","justify-center"),$.style.borderColor="",$.className=$.className.replace("border-muted--30","border-lime--30"),w.heroic.rewardType==="portal")$.title="Realm of Earth",$.innerHTML=`
            <img src="${H("icons/r4.png")}" style="width: 64px; height: 64px;" alt="Realm of Earth">
            <div class="text-xs text-lime font-bold mt-1">Realm of Earth</div>
          `;else{const oe=w.heroic.rewardType==="shard_drops"?"Shards":w.heroic.rewardType==="realm1_output"?"R1 out":w.heroic.rewardType==="realm2_output"?"R2 out":w.heroic.rewardType==="soul_production"?"Souls":w.heroic.rewardType==="creature_production"?"Creatures":w.heroic.rewardType==="realm_mastery"?"Gems":"";$.innerHTML=`
            <div class="flex flex-col items-center gap-1">
              <div class="text-xs text-lime font-mono" data-heroic-stats="${w.id}">${oe}: Complete</div>
              <div class="text-xs text-muted" data-heroic-victory-count="${w.id}">W: ${V}</div>
            </div>
          `}continue}const B=$.querySelector(`[data-heroic-stats="${w.id}"]`);if(B){const oe=w.heroic.rewardType==="shard_drops"?"Shards":w.heroic.rewardType==="realm1_output"?"R1 out":w.heroic.rewardType==="realm2_output"?"R2 out":w.heroic.rewardType==="soul_production"?"Souls":w.heroic.rewardType==="creature_production"?"Creatures":w.heroic.rewardType==="realm_mastery"?"Gems":w.heroic.rewardType==="portal"?"Portal":"";j?(B.textContent=`${oe}: Complete`,B.className="text-xs text-lime font-mono"):w.heroic.rewardType==="portal"?B.textContent="Realm of Earth":B.textContent=`${oe} x${(w.heroic.rewardScaling**V).toFixed(2)}`}const Z=$.querySelector(`[data-heroic-victory-count="${w.id}"]`);Z&&(Z.textContent=`W: ${t.heroicVictories[w.id]||0}`)}const A=$.querySelector(`[data-quest-bonus="${w.id}"]`);if(A&&w.rewards.questBonusTiers&&w.rewards.questBonusTiers.length>0){const V=w.rewards.questBonusTiers.length===1?`T${w.rewards.questBonusTiers[0]}`:`T${Math.min(...w.rewards.questBonusTiers)}-T${Math.max(...w.rewards.questBonusTiers)}`;let j="";k>0&&(j=` (+${Math.sqrt(k*.1).toFixed(2)})`),A.textContent=`${V} Output${j}`}const F=$.querySelector(`[data-reward-icons="${w.id}"]`);if(F){const V=Da(w.rewards,1,t.heroicVictories,r.prestige,r.altar.sacrificeCounts,e.activeRealm,1,e.globalTier);F.innerHTML=ls(V,"small");const j=$.querySelector(`[data-reward-rate="${w.id}"]`);if(j)if(y.length>0){const B=y[0].tauntMultiplier??1,Z=y[0].equipmentMultiplier??1,oe=Da(w.rewards,B,t.heroicVictories,r.prestige,r.altar.sacrificeCounts,e.activeRealm,Z,e.globalTier);j.textContent=cs(Rc(oe,y.length),y[0].duration,y[0].successRate)}else j.textContent=""}const E=$.querySelector("[data-progress-bars]");E&&E.querySelectorAll("[data-progress-slot]").length!==y.length&&(y.length>0?E.innerHTML=Ac(y):E.innerHTML="");const P=$.querySelector(`[data-clear-expedition="${w.id}"]`);P&&(y.length>0||!!t.expeditionSetups[w.id]?P.classList.remove("hidden"):P.classList.add("hidden"))}kf()&&it(_e);const m=((S=t.expeditionLog[0])==null?void 0:S.timestamp)??0,h=((b=t.expeditionLog[t.expeditionLog.length-1])==null?void 0:b.timestamp)??0,f=`${Sr}-${t.expeditionLog.length}-${m}-${h}`;if(f!==Ya){Ya=f;const T=_e.querySelector("[data-expedition-log]");T&&(T.innerHTML=so(t.expeditionLog,e.activeRealm,Sr,t.completionsPerExpedition))}const v=JSON.stringify(t.completionsPerExpedition);if(v!==io){io=v;const T=_e.querySelector("[data-quest-bonuses]");T&&(T.innerHTML=Cc(e.activeRealm,t.completionsPerExpedition))}},$n=e=>{_e=e;const r=M.getState(),t=J(r),{combat:a}=t,n=bt(r.activeRealm),s=To(t.recipeCrafting,n);if(!n.some(f=>(s.lifetimeCrafted[f]??0)>0||D(t.recipeInventory,f).gt(0))){e.innerHTML=`
      <div class="flex items-center justify-center h-64">
        <div class="text-center text-muted">
          <div class="text-lg mb-2">You must craft expedition units before you can start an expedition</div>
        </div>
      </div>
    `,Ka(Ee.Combat,wa);return}Jn(t.upgrades);const i=Rt(r.activeRealm),l=Uo(r.activeRealm),p=[],u=new Map;for(const f of i){const v=f.group||"Expeditions";if(!u.has(v)){const S=[];u.set(v,S),p.push({name:v,expeditions:S})}u.get(v).push(f)}const c=(f,v)=>{const S=ra(f.id,a.completionsPerExpedition,r.activeRealm,r.globalTier),b=a.activeExpeditions[f.id]||[],T=a.completionsPerExpedition[f.id]||0,w=v.indexOf(f);if(!ro(f.id,v,a.completionsPerExpedition,r.activeRealm,r.globalTier))return"";if(S){const $=!!f.heroic,R=$&&a.heroicVictories[f.id]||0;let x="";if($){const C=f.heroic.rewardType==="shard_drops"?"Shards":f.heroic.rewardType==="realm1_output"?"R1 out":f.heroic.rewardType==="realm2_output"?"R2 out":f.heroic.rewardType==="soul_production"?"Souls":f.heroic.rewardType==="creature_production"?"Creatures":f.heroic.rewardType==="realm_mastery"?"Gems":f.heroic.rewardType==="portal"?"Portal":"";f.heroic.maxVictories!==void 0&&R>=f.heroic.maxVictories?x=`<div class="text-xs text-lime font-mono" data-heroic-stats="${f.id}">${C}: Complete</div><div class="text-xs text-muted" data-heroic-victory-count="${f.id}">W: ${R}</div>`:f.heroic.rewardType==="portal"?x=`<div class="text-xs text-lime font-bold" data-heroic-stats="${f.id}">Realm of Earth</div><img src="${H("icons/r4.png")}" style="width: 48px; height: 48px;" alt="Realm of Earth"><div class="text-xs text-muted" data-heroic-victory-count="${f.id}">W: ${R}</div>`:x=`<div class="text-xs text-yellow font-mono" data-heroic-stats="${f.id}">${C} x${(f.heroic.rewardScaling**R).toFixed(2)}</div><div class="text-xs text-muted" data-heroic-victory-count="${f.id}">W: ${R}</div>`}else if(f.rewards.questBonusTiers&&f.rewards.questBonusTiers.length>0){const C=f.rewards.questBonusTiers.length===1?`T${f.rewards.questBonusTiers[0]}`:`T${Math.min(...f.rewards.questBonusTiers)}-T${Math.max(...f.rewards.questBonusTiers)}`;x=`<div class="text-xs text-yellow" data-quest-bonus="${f.id}">${C} Output${T>0?` (+${Math.sqrt(T*.1).toFixed(2)})`:""}</div>`}else{const C=Da(f.rewards,1,a.heroicVictories,t.prestige,t.altar.sacrificeCounts,r.activeRealm,1,r.globalTier);let I="";if(b.length>0){const _=b[0].tauntMultiplier??1,A=b[0].equipmentMultiplier??1,F=Da(f.rewards,_,a.heroicVictories,t.prestige,t.altar.sacrificeCounts,r.activeRealm,A,r.globalTier);I=cs(Rc(F,b.length),b[0].duration,b[0].successRate)}x=`<span data-reward-icons="${f.id}">${ls(C,"small")}</span><div class="text-xs text-cyan font-mono" data-reward-rate="${f.id}">${I}</div>`}const y=$&&f.heroic.maxVictories!==void 0&&R>=f.heroic.maxVictories,k=b.length>0||!!a.expeditionSetups[f.id];return y?f.heroic.rewardType==="portal"?`
            <div data-expedition-row="${f.id}" data-heroic-maxed class="border border-lime--30 p-2 flex flex-col items-center justify-center" style="width: 160px; height: 160px; background: var(--color-row-odd); overflow: hidden;" title="Realm of Earth">
              <img src="${H("icons/r4.png")}" style="width: 64px; height: 64px;" alt="Realm of Earth">
              <div class="text-xs text-lime font-bold mt-1">Realm of Earth</div>
            </div>
          `:`
          <div data-expedition-row="${f.id}" data-heroic-maxed class="border border-lime--30 p-2 flex flex-col items-center justify-center" style="width: 160px; height: 160px; background: var(--color-row-odd); overflow: hidden;">
            <div class="flex flex-col items-center gap-1">
              ${x}
            </div>
          </div>
        `:`
        <div data-expedition-row="${f.id}" data-expedition-click="${f.id}" class="border border-muted--30 p-2 cursor-pointer hover-border-steel hover-bg-row-odd-bright relative flex flex-col" style="width: 160px; height: 160px; background: var(--color-row-odd); overflow: hidden;">
          <div class="flex flex-col items-center gap-1">
            ${x}
          </div>
          <div data-progress-bars class="flex flex-col gap-1 mt-1 w-full">
            ${Ac(b)}
          </div>
          <span data-completions class="hidden">${$?R:T}</span>
          <span data-difficulty="${f.id}" class="hidden"></span>
          <span data-heroic-reward="${f.id}" class="hidden"></span>
          <div data-locked-info class="hidden"></div>
          <button data-setup-btn="${f.id}" class="hidden"></button>
          <button data-clear-expedition="${f.id}" class="mt-auto w-full text-xs border border-muted--30 text-muted hover-border-red hover-text-red cursor-pointer py-1 ${k?"":"hidden"}">Clear</button>
        </div>
      `}else{let $="";const R=ni(f,v,w);if(R){const x=a.completionsPerExpedition[R.id]||0;$=`<span class="text-red">&#128274;</span> ${l-x} more`}return`
        <div data-expedition-row="${f.id}" class="border border-muted--20 p-2 flex items-center justify-center" style="width: 160px; height: 160px; opacity: 0.5; background: var(--color-row-odd);">
          <div data-locked-info class="text-xs text-muted text-center">${$}</div>
        </div>
      `}},g={"Shards & CP":"+Shards<br>+Combat Points",Shards:"+Shards",Nullstones:"+Nullstones",Fragments:"+Mythic Fragments","Heroic Expeditions":"Heroic","Output Bonuses":"Output Bonuses"};let m="";for(const f of p){let v="";for(const b of f.expeditions)v+=c(b,i);if(!v)continue;const S=g[f.name]||f.name;m+=`
      <div class="expedition-group flex items-center gap-4 mb-4">
        <div class="expedition-group-label text-xs text-muted font-bold font-mono" style="width: 130px; flex-shrink: 0;">${S}</div>
        <div class="flex flex-wrap gap-2 items-center">
          ${v}
        </div>
      </div>
    `}const h=Cc(r.activeRealm,a.completionsPerExpedition);e.innerHTML=`
    <div>
      <div data-quest-bonuses>${h}</div>
      ${m}
      <div class="mt-6">
        ${Et("expedition-log","Expedition Log",`<div data-expedition-log class="max-w-2xl">
            ${so(a.expeditionLog,r.activeRealm,Sr,a.completionsPerExpedition)}
          </div>`,!0)}
      </div>
      <div data-setup-modal class="hidden"></div>
    </div>
  `,wr&&e.removeEventListener("click",wr),wr=f=>{const v=f.target,S=v.closest("[data-clear-expedition]");if(S){const x=S.getAttribute("data-clear-expedition");x&&M.getState().clearExpedition(x);return}const b=v.closest("[data-expedition-click]");if(b){const x=b.getAttribute("data-expedition-click");if(x){Rf(x,_e);return}}if(v.hasAttribute("data-close-modal")){ao(_e);return}if(v.hasAttribute("data-modal-backdrop")){ao(_e);return}if(v.hasAttribute("data-save-setup")&&!v.disabled){Cf(_e,wa);return}if(v.hasAttribute("data-restart-setup")&&!v.disabled){Mf(_e,wa);return}const T=v.getAttribute("data-modal-assign"),w=v.getAttribute("data-unit");if(T&&w){switch(T){case"clear":If(w,_e);break;case"sub1":no(w,-1,_e);break;case"add1":no(w,1,_e);break;case"max":Ef(w,_e);break;case"plus10":Af(w,_e);break;case"static":{const x=Number(v.getAttribute("data-amount")||"0");x>0&&_f(w,x,_e);break}}return}const $=v.getAttribute("data-modal-equip-assign"),R=v.getAttribute("data-equip");if($&&R){switch($){case"clear":Pf(R,_e);break;case"static":{const x=Number(v.getAttribute("data-amount")||"0");x>0&&Uf(R,x,_e);break}}return}},e.addEventListener("click",wr),e.addEventListener("change",f=>{var S,b;const v=f.target;if(v.matches("[data-log-filter]")){Sr=v.value,Ya="";const T=_e==null?void 0:_e.querySelector("[data-expedition-log]");if(T){const w=M.getState(),$=J(w).combat;T.innerHTML=so($.expeditionLog,w.activeRealm,Sr,$.completionsPerExpedition);const R=((S=$.expeditionLog[0])==null?void 0:S.timestamp)??0,x=((b=$.expeditionLog[$.expeditionLog.length-1])==null?void 0:b.timestamp)??0;Ya=`${Sr}-${$.expeditionLog.length}-${R}-${x}`}}}),Ka(Ee.Combat,wa),Jr&&clearInterval(Jr),Jr=setInterval(Gf,100),wa()},Qi=(e,r)=>{if(e.lte(0))return 0;if(e.gte(r))return 1;const t=e.log10().toNumber(),a=r.log10().toNumber(),n=0;return t<=n?0:Math.min(1,Math.max(0,(t-n)/(a-n)))};let Tr=null;const Kf=e=>{const r=ta[e];if(!r)return"";const t=Ca(e);if(e===5)return`${Oa} Heroic Trials in Realm of Earth`;if(e===4)return"3 Heroic Trials in Realm of Earth";if(e===3)return`${N(Ln)} pixies in Realm of Magic`;const a=t==="realm2"?"in R2":"";return`${N(r.manaRequirement)} mana${a?` ${a}`:""}`},Ji=[{tier:1,bonuses:["x1.2 Crafter Speed"],unlocks:["Altar of Sacrifice","Research Auto-Buy"]},{tier:2,bonuses:["x1.4 Crafter Speed (total)","Artifacts persist on reset"],unlocks:["Heroic Expeditions","T4+ Swords usable in Prime Realm","Auto-Prestige"],requiredRealm:"realm2",notes:"Resets BOTH realms"},{tier:3,bonuses:[],unlocks:['<span class="hover-tooltip-wrapper cursor-help">Unification (?)<div class="hover-tooltip" style="min-width:280px"><div class="tooltip-title">Unification</div><div class="tooltip-divider"></div><div class="tooltip-row">Prime Realm and Realm of War merge into the Unified Realm</div><div class="tooltip-row"> Best progress from both realms kept</div><div class="tooltip-row"> Prestige: highest levels preserved</div><div class="tooltip-row"> Altar sacrifices: merged, capped at 20k</div><div class="tooltip-row"> R2 artifacts refunded as shards</div><div class="tooltip-row"> Knights gain x100 strength</div><div class="tooltip-row"> Soulforge output squared</div><div class="tooltip-row"> Realm of Magic force-ascended</div></div></span>',"Mythic expedition & Artifacts","Captain (T8 expedition unit)","Realm of Earth portal","Altar uncapped","New shard expeditions"],notes:"R1 and R2 merge into Unified Realm. R2 artifacts refunded as shards."},{tier:4,bonuses:["x5 Global Output (everything)"],unlocks:["Creature Automation","Additional Heroic Trials"],notes:"Total reset  all progress is lost. Requires 3 Heroic Trials in Realm of Earth."},{tier:5,bonuses:["x20 Global Output (replaces x5)","x10 Arcane Dwelling population"],unlocks:["Ancient Valor wonder"],notes:`Total reset  all progress is lost. Requires ${Oa} Heroic Trials in Realm of Earth.`}],Yf=(e,r,t,a,n)=>{const s=r>=e.tier,o=r===e.tier-1,i=s?"border-positive bg-positive--20":"bg-panel border-muted--30",l=s?"text-positive":"text-gold",p=s?"text-positive":"text-text",u=e.bonuses.map(v=>`<div class="text-sm ${p}"> ${v}</div>`).join(""),c=e.unlocks.map(v=>`<div class="text-sm ${p}"> ${v}</div>`).join("");let g="";s?g='<span class="text-positive font-mono text-sm"> Complete</span>':o&&(g=`
      <button
        data-action="tier-reset"
        ${a?"":"disabled"}
        class="px-4 py-2 font-mono border ${a?"border-gold text-gold hover-bg-gold--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed"}"
      >Reset</button>
    `);const m=Kf(e.tier),h=o?`
    <div class="mt-3 h-2 bg-muted--20 border border-muted--30 overflow-hidden">
      <div data-tier-progress="${e.tier}" class="h-full ${a?"bg-positive":"bg-arcane"}" style="width: ${n*100}%"></div>
    </div>
  `:"",f=e.notes&&!s?`
    <div class="text-xs text-yellow mt-2">${e.notes}</div>
  `:"";return`
    <div data-milestone="${e.tier}" class="border ${i} p-4">
      <div class="flex items-start gap-4">
        <div class="text-2xl font-mono ${l} w-12 flex-shrink-0">T${e.tier}</div>
        <div class="flex-1 min-w-0">
          <div class="text-sm ${p} mb-2">
            <span class="text-steel">Req:</span> ${m}
            ${o?`<span class="text-muted ml-2">(Current: <span data-current-mana class="${a?"text-positive":"text-text"}">${t}</span>)</span>`:""}
          </div>
          ${e.bonuses.length>0?`
          <div class="flex gap-4 flex-wrap">
            <div class="flex-1">
              <div class="text-xs text-steel mb-1">Bonuses</div>
              ${u}
            </div>
            <div class="flex-1">
              <div class="text-xs text-steel mb-1">Unlocks</div>
              ${c||'<div class="text-sm text-muted"></div>'}
            </div>
          </div>
          `:`
          <div class="flex gap-4 flex-wrap">
            <div class="flex-1">
              <div class="text-xs text-steel mb-1">Unlocks</div>
              ${e.unlocks.slice(0,Math.ceil(e.unlocks.length/2)).map(v=>`<div class="text-sm ${p}"> ${v}</div>`).join("")}
            </div>
            <div class="flex-1">
              <div class="text-xs text-steel mb-1">&nbsp;</div>
              ${e.unlocks.slice(Math.ceil(e.unlocks.length/2)).map(v=>`<div class="text-sm ${p}"> ${v}</div>`).join("")}
            </div>
          </div>
          `}
          ${f}
          ${h}
          ${g?`<div class="mt-3">${g}</div>`:""}
        </div>
      </div>
    </div>
  `},zf=e=>{const r=()=>{const t=M.getState(),a=t.globalTier,s=Ji.filter(u=>u.tier<=a+1).slice().reverse().map(u=>{var R;const c=Ca(u.tier),g=t.realms[c],m=g.mana,h=t.activeRealm===c;let f,v;u.tier===5?(f=new d(t.realms.realm4.heroicTrialCompleted),v=new d(Oa)):u.tier===4?(f=new d(t.realms.realm4.heroicTrialCompleted),v=new d(3)):u.tier===3?(f=D(g.recipeInventory,"pixie"),v=Ln):(f=m,v=((R=ta[u.tier])==null?void 0:R.manaRequirement)??new d(1));const S=u.tier===3?f:void 0,b=t.realms.realm4.heroicTrialCompleted,T=h&&Bn(m,a,c,S,b)&&a===u.tier-1,w=Qi(f,v),$=N(f);return Yf(u,a,$,T,w)}).join(""),o=a+1,i=o<=Vs?Ca(o):null,p=!(i===t.activeRealm)&&i?`
      <div class="mb-4 p-3 border border-yellow text-yellow text-sm">
        T${o} reset requires ${Td[i]}. ${t.realm2Unlocked?"Switch realms to perform the reset.":"Advance through expeditions to unlock the Realm tab and open a portal to the Realm of War."}
      </div>
    `:"";e.innerHTML=`
      <div class="max-w-5xl">
        <div class="mb-6">
          <h2 class="text-xl font-mono text-gold mb-2">Tier Milestones</h2>
          <p class="text-sm text-steel">Reset your progress to unlock permanent bonuses. Bonuses persist through future resets.</p>
        </div>
        ${p}
        <div class="flex flex-col gap-2">
          ${s}
        </div>
      </div>
    `,Tr&&e.removeEventListener("click",Tr),Tr=u=>{u.target.getAttribute("data-action")==="tier-reset"&&M.getState().tierReset()},e.addEventListener("click",Tr)};return r(),()=>{var S;const t=M.getState(),a=t.globalTier,n=Ji.filter(b=>b.tier<=a+1),s=e.querySelectorAll("[data-milestone]").length;if(n.length!==s){r();return}const o=a+1,i=Ca(o),l=t.realms[i],p=l.mana,u=t.activeRealm===i;let c,g;o===5?(c=new d(t.realms.realm4.heroicTrialCompleted),g=new d(Oa)):o===4?(c=new d(t.realms.realm4.heroicTrialCompleted),g=new d(3)):o===3?(c=D(l.recipeInventory,"pixie"),g=Ln):(c=p,g=((S=ta[o])==null?void 0:S.manaRequirement)??new d(1));const m=o===3?c:void 0,h=t.realms.realm4.heroicTrialCompleted,f=u&&Bn(p,a,t.activeRealm,m,h),v=e.querySelector("[data-current-mana]");if(v&&(v.textContent=N(c),v.className=f?"text-positive":"text-text"),o<=Vs){const b=Qi(c,g),T=e.querySelector(`[data-tier-progress="${o}"]`);T&&(T.style.width=`${b*100}%`,T.className=`h-full ${f?"bg-positive":"bg-arcane"}`);const w=e.querySelector('[data-action="tier-reset"]');w&&(w.disabled=!f,w.className=`px-4 py-2 font-mono border ${f?"border-gold text-gold hover-bg-gold--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed"}`)}}},si=Dt(Ee.Tier,zf,{onCleanup:()=>{var e;Tr&&((e=si.getContainer())==null||e.removeEventListener("click",Tr),Tr=null)}}),Xf=si.cleanup,Zf=si.render,Cs=(e,r)=>{const t=M.getState();M.setState({realms:{...t.realms,[e]:{...t.realms[e],autoAllSacrifice:r}}})},Qf=(e,r)=>`
    <div class="h-2 border border-muted--30 overflow-hidden">
      <div data-progress-bar class="h-full ${r?"bg-red":"bg-positive"}" style="width: ${e*100}%"></div>
    </div>
  `;let kr=null;const Jf=e=>{var t,a;const r=na(e);if(!r)return"";if(r.type==="gem"&&r.tier!==void 0)return Ze[r.tier].icon;if(r.type==="flask"&&r.tier!==void 0)return ea[r.tier].icon;if(r.type==="military"&&r.militaryId!==void 0){const n=M.getState();return((t=an(n.activeRealm)[r.militaryId])==null?void 0:t.icon)??""}else if(r.type==="expedition_reward")return((a=me(r.id))==null?void 0:a.icon)??"";return""},_c=e=>{var s;const r=M.getState(),t=J(r),a=na(e);if(!a)return 0;const n=a.type==="military"&&a.militaryId?a.militaryId:e;return((s=t.recipeInventory[n])==null?void 0:s.toNumber())??0},qc=e=>e==="gem_1"?sc:1,eg=e=>{const r=M.getState(),t=J(r),a=t.altar.activeSacrifices.includes(e),n=t.altar.activeSacrifice===e;if(!a&&!n||t.altar.sacrificeProgress<1)return!1;const s=_c(e),o=qc(e);return s<=o},tg=()=>{const e=M.getState(),r=J(e),t=De(e.activeRealm),a=t.MODIFIERS.sacrificeCap,n=t.MODIFIERS.sacrificeBatchSize*ca(r.upgrades),s=t.MODIFIERS.calculateSacrificeBonus,o=s(a),i=Ra(e.activeRealm),l=i.filter(T=>T.type==="gem"),p=i.filter(T=>T.type==="flask"),u=i.filter(T=>T.type==="military"),c=i.filter(T=>T.type==="expedition_reward"),g=(T,w)=>{if(!na(T))return"";const R=`
      <button
        data-action="start-sacrifice"
        data-item="${T}"
        disabled
        class="px-2 py-1 text-xs font-mono border border-muted--30 text-muted--50 cursor-not-allowed"
      >Sacrifice</button>
    `;return`
      <tr data-sacrifice-row="${T}">
        <td class="py-2 pr-4" style="width: 200px;">
          <div class="flex items-center gap-3">
            <img src="${Jf(T)}" alt="${w}" class="w-8 h-8 object-contain">
            <span class="text-text text-sm whitespace-nowrap">${w}</span>
          </div>
        </td>
        <td class="text-text font-mono text-sm text-left pl-2" style="width: 110px;" data-item-count="${T}"></td>
        <td class="text-steel font-mono text-sm text-left pl-2" style="width: 110px;" data-sacrifice-count="${T}"></td>
        <td class="text-positive font-mono text-sm text-left pl-2" style="width: 100px;" data-sacrifice-bonus="${T}"></td>
        <td style="width: 200px;" data-sacrifice-action="${T}">${R}</td>
      </tr>
    `},m=(T,w,$)=>{if(w.length===0)return"";const R=h?`
      <button
        data-action="start-group-sacrifice"
        data-group="${$}"
        class="px-2 py-1 text-xs font-mono border border-arcane text-arcane hover-bg-arcane--20 cursor-pointer ml-2"
      >Start All</button>`:"",x=`
      <div class="mobile-scroll-x">
        <table style="width: 720px; table-layout: fixed;">
          <thead>
            <tr class="text-xs text-steel">
              <th class="text-left pb-2" style="width: 200px;">Item</th>
              <th class="text-left pb-2 pl-2" style="width: 110px;">Owned</th>
              <th class="text-left pb-2 pl-2" style="width: 110px;">Sacrificed</th>
              <th class="text-left pb-2 pl-2" style="width: 100px;">Bonus</th>
              <th style="width: 200px;" data-group-action="${$}">${R}</th>
            </tr>
          </thead>
          <tbody>
            ${w.map(y=>g(y.id,y.name)).join("")}
          </tbody>
        </table>
      </div>
    `;return Et(`altar-${$}`,T,x,!0)},h=!isFinite(a),f=n>1?` Sacrifices ${N(n)} items at a time.`:"",S=`Sacrifice items to permanently increase their output bonus.<br>
        Altar bonuses do not reset on tier up until T4. T4+ resets altar bonuses. ${h?"No sacrifice cap.":`Cap: ${te(a)} sacrificed (x${N(o)} max).`}${f}`,b=J(e).autoAllSacrifice;return`
    <div class="text-lg font-mono text-gold mb-3">Altar of Sacrifice</div>
    <div class="text-sm text-steel mb-4">
      ${S}
    </div>
    ${h?`<div class="mb-4">
      <label class="inline-flex items-center gap-2 text-sm cursor-pointer">
        <input type="checkbox" data-action="toggle-auto-all-sacrifice" ${b?"checked":""} class="cursor-pointer accent-gold">
        <span class="text-steel">Auto-sacrifice all (including new unlocks)</span>
      </label>
    </div>`:""}
    <hr class="border-muted--30 mb-6">
    ${m("Gems",l,"gem")}
    ${m("Flasks",p,"flask")}
    ${m("Units",u,"military")}
    ${m("Rewards",c,"expedition_reward")}
  `},rg=e=>{const r=()=>{const t=M.getState();if(!js(t.globalTier)){e.innerHTML=`
        <div class="flex items-center justify-center h-64">
          <div class="text-center text-muted">
            <div class="text-lg mb-2">The Altar is locked</div>
            <div class="text-sm">Perform a Tier 1 reset to unlock the Altar.</div>
          </div>
        </div>
      `;return}e.innerHTML=`
      <div class="max-w-4xl">
        ${tg()}
      </div>
    `;const a=e.querySelector('[data-action="toggle-auto-all-sacrifice"]');a&&a.addEventListener("change",()=>{const n=M.getState(),s=a.checked;Cs(n.activeRealm,s);const o=J(n),i=Ra(n.activeRealm);if(s)for(const l of i)o.altar.activeSacrifices.includes(l.id)||M.getState().startSacrifice(l.id);else for(const l of i)o.altar.activeSacrifices.includes(l.id)&&M.getState().stopSacrifice(l.id)}),kr&&e.removeEventListener("click",kr),kr=n=>{const s=n.target,o=s.getAttribute("data-action");if(o==="start-sacrifice"){const i=s.getAttribute("data-item");i&&M.getState().startSacrifice(i)}else if(o==="stop-sacrifice"){const i=s.getAttribute("data-item"),l=M.getState();J(l).autoAllSacrifice&&Cs(l.activeRealm,!1),M.getState().stopSacrifice(i??void 0)}else if(o==="start-group-sacrifice"||o==="stop-group-sacrifice"){const i=s.getAttribute("data-group");if(i){const l=M.getState(),p=J(l),u=Ra(l.activeRealm).filter(c=>c.type===i);if(o==="start-group-sacrifice")for(const c of u)p.altar.activeSacrifices.includes(c.id)||M.getState().startSacrifice(c.id);else{p.autoAllSacrifice&&Cs(l.activeRealm,!1);for(const c of u)p.altar.activeSacrifices.includes(c.id)&&M.getState().stopSacrifice(c.id)}}}},e.addEventListener("click",kr)};return r(),()=>{const t=M.getState(),a=J(t),n=De(t.activeRealm),{altar:s}=a,o=n.MODIFIERS.sacrificeCap,i=n.MODIFIERS.calculateSacrificeBonus;if(!e.querySelector("[data-sacrifice-row]")&&js(t.globalTier)){r();return}const l=e.querySelector('[data-action="toggle-auto-all-sacrifice"]');l&&l.checked!==a.autoAllSacrifice&&(l.checked=a.autoAllSacrifice);const p=!isFinite(o),u=Ra(t.activeRealm);if(p){const c=["gem","flask","military","expedition_reward"];for(const g of c){const m=e.querySelector(`[data-group-action="${g}"]`);if(!m)continue;const h=u.filter(w=>w.type===g),f=h.length>0&&h.every(w=>s.activeSacrifices.includes(w.id)),v=f?"stop-group-sacrifice":"start-group-sacrifice",S=f?"Stop All":"Start All",b=f?"border-red text-red hover-bg-red--20":"border-arcane text-arcane hover-bg-arcane--20",T=m.querySelector("button");T&&T.getAttribute("data-action")!==v&&(T.setAttribute("data-action",v),T.textContent=S,T.className=`px-2 py-1 text-xs font-mono border ${b} cursor-pointer ml-2`)}}for(const c of u){const g=e.querySelector(`[data-sacrifice-row="${c.id}"]`);if(!g)continue;const m=s.sacrificeCounts[c.id]||0,h=i(m),f=!p&&m>=o,v=p?s.activeSacrifices.includes(c.id):s.activeSacrifice===c.id,S=_c(c.id),b=qc(c.id),T=S>b&&!f,w=g.querySelector(`[data-item-count="${c.id}"]`);w&&(w.textContent=N(S));const $=g.querySelector(`[data-sacrifice-count="${c.id}"]`);$&&($.textContent=N(m));const R=g.querySelector(`[data-sacrifice-bonus="${c.id}"]`);R&&(R.textContent=`x${N(h)}`);const x=g.querySelector(`[data-sacrifice-action="${c.id}"]`);if(x)if(v){const y=eg(c.id);let k=x.querySelector("[data-progress-bar]");k?Zr(k,s.sacrificeProgress,y):x.innerHTML=`
              <div class="flex items-center gap-2">
                <div class="w-24">${Qf(s.sacrificeProgress,y)}</div>
                <button
                  data-action="stop-sacrifice"
                  data-item="${c.id}"
                  class="px-2 py-1 text-xs font-mono border border-red text-red hover-bg-red--20 cursor-pointer"
                >Stop</button>
              </div>
            `}else if(f)x.innerHTML='<span class="text-gold text-xs">MAX</span>';else{const y=T?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted--50 cursor-not-allowed",k=x.querySelector('[data-action="start-sacrifice"]');if(!k)x.innerHTML=`
              <button
                data-action="start-sacrifice"
                data-item="${c.id}"
                ${T?"":"disabled"}
                class="px-2 py-1 text-xs font-mono border ${y}"
              >Sacrifice</button>
            `;else{const C=k;C.className=`px-2 py-1 text-xs font-mono border ${y}`,C.disabled=!T}}}}},oi=Dt(Ee.Altar,rg,{onCleanup:()=>{var e;kr&&((e=oi.getContainer())==null||e.removeEventListener("click",kr),kr=null)}}),ag=oi.cleanup,ng=oi.render,br=10,Hr=1e6;let $r=null;const sg=e=>{const r=M.getState(),t=r.realms.realm1,a=r.realms.realm2,n=Be[e],s=xt(t.artifacts,e),o=t.artifacts.upgradeLevels[e]??0,i=xt(a.artifacts,e),l=a.artifacts.upgradeLevels[e]??0;if(!s)return"";const p=D(r.realms.realm1.recipeInventory,"nullstone").toNumber(),u=p>=Ha&&(!i||o>l),c=i;let g,m,h=!1;u?c?(g="border-gold text-gold hover-bg-gold--20 cursor-pointer",m=`Overwrite (+${o-l})`):(g="border-lime text-lime hover-bg-lime--20 cursor-pointer",m="Ship"):p<Ha?(g="border-muted--30 text-muted--50 cursor-not-allowed",m="Ship",h=!0):(g="border-muted--30 text-muted--50 cursor-not-allowed line-through",m="Already in R2",h=!0);const f=o>0?`<span class="text-cyan">+${o}</span>`:"";let v="";return i&&(v=`<div class="text-xs text-steel">In R2: +${l}</div>`),`
    <div class="flex items-center gap-3 p-2 border border-muted--30 bg-black--30" data-ship-card="${e}">
      <img src="${n.icon}" alt="${n.name}" class="w-12 h-12 object-contain">
      <div class="flex-1 min-w-0">
        <div class="text-sm font-mono text-text">${n.name} ${f}</div>
        <div class="text-xs text-steel">T${n.tier} ${n.type}</div>
        ${v}
      </div>
      <button
        data-action="ship-artifact"
        data-artifact-id="${e}"
        ${h?"disabled":""}
        class="px-3 py-1 text-xs font-mono border ${g}"
      >${m}</button>
    </div>
  `},el=()=>{const e=M.getState(),r=D(e.realms.realm1.recipeInventory,"nullstone").toNumber(),t=e.realms.realm1,a=$t.filter(s=>xt(t.artifacts,s));if(a.length===0)return`
      <div data-shipping-section class="mt-8 p-4 border border-muted--30">
        <h3 class="text-lg font-mono text-gold mb-2">Ship Artifacts to Realm of War</h3>
        <p class="text-sm text-steel">
          You don't have any artifacts in the Prime Realm to ship.
          Craft artifacts in the Artifacts tab first.
        </p>
      </div>
    `;const n=a.map(s=>sg(s)).join("");return`
    <div data-shipping-section class="mt-8 p-4 border border-muted--30">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-mono text-gold">Ship Artifacts to Realm of War</h3>
          <p class="text-xs text-steel">
            In the Realm of War, you cannot craft artifacts - only receive shipments from the Prime Realm.
          </p>
        </div>
        <div class="text-right">
          <div class="text-sm text-text">
            <span data-ship-nullstone-count>${te(r)}</span>
            <img src="${H("icons/nullstone.png")}" alt="Nullstone" class="w-4 h-4 inline ml-1">
          </div>
          <div class="text-xs text-steel">Cost: ${Ha} per artifact</div>
        </div>
      </div>
      <div class="grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
        ${n}
      </div>
      <div class="mt-3 text-xs text-steel">
        Shipped artifacts are removed from the Prime Realm and must be re-crafted.
        You can overwrite a Realm of War artifact only if the Prime Realm version has a higher upgrade level.
      </div>
    </div>
  `},tl=()=>{const e=M.getState(),r=e.realms.realm1.artifacts,t=e.realms.realm2.artifacts;return JSON.stringify({nullstone:D(e.realms.realm1.recipeInventory,"nullstone").toNumber(),r1Owned:r.owned,r1Levels:r.upgradeLevels,r2Owned:t.owned,r2Levels:t.upgradeLevels})},og={realm1:{icon:"icons/r0.png",name:"Prime Realm",color:"cyan"},realm2:{icon:"icons/portal.png",name:"Realm of War",color:"arcane"},realm3:{icon:"icons/r3.png",name:"Realm of Magic",color:"magenta"},realmU:{icon:"icons/r0.png",name:"Unified Realm",color:"cyan"},realm4:{icon:"icons/r4.png",name:"Realm of Earth",color:"yellow"}},ig=()=>`
  <div class="tooltip-title" style="color: var(--color-magenta);">Realm of Magic</div>
  <div class="tooltip-section" style="margin-bottom: 4px;">A magical realm powered by arcane souls.</div>
  <div class="tooltip-divider"></div>
  <div class="tooltip-row">
    <span class="tooltip-label">Soulforges</span>
    <span class="tooltip-value" style="color: var(--color-magenta);">Generate arcane souls</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Recipes</span>
    <span class="tooltip-value" style="color: var(--color-magenta);">Require arcane souls</span>
  </div>
`,lg=()=>`
  <div class="tooltip-title" style="color: var(--color-cyan);">Prime Realm</div>
  <div class="tooltip-section" style="margin-bottom: 4px;">The standard realm with normal mechanics.</div>
  <div class="tooltip-divider"></div>
  <div class="tooltip-row">
    <span class="tooltip-label">Mana generation</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Normal</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Craft speed</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Normal</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Artifacts</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Craftable</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Heroic expeditions</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Available</span>
  </div>
`,cg=()=>`
  <div class="tooltip-title" style="color: var(--color-cyan);">Unified Realm</div>
  <div class="tooltip-section" style="margin-bottom: 4px;">The merged realm after T3 reset.</div>
  <div class="tooltip-divider"></div>
  <div class="tooltip-row">
    <span class="tooltip-label">Knights</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">x10 strength</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Artifacts</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Craftable</span>
  </div>
  <div class="tooltip-row">
    <span class="tooltip-label">Heroic expeditions</span>
    <span class="tooltip-value" style="color: var(--color-cyan);">Available</span>
  </div>
`,lo=e=>{const t=(e.realms.realmU.combat.heroicVictories.heroic_portal||0)>=1,a=D(e.realms.realm3.recipeInventory,"soulcaster"),n=a.gte(1);return{portalWon:t,hasSoulcaster:n,soulcasterCount:a,canBuild:t&&n}},ug=e=>{const{portalWon:r,hasSoulcaster:t,soulcasterCount:a,canBuild:n}=lo(e);return`
    <div class="mt-8 flex flex-col items-center gap-4" data-earth-portal-section>
      <button
        data-action="build-earth-portal"
        ${n?"":"disabled"}
        class="px-6 py-3 font-mono text-lg border ${n?"border-yellow text-yellow hover-bg-yellow--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed"}"
        style="min-width: 340px;"
      >
        Open Portal to Realm of Earth
      </button>
      <div class="text-sm text-steel flex flex-col items-center gap-1">
        <div>Requires: <span class="${r?"text-positive":"text-red"}" data-earth-portal-req>${r?"Won":"Not won"} - Portal expedition</span></div>
        <div>Requires: <span class="${t?"text-positive":"text-red"}" data-earth-soulcaster-req>${N(a)} / 1 Soulcaster</span></div>
      </div>
    </div>
  `},dg=()=>`
  <div class="tooltip-title" style="color: var(--color-yellow);">Realm of Earth</div>
  <div class="tooltip-section" style="margin-bottom: 4px;">A mysterious realm with its own rules.</div>
  <div class="tooltip-divider"></div>
  <div class="tooltip-row">
    <span class="tooltip-label">Resources</span>
    <span class="tooltip-value" style="color: var(--color-yellow);">Soulcasters, Portal Knights</span>
  </div>
`,Vr=(e,r)=>{const t=og[e],a=e==="realm1"?lg():e==="realm2"?zc():e==="realmU"?cg():e==="realm4"?dg():ig(),n=r?"1":"0.4",s=r?`<span class="text-${t.color} text-xs font-mono">Current realm</span>`:'<span class="text-steel text-xs font-mono">Click to enter</span>';return`
    <div class="flex flex-col items-center gap-2 portal-card" data-portal-card="${e}" data-portal-active="${r}">
      <div class="realm-tooltip-wrapper" style="display: inline-block;">
        <div
          ${r?"":'data-action="switch-realm"'}
          data-realm-target="${e}"
          style="cursor: ${r?"default":"pointer"}; opacity: ${n};"
          class="portal-card-img"
        >
          <img
            src="${H(t.icon)}"
            alt="${t.name}"
            style="width: 160px; height: 160px;"
            class="object-contain"
          >
        </div>
        <div class="realm-tooltip" style="left: 50%; transform: translateX(-50%);">
          ${a}
        </div>
      </div>
      <div class="text-${t.color} font-mono" style="opacity: ${n};">${t.name}</div>
      <div style="opacity: ${n};">${s}</div>
    </div>
  `},mg=e=>{const r=bc();let t=null;const a=s=>{const o=s.realmUUnlocked?"realmU":"realm1",i=D(s.realms[o].recipeInventory,"nullstone").toNumber(),l=s.realmUUnlocked||s.realms.realm1.combat.portalBuilt;return{nullstoneCount:i,portalBuilt:l}},n=()=>{const s=M.getState(),{nullstoneCount:o,portalBuilt:i}=a(s),l=Math.min(1,o/br),p=o>=br;let u,c="";if(i){t=s.activeRealm;let g;if(s.realmUUnlocked?g=`
          ${Vr("realmU",s.activeRealm==="realmU")}
          ${Vr("realm3",s.activeRealm==="realm3")}
          ${s.earthPortalBuilt?Vr("realm4",s.activeRealm==="realm4"):""}
        `:(g=`
          ${Vr("realm1",s.activeRealm==="realm1")}
          ${Vr("realm2",s.activeRealm==="realm2")}
        `,s.realm3Unlocked&&(g+=Vr("realm3",s.activeRealm==="realm3"))),u=`
        <div class="flex items-start justify-center gap-12 flex-wrap">
          ${g}
        </div>
      `,!s.realm3Unlocked&&!s.realmUUnlocked){const m=D(s.realms.realm3.recipeInventory,"soulforge"),h=m.gte(1),f=o>=Hr,v=h&&f;u+=`
          <div class="mt-8 flex flex-col items-center gap-4" data-r3-portal-section>
            <button
              data-action="build-r3-portal"
              ${v?"":"disabled"}
              class="px-6 py-3 font-mono text-lg border ${v?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed"}"
              style="min-width: 340px;"
            >
              Open Portal to Realm of Magic
            </button>
            <div class="text-sm text-steel flex flex-col items-center gap-1">
              <div>Requires: <span class="${h?"text-positive":"text-red"}" data-r3-soulforge-req>${N(m)} / 1 Soulforge</span></div>
              <div>Cost: <span class="${f?"text-positive":"text-red"}" data-r3-nullstone-req>${te(o)} / ${te(Hr)} Nullstone</span></div>
            </div>
            <div class="text-xs text-muted mt-2">Soulforges are crafted in the Prime Realm's Crafting tab after reaching 1 billion T8 gems.</div>
          </div>
        `}s.realmUUnlocked&&!s.earthPortalBuilt&&(u+=ug(s)),s.activeRealm==="realm2"&&!s.realmUUnlocked&&(c=el(),r(tl()))}else u=`
        <div class="flex flex-col items-center gap-4">
          <button
            data-action="build-portal"
            ${p?"":"disabled"}
            class="relative px-6 py-3 font-mono text-lg border ${p?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed"} overflow-hidden"
            style="min-width: 300px;"
          >
            ${Yt(l,"data-portal-progress")}
            <span class="relative flex items-center justify-center gap-2">
              Build a portal to another realm -
              <span class="inline-flex items-center gap-1 bg-black--50 px-2 py-0.5 rounded">
                ${br}
                <img src="${H("icons/nullstone.png")}" alt="Nullstone" style="width: 18px; height: 18px;" class="object-contain">
              </span>
            </span>
          </button>
          <div class="text-sm text-steel">
            You have <span data-nullstone-count class="text-text font-mono">${o}</span> nullstone
          </div>
        </div>
      `;e.innerHTML=`
      <div class="max-w-3xl mx-auto">
        <div class="mb-8 text-center">
          <h2 class="text-xl font-mono text-arcane mb-2">Realm Portal</h2>
          <p class="text-sm text-steel">Harness the power of nullstone to open a gateway to another realm.</p>
        </div>
        ${u}
        ${c}
      </div>
    `,$r&&e.removeEventListener("click",$r),$r=g=>{const h=g.target.closest("[data-action]");if(!h)return;const f=h.getAttribute("data-action");if(f==="build-portal"){const v=M.getState();if(D(v.realms.realm1.recipeInventory,"nullstone").toNumber()>=br){const b=v.realms.realm1,T={...b.recipeInventory};qe(T,"nullstone",new d(br)),M.setState({realms:{...v.realms,realm1:{...b,recipeInventory:T,combat:{...b.combat,portalBuilt:!0}}}})}}else if(f==="build-r3-portal"){const v=M.getState(),S=D(v.realms.realm1.recipeInventory,"nullstone").toNumber(),b=D(v.realms.realm3.recipeInventory,"soulforge");if(S>=Hr&&b.gte(1)){const T=v.realms.realm1,w={...T.recipeInventory};qe(w,"nullstone",new d(Hr)),M.setState({realms:{...v.realms,realm1:{...T,recipeInventory:w}}}),v.unlockRealm3()}}else if(f==="build-earth-portal"){const v=M.getState(),{canBuild:S}=lo(v);S&&(M.setState({earthPortalBuilt:!0}),n())}else if(f==="switch-realm"){const v=M.getState(),S=h.getAttribute("data-realm-target");if(!S||S===v.activeRealm)return;S==="realm2"&&!v.realm2Unlocked&&v.unlockRealm2(),v.setActiveRealm(S)}else if(f==="ship-artifact"){const v=h.getAttribute("data-artifact-id");v&&M.getState().shipArtifact(v)}},e.addEventListener("click",$r)};return n(),()=>{const s=M.getState(),{nullstoneCount:o,portalBuilt:i}=a(s),l=e.querySelector("[data-portal-card]"),p=e.querySelector('[data-action="build-portal"]');if(i&&!l){n();return}if(i&&l&&s.activeRealm!==t){n();return}if(s.realm3Unlocked&&e.querySelector("[data-r3-portal-section]")){n();return}if(s.earthPortalBuilt&&e.querySelector("[data-earth-portal-section]")){n();return}if(!i&&p){const u=Math.min(1,o/br),c=o>=br;zt(e.querySelector("[data-portal-progress]"),u);const g=e.querySelector("[data-nullstone-count]");g&&(g.textContent=String(o));const m=p;m.disabled=!c,m.className=`relative px-6 py-3 font-mono text-lg border overflow-hidden ${c?"border-arcane text-arcane hover-bg-arcane--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed"}`}if(i&&s.activeRealm==="realm2")if(r(tl())){const u=e.querySelector("[data-shipping-section]");u&&(u.outerHTML=el())}else{const u=e.querySelector("[data-ship-nullstone-count]");u&&(u.textContent=te(o))}if(i&&!s.realm3Unlocked){const u=D(s.realms.realm3.recipeInventory,"soulforge"),c=u.gte(1),g=o>=Hr,m=c&&g,h=e.querySelector('[data-action="build-r3-portal"]');h&&(h.disabled=!m,h.className=`px-6 py-3 font-mono text-lg border ${m?"border-magenta text-magenta hover-bg-magenta--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed"}`);const f=e.querySelector("[data-r3-soulforge-req]");f&&(f.textContent=`${N(u)} / 1 Soulforge`,f.className=c?"text-positive":"text-red");const v=e.querySelector("[data-r3-nullstone-req]");v&&(v.textContent=`${te(o)} / ${te(Hr)} Nullstone`,v.className=g?"text-positive":"text-red")}if(s.realmUUnlocked&&!s.earthPortalBuilt){const{portalWon:u,hasSoulcaster:c,soulcasterCount:g,canBuild:m}=lo(s),h=e.querySelector('[data-action="build-earth-portal"]');h&&(h.disabled=!m,h.className=`px-6 py-3 font-mono text-lg border ${m?"border-yellow text-yellow hover-bg-yellow--20 cursor-pointer":"border-muted--30 text-muted cursor-not-allowed"}`);const f=e.querySelector("[data-earth-portal-req]");f&&(f.textContent=`${u?"Won":"Not won"} - Portal expedition`,f.className=u?"text-positive":"text-red");const v=e.querySelector("[data-earth-soulcaster-req]");v&&(v.textContent=`${N(g)} / 1 Soulcaster`,v.className=c?"text-positive":"text-red")}}},ii=Dt(Ee.Realm,mg,{onCleanup:()=>{var e;$r&&((e=ii.getContainer())==null||e.removeEventListener("click",$r),$r=null)}}),pg=ii.cleanup,fg=ii.render,rl=(e,r)=>{const t=M.getState();M.setState({realms:{...t.realms,[e]:{...t.realms[e],autoAllPrestige:r}}})},al=e=>{const r=Nl.filter(a=>!(e==="realmU"&&a==="nullstone"||e!=="realmU"&&a==="mythic_fragment"));return[...Zn(e).filter(a=>{const n=vt[a];return n.category!=="military"||!n.ignoreModifiers}),...r]},gg=["gem","flask","military","expedition_reward","special","magical_creature","building"],hg={gem:"Mana Gems",flask:"Research Flasks",military:"Expedition Units",expedition_reward:"Expedition Rewards",special:"Special",magical_creature:"Magical Creatures",building:"Buildings",equipment:"Expedition Equipment",arcane_wonder:"Arcane Wonders"},vg=()=>{const e=M.getState(),r=J(e),t=De(e.activeRealm),a=e.activeRealm==="realm3",n=e.globalTier>=3?"realmU":"realm1",s=Er(e.realms[n].combat.heroicVictories,e.activeRealm,n),o=a?Ba(r.combat.heroicVictories):1,i=a?1:on(e.realms.realm3.combat.heroicVictories),l=e.activeRealm!=="realm3"?e.realms.realm3.recipeInventory:void 0,p={recipeInventory:r.recipeInventory,ascension:e.realms.realm3.ascension,realmId:e.activeRealm,r3Inventory:l,globalTier:e.globalTier,r4TowerLevels:e.realms.realm4.towerLevels,heroicTrialCompleted:e.realms.realm4.heroicTrialCompleted},u=Jo(r.recipeCrafting,r.upgrades,r.artifacts,r.altar,e.globalTier,t.MODIFIERS.craftTimeMultiplier,t.MODIFIERS.calculateSacrificeBonus,t.MODIFIERS.sacrificeBatchSize*ca(r.upgrades),e.activeRealm,r.combat,t.MODIFIERS.flaskRecipeMultiplier,s,r.prestige,p,o,i),c={};for(const[w,$]of Object.entries(u.recipes))c[w]=$.toNumber();const g=t.MODIFIERS.calculateSacrificeBonus,m=pa(r.combat.heroicVictories,e.activeRealm),h=at(r.prestige.prestigeCounts,"artifact_shard").toNumber(),f=at(r.prestige.prestigeCounts,"nullstone").toNumber(),v=nn(r.altar.sacrificeCounts,g).toNumber(),S=ns(r.altar.sacrificeCounts,g).toNumber(),b=at(r.prestige.prestigeCounts,"mythic_fragment").toNumber(),T=sn(r.altar.sacrificeCounts,g).toNumber();for(const[w,$]of Object.entries(r.combat.activeExpeditions))for(const R of $){if(!R.repeatIfUnitsAvailable)continue;const x=nt(w,e.activeRealm);if(!x)continue;const y=R.tauntMultiplier??1,k=R.duration/1e3;if(k<=0)continue;const C=x.rewards.artifactShards||0,I=Math.round(C*y*m*h*v);c.artifact_shard=(c.artifact_shard||0)+I*R.successRate/k;const _=x.rewards.nullstone||0,A=Math.round(_*y*f*S);c.nullstone=(c.nullstone||0)+A*R.successRate/k;const F=x.rewards.mythicFragments||0,E=Math.round(F*y*b*T);c.mythic_fragment=(c.mythic_fragment||0)+E*R.successRate/k}return c},bg=e=>{const r=()=>{const t=M.getState(),a=J(t),{prestige:n}=a,s=al(t.activeRealm);let o='<div class="p-4 font-mono">';if(o+='<h2 class="text-lg text-gold mb-2">Prestige</h2>',o+=`<div class="text-sm text-steel mb-4">Spend items from a recipe's inventory for permanent output multipliers. Prestige is reset on tiers 4+.</div>`,o+=`<div class="mb-4">${Et("prestige-explanation","How prestige works",`
      <div class="text-sm border border-muted--30 bg-panel p-3">
        <div class="text-muted mb-1"> Each prestige subtracts the requirement from inventory</div>
        <div class="text-muted mb-1"> <span class="text-positive">Recipe bonus:</span> +x0.2 output multiplier for that recipe per prestige</div>
        <div class="text-muted mb-1"> <span class="text-cyan">Global bonus:</span> +x0.01 output multiplier for <span class="text-text">all</span> recipes per prestige (any recipe)</div>
        <div class="text-muted"> Cost scales x100 per prestige (1.00k  100k  10.0m  ...)</div>
      </div>`)}</div>`,o+='<div class="text-sm mb-4">',o+='<span class="text-muted">Global prestige bonus:</span> ',o+='<span class="text-positive" data-prestige-global-mult></span>',o+='<span class="text-muted"> (all recipes)</span>',o+="</div>",t.globalTier>=2){const u=a.autoAllPrestige;o+=`<div class="mb-4">
        <label class="inline-flex items-center gap-2 text-sm cursor-pointer">
          <input type="checkbox" data-action="toggle-auto-all-prestige" ${u?"checked":""} class="cursor-pointer accent-gold">
          <span class="text-steel">Auto-prestige all (including new unlocks)</span>
        </label>
      </div>`}const l={gem:[],flask:[],military:[],expedition_reward:[],special:[],magical_creature:[],building:[],equipment:[],arcane_wonder:[]};for(const u of s){const c=me(u);l[c.category].push(u)}for(const u of gg){const c=l[u];if(c.length===0)continue;const g=c.filter(h=>{const f=D(a.recipeInventory,h),v=n.prestigeCounts[h]||0;return f.gt(0)||v>0});if(g.length===0)continue;let m=`<table class="text-sm font-mono w-full" data-prestige-table="${u}">
        <thead>
          <tr class="text-steel border-b border-muted--30">
            <th class="w-40 text-left">Recipe</th>
            <th class="w-24 text-center">Count</th>
            <th class="w-28 text-center">Inventory</th>
            <th class="w-28 text-center">Cost</th>
            <th class="w-28 text-center text-positive">Recipe</th>
            <th class="w-28 text-center text-cyan">Total</th>
            <th class="w-28"></th>
            <th class="w-10 text-center" data-auto-prestige-header style="display: none">
              <span data-action="toggle-all-auto-prestige" data-category="${u}" class="cursor-pointer text-steel hover-text-text" style="text-decoration: underline" title="Toggle all auto-prestige"><span data-auto-prestige-header-check="${u}"></span> Auto</span>
            </th>
          </tr>
        </thead>
        <tbody>`;for(const h of g){const f=me(h),v=sa(!1,!1);m+=`
          <tr data-prestige-row="${h}">
            <td class="w-40 py-1">
              <span class="inline-flex items-center gap-1.5">
                <img src="${f.icon}" alt="${f.name}" style="width: 28px; height: 28px;" class="object-contain">
                <span class="text-gold">${f.name}</span>
              </span>
            </td>
            <td class="w-24 text-center text-steel" data-prestige-count="${h}"></td>
            <td class="w-28 text-center text-muted--50" data-prestige-inventory="${h}"></td>
            <td class="w-28 text-center text-text" data-prestige-cost="${h}"></td>
            <td class="w-28 text-center text-positive" data-prestige-recipe-mult="${h}"></td>
            <td class="w-28 text-center text-cyan" data-prestige-total-mult="${h}"></td>
            <td class="w-28">
              <span class="hover-tooltip-wrapper" style="display:block">
                <button
                  data-action="prestige-recipe"
                  data-id="${h}"
                  disabled
                  class="relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${v}"
                >
                  ${Yt(0,`data-prestige-progress="${h}"`)}
                  <span class="relative z-10">Prestige</span>
                </button>
                <div class="hover-tooltip tooltip-compact" data-prestige-afford="${h}"></div>
              </span>
            </td>
            <td class="w-10 text-center" data-auto-prestige-cell="${h}" style="display: none">
              <input type="checkbox" data-action="toggle-auto-prestige" data-id="${h}" title="Auto-prestige" class="cursor-pointer" />
            </td>
          </tr>`}m+="</tbody></table>",o+=`<div class="mb-4">${Et(`prestige-${u}`,hg[u],m)}</div>`}o+="</div>",e.innerHTML=o,e.querySelectorAll('[data-action="prestige-recipe"]').forEach(u=>{u.addEventListener("click",()=>{const c=u.getAttribute("data-id");M.getState().prestigeRecipe(c)})}),e.querySelectorAll('[data-action="toggle-auto-prestige"]').forEach(u=>{u.addEventListener("change",()=>{const c=u.getAttribute("data-id"),g=M.getState();J(g).autoAllPrestige&&!u.checked&&rl(g.activeRealm,!1),M.getState().toggleAutoPrestige(c)})}),e.querySelectorAll('[data-action="toggle-all-auto-prestige"]').forEach(u=>{u.addEventListener("click",()=>{const c=u.getAttribute("data-category"),g=M.getState(),m=J(g),h=e.querySelector(`[data-prestige-table="${c}"]`);if(!h)return;const f=[];h.querySelectorAll("[data-prestige-row]").forEach(S=>{f.push(S.getAttribute("data-prestige-row"))});const v=f.every(S=>m.prestige.autoPrestige[S]);for(const S of f){const b=m.prestige.autoPrestige[S]??!1;(v?b:!b)&&M.getState().toggleAutoPrestige(S)}})});const p=e.querySelector('[data-action="toggle-auto-all-prestige"]');if(p&&p.addEventListener("change",()=>{const u=M.getState(),c=J(u),g=p.checked;rl(u.activeRealm,g),e.querySelectorAll("[data-prestige-row]").forEach(m=>{const h=m.getAttribute("data-prestige-row"),f=c.prestige.autoPrestige[h]??!1;(g?!f:f)&&M.getState().toggleAutoPrestige(h)})}),t.globalTier>=2){e.querySelectorAll("[data-auto-prestige-header]").forEach(u=>u.style.display=""),e.querySelectorAll("[data-auto-prestige-cell]").forEach(u=>u.style.display="");for(const u of s){const c=e.querySelector(`[data-action="toggle-auto-prestige"][data-id="${u}"]`);c&&(c.checked=a.autoAllPrestige||(a.prestige.autoPrestige[u]??!1))}}};return r(),()=>{const t=M.getState(),a=J(t),{prestige:n}=a,s=Xl(n.prestigeCounts),o=e.querySelectorAll("[data-prestige-row]");let i=!1;for(const m of o){const h=m.getAttribute("data-prestige-row"),f=D(a.recipeInventory,h),v=n.prestigeCounts[h]||0;if(f.eq(0)&&v>0){const S=e.querySelector(`[data-prestige-count="${h}"]`);if(S&&S.textContent!==te(v)){i=!0;break}}}const l=al(t.activeRealm);for(const m of l){const h=D(a.recipeInventory,m),f=n.prestigeCounts[m]||0;if((h.gt(0)||f>0)&&!e.querySelector(`[data-prestige-row="${m}"]`)){i=!0;break}}i&&r();const p=e.querySelector("[data-prestige-global-mult]");p&&(p.textContent=`x${N(s)}`);const u=vg(),c=i?e.querySelectorAll("[data-prestige-row]"):o;for(const m of c){const h=m.getAttribute("data-prestige-row"),f=n.prestigeCounts[h]||0,v=D(a.recipeInventory,h),S=rs(f),b=as(h,v,f),T=v.gt(0)?Math.min(1,v.div(S).toNumber()):0,w=zl(n.prestigeCounts,h),$=at(n.prestigeCounts,h),R=e.querySelector(`[data-prestige-count="${h}"]`);R&&(R.textContent=te(f));const x=e.querySelector(`[data-prestige-inventory="${h}"]`);x&&(x.textContent=N(v),x.className=`w-28 text-center ${v.gte(S)?"text-text":"text-muted--50"}`);const y=e.querySelector(`[data-prestige-cost="${h}"]`);y&&(y.textContent=N(S));const k=e.querySelector(`[data-prestige-recipe-mult="${h}"]`);k&&(k.textContent=`x${N(w)}`);const C=e.querySelector(`[data-prestige-total-mult="${h}"]`);C&&(C.textContent=`x${N($)}`);const I=e.querySelector(`[data-action="prestige-recipe"][data-id="${h}"]`);if(I){const A=sa(!1,b);I.className=`relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${A}`,b?I.removeAttribute("disabled"):I.setAttribute("disabled",""),zt(e.querySelector(`[data-prestige-progress="${h}"]`),T,!1);const F=e.querySelector(`[data-prestige-afford="${h}"]`);if(F){const E=u[h]||0;F.textContent=is(v,S,E)}}const _=e.querySelector(`[data-action="toggle-auto-prestige"][data-id="${h}"]`);if(_){const A=a.autoAllPrestige||(n.autoPrestige[h]??!1);_.checked!==A&&(_.checked=A)}}const g=e.querySelector('[data-action="toggle-auto-all-prestige"]');g&&g.checked!==a.autoAllPrestige&&(g.checked=a.autoAllPrestige),e.querySelectorAll("[data-auto-prestige-header-check]").forEach(m=>{const h=m.getAttribute("data-auto-prestige-header-check"),f=e.querySelector(`[data-prestige-table="${h}"]`);if(!f)return;const v=[];f.querySelectorAll("[data-prestige-row]").forEach(b=>{v.push(b.getAttribute("data-prestige-row"))});const S=v.length>0&&v.every(b=>n.autoPrestige[b])||a.autoAllPrestige;m.textContent=S?"":""})}},Nc=Dt(Ee.Prestige,bg),xg=Nc.cleanup,yg=Nc.render,nl=(e,r,t=0,a=1)=>{if(!e)return"";if(e.population>0)return`+${(e.population+t)*a} population`;if(e.creatureProductionMultiplier){const n=e.creatureProductionMultiplier,s=Math.pow(n,r),o=Math.pow(n,r+1),i=l=>l>=10?l.toFixed(1):l.toFixed(2);return`<span class="leading-tight">x${i(s)}  x${i(o)}</span>`}if(e.soulProductionMultiplier){const n=e.soulProductionMultiplier,s=Math.pow(n,r),o=Math.pow(n,r+1),i=l=>l>=10?l.toFixed(1):l.toFixed(2);return`<span class="leading-tight">x${i(s)}  x${i(o)} <span class="text-muted">soul prod</span></span>`}return""},sl={arcane_dwelling:"Provides 1 population per building. Population is used to assign workers in the Workshop and Arcane Wonders.",arcane_well:"Multiplies Arcane Soul production by x1.25 per building."},ol={arcane_sanctum:"Multiplies all creature passive production by x2 per level. Built by assigning population. Persists through ascension.",enchanting_tower:"Multiplies all gem production in R1, R2, and RU by x2 per level. Built by assigning population. Persists through ascension.",speed_pylon:"Increases all worker speed (workshop + wonders) and expedition speed by x1.3 per level. Built by assigning population. Persists through ascension.",ancient_valor:"Multiplies combat strength of all knights and pixies by x1.5 per level across all realms. Built by assigning population. Persists through ascension."},il=(e,r)=>{const t=e.strengthMultiplier??e.workerSpeedMultiplier??e.gemProductionMultiplier??e.creatureProductionMultiplier,a=Math.pow(t,r),n=Math.pow(t,r+1),s=i=>i>=10?i.toFixed(1):i.toFixed(2),o=e.strengthMultiplier?"strength":e.workerSpeedMultiplier?"speed":e.gemProductionMultiplier?"gem prod":"creature prod";return`<span class="leading-tight">x${s(a)}  x${s(n)} <span class="text-muted">${o}</span></span>`},ll={pickaxe:"Assigned to Mine expeditions. Increases both rewards and difficulty.",axe:"Assigned to Forest expeditions. Increases both rewards and difficulty."},Ms=(e,r,t,a)=>!t||t.length===0?{icon:e,name:r}:{icon:dt(t,a,e),name:dt(t,a,r)},co=(e,r)=>{const t=me(e),a=new d(t.escalatingCost??1).pow(r);return t.recipe.filter(n=>n.recipeId).map(n=>({recipeId:n.recipeId,amount:n.amount.mul(a)}))},cl=(e,r,t)=>co(r,t).every(n=>D(e,n.recipeId).gte(n.amount)),nr=(e,r=0,t=1)=>{let a=0;for(const[n,s]of Object.entries(qa)){const o=D(e,n).toNumber(),i=(s.population+(s.population>0?r:0))*(s.population>0?t:1);a+=o*i}return a},sr=(e,r={})=>{let t=0;for(const a of Object.values(e))t+=a;for(const a of Object.values(r))t+=a;return t},wg=e=>((()=>{var R;const t=M.getState(),a=J(t),{recipeInventory:n,workshopAssignments:s,wonderAssignments:o}=a,i=bi("realm3"),l=_n("realm3"),p=qn("realm3").filter(x=>{const y=ht[x];return!(y!=null&&y.minGlobalTier)||t.globalTier>=y.minGlobalTier}),u=x=>`border-${x} text-${x} hover-bg-${x}--20 cursor-pointer`,c="border-muted--30 text-muted cursor-not-allowed",g=["var(--color-tooltip-bg)","var(--color-row-odd)"],m=Gt(a.ascension),h=t.globalTier>=5?ar:1,f=nr(n,m,h),v=sr(s,o),S=Math.max(0,f-v);let b="";const w=`<div class="mobile-scroll-x">
      <table class="text-sm font-mono valign-mid" style="table-layout: fixed; width: 1080px">
        <colgroup>
          <col style="width: 64px">
          <col style="width: 196px">
          <col style="width: 80px">
          <col style="width: 200px">
          <col style="width: 440px">
          <col style="width: 100px">
        </colgroup>
        <thead>
          <tr class="text-steel border-b border-muted--30">
            <th></th>
            <th class="text-left py-1 px-2">Building</th>
            <th class="text-left py-1 px-2">Owned</th>
            <th class="text-left py-1 px-2">Effect</th>
            <th class="text-left py-1 px-2">Cost</th>
            <th class="text-center py-1 px-2">Buy</th>
          </tr>
        </thead>
        <tbody>${i.map((x,y)=>{const k=me(x),C=qa[x],I=D(n,x).toNumber(),_=co(x,I),A=cl(n,x,I),F=A?u("cyan"):c,E=_.map(j=>{const B=me(j.recipeId);return`<span class="inline-flex items-center gap-1">
          <img src="${B.icon}" alt="${B.name}" style="width: 40px; height: 40px;" class="object-contain">
          <span>${N(j.amount)}</span>
        </span>`}).join(" "),P=nl(C,I,m,h),V=Ms(`<img src="${k.icon}" alt="${k.name}" style="width: 48px; height: 48px;" class="object-contain">`,`<span class="text-cyan">${k.name}</span>`,sl[x]?[{label:sl[x]}]:void 0,k.name);return`<tr data-village-building-row="${x}" style="background-color: ${g[y%2]}">
        <td class="py-2 px-2 text-center">
          ${V.icon}
        </td>
        <td class="py-2 px-2">
          ${V.name}
        </td>
        <td class="text-left px-2 font-mono" data-village-owned="${x}">${te(I)}</td>
        <td class="text-left px-2 text-sm text-positive" data-village-effect="${x}">${P}</td>
        <td class="px-2">
          <span class="inline-flex items-center gap-2 font-mono text-sm" data-village-cost="${x}">${E}</span>
        </td>
        <td class="text-center px-2">
          <button data-action="buy-building" data-building="${x}" class="px-3 py-1 text-xs font-mono border ${F}" ${A?"":"disabled"}>Buy</button>
        </td>
      </tr>`}).join("")}</tbody>
      </table>
    </div>`;b+=Et("village-arcane-buildings","Arcane Buildings",w),b+='<div class="mb-4 flex items-center gap-2 text-sm font-mono">',b+='<span class="text-steel">Population:</span>',b+=`<span class="text-gold" data-village-available>${te(S)}</span>`,b+='<span class="text-muted">/</span>',b+=`<span class="text-text" data-village-population>${te(f)}</span>`,b+="</div>";const $=ir(n);if(p.length>0){const y=`<div class="mobile-scroll-x">
        <table class="text-sm font-mono valign-mid" style="table-layout: fixed; width: 1080px">
          <colgroup>
            <col style="width: 64px">
            <col style="width: 196px">
            <col style="width: 80px">
            <col style="width: 180px">
            <col style="width: 200px">
            <col style="width: 170px">
            <col style="width: 190px">
          </colgroup>
          <thead>
            <tr class="text-steel border-b border-muted--30">
              <th></th>
              <th class="text-left py-1 px-2">Wonder</th>
              <th class="text-left py-1 px-2">Owned</th>
              <th class="text-left py-1 px-2">Effect</th>
              <th class="text-left py-1 px-2">Workers</th>
              <th class="text-left py-1 px-2">Progress</th>
              <th class="text-left py-1 px-2">Cost</th>
            </tr>
          </thead>
          <tbody>${p.map((C,I)=>{var be;const _=me(C),A=ht[C];if(!A)return"";const F=D(n,C).toNumber(),E=o[C]||0,P=S>0,V=E>0,j=Math.pow(A.costEscalation,F),B=A.baseTicks*j,Z=((be=a.recipeCrafting[C])==null?void 0:be.progress)??0,oe=Math.floor(Z*B),U=Math.min(100,Z*100),O=il(A,F),K=A.tickCost.map(G=>{const L=me(G.recipeId),Y=G.amount;return`<span class="inline-flex items-center gap-1">
            <img src="${L.icon}" alt="${L.name}" style="width: 40px; height: 40px;" class="object-contain">
            <span>${N(new d(Y))}</span>
          </span>`}).join(" "),se=Ms(`<img src="${_.icon}" alt="${_.name}" style="width: 48px; height: 48px;" class="object-contain">`,`<span class="text-cyan">${_.name}</span>`,ol[C]?[{label:ol[C]}]:void 0,_.name);return`<tr data-wonder-row="${C}" style="background-color: ${g[I%2]}">
          <td class="py-2 px-2 text-center">
            ${se.icon}
          </td>
          <td class="py-2 px-2">
            ${se.name}
          </td>
          <td class="text-left px-2 font-mono" data-wonder-owned="${C}">${te(F)}</td>
          <td class="text-left px-2 text-sm text-positive" data-wonder-effect="${C}">${O}</td>
          <td class="px-2">
            <div class="flex items-center gap-1">
              <button data-action="wonder-remove10" data-wonder="${C}" class="${V?"text-red hover-text-white hover-bg-red--20":"text-muted"} font-mono text-sm font-bold border ${V?"border-text":"border-muted--30"} focus-outline-none relative${V?"":" cursor-not-allowed"}" style="width: 44px; height: 28px;" ${V?"":"disabled"}><span class="absolute inset-0 flex items-center justify-center">-10</span></button>
              <button data-action="wonder-remove" data-wonder="${C}" class="${V?"text-red hover-text-white hover-bg-red--20":"text-muted"} font-mono text-xl font-bold border ${V?"border-text":"border-muted--30"} focus-outline-none relative${V?"":" cursor-not-allowed"}" style="width: 28px; height: 28px;" ${V?"":"disabled"}><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;"></span></button>
              <span class="text-positive text-center font-mono text-sm" style="width: 34px;" data-wonder-workers="${C}">${te(E)}</span>
              <button data-action="wonder-add" data-wonder="${C}" class="${P?"text-positive hover-text-white hover-bg-positive--20":"text-muted"} font-mono text-xl font-bold border ${P?"border-text":"border-muted--30"} focus-outline-none relative${P?"":" cursor-not-allowed"}" style="width: 28px; height: 28px;" ${P?"":"disabled"}><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;">+</span></button>
              <button data-action="wonder-add10" data-wonder="${C}" class="${P?"text-positive hover-text-white hover-bg-positive--20":"text-muted"} font-mono text-sm font-bold border ${P?"border-text":"border-muted--30"} focus-outline-none relative${P?"":" cursor-not-allowed"}" style="width: 44px; height: 28px;" ${P?"":"disabled"}><span class="absolute inset-0 flex items-center justify-center">+10</span></button>
            </div>
          </td>
          <td class="px-2">
            <div class="w-full" style="min-width: 120px;">
              <div class="flex justify-between text-xs font-mono mb-0.5">
                <span class="text-muted" data-wonder-ticks="${C}">${N(new d(oe))} / ${N(new d(B))}</span>
              </div>
              <div class="h-2 border border-muted--30" style="background: transparent;">
                <div data-wonder-bar="${C}" class="h-full bg-cyan" style="width: ${U}%; transition: none;"></div>
              </div>
              <div class="text-xs font-mono text-muted mt-0.5" data-wonder-eta="${C}">${E>0?_r((B-oe)*A.secondsPerTick/(E*$)*1e3):""}</div>
            </div>
          </td>
          <td class="px-2">
            <span class="inline-flex items-center gap-2 font-mono text-xs text-muted" data-wonder-cost="${C}">${K}</span>
          </td>
        </tr>`}).join("")}</tbody>
        </table>
      </div>`;b+=Et("village-arcane-wonders","Arcane Wonders",y),t.dismissedTips.includes("wonder-ascension")||(b+=`
          <div data-tip="wonder-ascension" class="mb-4 flex items-center gap-2 text-sm">
            <button data-action="dismiss-tip" data-tip-id="wonder-ascension"
                    class="text-muted hover-text-positive cursor-pointer border-none bg-transparent"
                    title="Dismiss tip">&#x2714;</button>
            <span class="text-muted">Tip: arcane wonder progress and completions do not reset on ascension</span>
          </div>
        `)}if(l.length>0){const x=ir(n),y=Tt(t.globalTier),C=`<div class="mobile-scroll-x">
        <table class="text-sm font-mono valign-mid" style="table-layout: fixed; width: 1080px">
          <colgroup>
            <col style="width: 64px">
            <col style="width: 196px">
            <col style="width: 80px">
            <col style="width: 180px">
            <col style="width: 560px">
          </colgroup>
          <thead>
            <tr class="text-steel border-b border-muted--30">
              <th></th>
              <th class="text-left py-1 px-2">Equipment</th>
              <th class="text-left py-1 px-2">Owned</th>
              <th class="text-left py-1 px-2">Rate</th>
              <th class="text-left py-1 px-2">Workers</th>
            </tr>
          </thead>
          <tbody>${l.map((I,_)=>{const A=me(I),F=D(n,I).toNumber(),E=s[I]||0,P=S>0,V=E>0,j=E*x*y/A.craftTime,B=Ir[I],Z=[];ll[I]&&Z.push({label:ll[I]}),B&&(Z.push({label:`Reward: 1 + count / ${B.rewardDivisor}`}),Z.push({label:`Difficulty: 1 + count / ${B.difficultyDivisor}`}));const oe=Ms(`<img src="${A.icon}" alt="${A.name}" style="width: 48px; height: 48px;" class="object-contain">`,`<span class="text-cyan">${A.name}</span>`,Z.length>0?Z:void 0,A.name);return`<tr data-workshop-row="${I}" style="background-color: ${g[_%2]}">
          <td class="py-2 px-2 text-center">
            ${oe.icon}
          </td>
          <td class="py-2 px-2">
            ${oe.name}
          </td>
          <td class="text-left px-2 font-mono" data-workshop-owned="${I}">${te(F)}</td>
          <td class="text-left px-2 font-mono text-sm text-muted" data-workshop-rate="${I}">${j>0?`${j.toFixed(2)}/s`:""}</td>
          <td class="px-2">
            <div class="flex items-center gap-1">
              <button data-action="workshop-remove10" data-equip="${I}" class="${V?"text-red hover-text-white hover-bg-red--20":"text-muted"} font-mono text-sm font-bold border ${V?"border-text":"border-muted--30"} focus-outline-none relative${V?"":" cursor-not-allowed"}" style="width: 44px; height: 28px;" ${V?"":"disabled"}><span class="absolute inset-0 flex items-center justify-center">-10</span></button>
              <button data-action="workshop-remove" data-equip="${I}" class="${V?"text-red hover-text-white hover-bg-red--20":"text-muted"} font-mono text-xl font-bold border ${V?"border-text":"border-muted--30"} focus-outline-none relative${V?"":" cursor-not-allowed"}" style="width: 28px; height: 28px;" ${V?"":"disabled"}><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;"></span></button>
              <span class="text-positive text-center font-mono text-sm" style="width: 34px;" data-workshop-workers="${I}">${te(E)}</span>
              <button data-action="workshop-add" data-equip="${I}" class="${P?"text-positive hover-text-white hover-bg-positive--20":"text-muted"} font-mono text-xl font-bold border ${P?"border-text":"border-muted--30"} focus-outline-none relative${P?"":" cursor-not-allowed"}" style="width: 28px; height: 28px;" ${P?"":"disabled"}><span class="absolute inset-0 flex items-center justify-center" style="margin-top: -2px;">+</span></button>
              <button data-action="workshop-add10" data-equip="${I}" class="${P?"text-positive hover-text-white hover-bg-positive--20":"text-muted"} font-mono text-sm font-bold border ${P?"border-text":"border-muted--30"} focus-outline-none relative${P?"":" cursor-not-allowed"}" style="width: 44px; height: 28px;" ${P?"":"disabled"}><span class="absolute inset-0 flex items-center justify-center">+10</span></button>
            </div>
          </td>
        </tr>`}).join("")}</tbody>
        </table>
      </div>`;b+=Et("village-workshop","Workshop",C)}e.innerHTML=b,e.addEventListener("contextmenu",x=>x.preventDefault()),e.querySelectorAll('[data-action="buy-building"]').forEach(x=>{x.addEventListener("click",()=>{const y=x.getAttribute("data-building");M.getState().buyBuilding(y)})}),e.querySelectorAll('[data-action="workshop-add"]').forEach(x=>{x.addEventListener("click",()=>{const y=x.getAttribute("data-equip"),k=M.getState(),I=J(k).workshopAssignments[y]||0;k.setWorkshopAssignment(y,I+1)}),x.addEventListener("contextmenu",y=>{y.preventDefault();const k=x.getAttribute("data-equip"),C=M.getState(),I=J(C),_=Gt(I.ascension),A=C.globalTier>=5?ar:1,F=nr(I.recipeInventory,_,A),E=sr(I.workshopAssignments,I.wonderAssignments),P=Math.max(0,F-E),V=I.workshopAssignments[k]||0;C.setWorkshopAssignment(k,V+P)})}),e.querySelectorAll('[data-action="workshop-add10"]').forEach(x=>{x.addEventListener("click",()=>{const y=x.getAttribute("data-equip"),k=M.getState(),C=J(k),I=Gt(C.ascension),_=k.globalTier>=5?ar:1,A=nr(C.recipeInventory,I,_),F=sr(C.workshopAssignments,C.wonderAssignments),E=Math.max(0,A-F),P=C.workshopAssignments[y]||0;k.setWorkshopAssignment(y,P+Math.min(10,E))}),x.addEventListener("contextmenu",y=>{y.preventDefault();const k=x.getAttribute("data-equip"),C=M.getState(),I=J(C),_=Gt(I.ascension),A=C.globalTier>=5?ar:1,F=nr(I.recipeInventory,_,A),E=sr(I.workshopAssignments,I.wonderAssignments),P=Math.max(0,F-E),V=I.workshopAssignments[k]||0;C.setWorkshopAssignment(k,V+P)})}),e.querySelectorAll('[data-action="workshop-remove"]').forEach(x=>{x.addEventListener("click",()=>{const y=x.getAttribute("data-equip"),k=M.getState(),I=J(k).workshopAssignments[y]||0;k.setWorkshopAssignment(y,Math.max(0,I-1))}),x.addEventListener("contextmenu",y=>{y.preventDefault();const k=x.getAttribute("data-equip");M.getState().setWorkshopAssignment(k,0)})}),e.querySelectorAll('[data-action="workshop-remove10"]').forEach(x=>{x.addEventListener("click",()=>{const y=x.getAttribute("data-equip"),k=M.getState(),I=J(k).workshopAssignments[y]||0;k.setWorkshopAssignment(y,Math.max(0,I-10))}),x.addEventListener("contextmenu",y=>{y.preventDefault();const k=x.getAttribute("data-equip");M.getState().setWorkshopAssignment(k,0)})}),e.querySelectorAll('[data-action="wonder-add"]').forEach(x=>{x.addEventListener("click",()=>{const y=x.getAttribute("data-wonder"),k=M.getState(),I=J(k).wonderAssignments[y]||0;k.setWonderAssignment(y,I+1)}),x.addEventListener("contextmenu",y=>{y.preventDefault();const k=x.getAttribute("data-wonder"),C=M.getState(),I=J(C),_=Gt(I.ascension),A=C.globalTier>=5?ar:1,F=nr(I.recipeInventory,_,A),E=sr(I.workshopAssignments,I.wonderAssignments),P=Math.max(0,F-E),V=I.wonderAssignments[k]||0;C.setWonderAssignment(k,V+P)})}),e.querySelectorAll('[data-action="wonder-add10"]').forEach(x=>{x.addEventListener("click",()=>{const y=x.getAttribute("data-wonder"),k=M.getState(),C=J(k),I=Gt(C.ascension),_=k.globalTier>=5?ar:1,A=nr(C.recipeInventory,I,_),F=sr(C.workshopAssignments,C.wonderAssignments),E=Math.max(0,A-F),P=C.wonderAssignments[y]||0;k.setWonderAssignment(y,P+Math.min(10,E))}),x.addEventListener("contextmenu",y=>{y.preventDefault();const k=x.getAttribute("data-wonder"),C=M.getState(),I=J(C),_=Gt(I.ascension),A=C.globalTier>=5?ar:1,F=nr(I.recipeInventory,_,A),E=sr(I.workshopAssignments,I.wonderAssignments),P=Math.max(0,F-E),V=I.wonderAssignments[k]||0;C.setWonderAssignment(k,V+P)})}),e.querySelectorAll('[data-action="wonder-remove"]').forEach(x=>{x.addEventListener("click",()=>{const y=x.getAttribute("data-wonder"),k=M.getState(),I=J(k).wonderAssignments[y]||0;k.setWonderAssignment(y,Math.max(0,I-1))}),x.addEventListener("contextmenu",y=>{y.preventDefault();const k=x.getAttribute("data-wonder");M.getState().setWonderAssignment(k,0)})}),e.querySelectorAll('[data-action="wonder-remove10"]').forEach(x=>{x.addEventListener("click",()=>{const y=x.getAttribute("data-wonder"),k=M.getState(),I=J(k).wonderAssignments[y]||0;k.setWonderAssignment(y,Math.max(0,I-10))}),x.addEventListener("contextmenu",y=>{y.preventDefault();const k=x.getAttribute("data-wonder");M.getState().setWonderAssignment(k,0)})}),(R=e.querySelector('[data-action="dismiss-tip"]'))==null||R.addEventListener("click",x=>{var C;const y=x.currentTarget.getAttribute("data-tip-id"),k=M.getState();M.setState({dismissedTips:[...k.dismissedTips,y]}),(C=e.querySelector(`[data-tip="${y}"]`))==null||C.remove()})})(),()=>{var w;const t=M.getState(),a=J(t),{recipeInventory:n,workshopAssignments:s,wonderAssignments:o}=a,i=bi("realm3"),l=_n("realm3"),p=qn("realm3").filter($=>{const R=ht[$];return!(R!=null&&R.minGlobalTier)||t.globalTier>=R.minGlobalTier}),u=Gt(a.ascension),c=t.globalTier>=5?ar:1,g=nr(n,u,c),m=sr(s,o),h=Math.max(0,g-m),f=e.querySelector("[data-village-population]");f&&(f.textContent=te(g));const v=e.querySelector("[data-village-available]");v&&(v.textContent=te(h));const S=ir(n),b=Tt(t.globalTier);for(const $ of l){const R=me($),x=D(n,$).toNumber(),y=s[$]||0,k=y*S*b/R.craftTime,C=h>0,I=y>0,_=e.querySelector(`[data-workshop-owned="${$}"]`);_&&(_.textContent=te(x));const A=e.querySelector(`[data-workshop-workers="${$}"]`);A&&(A.textContent=te(y));const F=e.querySelector(`[data-workshop-rate="${$}"]`);F&&(F.textContent=k>0?`${k.toFixed(2)}/s`:"");const E=e.querySelector(`[data-action="workshop-add"][data-equip="${$}"]`);E&&(E.disabled=!C,E.className=`${C?"text-positive hover-text-white hover-bg-positive--20":"text-muted"} font-mono text-xl font-bold border ${C?"border-text":"border-muted--30"} focus-outline-none relative${C?"":" cursor-not-allowed"}`);const P=e.querySelector(`[data-action="workshop-add10"][data-equip="${$}"]`);P&&(P.disabled=!C,P.className=`${C?"text-positive hover-text-white hover-bg-positive--20":"text-muted"} font-mono text-sm font-bold border ${C?"border-text":"border-muted--30"} focus-outline-none relative${C?"":" cursor-not-allowed"}`);const V=e.querySelector(`[data-action="workshop-remove"][data-equip="${$}"]`);V&&(V.disabled=!I,V.className=`${I?"text-red hover-text-white hover-bg-red--20":"text-muted"} font-mono text-xl font-bold border ${I?"border-text":"border-muted--30"} focus-outline-none relative${I?"":" cursor-not-allowed"}`);const j=e.querySelector(`[data-action="workshop-remove10"][data-equip="${$}"]`);j&&(j.disabled=!I,j.className=`${I?"text-red hover-text-white hover-bg-red--20":"text-muted"} font-mono text-sm font-bold border ${I?"border-text":"border-muted--30"} focus-outline-none relative${I?"":" cursor-not-allowed"}`)}for(const $ of i){const R=D(n,$).toNumber(),x=co($,R),y=cl(n,$,R),k=e.querySelector(`[data-village-owned="${$}"]`);k&&(k.textContent=te(R));const C=e.querySelector(`[data-village-effect="${$}"]`);C&&(C.innerHTML=nl(qa[$],R,u,c));const I=e.querySelector(`[data-village-cost="${$}"]`);I&&(I.innerHTML=x.map(A=>{const F=me(A.recipeId);return`<span class="inline-flex items-center gap-1">
            <img src="${F.icon}" alt="${F.name}" style="width: 40px; height: 40px;" class="object-contain">
            <span>${N(A.amount)}</span>
          </span>`}).join(" "));const _=e.querySelector(`[data-action="buy-building"][data-building="${$}"]`);_&&(y?(_.disabled=!1,_.className="px-3 py-1 text-xs font-mono border border-cyan text-cyan hover-bg-cyan--20 cursor-pointer"):(_.disabled=!0,_.className="px-3 py-1 text-xs font-mono border border-muted--30 text-muted cursor-not-allowed"))}const T=ir(n);for(const $ of p){const R=ht[$];if(!R)continue;const x=D(n,$).toNumber(),y=o[$]||0,k=h>0,C=y>0,I=Math.pow(R.costEscalation,x),_=R.baseTicks*I,A=((w=a.recipeCrafting[$])==null?void 0:w.progress)??0,F=Math.floor(A*_),E=Math.min(100,A*100),P=e.querySelector(`[data-wonder-owned="${$}"]`);P&&(P.textContent=te(x));const V=e.querySelector(`[data-wonder-effect="${$}"]`);V&&(V.innerHTML=il(R,x));const j=e.querySelector(`[data-wonder-workers="${$}"]`);j&&(j.textContent=te(y));const B=e.querySelector(`[data-wonder-ticks="${$}"]`);B&&(B.textContent=`${N(new d(F))} / ${N(new d(_))}`);const Z=e.querySelector(`[data-wonder-bar="${$}"]`);Z&&(Z.style.width=`${E}%`);const oe=e.querySelector(`[data-wonder-eta="${$}"]`);oe&&(oe.textContent=y>0?_r((_-F)*R.secondsPerTick/(y*T)*1e3):"");const U=e.querySelector(`[data-wonder-cost="${$}"]`);U&&(U.innerHTML=R.tickCost.map(G=>{const L=me(G.recipeId),Y=G.amount;return`<span class="inline-flex items-center gap-1">
            <img src="${L.icon}" alt="${L.name}" style="width: 40px; height: 40px;" class="object-contain">
            <span>${N(new d(Y))}</span>
          </span>`}).join(" "));const O=e.querySelector(`[data-action="wonder-add"][data-wonder="${$}"]`);O&&(O.disabled=!k,O.className=`${k?"text-positive hover-text-white hover-bg-positive--20":"text-muted"} font-mono text-xl font-bold border ${k?"border-text":"border-muted--30"} focus-outline-none relative${k?"":" cursor-not-allowed"}`);const K=e.querySelector(`[data-action="wonder-add10"][data-wonder="${$}"]`);K&&(K.disabled=!k,K.className=`${k?"text-positive hover-text-white hover-bg-positive--20":"text-muted"} font-mono text-sm font-bold border ${k?"border-text":"border-muted--30"} focus-outline-none relative${k?"":" cursor-not-allowed"}`);const se=e.querySelector(`[data-action="wonder-remove"][data-wonder="${$}"]`);se&&(se.disabled=!C,se.className=`${C?"text-red hover-text-white hover-bg-red--20":"text-muted"} font-mono text-xl font-bold border ${C?"border-text":"border-muted--30"} focus-outline-none relative${C?"":" cursor-not-allowed"}`);const be=e.querySelector(`[data-action="wonder-remove10"][data-wonder="${$}"]`);be&&(be.disabled=!C,be.className=`${C?"text-red hover-text-white hover-bg-red--20":"text-muted"} font-mono text-sm font-bold border ${C?"border-text":"border-muted--30"} focus-outline-none relative${C?"":" cursor-not-allowed"}`)}}),Lc=Dt(Ee.Village,wg),Sg=Lc.render,Tg=Lc.cleanup,kg=e=>Math.sqrt(e/Za),ul=(e,r)=>{if(!r)return"Ascend (not enough pixies)";const t=kg(e);return`Ascend +${N(t,2)} <img src="icons/ascended souls.png" alt="" class="inline-icon">`},dl=e=>{const r=[{label:"Total pixies",value:N(e)},{label:"Formula",value:`floor(sqrt(pixies / ${N(Za)}))`}];let t='<div class="tooltip-title">Ascension Gain</div><div class="tooltip-divider"></div>';for(const a of r)t+=`<div class="tooltip-row"><span class="tooltip-label">${a.label}</span>`,a.value!==void 0&&(t+=`<span class="tooltip-value">${a.value}</span>`),t+="</div>";return t},$g=e=>{const r=bc(),t=()=>{const a=M.getState(),n=a.realms.realm3,{ascension:s}=n,o=In(s.lifetimePixies);let i=`
      <div data-ascension-layout style="display:flex;gap:24px;align-items:flex-start">
      <div style="flex:1;min-width:0">
      <div class="mb-4 flex items-center gap-4">
        <div class="flex items-center gap-1" data-asc-souls-indicator>
          <img src="icons/ascended souls.png" alt="" style="width:32px;height:32px">
          <span class="text-gold font-mono" data-asc-souls-count>${te(s.ascendedSouls)}</span>
        </div>
        <span class="hover-tooltip-wrapper" data-asc-tooltip-wrapper>
          <button
            data-asc-btn
            style="min-width:300px" class="px-8 py-3 text-sm font-mono border ${o?"text-yellow border-yellow hover-bg-yellow hover-text-black cursor-pointer":"text-muted border-muted"}"
            ${o?"":"disabled"}
          >
            ${ul(s.lifetimePixies,o)}
          </button>
          <div class="hover-tooltip" data-asc-tooltip>${dl(s.lifetimePixies)}</div>
        </span>
      </div>
      <div class="mobile-scroll-x"><table class="text-sm font-mono mb-6">
        <thead>
          <tr class="text-steel border-b border-muted--30">
            <th class="w-76 text-left">Ascended upgrades</th>
            <th class="w-24 text-left">Level</th>
            <th class="w-40 text-left">Cost</th>
            <th class="w-48 text-left">Effect</th>
            <th class="w-28"></th>
          </tr>
        </thead>
        <tbody>`;const l=a.ascensionCapBonus||0;for(const u of jr){const c=Ft(s,u.id),g=wn(u.id,l),m=c>=g,h=m?0:En(u.id,c),f=!m&&s.ascendedSouls>=h,v=m?1:s.ascendedSouls/Math.max(h,1),S=sa(m,f),b=[{label:u.description}];i+=`
        <tr data-asc-upgrade-row="${u.id}" class="${m?"text-muted--50":""}">
          <td data-asc-name="${u.id}" class="w-76 ${m?"line-through":"text-gold"}">
            <span class="inline-flex items-center gap-1.5">
              ${dt(b)}
              ${u.name}
            </span>
          </td>
          <td data-asc-level="${u.id}" class="w-24 text-steel">${c}/${g}</td>
          <td data-asc-cost="${u.id}" class="w-40">${m?"-":`<span class="${f?"text-text":"text-muted--50"}"><img src="icons/ascended souls.png" alt="" class="inline-icon"> ${te(h)}</span>`}</td>
          <td data-asc-effect="${u.id}" class="w-48">${m?`<span class="text-steel">${u.effectDescription(c)}</span>`:`<span class="text-steel">${u.effectDescription(c)}</span><span class="text-muted">  </span><span class="text-positive">${u.effectDescription(c+1)}</span>`}</td>
          <td class="w-28">
            <button
              data-asc-buy="${u.id}"
              ${m||!f?"disabled":""}
              class="relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${S}"
            >
              ${m?"":Yt(Math.min(1,v),`data-asc-progress="${u.id}"`)}
              <span data-asc-btn-text="${u.id}" class="relative z-10">${m?"MAX":"Buy"}</span>
            </button>
          </td>
        </tr>`}i+=`
        </tbody>
      </table></div>
      </div>
      <div style="width:450px;flex-shrink:0" class="border border-muted--30 p-4 px-6 font-mono text-sm">
        <div class="text-gold mb-3">About Ascension</div>
        <div class="text-steel mb-3">Ascension grants <img src="icons/ascended souls.png" alt="" class="inline-icon"> Ascended Souls which can be used to buy Ascended upgrades. <img src="icons/ascended souls.png" alt="" class="inline-icon"> gain is based on pixies produced this ascension. The formula is sqrt(pixies/100k)</div>
        <div class="text-red mb-1">Ascension resets:</div>
        <ul class="text-steel mb-3 ml-4" style="list-style:disc">
          <li>Arcane Souls</li>
          <li>Creatures</li>
          <li>Expedition equipment</li>
          <li>Expedition loot</li>
          <li>Arcane buildings</li>
        </ul>
        <div class="text-positive mb-1">Ascension does not reset:</div>
        <ul class="text-steel ml-4" style="list-style:disc">
          <li>Arcane Wonders</li>
          <li>Soulforges</li>
          <li>Forge Enhancers</li>
          <li>Ascended upgrades</li>
          <li>Anything outside Realm of Magic</li>
        </ul>
      </div>
      </div>`,e.innerHTML=i;const p=e.querySelector("[data-asc-btn]");p&&(p.onclick=()=>{M.getState().ascend()&&t()});for(const u of jr){const c=e.querySelector(`[data-asc-buy="${u.id}"]`);c&&(c.onclick=()=>{M.getState().purchaseAscensionUpgrade(u.id)})}};return t(),()=>{const a=M.getState(),n=a.realms.realm3,{ascension:s}=n,o=Xn(s.lifetimePixies),i=In(s.lifetimePixies),l=`${s.ascendedSouls}|${o}|${i}|${s.totalAscensions}|${s.lifetimePixies}|${JSON.stringify(s.upgrades)}`;if(!r(l))return;const p=a.ascensionCapBonus||0;let u=!1;for(const h of jr){const f=Ft(s,h.id),v=wn(h.id,p),S=e.querySelector(`[data-asc-level="${h.id}"]`);if(S&&S.textContent!==`${f}/${v}`){u=!0;break}}if(u){t();return}const c=e.querySelector("[data-asc-btn]");c&&(c.innerHTML=ul(s.lifetimePixies,i),c.disabled=!i,c.style.minWidth="300px",c.className=`px-8 py-3 text-sm font-mono border ${i?"text-yellow border-yellow hover-bg-yellow hover-text-black cursor-pointer":"text-muted border-muted"}`);const g=e.querySelector("[data-asc-tooltip]");g&&(g.innerHTML=dl(s.lifetimePixies));const m=e.querySelector("[data-asc-souls-count]");m&&(m.textContent=`${te(s.ascendedSouls)}`);for(const h of jr){const f=Ft(s,h.id),v=f>=wn(h.id,p),S=v?0:En(h.id,f),b=!v&&s.ascendedSouls>=S,T=v?1:Math.min(1,s.ascendedSouls/Math.max(S,1)),w=e.querySelector(`[data-asc-cost="${h.id}"]`);w&&(v?w.innerHTML="-":w.innerHTML=`<span class="${b?"text-text":"text-muted--50"}"><img src="icons/ascended souls.png" alt="" class="inline-icon"> ${te(S)}</span>`);const $=e.querySelector(`[data-asc-effect="${h.id}"]`);$&&(v?$.innerHTML=`<span class="text-steel">${h.effectDescription(f)}</span>`:$.innerHTML=`<span class="text-steel">${h.effectDescription(f)}</span><span class="text-muted">  </span><span class="text-positive">${h.effectDescription(f+1)}</span>`);const R=e.querySelector(`[data-asc-buy="${h.id}"]`);if(R){const x=sa(v,b);R.className=`relative w-full px-4 py-2 text-sm font-mono border overflow-hidden ${x}`,v||!b?R.setAttribute("disabled",""):R.removeAttribute("disabled");const y=e.querySelector(`[data-asc-btn-text="${h.id}"]`);y&&(y.textContent=v?"MAX":"Buy"),zt(e.querySelector(`[data-asc-progress="${h.id}"]`),T,v)}}}},Uc=Dt(Ee.Ascension,$g),Rg=Uc.render,Cg=Uc.cleanup,uo=e=>{const r=M.getState(),t=r.realms.realm4,a=r.realms.realm3.recipeInventory,n=ot(D(a,"soulcaster")),s=r.realms.realmU.recipeInventory,o=ot(D(s,"u_portal_knight")),i=xr.reduce((m,h)=>m+t.soulcasterAllocations[h],0),l=Math.max(0,n-i);let p="<div>";p+=`
    <div class="mb-6 px-4">
      <div class="text-sm text-steel">
        Soulcasters: <span data-camp-total-sc class="text-cyan">${te(n)}</span>
        &nbsp;|&nbsp; Allocated: <span data-camp-alloc-sc class="text-yellow">${te(i)}</span>
        &nbsp;|&nbsp; Available: <span data-camp-avail-sc class="text-lime">${te(l)}</span>
      </div>
    </div>`,p+='<h3 class="text-lg font-mono text-yellow mb-4 px-4">Universal Towers</h3>',p+=`<table class="text-sm" style="border-collapse: collapse; margin-left: 16px; border-spacing: 0;">
    <thead>
      <tr class="text-steel text-xs">
        <th class="text-left pb-2" style="padding-right: 20px;">Tower</th>
        <th class="text-center pb-2" style="padding-right: 20px;">Lv</th>
        <th class="text-left pb-2" style="padding-right: 50px;">Effect</th>
        <th class="text-left pb-2" style="padding-right: 20px; width: 220px;">Progress</th>
        <th class="text-left pb-2">Soulcasters</th>
      </tr>
    </thead>
    <tbody>`;for(const m of xr){const h=Wa[m],f=t.towerLevels[m],v=t.towerProgress[m],S=Hn(h,f),b=Math.min(1,v/S),T=hn(h,f),w=hn(h,f+1),$=t.soulcasterAllocations[m],R=x=>x<100?`x${x.toFixed(2)}`:`x${N(x)}`;p+=`
      <tr data-tower="${m}">
        <td style="padding-right: 20px; padding: 6px 20px 6px 0;">
          ${dt([{label:h.description}],h.name,`<div class="flex items-center gap-2 cursor-help">
              <img src="${h.icon}" alt="${h.name}" style="width: 40px; height: 40px;">
              <span class="text-gold font-mono">${h.name}</span>
            </div>`)}
        </td>
        <td class="text-steel text-center" style="padding: 6px 20px 6px 0;"><span data-tower-level="${m}">${f}</span></td>
        <td style="padding: 6px 50px 6px 0;" data-tower-effect="${m}"><span class="text-cyan">${R(T)}</span> <span class="text-steel"></span> <span class="text-yellow">${R(w)}</span></td>
        <td style="padding: 6px 20px 6px 0; width: 220px;">
          <div class="craft-progress-bg" style="height: 10px;">
            <div class="h-full craft-progress-fill" data-tower-bar="${m}" style="width: ${(b*100).toFixed(2)}%"></div>
          </div>
          <div class="text-xs text-steel">
            <span data-tower-progress="${m}">${N(v,0)}</span>/<span data-tower-cost="${m}">${N(S)}</span>${$>0?`<span class="text-lime" data-tower-rate="${m}"> +${$*$}/s</span>`:`<span data-tower-rate="${m}"></span>`}
          </div>
        </td>
        <td style="padding: 6px 0;">
          <div class="flex items-center gap-2">
            <button data-tower-minus="${m}" class="px-2 py-0.5 text-sm font-mono border border-steel text-steel hover-bg-steel hover-text-black cursor-pointer"></button>
            <span data-tower-alloc="${m}" class="text-yellow w-12 text-center">${$}</span>
            <button data-tower-plus="${m}" class="px-2 py-0.5 text-sm font-mono border border-steel text-steel hover-bg-steel hover-text-black cursor-pointer">+</button>
          </div>
        </td>
      </tr>`}p+="</tbody></table>",p+='<h3 class="text-lg font-mono text-yellow mb-4 mt-8 px-4">Heroic Trials</h3>',p+='<table class="text-xs ml-4" style="border-collapse: collapse"><tbody>';for(const m of Ia){const h=t.heroicTrialCompleted>m.index,f=t.heroicTrialCompleted===m.index;if(!h&&!f||m.requiredTier&&r.globalTier<m.requiredTier)continue;const v=f&&o>=m.cost,S=v||h?"text-cyan":"text-muted--50";p+=`
      <tr data-trial="${m.index}">
        <td class="py-2 pr-3 text-steel">${m.rewardDescription}</td>
        <td class="py-2 px-3 ${S}" style="white-space: nowrap"><span style="display: inline-flex; align-items: center; gap: 4px"><img src="${fp}" width="16" height="16" style="image-rendering: pixelated">${te(m.cost)}</span></td>
        <td class="py-2 pl-3" style="white-space: nowrap">${h?'<span data-trial-status="'+m.index+'" class="text-xs text-lime">Completed</span>':`<button data-trial-btn="${m.index}" class="px-3 py-1 text-xs font-mono border ${v?"border-yellow text-yellow hover-bg-yellow hover-text-black cursor-pointer":"border-muted text-muted"}" ${v?"":"disabled"}>Complete</button>`}</td>
      </tr>`}p+="</tbody></table>",p+="</div>",e.innerHTML=p;const u=m=>{const h=m.target;for(const f of xr){const v=h.closest(`[data-tower-minus="${f}"]`),S=h.closest(`[data-tower-plus="${f}"]`);if(v||S){const b=M.getState(),T=b.realms.realm4.soulcasterAllocations[f],w=b.realms.realm3.recipeInventory,$=ot(D(w,"soulcaster")),R=f==="gem_tower"?"military_tower":"gem_tower",x=b.realms.realm4.soulcasterAllocations[R],y=Math.max(0,$-x);v?m.button===2||m.type==="contextmenu"?M.getState().setSoulcasterAllocation(f,0):M.getState().setSoulcasterAllocation(f,Math.max(0,T-1)):S&&(m.button===2||m.type==="contextmenu"?M.getState().setSoulcasterAllocation(f,y):M.getState().setSoulcasterAllocation(f,Math.min(y,T+1)));return}}for(const f of Ia)if(h.closest(`[data-trial-btn="${f.index}"]`)){M.getState().completeHeroicTrial(),g();return}},c=m=>{const h=m.target;for(const f of xr)if(h.closest(`[data-tower-minus="${f}"]`)||h.closest(`[data-tower-plus="${f}"]`)){m.preventDefault(),u(m);return}};e.addEventListener("click",u),e.addEventListener("contextmenu",c);const g=()=>{e.removeEventListener("click",u),e.removeEventListener("contextmenu",c),uo(e)};return()=>{const m=M.getState(),h=m.realms.realm4,f=m.realms.realm3.recipeInventory,v=ot(D(f,"soulcaster")),S=xr.reduce((y,k)=>y+h.soulcasterAllocations[k],0),b=Math.max(0,v-S),T=e.querySelector("[data-camp-total-sc]");T&&(T.textContent=te(v));const w=e.querySelector("[data-camp-alloc-sc]");w&&(w.textContent=te(S));const $=e.querySelector("[data-camp-avail-sc]");$&&($.textContent=te(b));for(const y of xr){const k=Wa[y],C=h.towerLevels[y],I=h.towerProgress[y],_=Hn(k,C),A=Math.min(1,I/_),F=hn(k,C),E=h.soulcasterAllocations[y],P=se=>se<100?`x${se.toFixed(2)}`:`x${N(se)}`,V=hn(k,C+1),j=e.querySelector(`[data-tower-level="${y}"]`);j&&(j.textContent=`${C}`);const B=e.querySelector(`[data-tower-effect="${y}"]`);B&&(B.innerHTML=`<span class="text-cyan">${P(F)}</span> <span class="text-steel"></span> <span class="text-yellow">${P(V)}</span>`);const Z=e.querySelector(`[data-tower-bar="${y}"]`);Z&&(Z.style.width=`${(A*100).toFixed(2)}%`);const oe=e.querySelector(`[data-tower-progress="${y}"]`);oe&&(oe.textContent=N(I,0));const U=e.querySelector(`[data-tower-cost="${y}"]`);U&&(U.textContent=N(_));const O=e.querySelector(`[data-tower-rate="${y}"]`);O&&(O.textContent=E>0?` +${E*E}/s`:""),O&&(O.className=E>0?"text-lime":"");const K=e.querySelector(`[data-tower-alloc="${y}"]`);K&&(K.textContent=`${E}`)}const R=m.realms.realmU.recipeInventory,x=ot(D(R,"u_portal_knight"));for(const y of Ia){const k=h.heroicTrialCompleted>y.index,C=h.heroicTrialCompleted===y.index,I=C&&x>=y.cost,_=e.querySelector(`[data-trial-status="${y.index}"]`);if(_){const F=k?"Completed":C?"Available":"Locked",E=k?"text-lime":C?I?"text-yellow":"text-steel":"text-muted--50";_.textContent=F,_.className=`text-xs ${E}`}const A=e.querySelector(`[data-trial-btn="${y.index}"]`);if(A&&(A.disabled=!I,A.className=`px-3 py-1 text-xs font-mono border ${I?"border-yellow text-yellow hover-bg-yellow hover-text-black cursor-pointer":"border-muted text-muted"}`),k&&e.querySelector(`[data-trial-btn="${y.index}"]`)){e.removeEventListener("click",u),e.removeEventListener("contextmenu",c),uo(e);return}}}},Pc=Dt(Ee.Camp,uo),Mg=Pc.render,Ig=Pc.cleanup,Eg={0:0,1:100,2:200,3:300},Ag=e=>Eg[Math.min(e,3)]??0,Fc=e=>{var s,o;const r=Ag(e),t=document.createElement("div");t.className="fixed inset-0 bg-black--90 flex items-center justify-center z-50";const a=r>0?`
      <p class="text-text mb-2">
        Based on your previous progress (Tier ${e}), you are eligible for
        <span class="text-yellow font-bold">${r} Time Warp charges</span>.
      </p>
      <p class="text-steel mb-4" style="font-size: 13px;">
        Each charge skips 5 minutes of game time, helping you get back to where you were faster.
        You can use them from the tab bar at any time.
      </p>
      <div class="flex gap-4 justify-center">
        <button data-action="accept" class="px-6 py-2 border-2 border-yellow text-yellow hover-bg-yellow hover-text-black font-mono cursor-pointer">
          Accept ${r} Charges
        </button>
        <button data-action="decline" class="px-6 py-2 border-2 border-steel text-steel hover-bg-steel hover-text-black font-mono cursor-pointer">
          No Thanks
        </button>
      </div>
    `:`
      <button data-action="decline" class="px-6 py-2 border-2 border-steel text-steel hover-bg-steel hover-text-black font-mono cursor-pointer">
        OK
      </button>
    `,n=r>0?`<p class="text-text mb-4">
        To help you get back to where you were, a <span class="text-yellow font-bold">Time Warp</span> feature is available.
        Time Warp charges let you fast-forward through the early game.
      </p>`:"";t.innerHTML=`
    <div class="bg-black border-2 border-red p-6 max-w-lg text-center">
      <h2 class="text-xl text-red font-bold mb-4">v${Xs()}  Incompatible Save</h2>
      <p class="text-text mb-4">
        Version ${Xs()} is incompatible with previous versions and your progress has been reset. Sorry about that!
      </p>
      ${n}
      ${a}
    </div>
  `,document.body.appendChild(t),(s=t.querySelector('[data-action="accept"]'))==null||s.addEventListener("click",()=>{M.setState({timeWarpCharges:r}),t.remove(),Ai()}),(o=t.querySelector('[data-action="decline"]'))==null||o.addEventListener("click",()=>{t.remove(),Ai()})},Oc="evercraft-hotkeys",ml={tabLeft:{label:"Cycle Tab Left",key:"a"},tabRight:{label:"Cycle Tab Right",key:"d"},swapRealm:{label:"Swap Realm",key:"q"}};let za=_g();function _g(){var e;try{const r=localStorage.getItem(Oc);if(r){const t=JSON.parse(r),a={...ml};for(const n of Object.keys(a))(e=t[n])!=null&&e.key&&(a[n]={...a[n],key:t[n].key});return a}}catch{}return{...ml}}function qg(){const e={};for(const[r,t]of Object.entries(za))e[r]={key:t.key};localStorage.setItem(Oc,JSON.stringify(e))}const Ng=()=>za,Lg=(e,r)=>{za[e]={...za[e],key:r},qg()},Ug=e=>{const r=e.toLowerCase();for(const[t,a]of Object.entries(za))if(a.key.toLowerCase()===r)return t;return null},Pg=["tabLeft","tabRight","swapRealm"],Fg=e=>e===" "?"Space":e.length===1?e.toUpperCase():e,Og=JSON.parse(`[{"version":"1.29","changes":["All: Artifacts - added description tooltips to all artifact names","RU: Artifacts - clarified Breeding Artifact description","T4+: R3 Combat - expedition card rewards now correctly show tier bonus for arcane bars and logs"]},{"version":"1.28","changes":["T4+: Inventory - shard, nullstone, and mythic fragment income rates now reflect tier bonus","T5: Combat - expedition shard/nullstone/mythic fragment rewards now correctly use x20 instead of x5","All: Prestige - clarified that prestige resets on tiers 4+","T4+: R3 - tier bonus now applies to arcane bar and log expedition rewards","T4+: R3 - tier bonus now applies to workshop equipment production"]},{"version":"1.27","changes":["All: Altar - clarified that altar bonuses reset on T4+ but not before","R4: Camp - heroic trials 4-6 now correctly require T4 reset before appearing","RU: Prestige - fixed auto-prestige-all incorrectly prestiging Portal Knight"]},{"version":"1.26","changes":["R3: Crafting - removed outdated 'coming soon' label from Soulcaster description","R3: Creatures - fixed breeding artifact not showing in creature production tooltip","R4: Camp - tower tooltips now use custom instant tooltips instead of browser defaults"]},{"version":"1.25","changes":["R3: Creatures - fixed soul priority not blocking lower creatures when an intermediate tier is soul-bottlenecked"]},{"version":"1.24","changes":["Combat - fixed captain buff formula so 1 captain is stronger than 0","R3: Combat - added equipment tooltip showing reward and difficulty formulas","Research - added time-to-afford tooltip on research upgrade buttons","Crafting - added time-to-afford tooltip on buy crafter button","Altar - sacrifice groups are now collapsible","R3: Creatures - added buy-until limits for creature auto-buy (stop when next tier reaches threshold)","R3: Creatures - added soul priority for creature auto-buy (pauses lower tiers when higher tier needs souls)"]},{"version":"1.23","changes":["Added Realm of Earth","Added Tiers 4 and 5","Improved RU automation","Added repeat option for heroic expeditions (scales units until you can't afford)"]},{"version":"1.22","changes":["RU: Village - Enchanting Tower now applies gem production multiplier to Unified Realm"]},{"version":"1.21","changes":["R3: Village - dwelling effect now reflects Bigger Dwelling ascension upgrade","All: Research - hide maxed upgrades checkbox now persists across tab switches and reloads"]},{"version":"1.20","changes":["R3: Village - reverted arcane wonder tick speed change (back to 3s per tick, fewer ticks)","R3: Ascension - fixed formula display consistency in explanation box","All: Altar - fixed sacrificed count not respecting scientific notation setting","All: Research - added tooltips to flask/sword cost icons for colorblind accessibility"]},{"version":"1.19","changes":["RU: Combat - Portal Knight no longer appears in expedition setup","R2: Crafting - fixed Forge Enhancer description to match actual effect","All: Inventory - removed parentheses from income rates","All: Altar - fixed item count formatting to match inventory","R3: Village - arcane wonders now tick 3x faster with 3x more ticks required (total build time unchanged)","R3: Ascension - ascend button now shows 2 decimal places","R3: Ascension - added tooltip to ascend button showing total pixies and gain formula"]},{"version":"1.18","changes":["Settings: Color Theme - added preset themes (Default, Dark theme by DearHoney), reorganized controls above color list","All: Prestige - added time-to-afford tooltip on prestige buttons","All: Artifacts - added time-to-afford tooltip on forge buttons"]},{"version":"1.17","changes":["R3: Village - added -10 button for Workshop and Arcane Wonder worker assignment","Settings: Color Theme - fixed misleading color descriptions to accurately reflect what each color changes","Settings: Color Theme - fixed reset buttons losing scroll position, removed unused Dimmed surface option","R3: Combat - Speed Pylon now also speeds up expedition duration"]},{"version":"1.16","changes":["Tier2: Tier - fixed T2 reset crashing the game and failing to apply"]},{"version":"1.15","changes":["R4: Main - fixed page refresh showing Main tab instead of Camp tab","Unified: Inventory - fixed mythic fragment rate not accounting for altar sacrifice consumption","Settings: Discord - removed noreferrer from Discord link to avoid Firefox COOP warning"]},{"version":"1.14","changes":["Tier3: Realm - Realm of Earth portal is now visible (content coming soon)","Unified: Combat - fixed mythic fragment rewards not showing in expedition log"]},{"version":"1.13","changes":["Combat - Fixed 'Repeat until victory' not working for heroic expeditions","R3: Village/Inventory - equipment production rates now show 2 decimal places for accurate expedition planning"]},{"version":"1.12","changes":["Settings: Display - Color Theme descriptions now explain what each color controls"]},{"version":"1.11","changes":["Settings: Display - Color Theme now correctly affects all UI elements"]},{"version":"1.10","changes":["Settings: Display - added Color Theme customization with export/import support","Tier3: Unification was wrongly granting initial sacrifice amounts over 20k","All: Altar - fixed floating point display in sacrifice batch size"]},{"version":"1.09","changes":["RU: Crafting - Portal Knight is now hidden until the portal has been built","R3: Village - right-click +10 buttons to assign all available workers","RU: Altar - removed Portal Knight from sacrifice items","RU: Prestige - removed Portal Knight from prestige recipes","RU: Altar - added Mythic Fragment sacrifice","RU: Prestige - added Mythic Fragment prestige","RU: Combat - Mythic Fragment drops now benefit from prestige and sacrifice multipliers","RU: Combat - fixed expeditions tab re-rendering every frame when heroic expeditions are maxed","R3: Inventory - fixed equipment rate display not accounting for worker speed multiplier"]},{"version":"1.08","changes":["R3: Village - fixed offline progress for arcane wonders not accounting for expedition rewards earned during offline period"]},{"version":"1.07","changes":["Mobile: R3 Creatures - responsive 2-row layout with smaller icons, no more horizontal scrolling"]},{"version":"1.06","changes":["Mobile: Crafting - responsive 2-row layout, no more horizontal scrolling to assign crafters","Mobile: Crafting - added ++ and  buttons to assign/unassign all crafters (replaces right-click)"]},{"version":"1.05","changes":["Mobile: Combat - improved expedition layout, cards now fit 2 per row, setup modal no longer overflows"]},{"version":"1.04","changes":["Settings: Display - added scientific notation threshold slider"]},{"version":"1.03","changes":["R3: Ascension - fixed layout overlap on mobile preventing Ascend button from being tapped"]},{"version":"1.02","changes":["Combat - removed 10% minimum success rate requirement to start expeditions","Combat - added repeat until victory option for heroic expeditions"]},{"version":"1.01","changes":["Settings - import now shows a success message"]},{"version":"1.00","changes":["Tier3: Research - consolidated knight strength into one upgrade in Unified Realm","Tier3: Tier - added Tier 3 reset","Crafting - buying a crafter now buys max crafters","Tier3: Crafting - added T8 Captain unit to Unified Realm","Tier3: Combat - T8 Captain now only buffs strength units, not beacons or boats","Tier3: Combat - T8 Captain buff changed from sqrt to diminishing returns (0.85 exponent)","Tier3: Combat - removed nullstone and nullstone expeditions","Tier3: Combat - added Shard 2 and Shard 3 expeditions","Tier3: Crafting - forge enhancer removed; soulforge arcane soul production now scales with count","Tier3: Combat - added Mythic Fragment expedition","Tier3: Artifacts - added Mythic artifact category with Army Banner","Tier3: Combat - added Heroic Creatures expedition","Tier3: Ascension - increased ascension upgrade caps","R3: Village - added Speed Pylon arcane wonder","Tier3: Artifacts - ring and combat artifact upgrades capped at 40","Artifacts - level display now shows current/max format","Tier3: Tier - T3 reset force-ascends Realm of Magic","Research - tab highlight no longer counts auto-buy upgrades as affordable","Combat - expedition log filter now only shows completed expeditions","Tier3: Research - added Altar Sacrifice Multi research","Combat - added Restart button to expedition setup dialog for quick iteration","Tier3: Combat - added Portal heroic expedition to Unified Realm","R3: Crafting - added Soulcaster, crafted from Luminaries for the upcoming Realm of Earth","Tier3: Realm - added Realm of Earth portal unlock with requirements","Tier3: Crafting - added Portal Knight unit to Unified Realm for the Realm of Earth"]},{"version":"0.96","changes":["Added Discord link to nav bar","Fixed large numbers (1e100+) displaying incorrectly (e.g., 1e103 showing as 1e100)"]},{"version":"0.95","changes":["R3 expedition unlocks now persist through ascension"]},{"version":"0.94","changes":["Fixed mana value and rate overlapping in inventory when both exceed 1e100"]},{"version":"0.93","changes":["Fixed expedition +10%/100% buttons not accounting for Knight Strength upgrades"]},{"version":"0.92","changes":["Added hint on Realm tab explaining how to obtain a Soulforge for the Realm of Magic portal"]},{"version":"0.91","changes":["Fixed large numbers (1e100+) displaying incorrectly (e.g. crafter costs showing same value after purchase)","Fixed game hanging when assigning units in expedition modal with very large unit counts","Fixed worker count overflowing in Village tab when population reaches 3 digits"]},{"version":"0.90","changes":["Expedition dialog now hides units and equipment you don't have any of"]},{"version":"0.89","changes":["Fixed inconsistent icon ordering for Arcane Bar/Log costs in Realm of Magic buildings and wonders"]},{"version":"0.88","changes":["Realm of Magic: added Enchanting Tower (wonder) and Arcane Well (building)","Fixed crafting tooltips being clipped on mobile when the collapsible section is short","Realm of Magic: rebalanced ascension upgrades","Realm of Magic: added heroic expeditions  Soul Mastery (arcane soul production), Creature Mastery (creature production), and Realm Mastery (R1+R2 gem production)","Fixed Realm of Magic Heroic bonus not showing as a separate row in R1/R2 gem tooltips"]},{"version":"0.87","changes":["Renamed \\"Sword Efficiency\\" research upgrades to \\"Cheaper Swords\\" for consistency with other cost-reduction upgrades","Fixed T7 Knight icon not being orange","Fixed export save notification causing screen flash when it expires while on another tab","Artifacts tab: Active Bonuses now shows as a compact horizontal strip on mobile instead of taking up the full screen"]},{"version":"0.86","changes":["Fixed expeditions with cross-realm swords not looping correctly","Fixed R2 inventory not showing consumption rate for swords used in R1 expeditions"]},{"version":"0.85","changes":["Fixed cross-realm swords not being consumed when expeditions repeat in loop mode"]},{"version":"0.84","changes":["Shard 4 reward increased x5 (200K  1M shards)","Fixed expedition reward icons and log not including prestige and sacrifice multipliers for shards and nullstone"]},{"version":"0.83","changes":["Added clickable Auto header to toggle all automations on Prestige and Research tabs","Auto header shows dynamic checkmark reflecting current toggle state","Added dismissible tips explaining the Auto toggle-all feature"]},{"version":"0.82","changes":["Fixed R3 expedition modal overstating arcane rewards when beacon assigned","Fixed equipment bonuses being lost to rounding on low base rewards","Fixed equipment tooltip showing wrong exponent (0.8 instead of 0.6)"]},{"version":"0.81","changes":["Reverted beacon and R3 equipment to increase expedition difficulty again","R3 equipment reward bonus tripled","Renamed R1 shard expeditions to Shard 1-4, removed Shard 5","Reverted Shard 1-3 difficulty and rewards to pre-0.80 values","Added Shard 4: difficulty 100M, 6M shard reward"]},{"version":"0.80","changes":["Beacons no longer increase expedition difficulty; beacon reward bonus reduced by 3x","R3 equipment no longer increases expedition difficulty; equipment reward bonus reduced by 3x"]},{"version":"0.79","changes":["Fixed R3 expedition equipment not persisting across save/reload (also affected repeat expeditions after reload)"]},{"version":"0.78","changes":["Fixed R3 expedition log not showing equipment-boosted rewards for arcane bars and logs"]},{"version":"0.77","changes":["Village tab now stays unlocked permanently once expedition loot is obtained (no longer disappears after ascension)","Arcane Wonders and Workshop sections now stay visible after ascension","R3 creature cycle time display now reflects Production Speed ascension upgrade","Ascension tab now formats large numbers (ascended souls, costs, gains)","Fixed R3 creature \\"Produces\\" column not reflecting Arcane Sanctum multiplier","Fixed Arcane Sanctum cost per tick incorrectly scaling with level (only tick count should increase)","Fixed Arcane Wonder workers staying assigned after ascension despite population resetting to 0","Fixed expedition reward rates not accounting for equipment multiplier in Combat tab and Inventory panel"]},{"version":"0.76","changes":["Reduced icon file sizes for faster loading"]},{"version":"0.75","changes":["Capped game loop at 60fps on high refresh rate monitors"]},{"version":"0.74","changes":["Fixed ascension upgrade buy buttons becoming unclickable after purchasing an upgrade"]},{"version":"0.73","changes":["Hidden Altar and Artifacts tabs in Realm of Magic","Added 3 new creatures: Mana Wisp, Anima Core, Luminary  each produces the previous creature tier","Added Workshop: assign population to craft Pickaxes and Axes for expeditions","Added Arcane Wonders: build Arcane Sanctum (x2 creature production per level) using population workers and expedition loot","Added Mine IV/V and Forest IV/V expeditions with equipment multipliers","Equipment (Pickaxes, Axes) increases both expedition rewards and difficulty","Added Forge Enhancer: crafted in Realm of War from 1B T8 gems, multiplies arcane soul production by 1 + count","Added Ascension prestige system: reset creatures, equipment, and village to earn Ascended Souls","Ascension upgrades: Arcane Soul Production, Production Speed, Pixie Strength, T8 Gem Production (cross-realm), Bigger Dwelling","Arcane Dwelling cost reduced (1000  100 souls, x3  x1.7 scaling)","Mine/Forest II-III expedition difficulty and rewards rebalanced"]},{"version":"0.72","changes":["UI scale minimum lowered from 80% to 50%"]},{"version":"0.71","changes":["Fixed Upgrades tab highlight not appearing when research upgrades are affordable"]},{"version":"0.70","changes":["Added Realm of Magic. See requirements in the realm tab. Realm of Magic is partially done, more content coming soon."]},{"version":"0.69","changes":["Boats (speed units) can now be used in heroic expeditions to reduce duration","Fixed expedition card income rate not being formatted for large numbers"]},{"version":"0.68","changes":["Tweaked inventory panel alignment"]},{"version":"0.67","changes":["Fixed combat tab message to say \\"expedition units\\" instead of \\"military unit\\"","Altar tab hidden until first tier reset; Artifacts tab hidden until an expedition unit has been crafted","Added dismissable tip under crafters about right-click to assign/unassign all"]},{"version":"0.66","changes":["Mobile browser support: responsive layout, collapsible inventory sidebar, horizontally scrollable tables and crafting grids, smaller fonts and spacing on small screens"]},{"version":"0.65","changes":["Expedition dialog: replaced unit assignment buttons with role-specific controls  Army gets +10% and 100% success rate buttons, Fleet/Beacons get three scaled static-amount buttons"]},{"version":"0.64","changes":["Added favicon (T1 gem icon)","Altar of Sacrifice: removed extra border wrapper, moved section labels into table headers"]},{"version":"0.63","changes":["Prepared realm tab to support R3","Fixed realm portal button shrinking on narrow browsers","Removed title header from nav bar to give tabs more space","New display setting: Tab Highlighting toggle  disables glow and count indicators on tabs"]},{"version":"0.62","changes":["Reduced R2 sword gem cost scaling from x10 to x4 per tier for T4+ (T1-T3 unchanged)","New R2 research upgrades: T4/T5/T6 Sword Efficiency  reduces sword input costs by 12% per level (max 8 levels, costs flasks + swords)"]},{"version":"0.61","changes":["Auto-Prestige unlocked at T2: checkbox next to each prestige button to automatically prestige when affordable. Click \\"Auto\\" column header to toggle all in a category.","Heroic expedition setup is now automatically cleared when the expedition finishes","New Realm 2 expedition: T5-T6 Quest (difficulty 2M)  grants scaling output bonus to T5 and T6 recipes"]},{"version":"0.60","changes":["Reduced T1 Knight Strength research base cost from 50k to 1k flasks","Expedition unit tooltips now show on icon hover and explain how stats affect success rate, duration, and rewards","Expeditions now consume all assigned units on success (previously half were returned)"]},{"version":"0.59","changes":["Prestige now subtracts the requirement cost instead of resetting the recipe to 0","Pause state now persists across refresh  no offline time is processed for a paused game","Expedition modal: unit icons now have hover tooltips showing role description and strength formula"]},{"version":"0.58","changes":["New artifact: Combat Artifact (x1.1 combat strength per level, max 100, 50 shard base cost)","New artifact: Crafting Speed (+5% crafting speed per level, max 40, 200 shard base cost)","Fix: Expeditions 3 and 4 no longer reset to locked on page refresh"]},{"version":"0.57","changes":["Removed Cave Exploration expedition; remaining expeditions renumbered","Expedition unlock requirement reduced from 20 to 5 completions","Expedition difficulty reduced: Mountain Pass, Ancient Ruins, Wraith Stronghold","Beacons now increase rewards by twice as much as difficulty (was equal), and beacon effect strengthened 5x","Knight strength exponent increased from 0.7 to 0.8","Prestige tab: explanation section is now collapsible, collapse state persists across saves"]},{"version":"0.56","changes":["Prestige tab: added mechanics explanation, split bonus column into separate Recipe and Total columns"]},{"version":"0.55","changes":["Reduced base cost of knight strength research from 1M to 50K flasks","Fixed inventory panel scrollbar not flush with right border"]},{"version":"0.54","changes":["Crafter's Guild bonus now caps at 30 crafters (the 31st+ crafter no longer increases the bonus)"]},{"version":"0.53","changes":["Crafting tab now always shows per-craft amounts, with per-second rate in parentheses when crafters are assigned","Fixed Altar tab in Realm of War showing Nullstone and Artifact Shard sacrifice options (these are only earnable in Realm 1)"]},{"version":"0.52","changes":["Fixed tooltips getting clipped when near the bottom of the screen"]},{"version":"0.51","changes":["Fixed collapsible sections breaking the page when collapsed"]},{"version":"0.50","changes":["Mountain Pass expedition rebalanced: difficulty 50k10k, duration 3h1h, shards 400150"]},{"version":"0.49","changes":["Tier tab warning now guides players to advance through expeditions when Realm of War is not yet unlocked","Recipe output rate now displays in green when crafters are actively producing","Renamed Upgrades tab to Research","Fixed research upgrades table showing blank Level, Cost, and Effect columns","Added \\"Hide maxed upgrades\\" checkbox to Research tab (on by default)"]},{"version":"0.48","changes":["R1 military unlock thresholds now scale per unit (x100 craft cost) instead of flat 100k","Buffed all ring artifact upgrade bonuses from x1.3 to x1.35 per level","Reduced T2 ring shard cost from 100 to 50 and T3 ring shard cost from 1000 to 500","Forest Patrol expedition difficulty reduced from 10 to 5 and duration from 2m to 1m"]},{"version":"0.47","changes":["Reduced T1 tier reset mana requirement from 1e21 to 1e20"]},{"version":"0.46","changes":["New research upgrade: Cheaper Gems  reduces gem input costs by 5% per level (10 levels)","New research upgrade: Cheaper Expedition Units  reduces military input costs by 5% per level (10 levels)","New research upgrade: Cheaper Flasks  reduces flask input costs by 5% per level (10 levels)","Buffed T4T8 gem mana multipliers (T4: x1.6x3, T5: x2x4, T6: x2.4x5, T7: x3x10, T8: x5x20)"]},{"version":"0.45","changes":["Mana tooltip now shows cleaner format: \\"605 T2 gems  x605 multiplier\\"","R1 military unlock thresholds increased to 100k lifetime gems","R1 boat and beacon gem crafting costs increased"]},{"version":"0.44","changes":["Knight strength upgrades are now hidden until the corresponding knight has been produced","Expedition unit unlock conditions increased (more lifetime gems required)"]},{"version":"0.43","changes":["T2 global military changed: only Realm of War T4+ Swords are usable cross-realm (previously all units were global)","Gem Manufacturing research upgrade rebalanced: 16 levels with alternating 10/50 flask costs climbing through tiers"]},{"version":"0.42","changes":["Fix: Inventory panel nullstone/shard rates now include prestige and sacrifice bonus multipliers","Fix: Expedition rewards/s now factors in success rate instead of assuming 100%","New military unit: T7 Knight (Realm 1)","Auto-buy checkboxes on upgrades tab are now hidden before Tier 1","R1 Military Strength upgrade split into 3 per-knight upgrades (T1/T4/T7). Existing levels migrate to all three."]},{"version":"0.41","changes":["Playtime clock now visible for all players","Fix: Time Warp button now appears immediately after migration grants charges"]},{"version":"0.40","changes":["Major rework, too many changes to list","V0.39 incompatible. Receive time warps as compensation based on tier reached."]},{"version":"0.39","changes":["T1 Mana Gems are now free to craft (no mana cost)","Starting mana is now 0","Fix: crafting progress bars now animate correctly"]},{"version":"0.38","changes":["Fix: offline time calculation no longer undercounts production"]},{"version":"0.37","changes":["Internal: centralized UI update system with dirty flags for better performance","Internal: split large combat and artifact UI modules into smaller files","Internal: removed code duplication with tab manager factory and fingerprint utility","Fix: mana regeneration tooltip no longer cut off by inventory panel"]},{"version":"0.36","changes":["Ring artifacts now only increase output (no longer increase input costs)","Tier milestones now display in chronological order"]},{"version":"0.35","changes":["New artifact: Mana Globe (x10 mana generation, x10 per upgrade level)","New artifact: Crafting Speed (+30% crafting speed, +2% per upgrade level)","New expedition: Abyssal Rift (artifact shards + combat points)","New expedition: Void Sanctum (nullstone)","New heroic expedition: Combat Mastery (scales combat point drops)","Added 3 more artifact slots (6-8)","Expedition reward icons now reflect heroic multipliers","Added T5 Sword and T6 Sword military units in Realm of War","Molds now always give 100% of their effect (no longer need to be slotted)"]},{"version":"0.34","changes":["Fixed tier reset corrupting Realm of War military crafters (NaN bug)","Expedition UI simplified: compact reward squares replace icon cards","Click any expedition square to open the setup dialog","Category labels shown to the left of each expedition group"]},{"version":"0.33","changes":["Heroic expeditions no longer have a 9,999 unit cap","Expedition unlocks now persist across tier resets"]},{"version":"0.32","changes":["Expedition UI redesigned: side-by-side icon cards replace table rows","Custom expedition icons for R1 (Forest Patrol, Cave, Mountain, Ruins, Wraith)","R2 quest icons now use gem icons instead of enemy icons","Heroic expedition cards show victories and bonus multiplier","R2 quest cards show completions and output bonus","Setup dialog: unit controls use table layout for proper alignment","Setup dialog: expedition icon enlarged to 96x96","Performance: separated lightweight progress bar updates from full state updates"]},{"version":"0.31","changes":["Added automatic update notification when a new version is available"]},{"version":"0.30","changes":["Upgrades and Tier tabs glow when an action is available","Expedition setup now saves and starts in one click","Expedition log is now collapsible","Early game pacing tweaked to be faster"]},{"version":"0.29","changes":["Removed mold artifacts from the game","Artifact shards spent on molds (purchase + upgrades) are refunded automatically"]},{"version":"0.28","changes":["Added Heroic Expeditions"]},{"version":"0.27","changes":["Fixed inventory sections not collapsible in R2","Removed spinner arrows from expedition unit assignment input","Fixed +/- buttons not working on expedition assignment until ++ was used first","Fixed expedition log not updating when switching realms while on Expeditions tab","Removed misleading \\"T3 reset only here\\" from Realm of War tooltip (T3 resets both realms)","R2 expedition dialog now shows the bonus formula per completion"]},{"version":"0.26","changes":["Added UI Scale slider in Settings under new Display section (0.8x to 1.3x)","Moved Background Image toggle from Game to Display section"]},{"version":"0.25","changes":["Added realm background images (blended with 70% black overlay)","Added \\"Background Image\\" toggle in Settings under Game","Crafting row backgrounds now semi-transparent to show background image"]},{"version":"0.24","changes":["Expedition log now shows last 20 entries per expedition type","Added filter dropdown to expedition log to view specific expedition types","Tab content now scrolls independently instead of the whole page"]},{"version":"0.23","changes":["Added Combat Artifact: costs 100k Artifact Shards, 100k Ghost Knights, and 100k Wisps","Combat Artifact grants +30% military strength (+3% per upgrade level)","Expeditions can now reach 100% success rate (was capped at 80%)"]},{"version":"0.22","changes":["Added Realm of War tooltip on realm switch button and portal gate","Added Q hotkey to swap realms","Added rebindable hotkeys dialog in Settings"]},{"version":"0.21","changes":["Increased max units per expedition from 5,000 to 9,999","Lowered military research upgrade costs","Increased T6 gem multiplier from x2.0 to x2.4"]},{"version":"0.2","changes":["Added Realm of War"]},{"version":"0.17","changes":["T2 reset now grants x1.4 total crafter speed and unlocks Military Research","Added Military Research upgrades: Knight Strength and Wisp Strength","Improved Tier milestone UI with two-column layout"]},{"version":"0.16","changes":["T4-T6 ring and mold artifacts","Added T5-T6 Output combat upgrade","Added T5-T6 Output mana upgrades","Rebalanced artifact slot and artifact costs","Fixed expedition unit assignment buttons firing multiple times when switching tabs","Fixed military strength formula to apply exponent to count before multiplier"]},{"version":"0.15","changes":["Added Tier system - prestige mechanic with permanent bonuses","Added Altar of Sacrifice - sacrifice items for permanent output bonuses","T1 reset requires 1e21 mana, grants x1.2 crafter speed and unlocks Altar","T2 reset requires 1e40 mana, grants x1.4 total crafter speed and unlocks Military Research","T1 gems require minimum 5 to prevent softlock when sacrificing","Craft time display now reflects tier speed bonuses"]},{"version":"0.14","changes":["Removed Village system (did not playtest well)"]},{"version":"0.13","changes":["Added military crafting speed combat upgrade","Fixed crafting input display to include artifact bonuses"]},{"version":"0.12","changes":["Added keyboard hotkeys: A/D to cycle main tabs, [/] to cycle inventory tabs"]},{"version":"0.11","changes":["Renamed Combat tab to Expeditions","Artifacts tab now shows a message when you have no lifetime artifact shards","Expeditions tab now shows a message when you have no lifetime ghost knights","Added lifetime artifact shards tracking","Added changelog to settings"]},{"version":"0.1","changes":["Initial release"]}]`),Bg=Og,mo="evercraft-color-theme",wt=[{variable:"--color-background",label:"Page background",group:"Core",defaultValue:"#0E1116"},{variable:"--color-panel",label:"Panel and input backgrounds",group:"Core",defaultValue:"#141922"},{variable:"--color-text",label:"Primary body text",group:"Core",defaultValue:"#BFC7D4"},{variable:"--color-muted",label:"Secondary text, disabled labels",group:"Core",defaultValue:"#9AA4B2"},{variable:"--color-steel",label:"Buttons, links, active tab",group:"Accent",defaultValue:"#5FA8D3"},{variable:"--color-arcane",label:"Import/action buttons, toast notifications",group:"Accent",defaultValue:"#5EB8C9"},{variable:"--color-gold",label:"Section headings, pause button",group:"Accent",defaultValue:"#C9964F"},{variable:"--color-red",label:"Danger buttons, blocked crafting",group:"Accent",defaultValue:"#E85A5A"},{variable:"--color-cyan",label:"Prime/Unified Realm, hotkeys, prestige, slider accent, expedition rates",group:"Secondary",defaultValue:"#5FD3D8"},{variable:"--color-magenta",label:"Color Theme button, Realm of Magic, soulforge, taunt modifiers",group:"Secondary",defaultValue:"#D85FD8"},{variable:"--color-yellow",label:"Realm of Earth, time warp, ascension, quest bonuses, tier notes",group:"Secondary",defaultValue:"#E0B73A"},{variable:"--color-lime",label:"Artifact shipping, heroic expeditions, Realm of Earth label",group:"Secondary",defaultValue:"#6FAE2C"},{variable:"--color-positive",label:"Positive rates, crafter +buttons, upgrade effects, success states",group:"Secondary",defaultValue:"#6BBF8C"},{variable:"--color-orange",label:"Altar table headers",group:"Secondary",defaultValue:"#E38A47"},{variable:"--color-white",label:"Button hover text",group:"Secondary",defaultValue:"#E3E7EE"},{variable:"--color-brown",label:"Layout borders, tooltip borders, scrollbar",group:"Secondary",defaultValue:"#B5794F"},{variable:"--color-brown-light",label:"Scrollbar hover",group:"Secondary",defaultValue:"#D4976A"},{variable:"--color-discord",label:"Discord button",group:"Secondary",defaultValue:"#5865F2"},{variable:"--color-tab-hover",label:"Tab hover background",group:"Surface",defaultValue:"#1E2530"},{variable:"--color-tooltip-bg-solid",label:"All tooltip backgrounds",group:"Surface",defaultValue:"#111318"},{variable:"--color-tooltip-divider",label:"Tooltip separator lines",group:"Surface",defaultValue:"#3a3a3a"},{variable:"--color-progress-start",label:"Crafting bar left edge",group:"Progress",defaultValue:"#2E8A96"},{variable:"--color-progress-end",label:"Crafting bar right edge",group:"Progress",defaultValue:"#5EB8C9"},{variable:"--color-progress-track",label:"Empty bar background",group:"Progress",defaultValue:"#0E1619"},{variable:"--color-row-penalty",label:"Realm of War tooltip: penalty text",group:"Realm of War Tooltip",defaultValue:"#E27C7C"},{variable:"--color-row-bonus",label:"Realm of War tooltip: bonus text",group:"Realm of War Tooltip",defaultValue:"#5BCF88"},{variable:"--color-row-special",label:"Realm of War tooltip: title and special text",group:"Realm of War Tooltip",defaultValue:"#B48AE6"}],Bc=[{name:"Default",colors:{}},{name:"Dark",tooltip:"made by DearHoney",colors:{"--color-background":"#101217","--color-panel":"#141922","--color-text":"#BFC7D4","--color-muted":"#9AA4B2","--color-steel":"#5FA8D3","--color-arcane":"#5EB8C9","--color-gold":"#818181","--color-red":"#E85A5A","--color-cyan":"#5FD3D8","--color-magenta":"#D85FD8","--color-yellow":"#E0B73A","--color-lime":"#6FAE2C","--color-positive":"#6BBF8C","--color-orange":"#E38A47","--color-white":"#E3E7EE","--color-brown":"#101217","--color-brown-light":"#D4976A","--color-discord":"#5865F2","--color-tab-hover":"#101217","--color-tooltip-bg-solid":"#111318","--color-tooltip-divider":"#111318","--color-progress-start":"#2E8A96","--color-progress-end":"#5EB8C9","--color-progress-track":"#0E1619","--color-row-penalty":"#E27C7C","--color-row-bonus":"#5BCF88","--color-row-special":"#B48AE6"}}],li=()=>{const e={};for(const r of wt)e[r.variable]=r.defaultValue;return e},Dc=()=>{try{const e=localStorage.getItem(mo);if(e)return JSON.parse(e)}catch{}return{}},Wr=e=>{const r={};for(const[t,a]of Object.entries(e)){const n=wt.find(s=>s.variable===t);n&&a.toLowerCase()!==n.defaultValue.toLowerCase()&&(r[t]=a)}Object.keys(r).length===0?localStorage.removeItem(mo):localStorage.setItem(mo,JSON.stringify(r))},Rr=e=>{const r=document.documentElement;for(const t of wt){const a=e[t.variable]||t.defaultValue;r.style.setProperty(t.variable,a)}},pl=e=>{const r={};for(const t of wt)r[t.variable]=e[t.variable]||t.defaultValue;return JSON.stringify(r,null,2)},Dg=e=>{try{const r=JSON.parse(e);if(typeof r!="object"||r===null)return null;const t={};for(const a of wt)typeof r[a.variable]=="string"&&/^#[0-9a-fA-F]{6}$/.test(r[a.variable])&&(t[a.variable]=r[a.variable]);return Object.keys(t).length>0?t:null}catch{return null}},Hg=()=>{const e=Dc();Object.keys(e).length>0&&Rr(e)};let Is=!1,ci=!1,Rn=!1,Cn=!1,Pe={},Wt="",Mr=null,Kr="",Es=null;const Pt=e=>{var a;Es&&clearTimeout(Es),(a=document.querySelector("[data-toast]"))==null||a.remove();const r=document.createElement("div");r.setAttribute("data-toast",""),r.className="z-50 p-3 px-5 border-2 border-arcane text-arcane bg-black font-mono",r.style.position="absolute",r.style.top="0.5rem",r.style.right="1rem",r.textContent=e;const t=document.getElementById("main-content");t&&(t.style.position="relative",t.appendChild(r)),Es=window.setTimeout(()=>{r.remove()},5e3)},Vg=async()=>{const e=M.getState().exportSave();await navigator.clipboard.writeText(e),Pt("Copied to clipboard!")},jg=()=>{const e=M.getState().exportSave(),r=new Blob([e],{type:"text/plain"}),t=URL.createObjectURL(r),a=document.createElement("a");a.href=t,a.download=`evercraft-save-${Date.now()}.txt`,a.click(),URL.revokeObjectURL(t),Pt("File downloaded!")},ui=e=>{e.success?(zp(),Pt("Save imported successfully!")):e.incompatible?Fc(e.oldTier??0):Pt("Invalid save data!")},Gg=async()=>{const e=await navigator.clipboard.readText(),r=M.getState().importSave(e);ui(r)},Wg=()=>{const e=M.getState().importSave(Kr);e.success&&(Kr=""),ui(e)},Kg=e=>{const r=new FileReader;r.onload=t=>{var s;const a=(s=t.target)==null?void 0:s.result,n=M.getState().importSave(a);ui(n)},r.readAsText(e)},Yg=()=>{M.getState().hardReset(),window.location.reload()},zg=()=>{M.getState().togglePause(),Je()},Xg=()=>{M.getState().toggleBackgroundImage(),Qc(M.getState().activeRealm),Je()},Zg=()=>{M.getState().toggleTabHighlighting(),Je()},As=e=>{const r=M.getState().uiScale,t=Math.round((r+e)*100)/100;M.getState().setUiScale(t),di(t),Je()},di=e=>{const r=document.getElementById("root");r&&(r.style.zoom=`${e}`,r.style.height=`${100/e}vh`,r.style.width=`${100/e}vw`)},Hc=e=>{Sp(e)},Vc=e=>{const r=ft.filter(a=>a.value<e).map(a=>a.suffix),t=Math.round(Math.log10(e));return r.length>0?r.join(", ")+`, 1e${t}`:`1e${t}`},Qg=e=>{const r=Math.pow(10,e);if(M.getState().setScientificNotationThreshold(r),Hc(r),Q){const t=Q.querySelector("[data-sci-label]"),a=Q.querySelector("[data-sci-preview]");t&&(t.textContent=`1e${e}`),a&&(a.textContent=Vc(r))}},Jg=()=>{ci=!0,Je()},fl=()=>{ci=!1,Je()},eh=()=>ci?`
    <div data-changelog-dialog class="fixed inset-0 bg-black--80 flex items-center justify-center z-50">
      <div class="bg-black border border-muted--50 p-6 max-w-2xl w-full mx-4 max-h-80vh flex flex-col">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl text-gold font-mono">Changelog</h2>
          <button data-action="close-changelog" class="text-muted hover-text-text text-2xl leading-none">&times;</button>
        </div>
        <div class="overflow-y-auto flex-1 pr-2">
          ${Bg.map(r=>`
    <div class="mb-6">
      <h3 class="text-lg text-gold font-mono mb-2">v${r.version}</h3>
      <ul class="list-disc list-inside text-text">
        ${r.changes.map(t=>`<li class="mb-1">${t}</li>`).join("")}
      </ul>
    </div>
  `).join("")}
        </div>
      </div>
    </div>
  `:"",th=()=>{if(!Rn)return"";const e=Ng();return`
    <div data-hotkey-dialog class="fixed inset-0 bg-black--80 flex items-center justify-center z-50">
      <div class="bg-black border border-muted--50 p-6 max-w-md w-full mx-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl text-gold font-mono">Hotkeys</h2>
          <button data-action="close-hotkeys" class="text-muted hover-text-text text-2xl leading-none">&times;</button>
        </div>
        <div>
          ${Pg.map(t=>{const a=e[t],n=Mr===t,s=n?'<span class="text-gold animate-pulse">Press a key...</span>':`<span class="text-cyan font-mono">${Fg(a.key)}</span>`;return`
      <div class="flex items-center justify-between py-2 border-b border-muted--20">
        <span class="text-text">${a.label}</span>
        <div class="flex items-center gap-3">
          ${s}
          <button
            data-action="rebind-hotkey"
            data-hotkey-action="${t}"
            class="px-3 py-1 text-xs font-mono border ${n?"border-gold text-gold":"border-steel text-steel hover-bg-steel hover-text-black"}"
          >${n?"Cancel":"Rebind"}</button>
        </div>
      </div>
    `}).join("")}
        </div>
        <div class="mt-4 text-xs text-steel">Click Rebind, then press any key to assign it.</div>
      </div>
    </div>
  `};let _a=null;const rh=e=>{Mr=e,Je(),_a=r=>{if(r.preventDefault(),r.stopPropagation(),r.key==="Escape"){jc();return}Lg(e,r.key),Mr=null,Wn(),Je()},document.addEventListener("keydown",_a,!0)},jc=()=>{Mr=null,Wn(),Je()},Wn=()=>{_a&&(document.removeEventListener("keydown",_a,!0),_a=null)},ah=()=>{if(!Cn)return"";const e=[],r=new Set;for(const s of wt)r.has(s.group)||(r.add(s.group),e.push(s.group));const t=li(),a=e.map(s=>{const i=wt.filter(l=>l.group===s).map(l=>{const p=Pe[l.variable]||t[l.variable],u=Pe[l.variable]&&Pe[l.variable].toLowerCase()!==l.defaultValue.toLowerCase();return`
        <div class="flex items-center gap-3 py-1">
          <input type="color" data-theme-picker="${l.variable}" value="${p}"
            class="w-8 h-8 cursor-pointer" style="border: 1px solid var(--color-muted); background: none; padding: 0;">
          <input type="text" data-theme-hex="${l.variable}" value="${p}"
            class="w-20 px-2 py-1 text-xs font-mono border border-muted--30 text-text" style="background: var(--color-panel);"
            maxlength="7" placeholder="#000000">
          <span class="text-text text-xs flex-1">${l.label}</span>
          ${u?`<button data-theme-reset="${l.variable}" class="px-2 py-1 text-xs font-mono border border-red text-red hover-bg-red hover-text-black" title="Reset to default">Reset</button>`:""}
        </div>`}).join("");return`
      <div class="mb-4">
        <h3 class="text-sm text-steel font-mono mb-2">${s}</h3>
        ${i}
      </div>`}).join("");return`
    <div data-color-theme-dialog class="fixed inset-0 bg-black--80 flex items-center justify-center z-50">
      <div class="bg-black border border-muted--50 p-6 max-w-2xl w-full mx-4 max-h-80vh flex flex-col">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl text-gold font-mono">Color Theme</h2>
          <button data-action="close-color-theme" class="text-muted hover-text-text text-2xl leading-none">&times;</button>
        </div>
        <div class="flex items-center gap-3 mb-2 flex-wrap">
          <span class="text-xs text-muted font-mono">Presets:</span>
          ${Bc.map(s=>`<button data-action="theme-preset" data-preset-name="${s.name}" class="px-3 py-1 text-xs font-mono border border-steel text-steel hover-bg-steel hover-text-black"${s.tooltip?` title="${s.tooltip}"`:""}>${s.name}</button>`).join("")}
          <button data-action="theme-reset-all" class="px-3 py-1 text-xs font-mono border border-red text-red hover-bg-red hover-text-black">Reset All</button>
        </div>
        <div class="flex items-center gap-3 mb-4 flex-wrap">
          <button data-action="theme-export-clipboard" class="px-3 py-1 text-xs font-mono border border-steel text-steel hover-bg-steel hover-text-black">Export to Clipboard</button>
          <button data-action="theme-export-file" class="px-3 py-1 text-xs font-mono border border-steel text-steel hover-bg-steel hover-text-black">Export File</button>
          <label class="px-3 py-1 text-xs font-mono border border-arcane text-arcane cursor-pointer hover-bg-arcane hover-text-black">
            Import File
            <input type="file" accept=".json,.txt" data-action="theme-import-file" class="hidden">
          </label>
          <input type="text" data-input="theme-import-text" value="${Wt}"
            placeholder="Paste theme JSON here..."
            class="flex-1 px-3 py-1 text-xs font-mono border border-muted--30 text-text placeholder-text-muted" style="background: var(--color-panel); min-width: 10em;">
          <button data-action="theme-import-text" class="px-3 py-1 text-xs font-mono border ${Wt?"border-arcane text-arcane hover-bg-arcane hover-text-black":"border-muted--30 text-muted--30 cursor-not-allowed"}">Import</button>
        </div>
        <div class="overflow-y-auto flex-1 pr-2">
          ${a}
        </div>
      </div>
    </div>
  `},ka=e=>{var t;delete Pe[e],Rr(Pe),Wr(Pe);const r=wt.find(a=>a.variable===e);if(r){const a=Q==null?void 0:Q.querySelector(`[data-theme-picker="${e}"]`),n=Q==null?void 0:Q.querySelector(`[data-theme-hex="${e}"]`);a&&(a.value=r.defaultValue),n&&(n.value=r.defaultValue),(t=Q==null?void 0:Q.querySelector(`[data-theme-reset="${e}"]`))==null||t.remove()}},gl=e=>{const r=Dg(e);if(r){Pe=r,Rr(Pe),Wr(Pe),Wt="";const t=li();for(const s of wt){const o=Pe[s.variable]||t[s.variable],i=Q==null?void 0:Q.querySelector(`[data-theme-picker="${s.variable}"]`),l=Q==null?void 0:Q.querySelector(`[data-theme-hex="${s.variable}"]`);i&&(i.value=o),l&&(l.value=o);const p=Pe[s.variable]&&Pe[s.variable].toLowerCase()!==s.defaultValue.toLowerCase(),u=i==null?void 0:i.closest(".flex.items-center"),c=u==null?void 0:u.querySelector(`[data-theme-reset="${s.variable}"]`);if(p&&!c&&u){const g=document.createElement("button");g.setAttribute("data-theme-reset",s.variable),g.className="px-2 py-1 text-xs font-mono border border-red text-red hover-bg-red hover-text-black",g.title="Reset to default",g.textContent="Reset",g.addEventListener("click",()=>ka(s.variable)),u.appendChild(g)}else!p&&c&&c.remove()}const a=Q==null?void 0:Q.querySelector('[data-input="theme-import-text"]');a&&(a.value="");const n=Q==null?void 0:Q.querySelector('[data-action="theme-import-text"]');n&&(n.className="px-3 py-1 text-xs font-mono border border-muted--30 text-muted--30 cursor-not-allowed"),Pt("Color theme imported!")}else Pt("Invalid color theme data!")};let Q=null;const Je=()=>{var f,v,S,b,T,w,$,R,x,y,k,C,I,_,A,F,E,P,V,j,B,Z,oe;if(!Q)return;const e=M.getState().paused,r=M.getState().backgroundImageOff,t=M.getState().tabHighlightingOff,a=M.getState().uiScale,n=M.getState().scientificNotationThreshold,s=Math.round(Math.log10(n)),o=Vc(n);Q.innerHTML=`
    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Game</h2>
      <div class="flex items-center gap-4">
        <button data-action="toggle-pause" class="px-4 py-2 border-2 ${e?"border-positive text-positive hover-bg-positive hover-text-black":"border-gold text-gold hover-bg-gold hover-text-black"} bg-black font-mono transition-colors">
          ${e?"Resume Game":"Pause Game"}
        </button>
        <button data-action="show-hotkeys" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
          Hotkeys
        </button>
        <a href="https://discord.gg/fCp7jCDqgg" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 border-2 border-discord text-discord bg-black font-mono hover-bg-discord hover-text-white transition-colors">
          <svg width="20" height="20" viewBox="0 -28.5 256 256" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid">
            <path d="M216.856 16.597A208.502 208.502 0 0 0 164.042 0c-2.275 4.113-4.933 9.645-6.766 14.046-19.692-2.961-39.203-2.961-58.533 0-1.832-4.4-4.55-9.933-6.846-14.046a207.809 207.809 0 0 0-52.855 16.638C5.618 67.147-3.443 116.4 1.087 164.956c22.169 16.555 43.653 26.612 64.775 33.193A161.094 161.094 0 0 0 79.735 175.3a136.413 136.413 0 0 1-21.846-10.632 108.636 108.636 0 0 0 5.356-4.237c42.122 19.702 87.89 19.702 129.51 0a131.66 131.66 0 0 0 5.355 4.237 136.07 136.07 0 0 1-21.886 10.653c4.006 8.02 8.638 15.67 13.873 22.848 21.142-6.58 42.646-16.637 64.815-33.213 5.316-56.288-9.08-105.09-38.056-148.36ZM85.474 135.095c-12.645 0-23.015-11.805-23.015-26.18s10.149-26.2 23.015-26.2c12.867 0 23.236 11.804 23.015 26.2.02 14.375-10.148 26.18-23.015 26.18Zm85.051 0c-12.645 0-23.014-11.805-23.014-26.18s10.148-26.2 23.014-26.2c12.867 0 23.236 11.804 23.015 26.2 0 14.375-10.148 26.18-23.015 26.18Z" fill="currentColor"/>
          </svg>
          Join Discord
        </a>
        ${e?'<span class="text-red">Game is paused - time is not accumulating</span>':""}
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Display</h2>
      <div class="flex items-center gap-4 mb-4">
        <button data-action="toggle-bg-image" class="px-4 py-2 border-2 ${r?"border-steel text-steel hover-bg-steel hover-text-black":"border-positive text-positive hover-bg-positive hover-text-black"} bg-black font-mono transition-colors">
          Background Image ${r?"Off":"On"}
        </button>
        <button data-action="toggle-tab-highlighting" class="px-4 py-2 border-2 ${t?"border-steel text-steel hover-bg-steel hover-text-black":"border-positive text-positive hover-bg-positive hover-text-black"} bg-black font-mono transition-colors">
          Tab Highlighting ${t?"Off":"On"}
        </button>
        <button data-action="show-color-theme" class="px-4 py-2 border-2 border-magenta text-magenta bg-black font-mono hover-bg-magenta hover-text-black transition-colors">
          Color Theme
        </button>
      </div>
      <div class="flex items-center gap-4">
        <span class="text-steel font-mono">UI Scale</span>
        <button data-action="ui-scale-down" ${a<=.5?"disabled":""} class="px-3 py-1 font-mono border-2 ${a<=.5?"border-muted--30 text-muted--30 cursor-not-allowed":"border-steel text-steel hover-bg-steel hover-text-black"} bg-black transition-colors">&minus;</button>
        <span class="text-text font-mono" data-ui-scale-value style="min-width: 3.5em; text-align: center;">${Math.round(a*100)}%</span>
        <button data-action="ui-scale-up" ${a>=1.3?"disabled":""} class="px-3 py-1 font-mono border-2 ${a>=1.3?"border-muted--30 text-muted--30 cursor-not-allowed":"border-steel text-steel hover-bg-steel hover-text-black"} bg-black transition-colors">+</button>
        <button data-action="reset-ui-scale" class="px-2 py-1 text-xs font-mono border border-steel text-steel hover-bg-steel hover-text-black transition-colors">Reset</button>
      </div>
      <div class="flex items-center gap-4 mt-4">
        <span class="text-steel font-mono">Scientific Notation</span>
        <input type="range" data-input="sci-threshold" min="3" max="36" step="3" value="${s}"
          class="w-40 accent-cyan cursor-pointer">
        <span class="text-text font-mono" data-sci-label style="min-width: 3em; text-align: center;">1e${s}</span>
      </div>
      <div class="text-xs text-muted font-mono mt-1 ml-0" data-sci-preview>${o}</div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Export</h2>
      <div class="flex gap-4">
        <button data-action="export-clipboard" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
          Copy to Clipboard
        </button>
        <button data-action="export-file" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
          Download File
        </button>
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Import</h2>
      <div class="flex gap-4 mb-4">
        <button data-action="import-clipboard" class="px-4 py-2 border-2 border-arcane text-arcane bg-black font-mono hover-bg-arcane hover-text-black transition-colors">
          Paste from Clipboard
        </button>
        <label class="px-4 py-2 border-2 border-arcane text-arcane bg-black font-mono cursor-pointer hover-bg-arcane hover-text-black transition-colors">
          Load File
          <input type="file" accept=".txt" data-action="import-file" class="hidden">
        </label>
      </div>
      <div class="flex gap-4">
        <input
          type="text"
          data-input="import-text"
          value="${Kr}"
          placeholder="Paste save data here..."
          class="flex-1 px-4 py-2 bg-panel border-2 border-text text-text font-mono placeholder-text-muted"
        >
        <button
          data-action="import-text"
          ${Kr?"":"disabled"}
          class="px-4 py-2 border-2 font-mono ${Kr?"border-arcane text-arcane bg-black hover-bg-arcane hover-text-black transition-colors":"border-muted--30 text-muted--30 cursor-not-allowed line-through"}"
        >
          Import
        </button>
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">Danger Zone</h2>
      ${Is?`
        <div class="flex gap-4 items-center">
          <span class="text-red">Are you sure?</span>
          <button data-action="hard-reset" class="px-4 py-2 border-2 border-red text-red bg-black font-mono hover-bg-red hover-text-black transition-colors">
            Yes, Reset Everything
          </button>
          <button data-action="cancel-reset" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
            Cancel
          </button>
        </div>
      `:`
        <button data-action="show-reset-confirm" class="px-4 py-2 border-2 border-red text-red bg-black font-mono hover-bg-red hover-text-black transition-colors">
          Hard Reset
        </button>
      `}
    </div>

    <div class="mb-8">
      <h2 class="text-xl text-gold mb-4">About</h2>
      <div class="flex items-center gap-4">
        <span class="text-muted">Version ${Xs()}</span>
        <button data-action="show-changelog" class="px-4 py-2 border-2 border-steel text-steel bg-black font-mono hover-bg-steel hover-text-black transition-colors">
          View Changelog
        </button>
      </div>
    </div>

    ${eh()}
    ${th()}
    ${ah()}
  `,(f=Q.querySelector('[data-action="toggle-pause"]'))==null||f.addEventListener("click",zg),(v=Q.querySelector('[data-action="toggle-bg-image"]'))==null||v.addEventListener("click",Xg),(S=Q.querySelector('[data-action="toggle-tab-highlighting"]'))==null||S.addEventListener("click",Zg),(b=Q.querySelector('[data-action="ui-scale-down"]'))==null||b.addEventListener("click",()=>As(-.05)),(T=Q.querySelector('[data-action="ui-scale-up"]'))==null||T.addEventListener("click",()=>As(.05)),(w=Q.querySelector('[data-action="reset-ui-scale"]'))==null||w.addEventListener("click",()=>As(1-M.getState().uiScale));const i=Q.querySelector('[data-input="sci-threshold"]');i==null||i.addEventListener("input",U=>{Qg(parseInt(U.target.value,10))}),($=Q.querySelector('[data-action="export-clipboard"]'))==null||$.addEventListener("click",Vg),(R=Q.querySelector('[data-action="export-file"]'))==null||R.addEventListener("click",jg),(x=Q.querySelector('[data-action="import-clipboard"]'))==null||x.addEventListener("click",Gg),(y=Q.querySelector('[data-action="import-text"]'))==null||y.addEventListener("click",Wg),(k=Q.querySelector('[data-action="show-reset-confirm"]'))==null||k.addEventListener("click",()=>{Is=!0,Je()}),(C=Q.querySelector('[data-action="hard-reset"]'))==null||C.addEventListener("click",Yg),(I=Q.querySelector('[data-action="cancel-reset"]'))==null||I.addEventListener("click",()=>{Is=!1,Je()}),(_=Q.querySelector('[data-action="show-changelog"]'))==null||_.addEventListener("click",Jg),(A=Q.querySelector('[data-action="close-changelog"]'))==null||A.addEventListener("click",fl);const l=Q.querySelector("[data-changelog-dialog]");l==null||l.addEventListener("click",U=>{U.target===l&&fl()}),(F=Q.querySelector('[data-action="show-hotkeys"]'))==null||F.addEventListener("click",()=>{Rn=!0,Je()}),(E=Q.querySelector('[data-action="close-hotkeys"]'))==null||E.addEventListener("click",()=>{Rn=!1,Mr=null,Wn(),Je()});const p=Q.querySelector("[data-hotkey-dialog]");p==null||p.addEventListener("click",U=>{U.target===p&&(Rn=!1,Mr=null,Wn(),Je())}),Q.querySelectorAll('[data-action="rebind-hotkey"]').forEach(U=>{U.addEventListener("click",()=>{const O=U.getAttribute("data-hotkey-action");Mr===O?jc():rh(O)})}),(P=Q.querySelector('[data-action="show-color-theme"]'))==null||P.addEventListener("click",()=>{Pe={...Dc()},Cn=!0,Je()}),(V=Q.querySelector('[data-action="close-color-theme"]'))==null||V.addEventListener("click",()=>{Cn=!1,Wt="",Je()});const u=Q.querySelector("[data-color-theme-dialog]");u==null||u.addEventListener("click",U=>{U.target===u&&(Cn=!1,Wt="",Je())}),Q.querySelectorAll("[data-theme-picker]").forEach(U=>{U.addEventListener("input",O=>{const K=U.getAttribute("data-theme-picker"),se=O.target.value;Pe[K]=se,Rr(Pe),Wr(Pe);const be=Q==null?void 0:Q.querySelector(`[data-theme-hex="${K}"]`);be&&(be.value=se);const G=wt.find(Y=>Y.variable===K),L=U.closest(".flex.items-center");if(G&&L){const Y=L.querySelector(`[data-theme-reset="${K}"]`);if(se.toLowerCase()!==G.defaultValue.toLowerCase()){if(!Y){const X=document.createElement("button");X.setAttribute("data-theme-reset",K),X.className="px-2 py-1 text-xs font-mono border border-red text-red hover-bg-red hover-text-black",X.title="Reset to default",X.textContent="Reset",X.addEventListener("click",()=>ka(K)),L.appendChild(X)}}else Y==null||Y.remove()}})}),Q.querySelectorAll("[data-theme-hex]").forEach(U=>{U.addEventListener("change",O=>{const K=U.getAttribute("data-theme-hex");let se=O.target.value.trim();if(/^[0-9a-fA-F]{6}$/.test(se)&&(se="#"+se),!/^#[0-9a-fA-F]{6}$/.test(se))return;Pe[K]=se,Rr(Pe),Wr(Pe);const be=Q==null?void 0:Q.querySelector(`[data-theme-picker="${K}"]`);be&&(be.value=se);const G=wt.find(Y=>Y.variable===K),L=U.closest(".flex.items-center");if(G&&L){const Y=L.querySelector(`[data-theme-reset="${K}"]`);if(se.toLowerCase()!==G.defaultValue.toLowerCase()){if(!Y){const X=document.createElement("button");X.setAttribute("data-theme-reset",K),X.className="px-2 py-1 text-xs font-mono border border-red text-red hover-bg-red hover-text-black",X.title="Reset to default",X.textContent="Reset",X.addEventListener("click",()=>ka(K)),L.appendChild(X)}}else Y==null||Y.remove()}})}),Q.querySelectorAll("[data-theme-reset]").forEach(U=>{U.addEventListener("click",()=>{const O=U.getAttribute("data-theme-reset");ka(O)})}),Q.querySelectorAll('[data-action="theme-preset"]').forEach(U=>{U.addEventListener("click",()=>{const O=U.getAttribute("data-preset-name"),K=Bc.find(be=>be.name===O);if(!K)return;Pe={...K.colors},Rr(Pe),Wr(Pe);const se=li();for(const be of wt){const G=Pe[be.variable]||se[be.variable],L=Q==null?void 0:Q.querySelector(`[data-theme-picker="${be.variable}"]`),Y=Q==null?void 0:Q.querySelector(`[data-theme-hex="${be.variable}"]`);L&&(L.value=G),Y&&(Y.value=G);const X=Pe[be.variable]&&Pe[be.variable].toLowerCase()!==be.defaultValue.toLowerCase(),ie=L==null?void 0:L.closest(".flex.items-center"),re=ie==null?void 0:ie.querySelector(`[data-theme-reset="${be.variable}"]`);if(X&&!re&&ie){const ce=document.createElement("button");ce.setAttribute("data-theme-reset",be.variable),ce.className="px-2 py-1 text-xs font-mono border border-red text-red hover-bg-red hover-text-black",ce.title="Reset to default",ce.textContent="Reset",ce.addEventListener("click",()=>ka(be.variable)),ie.appendChild(ce)}else!X&&re&&re.remove()}Pt(`Applied "${O}" theme!`)})}),(j=Q.querySelector('[data-action="theme-reset-all"]'))==null||j.addEventListener("click",()=>{Pe={},Rr({}),Wr({});for(const U of wt){const O=Q==null?void 0:Q.querySelector(`[data-theme-picker="${U.variable}"]`),K=Q==null?void 0:Q.querySelector(`[data-theme-hex="${U.variable}"]`);O&&(O.value=U.defaultValue),K&&(K.value=U.defaultValue)}Q==null||Q.querySelectorAll("[data-theme-reset]").forEach(U=>U.remove()),Pt("Color theme reset to defaults!")}),(B=Q.querySelector('[data-action="theme-export-clipboard"]'))==null||B.addEventListener("click",async()=>{const U=pl(Pe);await navigator.clipboard.writeText(U),Pt("Color theme copied to clipboard!")}),(Z=Q.querySelector('[data-action="theme-export-file"]'))==null||Z.addEventListener("click",()=>{const U=pl(Pe),O=new Blob([U],{type:"application/json"}),K=URL.createObjectURL(O),se=document.createElement("a");se.href=K,se.download=`evercraft-theme-${Date.now()}.json`,se.click(),URL.revokeObjectURL(K),Pt("Color theme file downloaded!")});const c=Q.querySelector('[data-action="theme-import-file"]');c==null||c.addEventListener("change",U=>{var K;const O=(K=U.target.files)==null?void 0:K[0];if(O){const se=new FileReader;se.onload=be=>{var L;const G=(L=be.target)==null?void 0:L.result;gl(G)},se.readAsText(O),c.value=""}});const g=Q.querySelector('[data-input="theme-import-text"]');g==null||g.addEventListener("input",U=>{Wt=U.target.value;const O=Q==null?void 0:Q.querySelector('[data-action="theme-import-text"]');O&&(Wt?O.className="px-3 py-1 text-xs font-mono border border-arcane text-arcane hover-bg-arcane hover-text-black":O.className="px-3 py-1 text-xs font-mono border border-muted--30 text-muted--30 cursor-not-allowed")}),(oe=Q.querySelector('[data-action="theme-import-text"]'))==null||oe.addEventListener("click",()=>{Wt&&gl(Wt)});const m=Q.querySelector('[data-action="import-file"]');m==null||m.addEventListener("change",U=>{var K;const O=(K=U.target.files)==null?void 0:K[0];O&&(Kg(O),m.value="")});const h=Q.querySelector('[data-input="import-text"]');h==null||h.addEventListener("input",U=>{Kr=U.target.value,Je()})},nh=e=>{Q=e,Je()};let Ke="crafting";const po={crafting:Ee.Crafting,upgrades:Ee.Upgrades,prestige:Ee.Prestige,combat:Ee.Combat,artifacts:Ee.Artifacts,village:Ee.Village,ascension:Ee.Ascension,camp:Ee.Camp,tier:Ee.Tier,altar:Ee.Altar,realm:Ee.Realm,settings:0},Gc=e=>{Ke=e,Qs(po[e]),$a(),go()},sh=["crafting","upgrades","prestige","combat","village","ascension","camp","artifacts","tier","altar","realm","settings"],Kn=()=>{const e=M.getState(),r=e.realmUUnlocked||D(e.realms.realm1.recipeInventory,"nullstone").gte(1)||e.realms.realm1.combat.portalBuilt,t=js(e.globalTier),a=St.some(o=>{const i=e.realms[o].recipeCrafting;return kd(o).some(l=>Oe(i,l)>0)}),n=e.activeRealm,s=n==="realm4";return sh.filter(o=>{if(o==="realm")return r;if(o==="camp")return s;if(s)return o==="tier"||o==="settings";if(o==="altar")return t&&n!=="realm3";if(o==="artifacts")return a&&n!=="realm3";if(o==="upgrades"&&n==="realm3"||o==="prestige"&&n==="realm3")return!1;if(o==="village"){if(n!=="realm3")return!1;if(e.villageUnlocked)return!0;const i=e.realms.realm3.recipeInventory;return D(i,"arcane_bar").gt(0)||D(i,"arcane_log").gt(0)?(M.setState({villageUnlocked:!0}),!0):!1}return o==="ascension"?n==="realm3":!0})},hl=e=>{const r=Kn(),a=(r.indexOf(Ke)+e+r.length)%r.length;Gc(r[a])},Yr={crafting:"Main",upgrades:"Research",prestige:"Prestige",artifacts:"Artifacts",combat:"Expeditions",village:"Village",ascension:"Ascension",camp:"Main",tier:"Tier",altar:"Altar",realm:"Realm",settings:"Settings"},oh=()=>{const e=M.getState();if(e.activeRealm==="realm3")return[];const r=J(e),{recipeCrafting:t}=r,a=[];for(const n of Ul){if(n==="crafters")continue;const o=n.match(/manaT(\d)Output/);if(o){const i=parseInt(o[1]);if(Oe(t,`gem_${i}`)<=0)continue}a.push(n)}for(const n of ko)if(!((n==="sacrificeMulti"||n==="unifiedKnightStrength")&&e.activeRealm!=="realmU")){if(Xr.includes(n)){if(e.activeRealm!=="realm1"&&e.activeRealm!=="realmU")continue;const s={t1KnightStrength:"t1_knight",t4KnightStrength:"t4_knight",t7KnightStrength:"t7_knight"};if(s[n]&&Oe(t,s[n])===0)continue}if(zr.includes(n)){if(e.activeRealm!=="realm2")continue;const s={t4SwordEfficiency:"t4_sword",t5SwordEfficiency:"t5_sword",t6SwordEfficiency:"t6_sword"};if(s[n]&&Oe(t,s[n])===0)continue}a.push(n)}return a},Wc=()=>{const e=M.getState(),r=J(e);if(r.autoAllResearch)return 0;const{mana:t,upgrades:a,autoBuyUpgrades:n}=r,s=Xt(r.recipeInventory),o=ia(r.recipeInventory),i=e.globalTier;return oh().filter(l=>!Kt(a,l,i)&&tn(a,l,t,s,o,i,r.recipeInventory)&&!n[l]).length},Kc=()=>{const e=M.getState(),r=J(e),t=e.activeRealm==="realm3"?r.mana:void 0;return Bn(r.mana,e.globalTier,e.activeRealm,t,e.realms.realm4.heroicTrialCompleted)},Yc=()=>{const e=M.getState(),r=J(e);if(r.autoAllPrestige)return 0;const{prestige:t}=r,a=[...Zn(e.activeRealm).filter(s=>{const o=vt[s];return o.category!=="military"||!o.ignoreModifiers}),...Nl];let n=0;for(const s of a){const o=D(r.recipeInventory,s),i=t.prestigeCounts[s]||0;as(s,o,i)&&!t.autoPrestige[s]&&n++}return n},fo=()=>window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",vl=e=>{const r=Math.floor(e/6e4),t=Math.floor(r/60),a=Math.floor(t/24);if(a>=1){const s=t%24;return`${a}d ${s}h`}const n=r%60;return`${t}h ${String(n).padStart(2,"0")}m`},zc=()=>`
    <div class="tooltip-title" style="color: var(--color-row-special);">Realm of War</div>
    <div class="tooltip-section" style="margin-bottom: 4px;">A harsher realm with unique mechanics:</div>
    <div class="tooltip-divider"></div>
    <div class="tooltip-section" style="color: var(--color-row-penalty); margin-bottom: 2px; font-weight: bold;">Penalties</div>
    <div class="tooltip-row">
      <span class="tooltip-label">Mana generation</span>
      <span class="tooltip-value" style="color: var(--color-row-penalty);">Square rooted</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Craft speed</span>
      <span class="tooltip-value" style="color: var(--color-row-penalty);">x4 slower</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Flask gem costs</span>
      <span class="tooltip-value" style="color: var(--color-row-penalty);">x4 higher</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Artifacts</span>
      <span class="tooltip-value" style="color: var(--color-row-penalty);">Cannot craft</span>
    </div>
    <div class="tooltip-divider"></div>
    <div class="tooltip-section" style="color: var(--color-row-bonus); margin-bottom: 2px; font-weight: bold;">Bonuses</div>
    <div class="tooltip-row">
      <span class="tooltip-label">Sacrifice cap</span>
      <span class="tooltip-value" style="color: var(--color-row-bonus);">200k (vs 20k)</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Sacrifice batch</span>
      <span class="tooltip-value" style="color: var(--color-row-bonus);">10 at once</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Sacrifice scaling</span>
      <span class="tooltip-value" style="color: var(--color-row-bonus);">Up to x9.94</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Quest bonuses</span>
      <span class="tooltip-value" style="color: var(--color-row-bonus);">Tier output multipliers</span>
    </div>
    <div class="tooltip-divider"></div>
    <div class="tooltip-section" style="color: var(--color-row-special); margin-bottom: 2px; font-weight: bold;">Unique</div>
    <div class="tooltip-row">
      <span class="tooltip-label">Military</span>
      <span class="tooltip-value" style="color: var(--color-text);">T1-T6 Swords</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Quest unlock</span>
      <span class="tooltip-value" style="color: var(--color-text);">15 completions</span>
    </div>
    <div style="font-size: 11px; color: var(--color-muted); margin-top: 8px;">Click to switch to Prime Realm.</div>
  `,Yn=e=>{const r=M.getState(),t=e/GAME_SPEED_MULT;M.setState({lastFrameTimestamp:r.lastFrameTimestamp-t,skippedTime:r.skippedTime+e})},$a=()=>{const e=document.getElementById("tab-buttons");e.innerHTML="";const r=M.getState();if(r.realm2Unlocked||r.realmUUnlocked){const g=r.activeRealm,h=H({realm1:{icon:"icons/r0.png",name:"Prime Realm"},realm2:{icon:"icons/portal.png",name:"Realm of War"},realm3:{icon:"icons/r3.png",name:"Realm of Magic"},realmU:{icon:"icons/r0.png",name:"Unified Realm"},realm4:{icon:"icons/r4.png",name:"Realm of Earth"}}[g].icon),f="border-white";let v;r.realmUUnlocked?(v=["realmU","realm3"],r.earthPortalBuilt&&v.push("realm4")):(v=["realm1","realm2"],r.realm3Unlocked&&v.push("realm3"));const S=document.createElement("div");S.className="realm-tooltip-wrapper mr-2 flex-shrink-0";const b=document.createElement("button");b.className=`px-2 py-1 border ${f} hover-bg-panel--50 cursor-pointer flex items-center`,b.innerHTML=`<img src="${h}" alt="Realm" style="width: 24px; height: 24px;" class="object-contain">`,b.onclick=()=>{const w=M.getState(),$=v.indexOf(w.activeRealm),R=v[($+1)%v.length];w.setActiveRealm(R)},S.appendChild(b);const T=document.createElement("div");T.className="realm-tooltip",g==="realm2"?T.innerHTML=zc():g==="realm3"?T.innerHTML=`<div class="tooltip-title text-magenta">Realm of Magic</div>
        <div class="tooltip-section">Click to switch realm.</div>`:g==="realmU"?T.innerHTML=`<div class="tooltip-title text-cyan">Unified Realm</div>
        <div class="tooltip-section">Click to switch realm.</div>`:g==="realm4"?T.innerHTML=`<div class="tooltip-title text-yellow">Realm of Earth</div>
        <div class="tooltip-section">Click to switch realm.</div>`:T.innerHTML=`<div class="tooltip-title text-cyan">Prime Realm</div>
        <div class="tooltip-section">Click to switch realm.</div>`,S.appendChild(T),e.appendChild(S)}const t=Kn(),a=r.tabHighlightingOff,n=a?0:Wc(),s=a?0:Yc(),o=a?!1:Kc(),i={upgrades:n>0,prestige:s>0,tier:o},l={upgrades:n,prestige:s};for(const g of t){const m=document.createElement("button"),h=Ke===g,f=!h&&(i[g]??!1);m.className=`px-4 py-2 font-mono transition-colors ${h?"tab-active":"tab-inactive"}${f?" tab-glow":""}`;const v=l[g]??0,S=v>0&&!h?`${Yr[g]} (${v})`:Yr[g];if(m.textContent=S,(g==="upgrades"||g==="prestige"||g==="tier")&&(m.setAttribute("data-tab",g),f)){const b=document.createElement("div");b.className="tab-glow-bg",m.prepend(b)}m.onclick=()=>Gc(g),e.appendChild(m)}const p=document.createElement("a");p.href="https://discord.gg/fCp7jCDqgg",p.target="_blank",p.className="px-2 py-1 flex items-center hover-bg-panel--50",p.innerHTML=`<img src="${H("icons/discord.svg")}" alt="Discord" style="width: 20px; height: 20px;">`,p.title="Join Discord",e.appendChild(p);const u=document.createElement("div");u.className="flex items-center gap-4 ml-auto",u.setAttribute("data-right-container","");const c=document.createElement("span");if(c.className="font-mono text-steel text-sm",c.setAttribute("data-playtime-clock",""),u.appendChild(c),r.timeWarpCharges>0){const g=document.createElement("button");g.className="px-4 py-2 font-mono text-yellow border border-yellow hover-bg-yellow hover-text-black cursor-pointer",g.setAttribute("data-time-warp-btn",""),g.textContent=`Time Warp (${r.timeWarpCharges})`,g.onclick=()=>{const m=M.getState();m.timeWarpCharges<=0||(Yn(300*1e3),M.setState({timeWarpCharges:m.timeWarpCharges-1}))},u.appendChild(g)}if(fo()){const g=document.createElement("button");g.className="px-4 py-2 font-mono text-yellow border border-yellow hover-bg-yellow hover-text-black",g.textContent="+5min",g.onclick=()=>Yn(300*1e3),u.appendChild(g)}u.childNodes.length>0&&e.appendChild(u)},go=()=>{const e=document.getElementById("main-content");nf(),pf(),xg(),Sf(),jf(),Tg(),Cg(),Ig(),Xf(),ag(),pg(),e.innerHTML="",Ke==="crafting"?sf(e):Ke==="upgrades"?ff(e):Ke==="prestige"?yg(e):Ke==="artifacts"?wf(e):Ke==="combat"?$n(e):Ke==="village"?Sg(e):Ke==="ascension"?Rg(e):Ke==="camp"?Mg(e):Ke==="tier"?Zf(e):Ke==="altar"?ng(e):Ke==="realm"?fg(e):Ke==="settings"&&nh(e)};let _s=!1,qs=!1,Ns=!1,Ls=!1,Us="realm1",Ps=0,Fs=0,bl=!1,Os=0;const Xc={realm1:{color:"var(--color-background)",image:'url("icons/r1%20bg.png")'},realm2:{color:"var(--color-realm2-bg)",image:'url("icons/r2%20bg.png")'},realm3:{color:"var(--color-background)",image:'url("icons/r3%20bg.png")',overlay:.82},realmU:{color:"var(--color-background)",image:'url("icons/r1%20bg.png")'},realm4:{color:"var(--color-realm4-bg)",image:'url("icons/r4%20bg.png")'}},Zc=(e,r)=>{if(e.style.backgroundColor=r.color,r.image){const t=r.overlay??.7;e.style.backgroundImage=`linear-gradient(rgba(0,0,0,${t}), rgba(0,0,0,${t})), ${r.image}`,e.style.backgroundSize="cover",e.style.backgroundPosition="center",e.style.backgroundRepeat="no-repeat"}else e.style.backgroundImage="none"},Qc=e=>{const r=Xc[e],t=M.getState().backgroundImageOff;Zc(document.body,t?{color:r.color}:r);const a=document.querySelector("#root > div");a&&(a.style.backgroundColor="transparent",a.style.backgroundImage="none")},ih=()=>{const e=M.getState(),r=Xc[e.activeRealm];Zc(document.body,e.backgroundImageOff?{color:r.color}:r);const t=document.getElementById("root");t.innerHTML=`
    <div class="h-full flex flex-col p-2 gap-2 overflow-hidden">
      <nav>
        <div id="tab-buttons" class="flex items-center px-4" style="border: 1px solid var(--color-brown);"></div>
      </nav>
      <div id="update-banner" class="update-banner hidden"></div>
      <div class="flex flex-1 overflow-hidden gap-2 mobile-layout">
        <div id="inventory" class="pt-2 pb-2 pl-2 flex-shrink-0 flex flex-col overflow-hidden" style="border: 1px solid var(--color-brown); width: 280px;"></div>
        <main id="main-content" class="flex-1 p-6 overflow-auto" style="border: 1px solid var(--color-brown);"></main>
      </div>
    </div>
  `;const a=document.getElementById("inventory"),n=t.querySelector("nav"),s=document.createElement("button");s.className="mobile-inventory-toggle",s.textContent="Inventory",s.setAttribute("data-mobile-inv-toggle",""),s.onclick=()=>{a.classList.toggle("mobile-open"),s.textContent=a.classList.contains("mobile-open")?"Hide Inventory":"Inventory"},n.appendChild(s),e.uiScale!==1&&di(e.uiScale),Hc(e.scientificNotationThreshold),Hg(),_s=e.realmUUnlocked||D(e.realms.realm1.recipeInventory,"nullstone").gte(1)||e.realms.realm1.combat.portalBuilt,qs=e.realm2Unlocked,Ns=e.realm3Unlocked,Ls=e.earthPortalBuilt,Us=e.activeRealm,Os=e.timeWarpCharges,Kn().includes(Ke)||(Ke=e.activeRealm==="realm4"?"camp":"crafting",Qs(po[Ke])),$a(),Ui(),go();const i=()=>{const g=M.getState(),m=g.realmUUnlocked||D(g.realms.realm1.recipeInventory,"nullstone").gte(1)||g.realms.realm1.combat.portalBuilt;if(m!==_s&&(_s=m,$a()),(g.realm2Unlocked!==qs||g.realm3Unlocked!==Ns||g.earthPortalBuilt!==Ls)&&(qs=g.realm2Unlocked,Ns=g.realm3Unlocked,Ls=g.earthPortalBuilt,$a()),g.activeRealm!==Us){if(Us=g.activeRealm,Qc(g.activeRealm),!Kn().includes(Ke)){const w=g.activeRealm==="realm4"?"camp":"crafting";Ke=w,Qs(po[w])}$a(),go(),Ui(),yc()}const h=g.tabHighlightingOff,f=(T,w,$)=>{if(w===$)return $;const R=document.querySelector(`[data-tab="${T}"]`);if(R&&Ke!==T){const x=R.querySelector(".tab-glow-bg");if(w&&!x){R.classList.add("tab-glow");const y=document.createElement("div");y.className="tab-glow-bg",R.prepend(y)}else!w&&x&&(R.classList.remove("tab-glow"),x.remove())}return w},v=h?0:Wc();if(v!==Ps){const T=Ps>0,w=v>0;Ps=v;const $=document.querySelector('[data-tab="upgrades"]');if($&&Ke!=="upgrades"){if(w!==T){const R=$.querySelector(".tab-glow-bg");if(w&&!R){$.classList.add("tab-glow");const x=document.createElement("div");x.className="tab-glow-bg",$.prepend(x)}else!w&&R&&($.classList.remove("tab-glow"),R.remove())}if($.textContent=w?`${Yr.upgrades} (${v})`:Yr.upgrades,w&&!$.querySelector(".tab-glow-bg")){const R=document.createElement("div");R.className="tab-glow-bg",$.prepend(R)}}}const S=h?0:Yc();if(S!==Fs){const T=Fs>0,w=S>0;Fs=S;const $=document.querySelector('[data-tab="prestige"]');if($&&Ke!=="prestige"){if(w!==T){const R=$.querySelector(".tab-glow-bg");if(w&&!R){$.classList.add("tab-glow");const x=document.createElement("div");x.className="tab-glow-bg",$.prepend(x)}else!w&&R&&($.classList.remove("tab-glow"),R.remove())}if($.textContent=w?`${Yr.prestige} (${S})`:Yr.prestige,w&&!$.querySelector(".tab-glow-bg")){const R=document.createElement("div");R.className="tab-glow-bg",$.prepend(R)}}}bl=f("tier",h?!1:Kc(),bl);{const T=g.timeWarpCharges;if(T!==Os)if(Os=T,T<=0){const w=document.querySelector("[data-time-warp-btn]");w&&w.remove()}else{let w=document.querySelector("[data-time-warp-btn]");if(w)w.textContent=`Time Warp (${T})`;else{const $=document.querySelector("[data-right-container]");$&&(w=document.createElement("button"),w.className="px-4 py-2 font-mono text-yellow border border-yellow hover-bg-yellow hover-text-black cursor-pointer",w.setAttribute("data-time-warp-btn",""),w.textContent=`Time Warp (${T})`,w.onclick=()=>{const R=M.getState();R.timeWarpCharges<=0||(Yn(300*1e3),M.setState({timeWarpCharges:R.timeWarpCharges-1}))},$.prepend(w))}}}const b=document.querySelector("[data-playtime-clock]");if(b){const T=g.totalPlaytime;let w=vl(T);fo()&&g.skippedTime>0&&(w+=` (${vl(g.skippedTime)} skipped)`),b.textContent=w}};Ka(Ee.TabBar,i),document.addEventListener("keydown",g=>{const m=g.target;if(m.tagName==="INPUT"||m.tagName==="TEXTAREA")return;if(g.key==="`"&&fo()){Yn(300*1e3);return}const h=Ug(g.key);if(h)switch(h){case"tabLeft":hl(-1);break;case"tabRight":hl(1);break;case"swapRealm":{const f=M.getState();if(f.realm2Unlocked||f.realmUUnlocked){let v;f.realmUUnlocked?(v=["realmU","realm3"],f.earthPortalBuilt&&v.push("realm4")):(v=["realm1","realm2"],f.realm3Unlocked&&v.push("realm3"));const S=v.indexOf(f.activeRealm),b=v[(S+1)%v.length];f.setActiveRealm(b)}break}}}),document.addEventListener("mouseover",g=>{var f,v;const m=(v=(f=g.target).closest)==null?void 0:v.call(f,".hover-tooltip-wrapper");if(!m)return;const h=m.getBoundingClientRect();m.classList.toggle("tooltip-above",h.top>window.innerHeight/2)});let l=null,p=null;const u=()=>window.matchMedia("(max-width: 768px)").matches,c=()=>{p&&(p.disconnect(),p=null),l&&(l.remove(),l=null)};document.addEventListener("click",g=>{var $,R;if(!u())return;const m=(R=($=g.target).closest)==null?void 0:R.call($,".hover-tooltip-wrapper");if(!m){c();return}if(g.target.closest("button"))return;const h=m.querySelector(".hover-tooltip");if(!h||!h.innerHTML.trim())return;if(g.preventDefault(),g.stopPropagation(),l&&l.dataset.sourceWrapper===m.dataset.mobileTooltipId){c();return}c();const f=document.createElement("div");f.className="mobile-fixed-tooltip",f.innerHTML=h.innerHTML;const v=`tt-${Date.now()}`;m.dataset.mobileTooltipId=v,f.dataset.sourceWrapper=v,document.body.appendChild(f),l=f,p=new MutationObserver(()=>{l&&h&&(l.innerHTML=h.innerHTML)}),p.observe(h,{childList:!0,subtree:!0,characterData:!0});const S=m.getBoundingClientRect();S.top>window.innerHeight/2?(f.style.bottom=`${window.innerHeight-S.top+4}px`,f.style.top="auto"):(f.style.top=`${S.bottom+4}px`,f.style.bottom="auto");const T=Math.min(S.right,window.innerWidth-12);f.style.right=`${window.innerWidth-T}px`,f.style.left="auto",f.getBoundingClientRect().left<12&&(f.style.right="auto",f.style.left="12px")}),document.addEventListener("scroll",c,!0)},Jc="evercraft_analytics_tiers",lh=()=>{try{const e=localStorage.getItem(Jc);return e?new Set(JSON.parse(e)):new Set}catch{return new Set}},ch=e=>{localStorage.setItem(Jc,JSON.stringify([...e]))},uh=e=>{const r=window.gtag;typeof r=="function"&&r("event","tier_reached",{tier:e})},ho=()=>{const e=M.getState();let r=0;for(const t of St){const a=e.realms[t];if(a)for(const n of gt)st(`gem_${n}`,a.recipeCrafting)&&n>r&&(r=n)}return r},xl=()=>{const e=ho(),r=lh();let t=!1;for(let a=0;a<=e;a++)r.has(a)||(uh(a),r.add(a),t=!0);t&&ch(r)},dh=()=>{xl();let e=ho();M.subscribe(()=>{const r=ho();r!==e&&(e=r,xl())})},mh=()=>{const e=M.getState().uiScale;e!==1&&di(e),sp()&&Fc(op()),dh();let r=0;const t=1e3/60,a=n=>{requestAnimationFrame(a),!(n-r<t)&&(r=n,wp(),yc(),_p())};requestAnimationFrame(a)},ph=6e4;let fh=null,yl=null;const gh=()=>{if(yl!==null||Dn.includes("-dev"))return;const e=async()=>{try{const r=await fetch(H("version.json")+"?t="+Date.now());if(!r.ok)return;const t=await r.json();t.version&&parseFloat(t.version)>parseFloat(Dn)&&(fh=t.version,hh(t.version))}catch{}};e(),yl=window.setInterval(e,ph)},hh=e=>{const r=document.getElementById("update-banner");if(!r)return;const t=H("changelog.txt");r.innerHTML=`V${e} is out, refresh to update (<a href="${t}" target="_blank" class="text-cyan" style="text-decoration: underline;">changelog</a>)`,r.classList.remove("hidden")};M.getState().loadFromStorage();ih();mh();gh();
